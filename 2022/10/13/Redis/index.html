

<!DOCTYPE html>
<html lang="zh-CN" data-default-color-scheme=auto>



<head>
  <meta charset="UTF-8">
  <link rel="apple-touch-icon" sizes="76x76" href="/img/favicon.png">
  <link rel="icon" href="/img/favicon.png">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="author" content="Xu huaiang">
  <meta name="keywords" content="">
  
    <meta name="description" content="1.场景引入Web1.0的时代，数据访问量很有限，用一夫当关的高性能的单点服务器可以解决大部分问题。  随着Web2.0的时代的到来，用户访问量大幅度提升，同时产生了大量的用户数据所有的互联网平台都面临了巨大的性能挑战。  解决CPU和内存压力的方案：  解决IO压力：&#x3D;&#x3D;减少IO操作&#x3D;&#x3D;  2.NoSQL数据库2.1NoSQL简介NoSQL(NoSQL">
<meta property="og:type" content="article">
<meta property="og:title" content="Redis">
<meta property="og:url" content="http://example.com/2022/10/13/Redis/index.html">
<meta property="og:site_name" content="xhang&#39;s blog">
<meta property="og:description" content="1.场景引入Web1.0的时代，数据访问量很有限，用一夫当关的高性能的单点服务器可以解决大部分问题。  随着Web2.0的时代的到来，用户访问量大幅度提升，同时产生了大量的用户数据所有的互联网平台都面临了巨大的性能挑战。  解决CPU和内存压力的方案：  解决IO压力：&#x3D;&#x3D;减少IO操作&#x3D;&#x3D;  2.NoSQL数据库2.1NoSQL简介NoSQL(NoSQL">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20221101201859716.png">
<meta property="article:published_time" content="2022-10-13T02:00:00.000Z">
<meta property="article:modified_time" content="2023-06-13T01:46:06.562Z">
<meta property="article:author" content="Xu huaiang">
<meta property="article:tag" content="NoSQL">
<meta property="article:tag" content="Redis">
<meta property="article:tag" content="缓存">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image" content="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20221101201859716.png">
  
  
  
  <title>Redis - xhang&#39;s blog</title>

  <link  rel="stylesheet" href="https://lib.baomitu.com/twitter-bootstrap/4.6.1/css/bootstrap.min.css" />



  <link  rel="stylesheet" href="https://lib.baomitu.com/github-markdown-css/4.0.0/github-markdown.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/hint.css/2.7.0/hint.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/prism/1.29.0/plugins/line-numbers/prism-line-numbers.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.css" />



<!-- 主题依赖的图标库，不要自行修改 -->
<!-- Do not modify the link that theme dependent icons -->

<link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_hj8rtnfg7um.css">



<link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_lbnruvf0jn.css">


<link  rel="stylesheet" href="/css/main.css" />


  <link id="highlight-css" rel="stylesheet" href="/css/highlight.css" />
  
    <link id="highlight-css-dark" rel="stylesheet" href="/css/highlight-dark.css" />
  



  
<link rel="stylesheet" href="/css/iconfont.css">



  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    Fluid.ctx = Object.assign({}, Fluid.ctx)
    var CONFIG = {"hostname":"example.com","root":"/","version":"1.9.4","typing":{"enable":true,"typeSpeed":70,"cursorChar":"_","loop":false,"scope":[]},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"left","visible":"hover","icon":""},"progressbar":{"enable":true,"height_px":3,"color":"#29d","options":{"showSpinner":false,"trickleSpeed":100}},"code_language":{"enable":true,"default":"TEXT"},"copy_btn":true,"image_caption":{"enable":true},"image_zoom":{"enable":true,"img_url_replace":["",""]},"toc":{"enable":true,"placement":"right","headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":0},"lazyload":{"enable":true,"loading_img":"/img/loading.gif","onlypost":false,"offset_factor":2},"web_analytics":{"enable":true,"follow_dnt":true,"baidu":null,"google":null,"gtag":null,"tencent":{"sid":null,"cid":null},"woyaola":null,"cnzz":null,"leancloud":{"app_id":"giycfQfOF4KRyAqEJy6tocBG-gzGzoHsz","app_key":"eFPJSGrHpiDV2uq6UTxse15b","server_url":"https://giycfqfo.lc-cn-n1-shared.com","path":"window.location.pathname","ignore_local":false}},"search_path":"/local-search.xml"};

    if (CONFIG.web_analytics.follow_dnt) {
      var dntVal = navigator.doNotTrack || window.doNotTrack || navigator.msDoNotTrack;
      Fluid.ctx.dnt = dntVal && (dntVal.startsWith('1') || dntVal.startsWith('yes') || dntVal.startsWith('on'));
    }
  </script>
  <script  src="/js/utils.js" ></script>
  <script  src="/js/color-schema.js" ></script>
  

  

  

  

  

  

  

  
    
  



  
<meta name="generator" content="Hexo 6.3.0"></head>


<body>
  

  <header>
    

<div class="header-inner" style="height: 70vh;">
  <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand" href="/">
      <strong>xhang&#39;s blog</strong>
    </a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/">
                <i class="iconfont icon-home-fill"></i>
                <span>首页</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/">
                <i class="iconfont icon-archive-fill"></i>
                <span>归档</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/categories/">
                <i class="iconfont icon-category-fill"></i>
                <span>分类</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/tags/">
                <i class="iconfont icon-tags-fill"></i>
                <span>标签</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/">
                <i class="iconfont icon-user-fill"></i>
                <span>关于</span>
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search">
              <i class="iconfont icon-search"></i>
            </a>
          </li>
          
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" target="_self" href="javascript:;" aria-label="Color Toggle">
              <i class="iconfont icon-dark" id="color-toggle-icon"></i>
            </a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

  

<div id="banner" class="banner" parallax=true
     style="background: url('https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/hexo/index.png') no-repeat center center; background-size: cover;">
  <div class="full-bg-img">
    <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
      <div class="banner-text text-center fade-in-up">
        <div class="h2">
          
            <span id="subtitle" data-typed-text="Redis"></span>
          
        </div>

        
          
  <div class="mt-3">
    
      <span class="post-meta mr-2">
        <i class="iconfont icon-author" aria-hidden="true"></i>
        Xu huaiang
      </span>
    
    
      <span class="post-meta">
        <i class="iconfont icon-date-fill" aria-hidden="true"></i>
        <time datetime="2022-10-13 10:00" pubdate>
          2022年10月13日 上午
        </time>
      </span>
    
  </div>

  <div class="mt-1">
    
      <span class="post-meta mr-2">
        <i class="iconfont icon-chart"></i>
        
          97k 字
        
      </span>
    

    
      <span class="post-meta mr-2">
        <i class="iconfont icon-clock-fill"></i>
        
        
        
          807 分钟
        
      </span>
    

    
    
  </div>


        
      </div>

      
    </div>
  </div>
</div>

</div>

  </header>

  <main>
    
      

<div class="container-fluid nopadding-x">
  <div class="row nomargin-x">
    <div class="side-col d-none d-lg-block col-lg-2">
      

    </div>

    <div class="col-lg-8 nopadding-x-md">
      <div class="container nopadding-x-md" id="board-ctn">
        <div id="board">
          <article class="post-content mx-auto">
            <!-- SEO header -->
            <h1 style="display: none">Redis</h1>
            
            
              <div class="markdown-body">
                
                <p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20221101201859716.png" srcset="/img/loading.gif" lazyload alt="image-20221101201859716"></p>
<h1 id="1-场景引入"><a href="#1-场景引入" class="headerlink" title="1.场景引入"></a>1.场景引入</h1><p>Web1.0的时代，数据访问量很有限，用一夫当关的高性能的单点服务器可以解决大部分问题。</p>
<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20220921150953794.png" srcset="/img/loading.gif" lazyload alt="image-20220921150953794"></p>
<p>随着Web2.0的时代的到来，<font color='red'>用户访问量大幅度提升，同时产生了大量的用户数据</font>所有的互联网平台都面临了巨大的性能挑战。</p>
<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20220921151027644.png" srcset="/img/loading.gif" lazyload alt="image-20220921151027644"></p>
<p>解决CPU和内存压力的方案：</p>
<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20220921152839951.png" srcset="/img/loading.gif" lazyload alt="image-20220921152839951"></p>
<p>解决IO压力：&#x3D;&#x3D;减少IO操作&#x3D;&#x3D;</p>
<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20220921153119225.png" srcset="/img/loading.gif" lazyload alt="image-20220921153119225"></p>
<h1 id="2-NoSQL数据库"><a href="#2-NoSQL数据库" class="headerlink" title="2.NoSQL数据库"></a>2.NoSQL数据库</h1><h2 id="2-1NoSQL简介"><a href="#2-1NoSQL简介" class="headerlink" title="2.1NoSQL简介"></a>2.1NoSQL简介</h2><p>NoSQL(NoSQL &#x3D; <strong>Not Only SQL</strong> )，意即“<font color='red'>不仅仅是SQL</font>”，泛指&#x3D;&#x3D;非关系型的数据库&#x3D;&#x3D;。 </p>
<p><font color='cornflowerblue'>NoSQL 不依赖业务逻辑方式存储，而以简单的key-value模式存储。因此大大的增加了数据库的扩展能力。</font></p>
<p>特点：</p>
<ol>
<li>不遵循SQL标准</li>
<li>不支持ACID(<font color='red'>事务的四大特性：原子性、一致性、隔离性、持久性</font>)</li>
<li>远超于SQL性能</li>
</ol>
<h2 id="2-2NoSQL的适用场景"><a href="#2-2NoSQL的适用场景" class="headerlink" title="2.2NoSQL的适用场景"></a>2.2NoSQL的适用场景</h2><ol>
<li>&#x3D;&#x3D;对数据高并发的读写&#x3D;&#x3D;</li>
<li>&#x3D;&#x3D;海量数据的读写&#x3D;&#x3D;</li>
<li>&#x3D;&#x3D;对数据具有高扩展性&#x3D;&#x3D;</li>
</ol>
<h2 id="2-3NoSQL不适用的场景"><a href="#2-3NoSQL不适用的场景" class="headerlink" title="2.3NoSQL不适用的场景"></a>2.3NoSQL不适用的场景</h2><ol>
<li><font color='red'>需要事务支持</font></li>
<li><font color='red'>基于SQL的结构化查询存储，处理复杂的关系需要即席查询</font></li>
</ol>
<h2 id="2-4NoSQL数据库的意义"><a href="#2-4NoSQL数据库的意义" class="headerlink" title="2.4NoSQL数据库的意义"></a>2.4NoSQL数据库的意义</h2><p>&#x3D;&#x3D;NoSQL数据库打破了<font color='red'>传统关系型数据库以业务逻辑为依据的存储模式</font>，而是针对不同数据结构的类型、以性能为优先的存储方式。&#x3D;&#x3D;</p>
<h1 id="3-SQL与NoSQL的区别"><a href="#3-SQL与NoSQL的区别" class="headerlink" title="3.SQL与NoSQL的区别"></a>3.SQL与NoSQL的区别</h1><p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20220923123417310.png" srcset="/img/loading.gif" lazyload alt="image-20220923123417310"></p>
<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20220923123637675.png" srcset="/img/loading.gif" lazyload alt="image-20220923123637675"></p>
<h1 id="4-Redis简介"><a href="#4-Redis简介" class="headerlink" title="4.Redis简介"></a>4.Redis简介</h1><p>Redis是一个NoSQL数据库，其数据都在内存中，支持持久化，主要用作备份恢复。<font color='cornflowerblue'>除了支持简单的key-value模式，还支持多种数据结构的存储，比如 list、set、hash、zset等。</font>&#x3D;&#x3D;一般是作为缓存数据库辅助持久化的数据库&#x3D;&#x3D;</p>
<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20220921122545305.png" srcset="/img/loading.gif" lazyload alt="image-20220921122545305"></p>
<p>redis诞生小故事：</p>
<p>说起我的诞生，跟关系数据库MySQL还挺有渊源的。</p>
<p>在我还没来到这个世界上的时候，MySQL过的很辛苦，互联网发展的越来越快，<font color='red'>它容纳的数据也越来越多，用户请求也随之暴涨</font>，而每一个用户请求都变成了对它的一个又一个读写操作，MySQL是苦不堪言。尤其是到“双11”、“618“这种全民购物狂欢的日子，都是MySQL受苦受难的日子。</p>
<p><font color='red'>据后来MySQL告诉我说，其实有一大半的用户请求都是读操作，而且经常都是重复查询一个东西，浪费它很多时间去进行磁盘I&#x2F;O。</font></p>
<p>后来有人就琢磨，是不是可以学学CPU，给数据库也加一个缓存呢？于是我就诞生了！</p>
<p>出生不久，我就和MySQL成为了好朋友，我们俩常常携手出现在后端服务器中。</p>
<p><font color='cornflowerblue'>应用程序们从MySQL查询到的数据，在我这里登记一下，后面再需要用到的时候，就先找我要，我这里没有再找MySQL要。</font></p>
<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20220921122636427.png" srcset="/img/loading.gif" lazyload alt="image-20220921122636427"></p>
<h1 id="5-Redis的应用场景"><a href="#5-Redis的应用场景" class="headerlink" title="5.Redis的应用场景"></a>5.Redis的应用场景</h1><h2 id="5-1配合关系型数据库做高速缓存"><a href="#5-1配合关系型数据库做高速缓存" class="headerlink" title="5.1配合关系型数据库做高速缓存"></a>5.1配合关系型数据库做高速缓存</h2><ul>
<li><p><font color='red'>高频次，热门访问的数据，降低数据库IO</font></p>
</li>
<li><p><font color='red'>分布式架构，做session共享</font></p>
</li>
</ul>
<h2 id="5-2多样的数据结构存储持久化数据"><a href="#5-2多样的数据结构存储持久化数据" class="headerlink" title="5.2多样的数据结构存储持久化数据"></a>5.2多样的数据结构存储持久化数据</h2><p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20220921160622697.png" srcset="/img/loading.gif" lazyload alt="image-20220921160622697"></p>
<h1 id="6-Redis的安装、启动服务、关闭服务"><a href="#6-Redis的安装、启动服务、关闭服务" class="headerlink" title="6.Redis的安装、启动服务、关闭服务"></a>6.Redis的安装、启动服务、关闭服务</h1><h2 id="6-1Redis的安装"><a href="#6-1Redis的安装" class="headerlink" title="6.1Redis的安装"></a>6.1Redis的安装</h2><h3 id="6-1-1虚拟机环境搭建"><a href="#6-1-1虚拟机环境搭建" class="headerlink" title="6.1.1虚拟机环境搭建"></a>6.1.1虚拟机环境搭建</h3><p><a target="_blank" rel="noopener" href="https://redis.io/">Redis官网</a></p>
<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20220921160940417.png" srcset="/img/loading.gif" lazyload alt="image-20220921160940417"></p>
<p>下载可以发现是Linux版本</p>
<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20220921161124146.png" srcset="/img/loading.gif" lazyload alt="image-20220921161124146"></p>
<p><font color='red'>原因是因为Redis官方并不推荐在Windows系统下使用Redis。不用考虑在windows环境下对Redis的支持</font></p>
<p>一：创建Redis环境测试虚拟机</p>
<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20220921163357318.png" srcset="/img/loading.gif" lazyload alt="image-20220921163357318"></p>
<p>二：用Xshell连接虚拟机，首先在虚拟机中安装C语言的编译环境gcc</p>
<figure><div class="code-wrapper"><pre class="line-numbers language-none"><code class="language-none">yum install gcc<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></div></figure>

<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20220921171919243.png" srcset="/img/loading.gif" lazyload alt="image-20220921171919243"></p>
<p>查看gcc版本信息</p>
<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20220921172042175.png" srcset="/img/loading.gif" lazyload alt="image-20220921172042175"></p>
<h3 id="6-1-2解压安装包"><a href="#6-1-2解压安装包" class="headerlink" title="6.1.2解压安装包"></a>6.1.2解压安装包</h3><p>解压到&#x2F;opt目录下</p>
<p>注意：<font color='red'>opt目录对于所有用户没有写权限，所以在此目录下传输文件时需要更改权限</font></p>
<figure><div class="code-wrapper"><pre class="line-numbers language-none"><code class="language-none">chmod 777 文件名<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></div></figure>

<p>&#x3D;&#x3D;r w x 分别表示读权限、写权限、执行权限 用数字表示为 4 2 1&#x3D;&#x3D;</p>
<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20220921180911409.png" srcset="/img/loading.gif" lazyload alt="image-20220921180911409"></p>
<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20220921180652035.png" srcset="/img/loading.gif" lazyload alt="image-20220921180652035"></p>
<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20220921181442979.png" srcset="/img/loading.gif" lazyload alt="image-20220921181442979"></p>
<p>解压压缩文件：</p>
<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20220921181530982.png" srcset="/img/loading.gif" lazyload alt="image-20220921181530982"></p>
<p>进入解压好的文件中进行编译安装：</p>
<p>编译</p>
<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20220921181848156.png" srcset="/img/loading.gif" lazyload alt="image-20220921181848156"></p>
<p>安装：</p>
<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20220921182218339.png" srcset="/img/loading.gif" lazyload alt="image-20220921182218339"></p>
<p>redis的默认安装目录为：&#x2F;usr&#x2F;local&#x2F;bin&#x2F;</p>
<p>​		&#x3D;&#x3D;该目录下有redis服务端和redis客户端&#x3D;&#x3D;</p>
<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20220921182345368.png" srcset="/img/loading.gif" lazyload alt="image-20220921182345368"></p>
<h2 id="6-2后台启动Redis服务"><a href="#6-2后台启动Redis服务" class="headerlink" title="6.2后台启动Redis服务"></a>6.2后台启动Redis服务</h2><p>切换到root用户下进入到redis文件目录下</p>
<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20220921183410578.png" srcset="/img/loading.gif" lazyload alt="image-20220921183410578"></p>
<p>复制redis.conf文件到etc目录下</p>
<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20220921183658970.png" srcset="/img/loading.gif" lazyload alt="image-20220921183658970"></p>
<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20220921183737421.png" srcset="/img/loading.gif" lazyload alt="image-20220921183737421"></p>
<p>&#x3D;&#x3D;一：修改redis.conf(128行)文件将里面的daemonize no 改成 yes，让服务在后台启动&#x3D;&#x3D;</p>
<p>​		采用vim编辑器中的搜索模式进行搜索(<font color='red'>正斜线进行搜索模式</font>)</p>
<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20220921184555187.png" srcset="/img/loading.gif" lazyload alt="image-20220921184555187"></p>
<p>&#x3D;&#x3D;二：修改监听地址：默认是127.0.0.1，只有在本机才能访问，现在<font color='red'>测试环境</font>修改为0.0.0.0，即任何ip都能够访问，生产环境下不能修改&#x3D;&#x3D;</p>
<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20220923125427229.png" srcset="/img/loading.gif" lazyload alt="image-20220923125427229"></p>
<p>&#x3D;&#x3D;三：设置redis密码&#x3D;&#x3D;</p>
<blockquote>
<p>命令：config set requirepass 密码</p>
</blockquote>
<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20220923125621732.png" srcset="/img/loading.gif" lazyload alt="image-20220923125621732"></p>
<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20220923131044399.png" srcset="/img/loading.gif" lazyload alt="image-20220923131044399"></p>
<p>启动redis服务</p>
<figure><div class="code-wrapper"><pre class="line-numbers language-none"><code class="language-none">redis-server &#x2F;etc&#x2F;redis.conf<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></div></figure>

<p>查看redis服务</p>
<figure><div class="code-wrapper"><pre class="line-numbers language-none"><code class="language-none">ps -ef | grep redis<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></div></figure>

<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20220921184920428.png" srcset="/img/loading.gif" lazyload alt="image-20220921184920428"></p>
<h2 id="6-3-redis客户端连接到redis服务"><a href="#6-3-redis客户端连接到redis服务" class="headerlink" title="6.3.redis客户端连接到redis服务"></a>6.3.redis客户端连接到redis服务</h2><figure><div class="code-wrapper"><pre class="line-numbers language-none"><code class="language-none">redis-cli<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></div></figure>

<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20220921185413243.png" srcset="/img/loading.gif" lazyload alt="image-20220921185413243"></p>
<p><font color='cornflowerblue'>可以看到已经连接到了redis服务，redis服务在虚拟机的6379端口运行</font></p>
<h2 id="6-4关闭Redis服务"><a href="#6-4关闭Redis服务" class="headerlink" title="6.4关闭Redis服务"></a>6.4关闭Redis服务</h2><p><font color='orange'>一：单实例关闭</font></p>
<figure><div class="code-wrapper"><pre class="line-numbers language-none"><code class="language-none">redis-cli shutdown<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></div></figure>

<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20220921190111532.png" srcset="/img/loading.gif" lazyload alt="image-20220921190111532"></p>
<p><font color='orange'>二：客户端连接后进行关闭</font></p>
<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20220921190312593.png" srcset="/img/loading.gif" lazyload alt="image-20220921190312593"></p>
<h1 id="7-单线程-IO多路复用机制"><a href="#7-单线程-IO多路复用机制" class="headerlink" title="7.单线程+IO多路复用机制"></a>7.单线程+IO多路复用机制</h1><p><strong>「为了让单线的服务端应用同时处理多个客户端的事件，Redis 采用了 IO 多路复用机制。」</strong></p>
<p>&#x3D;&#x3D;<strong>多路</strong>【<font color='red'>指的是多个网络连接客户端</font>】&#x3D;&#x3D;</p>
<p>&#x3D;&#x3D;<strong>复用</strong>【<font color='red'>指的是复用同一个线程</font>】&#x3D;&#x3D;</p>
<p>多路复用是指<font color='cornflowerblue'>使用一个线程来检查多个文件描述符（Socket）的就绪状态</font>，比如调用select和poll函数，<font color='cornflowerblue'>传入多个文件描述符，如果有一个文件描述符就绪，则返回，否则阻塞直到超时</font>。得到就绪状态后进行真正的操作可以在同一个线程里执行，也可以启动线程执行（比如使用线程池）</p>
<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20220921202301783.png" srcset="/img/loading.gif" lazyload alt="image-20220921202301783"></p>
<h1 id="8-Redis的常用操作-基于key"><a href="#8-Redis的常用操作-基于key" class="headerlink" title="8.Redis的常用操作(基于key)"></a>8.Redis的常用操作(基于key)</h1><table>
<thead>
<tr>
<th>命令</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>keys *</td>
<td>查看当前库所有key</td>
</tr>
<tr>
<td>exists key</td>
<td>判断某个key是否存在</td>
</tr>
<tr>
<td>type key</td>
<td>查看你的key是什么类型</td>
</tr>
<tr>
<td>del key</td>
<td>删除指定的key数据</td>
</tr>
<tr>
<td>unlink key</td>
<td>根据value选择非阻塞删除（<font color='red'>提示已经删除，但其实并没有删除，在后续会删除</font>）</td>
</tr>
<tr>
<td>expire key 数字</td>
<td>数字的单位为正整数，表示秒，为给定的key设置过期时间</td>
</tr>
<tr>
<td>ttl key</td>
<td>查看还有多少秒过期，<font color='red'>-1表示永不过期，-2表示已过期</font></td>
</tr>
<tr>
<td>select [0-15]</td>
<td>切换数据库，一共有16个</td>
</tr>
<tr>
<td>dbsize</td>
<td>查看当前数据库的key的数量</td>
</tr>
<tr>
<td>flushdb</td>
<td>清空当前库</td>
</tr>
<tr>
<td>flushall</td>
<td>通杀全部库</td>
</tr>
</tbody></table>
<p>可以采用help命令查看相关命令的使用方式：</p>
<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20220923132348191.png" srcset="/img/loading.gif" lazyload alt="image-20220923132348191"></p>
<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20220923132442740.png" srcset="/img/loading.gif" lazyload alt="image-20220923132442740"></p>
<p>&#x3D;&#x3D;<strong>一：查看当前库中的所有key</strong>&#x3D;&#x3D;</p>
<p>语法：</p>
<figure><div class="code-wrapper"><pre class="line-numbers language-none"><code class="language-none">keys *<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></div></figure>



<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20220921205404850.png" srcset="/img/loading.gif" lazyload alt="image-20220921205404850"></p>
<p>&#x3D;&#x3D;<strong>二：判断某个key是否存在</strong>&#x3D;&#x3D;</p>
<p>语法：</p>
<figure><div class="code-wrapper"><pre class="line-numbers language-none"><code class="language-none">exists key<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></div></figure>

<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20220921205637538.png" srcset="/img/loading.gif" lazyload alt="image-20220921205637538"></p>
<p>&#x3D;&#x3D;<strong>三：查看key的类型</strong>&#x3D;&#x3D;</p>
<p>语法：</p>
<figure><div class="code-wrapper"><pre class="line-numbers language-none"><code class="language-none">type key<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></div></figure>



<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20220921205822918.png" srcset="/img/loading.gif" lazyload alt="image-20220921205822918"></p>
<p>&#x3D;&#x3D;<strong>四：删除指定的key数据</strong>&#x3D;&#x3D;</p>
<p>语法：</p>
<figure><div class="code-wrapper"><pre class="line-numbers language-none"><code class="language-none">del key<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></div></figure>

<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20220921205958787.png" srcset="/img/loading.gif" lazyload alt="image-20220921205958787"></p>
<p>&#x3D;&#x3D;<strong>五：设置key的过期时间，查看还有多少秒过期</strong>&#x3D;&#x3D;</p>
<p>语法：</p>
<p>设置过期时间</p>
<figure><div class="code-wrapper"><pre class="line-numbers language-none"><code class="language-none">empire key 数字<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></div></figure>

<p>查看还有多少秒过期</p>
<figure><div class="code-wrapper"><pre class="line-numbers language-none"><code class="language-none">ttl key<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></div></figure>



<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20220921210708008.png" srcset="/img/loading.gif" lazyload alt="image-20220921210708008"></p>
<p>&#x3D;&#x3D;<strong>六：切换不同的数据库</strong>&#x3D;&#x3D;</p>
<p>语法：</p>
<figure><div class="code-wrapper"><pre class="line-numbers language-none"><code class="language-none">select [0-15]<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></div></figure>



<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20220921211104375.png" srcset="/img/loading.gif" lazyload alt="image-20220921211104375"></p>
<p>&#x3D;&#x3D;<strong>七：查看当前数据库的key的数量</strong>&#x3D;&#x3D;</p>
<p>语法：</p>
<figure><div class="code-wrapper"><pre class="line-numbers language-none"><code class="language-none">dbsize<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></div></figure>

<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20220921211250159.png" srcset="/img/loading.gif" lazyload alt="image-20220921211250159"></p>
<h1 id="9-key的层级结构"><a href="#9-key的层级结构" class="headerlink" title="9.key的层级结构"></a>9.key的层级结构</h1><p>Redis的key允许有多个单词形成层级结构，多个单词之间用’:’隔开，格式如下：</p>
<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20220923133608343.png" srcset="/img/loading.gif" lazyload alt="image-20220923133608343"></p>
<p>这个格式并非固定，也可以根据自己的需求来删除或添加词条。</p>
<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20220923133826528.png" srcset="/img/loading.gif" lazyload alt="image-20220923133826528"></p>
<p>如果Value是一个Java对象，例如一个User对象，<font color='red'>则可以将对象序列化为JSON字符串后存储：</font></p>
<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20220923133705602.png" srcset="/img/loading.gif" lazyload alt="image-20220923133705602"></p>
<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20220923134450203.png" srcset="/img/loading.gif" lazyload alt="image-20220923134450203"></p>
<h1 id="10-常用数据类型"><a href="#10-常用数据类型" class="headerlink" title="10.常用数据类型"></a>10.常用数据类型</h1><h2 id="10-1String字符串"><a href="#10-1String字符串" class="headerlink" title="10.1String字符串"></a>10.1String字符串</h2><h3 id="10-1-1String说明"><a href="#10-1-1String说明" class="headerlink" title="10.1.1String说明"></a>10.1.1String说明</h3><ol>
<li><p><font color='red'>String是Redis最基本的类型，一个key对应一个value。</font></p>
</li>
<li><p>String类型是&#x3D;&#x3D;二进制安全的&#x3D;&#x3D;。<font color='red'>意味着Redis的string可以包含任何数据。比如jpg图片或者序列化的对象。</font></p>
</li>
<li><p>String类型是Redis最基本的数据类型，<font color='red'>一个Redis中字符串value最多可以是512M</font></p>
</li>
</ol>
<h3 id="10-1-2String的常用命令"><a href="#10-1-2String的常用命令" class="headerlink" title="10.1.2String的常用命令"></a>10.1.2String的常用命令</h3><table>
<thead>
<tr>
<th></th>
<th></th>
</tr>
</thead>
<tbody><tr>
<td>set  key value</td>
<td>添加键值对</td>
</tr>
<tr>
<td>get key</td>
<td>根据key获取到value</td>
</tr>
<tr>
<td>append key value</td>
<td>将给定的value追加到key原值的末尾</td>
</tr>
<tr>
<td>strlen key</td>
<td>获得值的长度</td>
</tr>
<tr>
<td>setnx key value</td>
<td>只有在 key 不存在时  设置 key 的值</td>
</tr>
<tr>
<td>incr&#x2F;decr key</td>
<td>让数字类型加1&#x2F;减1</td>
</tr>
<tr>
<td>incrby&#x2F;decrby key step</td>
<td>指定步长，让数字类型加步长&#x2F;减步长</td>
</tr>
<tr>
<td>mset key1 value1 key2 value2 …</td>
<td>同时设置一个或多个 key-value对</td>
</tr>
<tr>
<td>mget key1 key2 …</td>
<td>同时获取一个或多个 value</td>
</tr>
<tr>
<td>msetnx key1 value1 key2 value2 …</td>
<td>同时设置一个或多个 key-value对(<font color='red'>具有原子性，如果有一个已经存在则全部都会失败</font>)</td>
</tr>
<tr>
<td>getrange key start end</td>
<td>获取从start开始，到end结束的字符串片段</td>
</tr>
<tr>
<td>setrange key start value</td>
<td>用 value 参数覆写给定 key 所储存的字符串值，从偏移量 start开始。</td>
</tr>
<tr>
<td>setex key 过期时间 value</td>
<td><font color='red'>设置值的同时设置过期时间</font></td>
</tr>
<tr>
<td>getset key value</td>
<td>获取旧值的同时设置新值</td>
</tr>
</tbody></table>
<p>&#x3D;&#x3D;<strong>一：添加键值对</strong>&#x3D;&#x3D;</p>
<p>语法：</p>
<figure><div class="code-wrapper"><pre class="line-numbers language-none"><code class="language-none">set key value<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></div></figure>



<p>&#x3D;&#x3D;<strong>二：根据键来获取值</strong>&#x3D;&#x3D;</p>
<p>语法：</p>
<figure><div class="code-wrapper"><pre class="line-numbers language-none"><code class="language-none">get key<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></div></figure>



<p>&#x3D;&#x3D;<strong>三：将给定的value追加到key原值的末尾</strong>&#x3D;&#x3D;</p>
<p>语法：</p>
<figure><div class="code-wrapper"><pre class="line-numbers language-none"><code class="language-none">append key value<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></div></figure>

<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20220921212655790.png" srcset="/img/loading.gif" lazyload alt="image-20220921212655790"></p>
<p>&#x3D;&#x3D;<strong>四：获得值的长度</strong>&#x3D;&#x3D;</p>
<p>语法：</p>
<figure><div class="code-wrapper"><pre class="line-numbers language-none"><code class="language-none">strlen key <span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></div></figure>

<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20220921213008216.png" srcset="/img/loading.gif" lazyload alt="image-20220921213008216"></p>
<p>&#x3D;&#x3D;<strong>五：只有在 key 不存在时  设置 key 的值</strong>&#x3D;&#x3D;</p>
<p>语法：</p>
<figure><div class="code-wrapper"><pre class="line-numbers language-none"><code class="language-none">setnx key value<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></div></figure>

<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20220921213528307.png" srcset="/img/loading.gif" lazyload alt="image-20220921213528307"></p>
<p>&#x3D;&#x3D;<strong>六：让数字类型加1&#x2F;减1</strong>&#x3D;&#x3D;</p>
<p>语法：</p>
<figure><div class="code-wrapper"><pre class="line-numbers language-none"><code class="language-none">incr&#x2F;decr key<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></div></figure>

<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20220921214045393.png" srcset="/img/loading.gif" lazyload alt="image-20220921214045393"></p>
<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20220921214128479.png" srcset="/img/loading.gif" lazyload alt="image-20220921214128479"></p>
<p>&#x3D;&#x3D;<strong>七：让数字类型按照步长加&#x2F;减</strong>&#x3D;&#x3D;</p>
<p>语法：</p>
<figure><div class="code-wrapper"><pre class="line-numbers language-none"><code class="language-none">incrby&#x2F;decrby key 步长<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></div></figure>

<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20220921214610353.png" srcset="/img/loading.gif" lazyload alt="image-20220921214610353"></p>
<p>其中数字类型的增加或减小是原子操作，即&#x3D;&#x3D;原子性&#x3D;&#x3D;</p>
<p><font color='red'>原子性就是不会被进程调度所影响的操作</font></p>
<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20220921222310659.png" srcset="/img/loading.gif" lazyload alt="image-20220921222310659"></p>
<p>&#x3D;&#x3D;<strong>八：同时设置一个或多个 key-value对</strong>&#x3D;&#x3D;</p>
<p>语法：</p>
<figure><div class="code-wrapper"><pre class="line-numbers language-none"><code class="language-none">mset key1 value1 key2 value2 ...<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></div></figure>

<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20220921222726017.png" srcset="/img/loading.gif" lazyload alt="image-20220921222726017"></p>
<p>&#x3D;&#x3D;<strong>九：同时获取一个或多个 value</strong>&#x3D;&#x3D;</p>
<p>语法：</p>
<figure><div class="code-wrapper"><pre class="line-numbers language-none"><code class="language-none">mget key1 key2 ...<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></div></figure>

<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20220921222726996.png" srcset="/img/loading.gif" lazyload alt="image-20220921222726996"></p>
<p>&#x3D;&#x3D;<strong>十：获取到字符串片段</strong>&#x3D;&#x3D;</p>
<p>语法：</p>
<figure><div class="code-wrapper"><pre class="line-numbers language-none"><code class="language-none">getrange key start end<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></div></figure>



<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20220921223239326.png" srcset="/img/loading.gif" lazyload alt="image-20220921223239326"></p>
<p>&#x3D;&#x3D;<strong>十一：替换掉指定的字符串片段</strong>&#x3D;&#x3D;</p>
<p>语法：</p>
<figure><div class="code-wrapper"><pre class="line-numbers language-none"><code class="language-none">setrange key start value<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></div></figure>



<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20220921224301569.png" srcset="/img/loading.gif" lazyload alt="image-20220921224301569"></p>
<p>&#x3D;&#x3D;<strong>十二：设置值的同时设置过期时间</strong>&#x3D;&#x3D;</p>
<p>语法：</p>
<figure><div class="code-wrapper"><pre class="line-numbers language-none"><code class="language-none">setex key 过期时间 value<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></div></figure>

<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20220921224943874.png" srcset="/img/loading.gif" lazyload alt="image-20220921224943874"></p>
<p>&#x3D;&#x3D;<strong>十三：获取旧值的同时设置新值</strong>&#x3D;&#x3D;</p>
<p>语法：</p>
<figure><div class="code-wrapper"><pre class="line-numbers language-none"><code class="language-none">getset key value<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></div></figure>

<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20220921225305593.png" srcset="/img/loading.gif" lazyload alt="image-20220921225305593"></p>
<h3 id="10-1-3String的数据结构"><a href="#10-1-3String的数据结构" class="headerlink" title="10.1.3String的数据结构"></a>10.1.3String的数据结构</h3><p>String的数据结构为&#x3D;&#x3D;简单动态字符串&#x3D;&#x3D;(Sample Dynamic Sting)。<font color='red'>是可以修改的字符串，内部结构实现上类似于Java的ArrayList，采用预分配冗余空间的方式来减少内存的频繁分配.</font></p>
<p>​           <img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20220921225618540.png" srcset="/img/loading.gif" lazyload alt="image-20220921225618540">                    </p>
<p><font color='cornflowerblue'>如图中所示，内部为当前字符串实际分配的空间capacity一般要高于实际字符串长度len。当字符串长度小于1M时，扩容都是加倍现有的空间，如果超过1M，扩容时一次只会多扩1M的空间。需要注意的是字符串最大长度为512M。</font></p>
<h2 id="10-2List列表"><a href="#10-2List列表" class="headerlink" title="10.2List列表"></a>10.2List列表</h2><h3 id="10-2-1List列表说明"><a href="#10-2-1List列表说明" class="headerlink" title="10.2.1List列表说明"></a>10.2.1List列表说明</h3><p>List的数据存储形式为：&#x3D;&#x3D;单键多值&#x3D;&#x3D;</p>
<p>Redis 列表是简单的字符串列表，按照插入顺序排序<font color='red'>。你可以添加一个元素到列表的头部（左边）或者尾部（右边）。</font></p>
<p><font color='red'>它的底层实际是个双向链表，对两端的操作性能很高，通过索引下标的操作中间的节点性能会较差。</font></p>
<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20220922084705655.png" srcset="/img/loading.gif" lazyload alt="image-20220922084705655"></p>
<h3 id="10-2-2List列表的常用命令"><a href="#10-2-2List列表的常用命令" class="headerlink" title="10.2.2List列表的常用命令"></a>10.2.2List列表的常用命令</h3><table>
<thead>
<tr>
<th>命令</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>lpush&#x2F;rpush key value1 value2  value3 ….</td>
<td>从左边&#x2F;右边插入一个或多个值</td>
</tr>
<tr>
<td>lpop&#x2F;rpop key</td>
<td>从左边&#x2F;右边移除一个值</td>
</tr>
<tr>
<td>rpoplpush  key1 key2</td>
<td>从key1列表右边移出一个值，插到key2列表左边</td>
</tr>
<tr>
<td>lrange  key start end</td>
<td>按照start开始，end结束的索引下标获得元素(从左到右)</td>
</tr>
<tr>
<td>lrange key 0 -1</td>
<td>0左边第一个，-1右边第一个，（0-1表示获取所有）</td>
</tr>
<tr>
<td>lindex  key index</td>
<td>按照索引下标获得元素(从左到右)</td>
</tr>
<tr>
<td>llen key</td>
<td>获得列表长度</td>
</tr>
<tr>
<td>linsert key  before&#x2F;after  value newvalue</td>
<td>在value的前面&#x2F;后面插入newvalue</td>
</tr>
<tr>
<td>lrem key n value</td>
<td>从左边删除n个value(从左到右)</td>
</tr>
<tr>
<td>lset key index value</td>
<td>将列表key下标为index的值替换成value</td>
</tr>
</tbody></table>
<p>&#x3D;&#x3D;<strong>一：从左边&#x2F;右边插入一个或多个值</strong>&#x3D;&#x3D;</p>
<p>语法：</p>
<figure><div class="code-wrapper"><pre class="line-numbers language-none"><code class="language-none">lpush&#x2F;rpush key value1 value2  value3 ....<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></div></figure>

<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20220922090422287.png" srcset="/img/loading.gif" lazyload alt="image-20220922090422287"></p>
<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20220922090543673.png" srcset="/img/loading.gif" lazyload alt="image-20220922090543673"></p>
<p>&#x3D;&#x3D;<strong>二：从左边&#x2F;右边移除一个值</strong>&#x3D;&#x3D;</p>
<p>语法：</p>
<figure><div class="code-wrapper"><pre class="line-numbers language-none"><code class="language-none">lpop&#x2F;rpop key<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></div></figure>

<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20220922090730797.png" srcset="/img/loading.gif" lazyload alt="image-20220922090730797"></p>
<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20220922090815743.png" srcset="/img/loading.gif" lazyload alt="image-20220922090815743"></p>
<p>&#x3D;&#x3D;<strong>三：从key1列表右边移出一个值，插到key2列表左边</strong>&#x3D;&#x3D;</p>
<p>语法：</p>
<figure><div class="code-wrapper"><pre class="line-numbers language-none"><code class="language-none">rpoplpush key1 key2<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></div></figure>

<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20220922091850731.png" srcset="/img/loading.gif" lazyload alt="image-20220922091850731"></p>
<p>&#x3D;&#x3D;<strong>四：按照start开始，end结束的索引下标获得元素(从左到右)</strong>&#x3D;&#x3D;</p>
<p>语法：</p>
<figure><div class="code-wrapper"><pre class="line-numbers language-none"><code class="language-none">lrange key start end<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></div></figure>

<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20220922092122437.png" srcset="/img/loading.gif" lazyload alt="image-20220922092122437"></p>
<p>&#x3D;&#x3D;<strong>五：按照索引下标获得元素</strong>&#x3D;&#x3D;</p>
<p>语法：</p>
<figure><div class="code-wrapper"><pre class="line-numbers language-none"><code class="language-none">lindex key index<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></div></figure>

<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20220922092414387.png" srcset="/img/loading.gif" lazyload alt="image-20220922092414387"></p>
<p>&#x3D;&#x3D;<strong>六：获取到列表长度</strong>&#x3D;&#x3D;</p>
<p>语法：</p>
<figure><div class="code-wrapper"><pre class="line-numbers language-none"><code class="language-none">llen key<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></div></figure>

<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20220922092516196.png" srcset="/img/loading.gif" lazyload alt="image-20220922092516196"></p>
<p>&#x3D;&#x3D;<strong>七：在value的前面&#x2F;后面插入newvalue</strong>&#x3D;&#x3D;</p>
<p>语法：</p>
<figure><div class="code-wrapper"><pre class="line-numbers language-none"><code class="language-none">linsert key  before&#x2F;after  value newvalue<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></div></figure>

<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20220922092816102.png" srcset="/img/loading.gif" lazyload alt="image-20220922092816102"></p>
<p>&#x3D;&#x3D;<strong>八：从左边删除n个值</strong>&#x3D;&#x3D;</p>
<p>语法：</p>
<figure><div class="code-wrapper"><pre class="line-numbers language-none"><code class="language-none">lrem key n value<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></div></figure>

<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20220922093540725.png" srcset="/img/loading.gif" lazyload alt="image-20220922093540725"></p>
<p>&#x3D;&#x3D;<strong>九：将列表key下标为index的值替换成value</strong>&#x3D;&#x3D;</p>
<p>语法：</p>
<figure><div class="code-wrapper"><pre class="line-numbers language-none"><code class="language-none">lset key index value<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></div></figure>



<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20220922094055880.png" srcset="/img/loading.gif" lazyload alt="image-20220922094055880"></p>
<h3 id="10-2-3List列表的数据结构"><a href="#10-2-3List列表的数据结构" class="headerlink" title="10.2.3List列表的数据结构"></a>10.2.3List列表的数据结构</h3><p>List的数据结构为&#x3D;&#x3D;快速链表quickList&#x3D;&#x3D;。</p>
<p>首先<font color='red'>在列表元素较少的情况下会使用一块连续的内存存储，这个结构是ziplist，也即是压缩列表。</font>它将所有的元素紧挨着一起存储，分配的是一块连续的内存。</p>
<p><font color='red'>当数据量比较多的时候才会改成quicklist。</font></p>
<p>因为普通的链表需要的附加指针空间太大，会比较浪费空间。比如这个列表里存的只是int类型的数据，结构上还需要两个额外的指针prev和next。</p>
<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20220922094207348.png" srcset="/img/loading.gif" lazyload alt="image-20220922094207348"></p>
<p><font color='cornflowerblue'>Redis将链表和ziplist结合起来组成了quicklist。也就是将多个ziplist使用双向指针串起来使用。这样既满足了快速的插入删除性能，又不会出现太大的空间冗余。</font></p>
<h2 id="10-3Set集合"><a href="#10-3Set集合" class="headerlink" title="10.3Set集合"></a>10.3Set集合</h2><h3 id="10-3-1Set集合说明"><a href="#10-3-1Set集合说明" class="headerlink" title="10.3.1Set集合说明"></a>10.3.1Set集合说明</h3><p>Redis set对外提供的功能与list类似是一个列表的功能，<font color='cornflowerblue'>特殊之处在于set中的元素是可以<strong>自动排重，且无序</strong></font>，<font color='red'>当你需要存储一个列表数据，又不希望出现重复数据时，set是一个很好的选择，并且set提供了判断某个成员是否在一个set集合内的重要接口，这个也是list所不能提供的。</font></p>
<p>Redis的Set是string类型的无序集合。它底层其实是一个value为null的hash表，所以添加，删除，查找的**复杂度都是O(1)**。</p>
<p>一个算法，随着数据的增加，执行时间的长短，如果是O(1)，数据增加，查找数据的时间不变</p>
<h3 id="10-3-2Set集合的常用命令"><a href="#10-3-2Set集合的常用命令" class="headerlink" title="10.3.2Set集合的常用命令"></a>10.3.2Set集合的常用命令</h3><table>
<thead>
<tr>
<th>命令</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>sadd key value1 value2</td>
<td>将一个或多个 元素加入到集合 key 中，已经存在的元素将被忽略</td>
</tr>
<tr>
<td>smembers  key</td>
<td>取出该集合的所有值</td>
</tr>
<tr>
<td>sismember  key value</td>
<td>判断集合key是否为含有该value值，有1，没有0</td>
</tr>
<tr>
<td>scard key</td>
<td>返回该集合的元素个数</td>
</tr>
<tr>
<td>srem  key value1 value2</td>
<td><font color='red'>删除集合中的一个或多个元素</font></td>
</tr>
<tr>
<td>spop  key</td>
<td>随机移除集合中的某个元素</td>
</tr>
<tr>
<td>srandmember  key n</td>
<td>随机从该集合中取出n个值。不会从集合中删除</td>
</tr>
<tr>
<td>smove key1 key2 value</td>
<td><font color='cornflowerblue'>把集合中一个值从一个集合移动到另一个集合</font></td>
</tr>
<tr>
<td>sinter  key1 key2</td>
<td>返回两个集合的交集元素</td>
</tr>
<tr>
<td>sunion  key1 key2</td>
<td>返回两个集合的并集元素</td>
</tr>
<tr>
<td>sdiff key1 key2</td>
<td>返回两个集合的<strong>差集</strong>元素(key1中的，不包含key2中的)</td>
</tr>
</tbody></table>
<p>&#x3D;&#x3D;<strong>一：将一个元素或者多个元素添加到集合中</strong>&#x3D;&#x3D;</p>
<p>语法：</p>
<figure><div class="code-wrapper"><pre class="line-numbers language-none"><code class="language-none">sadd username value1 value2...<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></div></figure>



<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20220922100849935.png" srcset="/img/loading.gif" lazyload alt="image-20220922100849935"></p>
<p>&#x3D;&#x3D;<strong>二：取出该集合的所有值</strong>&#x3D;&#x3D;</p>
<p>语法：</p>
<figure><div class="code-wrapper"><pre class="line-numbers language-none"><code class="language-none">smembers key<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></div></figure>

<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20220922101005317.png" srcset="/img/loading.gif" lazyload alt="image-20220922101005317"></p>
<p>&#x3D;&#x3D;<strong>三：判断集合key是否为含有该value值，有1，没有0</strong>&#x3D;&#x3D;</p>
<p>语法：</p>
<figure><div class="code-wrapper"><pre class="line-numbers language-none"><code class="language-none">sismember key valus<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></div></figure>

<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20220922101105776.png" srcset="/img/loading.gif" lazyload alt="image-20220922101105776"></p>
<p>&#x3D;&#x3D;<strong>四：返回该集合的元素个数</strong>&#x3D;&#x3D;</p>
<p>语法：</p>
<figure><div class="code-wrapper"><pre class="line-numbers language-none"><code class="language-none">scard key<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></div></figure>

<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20220922101157959.png" srcset="/img/loading.gif" lazyload alt="image-20220922101157959"></p>
<p>&#x3D;&#x3D;<strong>五：删除集合中的一个或多个元素</strong>&#x3D;&#x3D;</p>
<p>语法：</p>
<figure><div class="code-wrapper"><pre class="line-numbers language-none"><code class="language-none">scrm key value1 value2...<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></div></figure>

<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20220922101335675.png" srcset="/img/loading.gif" lazyload alt="image-20220922101335675"></p>
<p>&#x3D;&#x3D;<strong>六：随机移除集合中的某个元素</strong>&#x3D;&#x3D;</p>
<p>语法：</p>
<figure><div class="code-wrapper"><pre class="line-numbers language-none"><code class="language-none">spop  key<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></div></figure>

<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20220922101626152.png" srcset="/img/loading.gif" lazyload alt="image-20220922101626152"></p>
<p>&#x3D;&#x3D;<strong>七：随机从该集合中取出n个值。不会从集合中删除</strong>&#x3D;&#x3D;</p>
<p>语法：</p>
<figure><div class="code-wrapper"><pre class="line-numbers language-none"><code class="language-none">srandmember key<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></div></figure>

<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20220922101848030.png" srcset="/img/loading.gif" lazyload alt="image-20220922101848030"></p>
<p>&#x3D;&#x3D;<strong>八：把集合中一个值从一个集合移动到另一个集合</strong>&#x3D;&#x3D;</p>
<p>语法：</p>
<figure><div class="code-wrapper"><pre class="line-numbers language-none"><code class="language-none">smove key1 key2 value<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></div></figure>

<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20220922102616025.png" srcset="/img/loading.gif" lazyload alt="image-20220922102616025"></p>
<p>&#x3D;&#x3D;<strong>九：返回两个集合的交集元素</strong>&#x3D;&#x3D;</p>
<p>语法：</p>
<figure><div class="code-wrapper"><pre class="line-numbers language-none"><code class="language-none">sinter key1 key2<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></div></figure>

<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20220922103108657.png" srcset="/img/loading.gif" lazyload alt="image-20220922103108657"></p>
<p>&#x3D;&#x3D;<strong>十：返回两个集合的并集元素</strong>&#x3D;&#x3D;</p>
<p>语法：</p>
<figure><div class="code-wrapper"><pre class="line-numbers language-none"><code class="language-none">sunion key1 key2<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></div></figure>

<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20220922103233401.png" srcset="/img/loading.gif" lazyload alt="image-20220922103233401"></p>
<p>&#x3D;&#x3D;<strong>十一：返回两个集合的差集元素</strong>&#x3D;&#x3D;</p>
<p>语法：</p>
<figure><div class="code-wrapper"><pre class="line-numbers language-none"><code class="language-none">sdiff key1 key2<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></div></figure>

<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20220922103520310.png" srcset="/img/loading.gif" lazyload alt="image-20220922103520310"></p>
<h3 id="10-3-3Set集合的数据结构"><a href="#10-3-3Set集合的数据结构" class="headerlink" title="10.3.3Set集合的数据结构"></a>10.3.3Set集合的数据结构</h3><p><font color='red'>Set数据结构是dict字典，字典是用哈希表实现的。</font></p>
<p>Java中HashSet的内部实现使用的是HashMap，只不过所有的value都指向同一个对象。Redis的set结构也是一样，它的内部也使用hash结构，所有的value都指向同一个内部值。</p>
<h2 id="10-4Hash哈希"><a href="#10-4Hash哈希" class="headerlink" title="10.4Hash哈希"></a>10.4Hash哈希</h2><h3 id="10-4-1Hash哈希说明"><a href="#10-4-1Hash哈希说明" class="headerlink" title="10.4.1Hash哈希说明"></a>10.4.1Hash哈希说明</h3><p>Redis hash 是一个键值对集合。</p>
<p>&#x3D;&#x3D;Redis hash是一个string类型的field和value的映射表，hash特别适合用于存储对象。&#x3D;&#x3D;</p>
<p><font color='red'>类似Java里面的Map&lt;String,Object&gt;</font></p>
<p>用户ID为查找的key，存储的value用户对象包含姓名，年龄，生日等信息，如果用普通的key&#x2F;value结构来存储</p>
<p>主要有以下2种存储方式：</p>
<p>方式1：</p>
<p>​	<font color='red'>	每次修改用户的某个属性需要先反序列化改好后再序列化回去。开销较大。</font></p>
<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20220922104429455.png" srcset="/img/loading.gif" lazyload alt="image-20220922104429455"></p>
<p>方式2：</p>
<p>​	<font color='red'>	用户ID数据冗余</font></p>
<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20220922104541113.png" srcset="/img/loading.gif" lazyload alt="image-20220922104541113"></p>
<p>采用Hash的方式进行实现：</p>
<p><strong>通过 key(用户ID) + field(属性标签) 就可以操作对应属性数据了，既不需要重复存储数据，也不会带来序列化和并发修改控制的问题</strong></p>
<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20220923134750385.png" srcset="/img/loading.gif" lazyload alt="image-20220923134750385"></p>
<h3 id="10-4-2Hash哈希的常用命令"><a href="#10-4-2Hash哈希的常用命令" class="headerlink" title="10.4.2Hash哈希的常用命令"></a>10.4.2Hash哈希的常用命令</h3><table>
<thead>
<tr>
<th>命令</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>hset <key><field><value></td>
<td>给<key>集合中的 <field>键赋值<value></td>
</tr>
<tr>
<td>hget <key> <field></td>
<td>从<key>集合<field>取出 value</td>
</tr>
<tr>
<td>hmset <key1><field1><value1><field2><value2>…</td>
<td>批量设置hash的值</td>
</tr>
<tr>
<td>hexists<key1><field></td>
<td>查看哈希表 key 中，给定域 field 是否存在</td>
</tr>
<tr>
<td>hkeys <key></td>
<td><font color='red'>列出该hash集合的所有field</font></td>
</tr>
<tr>
<td>hvals <key></td>
<td>列出该hash集合的所有value</td>
</tr>
<tr>
<td>hincrby <key><field><increment></td>
<td>为哈希表 key 中的域 field 的值加上增量 1  -1</td>
</tr>
<tr>
<td>hsetnx <key><field><value></td>
<td><font color='cornflowerblue'>将哈希表 key 中的域 field 的值设置为 value ，当且仅当域 field 不存在</font></td>
</tr>
</tbody></table>
<p>&#x3D;&#x3D;<strong>一：给<key>集合中的 <field>键赋值<value></strong>&#x3D;&#x3D;</p>
<p>语法：</p>
<figure><div class="code-wrapper"><pre class="line-numbers language-none"><code class="language-none">hset &lt;key&gt; &lt;field&gt; &lt;value&gt;<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></div></figure>

<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20220922140518361.png" srcset="/img/loading.gif" lazyload alt="image-20220922140518361"></p>
<p>&#x3D;&#x3D;<strong>二：从<key>集合<field>取出 value</strong>&#x3D;&#x3D;</p>
<p>语法：</p>
<figure><div class="code-wrapper"><pre class="line-numbers language-none"><code class="language-none">hget &lt;key&gt; &lt;field&gt;<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></div></figure>

<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20220922140518361.png" srcset="/img/loading.gif" lazyload alt="image-20220922140518361"></p>
<p>&#x3D;&#x3D;<strong>三：批量设置hash的值</strong>&#x3D;&#x3D;</p>
<p>语法：</p>
<figure><div class="code-wrapper"><pre class="line-numbers language-none"><code class="language-none">hmset &lt;key1&gt;&lt;field1&gt;&lt;value1&gt;&lt;field2&gt;&lt;value2&gt;...<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></div></figure>

<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20220922140839629.png" srcset="/img/loading.gif" lazyload alt="image-20220922140839629"></p>
<p>&#x3D;&#x3D;<strong>四：查看哈希表 key 中，给定域 field 是否存在</strong>&#x3D;&#x3D;</p>
<p>语法：</p>
<figure><div class="code-wrapper"><pre class="line-numbers language-none"><code class="language-none">hexists &lt;key1&gt; &lt;field&gt;<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></div></figure>

<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20220922140932958.png" srcset="/img/loading.gif" lazyload alt="image-20220922140932958"></p>
<p>&#x3D;&#x3D;<strong>五：  列出该hash集合的所有field</strong>&#x3D;&#x3D;</p>
<p>语法：</p>
<figure><div class="code-wrapper"><pre class="line-numbers language-none"><code class="language-none">hkeys &lt;key&gt;<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></div></figure>

<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20220922141039483.png" srcset="/img/loading.gif" lazyload alt="image-20220922141039483"></p>
<p>&#x3D;&#x3D;<strong>六：列出该hash集合的所有value</strong>&#x3D;&#x3D;</p>
<p>语法：</p>
<figure><div class="code-wrapper"><pre class="line-numbers language-none"><code class="language-none">hvals &lt;key&gt;<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></div></figure>

<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20220922141124707.png" srcset="/img/loading.gif" lazyload alt="image-20220922141124707"></p>
<p>&#x3D;&#x3D;<strong>七：为哈希表 key 中的域 field 的值加上增量increment</strong>&#x3D;&#x3D;</p>
<p>语法：</p>
<figure><div class="code-wrapper"><pre class="line-numbers language-none"><code class="language-none">hincrby &lt;key&gt;&lt;field&gt;&lt;increment&gt;<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></div></figure>

<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20220922141549716.png" srcset="/img/loading.gif" lazyload alt="image-20220922141549716"></p>
<p>&#x3D;&#x3D;<strong>八：<font color='cornflowerblue'>将哈希表 key 中的域 field 的值设置为 value ，当且仅当域 field 不存在</font></strong>&#x3D;&#x3D;</p>
<p>语法：</p>
<figure><div class="code-wrapper"><pre class="line-numbers language-none"><code class="language-none">hsetnx &lt;key&gt;&lt;field&gt;&lt;value&gt;<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></div></figure>

<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20220922141950104.png" srcset="/img/loading.gif" lazyload alt="image-20220922141950104"></p>
<h3 id="10-4-3Hash哈希的数据结构"><a href="#10-4-3Hash哈希的数据结构" class="headerlink" title="10.4.3Hash哈希的数据结构"></a>10.4.3Hash哈希的数据结构</h3><p>Hash类型对应的数据结构是两种：<font color='red'>ziplist（压缩列表）</font>，<font color='cornflowerblue'>hashtable（哈希表）</font>。<font color='orange'>当field-value长度较短且个数较少时，使用ziplist，否则使用hashtable。</font></p>
<h2 id="10-5有序集合Zset"><a href="#10-5有序集合Zset" class="headerlink" title="10.5有序集合Zset"></a>10.5有序集合Zset</h2><h3 id="10-5-1有序集合Zset说明"><a href="#10-5-1有序集合Zset说明" class="headerlink" title="10.5.1有序集合Zset说明"></a>10.5.1有序集合Zset说明</h3><p>Redis有序集合zset与普通集合set非常相似，是一个没有重复元素的字符串集合。</p>
<p>&#x3D;&#x3D;不同之处是有序集合的每个成员都关联了一个<strong>评分（score）</strong>,这个评分（score）被用来按照从最低分到最高分的方式排序集合中的成员。集合的成员是唯一的，但是评分可以是重复了 。&#x3D;&#x3D;</p>
<p><font color='red'>因为元素是有序的, 所以你也可以很快的根据评分（score）或者次序（position）来获取一个范围的元素。</font></p>
<p>访问有序集合的中间元素也是非常快的,因此你能够使用有序集合作为一个没有重复成员的智能列表。</p>
<h3 id="10-5-2有序集合Zset的常用命令"><a href="#10-5-2有序集合Zset的常用命令" class="headerlink" title="10.5.2有序集合Zset的常用命令"></a>10.5.2有序集合Zset的常用命令</h3><table>
<thead>
<tr>
<th>命令</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>zadd <key><score1><value1><score2><value2>…</td>
<td>将一个或多个 member 元素及其 score 值加入到有序集 key 当中</td>
</tr>
<tr>
<td>zrange <key><start><stop>[WITHSCORES]</td>
<td>返回有序集 key 中，下标在<start><stop>之间的元素,<font color='red'>带WITHSCORES，可以让分数一起和值返回到结果集</font></td>
</tr>
<tr>
<td>zrangebyscore key min max [withscores] [limit offset count]</td>
<td>返回有序集 key 中，所有 score 值介于 min 和 max 之间(包括等于 min 或 max )的成员。有序集成员按 score 值递增(从小到大)次序排列</td>
</tr>
<tr>
<td>zrevrangebyscore key max min [withscores] [limit offset count]</td>
<td>取得从大到小从max开始到min结束的数据</td>
</tr>
<tr>
<td>zincrby <key><increment><value></td>
<td><font color='red'>为元素的score加上增量</font></td>
</tr>
<tr>
<td>zrem <key><value></td>
<td>删除该集合下，指定值的元素</td>
</tr>
<tr>
<td>zcount <key><min><max></td>
<td>统计该集合，分数区间内的元素个数</td>
</tr>
<tr>
<td>zrank <key><value></td>
<td><font color='cornflowerblue'>返回该值在集合中的排名，从0开始</font></td>
</tr>
</tbody></table>
<p>&#x3D;&#x3D;<strong>一：将一个或多个 member 元素及其 score 值加入到有序集 key 当中</strong>&#x3D;&#x3D;</p>
<p>语法：</p>
<figure><div class="code-wrapper"><pre class="line-numbers language-none"><code class="language-none">zadd &lt;key&gt;&lt;score1&gt;&lt;value1&gt;&lt;score2&gt;&lt;value2&gt;…<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></div></figure>

<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20220922143132174.png" srcset="/img/loading.gif" lazyload alt="image-20220922143132174"></p>
<p>&#x3D;&#x3D;<strong>二：返回有序集 key 中，下标在<start><stop>之间的元素,<font color='red'>带WITHSCORES，可以让分数一起和值返回到结果集</font></strong>&#x3D;&#x3D;</p>
<p>语法：</p>
<figure><div class="code-wrapper"><pre class="line-numbers language-none"><code class="language-none">zrange &lt;key&gt;&lt;start&gt;&lt;stop&gt;<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></div></figure>

<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20220922143749624.png" srcset="/img/loading.gif" lazyload alt="image-20220922143749624"></p>
<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20220922144009929.png" srcset="/img/loading.gif" lazyload alt="image-20220922144009929"></p>
<p>&#x3D;&#x3D;<strong>三：返回有序集 key 中，所有 score 值介于 min 和 max 之间(包括等于 min 或 max )的成员。有序集成员按 score 值递增(从小到大)次序排列</strong>&#x3D;&#x3D;</p>
<p>语法：</p>
<figure><div class="code-wrapper"><pre class="line-numbers language-none"><code class="language-none">zrangebyscore key minmax [withscores] [limit offset count]<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></div></figure>

<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20220922144442146.png" srcset="/img/loading.gif" lazyload alt="image-20220922144442146"></p>
<p>&#x3D;&#x3D;<strong>四：取得从大到小从max开始到min结束的数据</strong>&#x3D;&#x3D;</p>
<p>语法：</p>
<figure><div class="code-wrapper"><pre class="line-numbers language-none"><code class="language-none">zrevrangebyscore key max min [withscores] [limit offset count]hexists &lt;key1&gt; &lt;field&gt;<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></div></figure>

<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20220922144954111.png" srcset="/img/loading.gif" lazyload alt="image-20220922144954111"></p>
<p>&#x3D;&#x3D;<strong>五：  <font color='red'>为元素的score加上增量</font></strong>&#x3D;&#x3D;</p>
<p>语法：</p>
<figure><div class="code-wrapper"><pre class="line-numbers language-none"><code class="language-none">zincrby &lt;key&gt;&lt;increment&gt;&lt;value&gt;   <span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></div></figure>

<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20220922145351869.png" srcset="/img/loading.gif" lazyload alt="image-20220922145351869"></p>
<p>&#x3D;&#x3D;<strong>六：删除该集合下，指定值的元素</strong>&#x3D;&#x3D;</p>
<p>语法：</p>
<figure><div class="code-wrapper"><pre class="line-numbers language-none"><code class="language-none">zrem &lt;key&gt;&lt;value&gt;<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></div></figure>

<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20220922145616225.png" srcset="/img/loading.gif" lazyload alt="image-20220922145616225"></p>
<p>&#x3D;&#x3D;<strong>七：统计该集合，分数区间内的元素个数</strong>&#x3D;&#x3D;</p>
<p>语法：</p>
<figure><div class="code-wrapper"><pre class="line-numbers language-none"><code class="language-none">zcount &lt;key&gt;&lt;min&gt;&lt;max&gt;<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></div></figure>

<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20220922145707761.png" srcset="/img/loading.gif" lazyload alt="image-20220922145707761"></p>
<p>&#x3D;&#x3D;<strong>八：<font color='cornflowerblue'>返回该值在集合中的排名，从0开始</font></strong>&#x3D;&#x3D;</p>
<p>语法：</p>
<figure><div class="code-wrapper"><pre class="line-numbers language-none"><code class="language-none">zrank &lt;key&gt;&lt;value&gt;<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></div></figure>

<h3 id="10-5-3有序集合Zset的数据结构"><a href="#10-5-3有序集合Zset的数据结构" class="headerlink" title="10.5.3有序集合Zset的数据结构"></a>10.5.3有序集合Zset的数据结构</h3><p>SortedSet(zset)是Redis提供的一个非常特别的数据结构，<font color='red'>一方面它等价于Java的数据结构Map&lt;String, Double&gt;，可以给每一个元素value赋予一个权重score，另一方面它又类似于TreeSet，内部的元素会按照权重score进行排序，可以得到每个元素的名次，还可以通过score的范围来获取元素的列表。</font></p>
<p>zset底层使用了两个数据结构</p>
<p>（1）hash，<font color='cornflowerblue'>hash的作用就是关联元素value和权重score，保障元素value的唯一性，可以通过元素value找到相应的score值。</font></p>
<p>（2）跳跃表，<font color='orange'>跳跃表的目的在于给元素value排序，根据score的范围获取元素列表。</font></p>
<p>什么是跳跃表</p>
<p>有序集合在生活中比较常见，例如根据成绩对学生排名，根据得分对玩家排名等。对于有序集合的底层实现，可以用数组、平衡树、链表等。数组不便元素的插入、删除；平衡树或红黑树虽然效率高但结构复杂；链表查询需要遍历所有效率低。Redis采用的是跳跃表。跳跃表效率堪比红黑树，实现远比红黑树简单。</p>
<p>2、实例</p>
<p>  对比有序链表和跳跃表，从链表中查询出51</p>
<p>（1）  有序链表</p>
<p>​                               <img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20220922150526849.png" srcset="/img/loading.gif" lazyload alt="image-20220922150526849"></p>
<p>要查找值为51的元素，<font color='red'>需要从第一个元素开始依次查找、比较才能找到。共需要6次比较。</font></p>
<p>（2）  跳跃表</p>
<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20220922150540681.png" srcset="/img/loading.gif" lazyload alt="image-20220922150540681"></p>
<p>从第2层开始，1节点比51节点小，向后比较。21节点比51节点小，继续向后比较，后面就是NULL了，所以从21节点向下到第1层</p>
<p>在第1层，41节点比51节点小，继续向后，61节点比51节点大，所以从41向下</p>
<p>在第0层，51节点为要查找的节点，节点被找到，共查找4次。</p>
<p><font color='cornflowerblue'>从此可以看出跳跃表比有序链表效率要高</font></p>
<h1 id="11-Redis的java客户端Jedis"><a href="#11-Redis的java客户端Jedis" class="headerlink" title="11.Redis的java客户端Jedis"></a>11.Redis的java客户端Jedis</h1><h2 id="11-1Jedis简介"><a href="#11-1Jedis简介" class="headerlink" title="11.1Jedis简介"></a>11.1Jedis简介</h2><p>以 Redis 命令作为方法名称，学习成本低，简单实用。&#x3D;&#x3D;<font color='red'>但是 Jedis 实例是线程不安全的，多线程环境下需要基于连接池来使用</font>&#x3D;&#x3D;</p>
<h2 id="11-2Jedis快速入门"><a href="#11-2Jedis快速入门" class="headerlink" title="11.2Jedis快速入门"></a>11.2Jedis快速入门</h2><p>Jedis的官网地址： <a target="_blank" rel="noopener" href="https://github.com/redis/jedis">https://github.com/redis/jedis</a></p>
<p>一：在虚拟机中关闭防火墙</p>
<figure><div class="code-wrapper"><pre class="line-numbers language-none"><code class="language-none">systemctl stop firewall.service<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></div></figure>



<p>二：创建maven项目，引入Jedis的相关依赖</p>
<figure><div class="code-wrapper"><pre class="line-numbers language-markup" data-language="markup"><code class="language-markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>redis.clients<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>jedis<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">></span></span>4.2.0<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure>

<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20220923152013288.png" srcset="/img/loading.gif" lazyload alt="image-20220923152013288"></p>
<p>三：创建测试类</p>
<figure><div class="code-wrapper"><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">private</span> <span class="token class-name">Jedis</span> jedis<span class="token punctuation">;</span>
    <span class="token annotation punctuation">@BeforeEach</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">initJedis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
<span class="token comment">//        建立连接</span>
        jedis <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Jedis</span><span class="token punctuation">(</span><span class="token string">"192.168.26.133"</span><span class="token punctuation">,</span><span class="token number">6379</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//        设置密码</span>
        jedis<span class="token punctuation">.</span><span class="token function">auth</span><span class="token punctuation">(</span><span class="token string">"xu123456"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//        选择库</span>
        jedis<span class="token punctuation">.</span><span class="token function">select</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token annotation punctuation">@Test</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">jedisConnect</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
        <span class="token class-name">String</span> result <span class="token operator">=</span> jedis<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">"name"</span><span class="token punctuation">,</span> <span class="token string">"张三"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span> name <span class="token operator">=</span> jedis<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"name"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token annotation punctuation">@AfterEach</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">releaseJedis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>jedis <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
            jedis<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure>

<p>控制台打印情况</p>
<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20220923155456022.png" srcset="/img/loading.gif" lazyload alt="image-20220923155456022"></p>
<p>查看redis可视化工具中的情况</p>
<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20220923155808918.png" srcset="/img/loading.gif" lazyload alt="image-20220923155808918"></p>
<h2 id="11-3Jedis连接池"><a href="#11-3Jedis连接池" class="headerlink" title="11.3Jedis连接池"></a>11.3Jedis连接池</h2><p><font color='red'>Jedis本身是线程不安全的，并且频繁的创建和销毁连接会有性能损耗，因此我们推荐大家使用Jedis连接池代替Jedis的直连方式</font></p>
<p>一：创建Jedis连接池配置类</p>
<figure><div class="code-wrapper"><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">JedisConnectFactory</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">JedisPool</span> jedisPool<span class="token punctuation">;</span>
    <span class="token keyword">static</span> <span class="token punctuation">&#123;</span>
<span class="token comment">//        配置连接池</span>
        <span class="token class-name">JedisPoolConfig</span> poolConfig <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">JedisPoolConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//        设置最大连接数</span>
        poolConfig<span class="token punctuation">.</span><span class="token function">setMaxIdle</span><span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//        设置最大空闲连接</span>
        poolConfig<span class="token punctuation">.</span><span class="token function">setMaxIdle</span><span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//        设置最小空闲连接</span>
        poolConfig<span class="token punctuation">.</span><span class="token function">setMinIdle</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//        创建连接池对象</span>
        jedisPool <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">JedisPool</span><span class="token punctuation">(</span>
                poolConfig<span class="token punctuation">,</span>
                <span class="token string">"192.168.26.133"</span><span class="token punctuation">,</span>
                <span class="token number">6379</span><span class="token punctuation">,</span>
                <span class="token number">1000</span><span class="token punctuation">,</span>
                <span class="token string">"xu123456"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token comment">//    创建方法，用于返回jedis线程池连接</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">Jedis</span> <span class="token function">getJedis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> jedisPool<span class="token punctuation">.</span><span class="token function">getResource</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure>

<p>二：测试类测试Jedis数据库连接池</p>
<figure><div class="code-wrapper"><pre class="line-numbers language-java" data-language="java"><code class="language-java">    <span class="token keyword">private</span> <span class="token class-name">Jedis</span> jedis<span class="token punctuation">;</span>
    <span class="token annotation punctuation">@BeforeEach</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">initJedis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
<span class="token comment">//        建立连接</span>
        jedis <span class="token operator">=</span> <span class="token class-name">JedisConnectFactory</span><span class="token punctuation">.</span><span class="token function">getJedis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//        选择库</span>
        jedis<span class="token punctuation">.</span><span class="token function">select</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token annotation punctuation">@Test</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">jedisConnect</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
        <span class="token class-name">String</span> result <span class="token operator">=</span> jedis<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">"name"</span><span class="token punctuation">,</span> <span class="token string">"张三"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span> name <span class="token operator">=</span> jedis<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"name"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token annotation punctuation">@AfterEach</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">releaseJedis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>jedis <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
            jedis<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure>

<p>控制台打印：</p>
<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20221101192955764.png" srcset="/img/loading.gif" lazyload alt="image-20221101192955764"></p>
<h1 id="12-Redis的java客户端SpringDataRedis"><a href="#12-Redis的java客户端SpringDataRedis" class="headerlink" title="12.Redis的java客户端SpringDataRedis"></a>12.Redis的java客户端SpringDataRedis</h1><h2 id="12-1SpringDataRedis简介"><a href="#12-1SpringDataRedis简介" class="headerlink" title="12.1SpringDataRedis简介"></a>12.1SpringDataRedis简介</h2><p>&#x3D;&#x3D;SpringData是Spring中数据操作的模块，包含对各种数据库的集成&#x3D;&#x3D;，<font color='red'>其中对Redis的集成模块就叫做SpringDataRedis</font>，官网地址：<a target="_blank" rel="noopener" href="https://spring.io/projects/spring-data-redis">https://spring.io/projects/spring-data-redis</a></p>
<h2 id="12-2SpringDataRedis的特点"><a href="#12-2SpringDataRedis的特点" class="headerlink" title="12.2SpringDataRedis的特点"></a>12.2SpringDataRedis的特点</h2><ol>
<li>提供了对不同Redis客户端的整合（Jedis和Lettuce）</li>
<li><font color='cornflowerblue'>提供了RedisTemplate统一API来操作Redis</font></li>
<li><font color='cornflowerblue'>支持Redis的发布订阅模型</font></li>
<li><font color='cornflowerblue'>支持Redis哨兵和Redis集群</font></li>
<li>支持Lettuce的响应式编程</li>
<li>支持基于JDK、JSON、字符串、Spring对象的数据序列化及反序列化</li>
<li>支持基于Redis的JDKCollection实现</li>
</ol>
<p>&#x3D;&#x3D;SpringDataRedis中提供了RedisTemplate工具类，其中封装了各种对Redis的操作。并且将不同数据类型的操作API封装到了不同的类型中&#x3D;&#x3D;</p>
<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20220923164211141.png" srcset="/img/loading.gif" lazyload alt="image-20220923164211141"></p>
<h2 id="12-3SpringBoot集成SpringDataRedis"><a href="#12-3SpringBoot集成SpringDataRedis" class="headerlink" title="12.3SpringBoot集成SpringDataRedis"></a>12.3SpringBoot集成SpringDataRedis</h2><h3 id="12-3-1引入相应依赖"><a href="#12-3-1引入相应依赖" class="headerlink" title="12.3.1引入相应依赖"></a>12.3.1引入相应依赖</h3><p>使用项目初始化工具创建SpringBoot项目</p>
<p>引入Spring对Redis的依赖：</p>
<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20220923170512328.png" srcset="/img/loading.gif" lazyload alt="image-20220923170512328"></p>
<figure><div class="code-wrapper"><pre class="line-numbers language-markup" data-language="markup"><code class="language-markup"><span class="token comment">&lt;!--        Spring对redis的整合--></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>spring-boot-starter-data-redis<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span>
<span class="token comment">&lt;!--        连接池依赖--></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>org.apache.commons<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>commons-pool2<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure>

<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20220923172923065.png" srcset="/img/loading.gif" lazyload alt="image-20220923172923065"></p>
<h3 id="12-3-2在配置文件中添加配置信息"><a href="#12-3-2在配置文件中添加配置信息" class="headerlink" title="12.3.2在配置文件中添加配置信息"></a>12.3.2在配置文件中添加配置信息</h3><figure><div class="code-wrapper"><pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">redis</span><span class="token punctuation">:</span>
    <span class="token key atrule">host</span><span class="token punctuation">:</span> <span class="token string">"192.168.26.133"</span>
    <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">6379</span>
    <span class="token key atrule">password</span><span class="token punctuation">:</span> <span class="token string">"xu123456"</span>
    <span class="token key atrule">lettuce</span><span class="token punctuation">:</span>
      <span class="token key atrule">pool</span><span class="token punctuation">:</span>
        <span class="token key atrule">max-active</span><span class="token punctuation">:</span> <span class="token number">8</span>   <span class="token comment">#最大连接数</span>
        <span class="token key atrule">max-idle</span><span class="token punctuation">:</span> <span class="token number">8</span>     <span class="token comment">#最大空闲连接数</span>
        <span class="token key atrule">min-idle</span><span class="token punctuation">:</span> <span class="token number">0</span>     <span class="token comment">#最小空闲连接数</span>
        <span class="token key atrule">max-wait</span><span class="token punctuation">:</span> 100ms <span class="token comment">#等待连接时间</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure>

<h3 id="12-3-3测试RedisTemplate"><a href="#12-3-3测试RedisTemplate" class="headerlink" title="12.3.3测试RedisTemplate"></a>12.3.3测试RedisTemplate</h3><p><font color='red'>Spring对Redis的封装的各种API</font></p>
<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20220923174606851.png" srcset="/img/loading.gif" lazyload alt="image-20220923174606851"></p>
<p><font color='red'>每种API对应了redis所有操作数据的方法</font></p>
<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20220923183904850.png" srcset="/img/loading.gif" lazyload alt="image-20220923183904850"></p>
<figure><div class="code-wrapper"><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Autowired</span><span class="token punctuation">(</span>required <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">)</span>
<span class="token keyword">private</span> <span class="token class-name">RedisTemplate</span> redisTemplate<span class="token punctuation">;</span>

<span class="token annotation punctuation">@Test</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">redisTemplateTest1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
    redisTemplate<span class="token punctuation">.</span><span class="token function">opsForValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">"username"</span><span class="token punctuation">,</span><span class="token string">"徐哈哈"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">Object</span> username <span class="token operator">=</span> redisTemplate<span class="token punctuation">.</span><span class="token function">opsForValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"username"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"用户名为："</span><span class="token operator">+</span>username<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure>



<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20220923183209172.png" srcset="/img/loading.gif" lazyload alt="image-20220923183209172"></p>
<h3 id="12-3-4RedisTemplate的序列化方式"><a href="#12-3-4RedisTemplate的序列化方式" class="headerlink" title="12.3.4RedisTemplate的序列化方式"></a>12.3.4RedisTemplate的序列化方式</h3><p><font color='red'>前面已经看到Spring对Redis的集成的各种Api的各种方法的参数类型为Object类型</font>，&#x3D;&#x3D;而Redis底层对Object对象的处理方式就是<font color='red'>使用jdk的序列化工具ObjectOutputStream(对象操作流)进行序列化的</font>。&#x3D;&#x3D;</p>
<p>进入RedisTemplate</p>
<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20220923184858247.png" srcset="/img/loading.gif" lazyload alt="image-20220923184858247"></p>
<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20220923195103569.png" srcset="/img/loading.gif" lazyload alt="image-20220923195103569"></p>
<p>采用ObjectOutputStream序列化得到的结果为：</p>
<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20220923185853185.png" srcset="/img/loading.gif" lazyload alt="image-20220923185853185"></p>
<h3 id="12-3-5更改RedisTemplate的序列化方式"><a href="#12-3-5更改RedisTemplate的序列化方式" class="headerlink" title="12.3.5更改RedisTemplate的序列化方式"></a>12.3.5更改RedisTemplate的序列化方式</h3><p>一：导入相应依赖</p>
<p>导入json解析库的坐标（JSON解析库有：jackson（SpringMVC），fastjson（阿里），gson（Google））</p>
<figure><div class="code-wrapper"><pre class="line-numbers language-markup" data-language="markup"><code class="language-markup"><span class="token comment">&lt;!--        json解析库--></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>com.fasterxml.jackson.core<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>jackson-databind<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure>

<p>二：创建配置类，更改序列化规则</p>
<figure><div class="code-wrapper"><pre class="line-numbers language-java" data-language="java"><code class="language-java">  <span class="token annotation punctuation">@Configuration</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">RedisConfig</span> <span class="token punctuation">&#123;</span>

    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> <span class="token class-name">RedisTemplate</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span><span class="token class-name">Object</span><span class="token punctuation">></span></span> <span class="token function">redisTemplate</span><span class="token punctuation">(</span><span class="token class-name">RedisConnectionFactory</span> redisConnectionFactory<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
<span class="token comment">//        创建Template</span>
        <span class="token class-name">RedisTemplate</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span><span class="token class-name">Object</span><span class="token punctuation">></span></span> redisTemplate <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RedisTemplate</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//        设置连接工厂</span>
        redisTemplate<span class="token punctuation">.</span><span class="token function">setConnectionFactory</span><span class="token punctuation">(</span>redisConnectionFactory<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//        设置序列化工具</span>
        <span class="token class-name">GenericJackson2JsonRedisSerializer</span> jsonRedisSerializer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">GenericJackson2JsonRedisSerializer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//        key和HashKey采用String序列化方式</span>
        redisTemplate<span class="token punctuation">.</span><span class="token function">setKeySerializer</span><span class="token punctuation">(</span><span class="token class-name">RedisSerializer</span><span class="token punctuation">.</span><span class="token function">string</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        redisTemplate<span class="token punctuation">.</span><span class="token function">setHashKeySerializer</span><span class="token punctuation">(</span><span class="token class-name">RedisSerializer</span><span class="token punctuation">.</span><span class="token function">string</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//        value和Hashvalue采用JSON序列化方式</span>
        redisTemplate<span class="token punctuation">.</span><span class="token function">setValueSerializer</span><span class="token punctuation">(</span><span class="token class-name">RedisSerializer</span><span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        redisTemplate<span class="token punctuation">.</span><span class="token function">setHashValueSerializer</span><span class="token punctuation">(</span><span class="token class-name">RedisSerializer</span><span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> redisTemplate<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure>

<p>三：再次进行测试，查看序列化情况</p>
<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20220923202339033.png" srcset="/img/loading.gif" lazyload alt="image-20220923202339033"></p>
<p>四：创建javaBean，测试对象类型</p>
<p>&#x3D;&#x3D;可以看到当存入缓存的时候对象类型序列化为了JSON类型，读取的时候由JSON类型反序列化为了对象类型。&#x3D;&#x3D;</p>
<figure><div class="code-wrapper"><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Test</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">redisTemplateTest2</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
    redisTemplate<span class="token punctuation">.</span><span class="token function">opsForValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">"user:001"</span><span class="token punctuation">,</span><span class="token keyword">new</span> <span class="token class-name">User</span><span class="token punctuation">(</span><span class="token number">001</span><span class="token punctuation">,</span><span class="token string">"张三"</span><span class="token punctuation">,</span><span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">User</span> user001 <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">User</span><span class="token punctuation">)</span> redisTemplate<span class="token punctuation">.</span><span class="token function">opsForValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"user:001"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>user001<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure>

<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20220923203326767.png" srcset="/img/loading.gif" lazyload alt="image-20220923203326767"></p>
<h3 id="12-3-6StringRedisTemplate"><a href="#12-3-6StringRedisTemplate" class="headerlink" title="12.3.6StringRedisTemplate"></a>12.3.6StringRedisTemplate</h3><p>尽管JSON的序列化方式可以满足我们的需求，但依然存在一些问题，如图：</p>
<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20220923204251654.png" srcset="/img/loading.gif" lazyload alt="image-20220923204251654"></p>
<p><font color='red'>为了在反序列化时知道对象的类型，JSON序列化器会将类的class类型写入json结果中，存入Redis，会带来额外的内存开销。</font></p>
<p>&#x3D;&#x3D;<font color='cornflowerblue'>为了节省内存空间，我们并不会使用JSON序列化器来处理value，而是统一使用String序列化器，要求只能存储String类型的key和value。当需要存储Java对象时，手动完成对象的序列化和反序列化。</font>&#x3D;&#x3D;</p>
<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20220923204439037.png" srcset="/img/loading.gif" lazyload alt="image-20220923204439037"></p>
<p>&#x3D;&#x3D;Spring默认提供了一个<strong>StringRedisTemplate类</strong>，<font color='red'>它的key和value的序列化方式默认就是String方式</font>。省去了我们自定义RedisTemplate的过程&#x3D;&#x3D;</p>
<h3 id="12-3-7StringRedisTemplate操作字符串类型"><a href="#12-3-7StringRedisTemplate操作字符串类型" class="headerlink" title="12.3.7StringRedisTemplate操作字符串类型"></a>12.3.7StringRedisTemplate操作字符串类型</h3><p><font color='red'>ObjectMapper类是Jackson的主要类，它可以帮助我们快速的进行各个类型和Json类型的相互转换。它使用JsonParser和JsonGenerator的实例实现JSON实际的读&#x2F;写。</font></p>
<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20220923205656294.png" srcset="/img/loading.gif" lazyload alt="image-20220923205656294"></p>
<p>测试</p>
<figure><div class="code-wrapper"><pre class="line-numbers language-java" data-language="java"><code class="language-java">    <span class="token annotation punctuation">@Autowired</span><span class="token punctuation">(</span>required <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token class-name">StringRedisTemplate</span> stringRedisTemplate<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Test</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token class-name">StringRedisTemplateTest1</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">JsonProcessingException</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">ObjectMapper</span> objectMapper <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ObjectMapper</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//        创建对象</span>
        <span class="token class-name">User</span> user <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">User</span><span class="token punctuation">(</span><span class="token number">002</span><span class="token punctuation">,</span><span class="token string">"张全蛋"</span><span class="token punctuation">,</span><span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//        手动序列化</span>
        <span class="token class-name">String</span> userString <span class="token operator">=</span> objectMapper<span class="token punctuation">.</span><span class="token function">writeValueAsString</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span><span class="token punctuation">;</span>
        stringRedisTemplate<span class="token punctuation">.</span><span class="token function">opsForValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">"user:002"</span><span class="token punctuation">,</span> userString<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span> user002String <span class="token operator">=</span> stringRedisTemplate<span class="token punctuation">.</span><span class="token function">opsForValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"user:002"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//        手动反序列化</span>
        <span class="token class-name">User</span> user002 <span class="token operator">=</span> objectMapper<span class="token punctuation">.</span><span class="token function">readValue</span><span class="token punctuation">(</span>user002String<span class="token punctuation">,</span> <span class="token class-name">User</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>user002<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure>

<p>JSON字符串</p>
<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20220923210525936.png" srcset="/img/loading.gif" lazyload alt="image-20220923210525936"></p>
<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20220923210824266.png" srcset="/img/loading.gif" lazyload alt="image-20220923210824266"></p>
<h3 id="12-3-8StringRedisTemplate操作Hash类型"><a href="#12-3-8StringRedisTemplate操作Hash类型" class="headerlink" title="12.3.8StringRedisTemplate操作Hash类型"></a>12.3.8StringRedisTemplate操作Hash类型</h3><p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20220923211654236.png" srcset="/img/loading.gif" lazyload alt="image-20220923211654236"></p>
<figure><div class="code-wrapper"><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Test</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token class-name">StringRedisTemplateTest2</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">JsonProcessingException</span> <span class="token punctuation">&#123;</span>
    stringRedisTemplate<span class="token punctuation">.</span><span class="token function">opsForHash</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"user:003"</span><span class="token punctuation">,</span> <span class="token string">"name"</span><span class="token punctuation">,</span> <span class="token string">"李四"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    stringRedisTemplate<span class="token punctuation">.</span><span class="token function">opsForHash</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"user:003"</span><span class="token punctuation">,</span> <span class="token string">"age"</span><span class="token punctuation">,</span> <span class="token string">"21"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Object</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">></span></span> user <span class="token operator">=</span> stringRedisTemplate<span class="token punctuation">.</span><span class="token function">opsForHash</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">entries</span><span class="token punctuation">(</span><span class="token string">"user:003"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure>

<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20220923212057208.png" srcset="/img/loading.gif" lazyload alt="image-20220923212057208"></p>
<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20220923212019731.png" srcset="/img/loading.gif" lazyload alt="image-20220923212019731"></p>
<h1 id="13-Redis缓存"><a href="#13-Redis缓存" class="headerlink" title="13.Redis缓存"></a>13.Redis缓存</h1><h2 id="13-1什么是缓存"><a href="#13-1什么是缓存" class="headerlink" title="13.1什么是缓存"></a>13.1什么是缓存</h2><p><strong>缓存</strong>就是数据交换的缓冲区，是存贮数据的临时地方，&#x3D;&#x3D;一般读写性能较高&#x3D;&#x3D;。</p>
<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20220925111307170.png" srcset="/img/loading.gif" lazyload alt="image-20220925111307170"></p>
<h2 id="13-2缓存的作用和成本"><a href="#13-2缓存的作用和成本" class="headerlink" title="13.2缓存的作用和成本"></a>13.2缓存的作用和成本</h2><p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20220925145832701.png" srcset="/img/loading.gif" lazyload alt="image-20220925145832701"></p>
<h2 id="13-3缓存业务流程"><a href="#13-3缓存业务流程" class="headerlink" title="13.3缓存业务流程"></a>13.3缓存业务流程</h2><p>&#x3D;&#x3D;当不使用缓存的时候，当客户端向服务器端发送请求，服务器端每次都会调用DAO层查询数据库，数据库中的数据是写在磁盘当中的，读写效率很慢。&#x3D;&#x3D;</p>
<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20220925113345173.png" srcset="/img/loading.gif" lazyload alt="image-20220925113345173"></p>
<p>&#x3D;&#x3D;redis缓存的作用就是充当中间件，当客户端前服务器端请求数据的时候，首先会到缓存中查询数据，如果请求命中，redis缓存就返回数据，若请求未命中，则在关系型数据库进行查询，将查询到的数据写入缓存并返回给客户端。&#x3D;&#x3D;</p>
<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20220925113408180.png" srcset="/img/loading.gif" lazyload alt="image-20220925113408180"></p>
<h2 id="13-4缓存的更新策略"><a href="#13-4缓存的更新策略" class="headerlink" title="13.4缓存的更新策略"></a>13.4缓存的更新策略</h2><h3 id="13-4-1缓存更新策略的三种方式"><a href="#13-4-1缓存更新策略的三种方式" class="headerlink" title="13.4.1缓存更新策略的三种方式"></a>13.4.1缓存更新策略的三种方式</h3><p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20220925150005367.png" srcset="/img/loading.gif" lazyload alt="image-20220925150005367"></p>
<p>业务场景：</p>
<ul>
<li>&#x3D;&#x3D;低一致性需求：使用内存淘汰机制。例如不需要经常更新的数据—店铺类型的查询缓存&#x3D;&#x3D;。</li>
<li>&#x3D;&#x3D;高一致性需求：<font color='red'>主动更新</font>，并以超时剔除作为最后方案。例如店铺详情查询的缓存&#x3D;&#x3D;。</li>
</ul>
<h3 id="13-4-2主动更新策略实现更新的三种方式"><a href="#13-4-2主动更新策略实现更新的三种方式" class="headerlink" title="13.4.2主动更新策略实现更新的三种方式"></a>13.4.2主动更新策略实现更新的三种方式</h3><p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20220925154751975.png" srcset="/img/loading.gif" lazyload alt="image-20220925154751975"></p>
<p>操作缓存和数据库的时候有三个问题需要考虑：</p>
<ol>
<li><p><font color='red'>删除缓存还是更新缓存</font></p>
<p>​	  更新缓存：每次更新数据库都更新缓存，无效写操作较多<font color='red'> ✘</font></p>
<p>​    &#x3D;&#x3D;删除缓存：更新数据库时让缓存失效，查询时再更新缓存&#x3D;&#x3D; <font color='cornflowerblue'>✔</font></p>
</li>
<li><p><font color='red'>如何保证缓存和数据库之间的操作同时成功同时失败</font></p>
<p>​		单体系统：将缓存与数据库操作放在一个事务里</p>
<p>​		分布式系统：利用TCC等分布式事务方案</p>
</li>
<li><p><font color='red'>先操作缓存还是先操作数据库</font></p>
<p>​		先删除缓存，再操作数据库</p>
<p>​		&#x3D;&#x3D;先操作数据库，再删除缓存&#x3D;&#x3D;</p>
<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20220925155347238.png" srcset="/img/loading.gif" lazyload alt="image-20220925155347238"></p>
</li>
</ol>
<h3 id="13-4-3缓存更新的最佳方案"><a href="#13-4-3缓存更新的最佳方案" class="headerlink" title="13.4.3缓存更新的最佳方案"></a>13.4.3缓存更新的最佳方案</h3><p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20220925161924017.png" srcset="/img/loading.gif" lazyload alt="image-20220925161924017"></p>
<h2 id="13-5缓存穿透"><a href="#13-5缓存穿透" class="headerlink" title="13.5缓存穿透"></a>13.5缓存穿透</h2><h3 id="13-5-1缓存穿透的定义"><a href="#13-5-1缓存穿透的定义" class="headerlink" title="13.5.1缓存穿透的定义"></a>13.5.1缓存穿透的定义</h3><p>&#x3D;&#x3D;缓存穿透&#x3D;&#x3D;是客户端请求的数据既不在缓存当中，也不在数据库中。出于容错的考虑，如果从底层数据库查询不到数据，则不写入缓存。<font color='red'>这就导致每次请求都会到底层数据库进行查询，缓存也失去了意义</font>。当高并发或有人利用不存在的Key频繁攻击时，数据库的压力骤增，甚至崩溃，这就是缓存穿透问题。</p>
<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/c5f45358eb82351e3abfc0885d48fce6.jpeg" srcset="/img/loading.gif" lazyload alt="img"></p>
<h3 id="13-5-2缓存穿透的解决方案"><a href="#13-5-2缓存穿透的解决方案" class="headerlink" title="13.5.2缓存穿透的解决方案"></a>13.5.2缓存穿透的解决方案</h3><ol>
<li>&#x3D;&#x3D;缓存空值&#x3D;&#x3D;</li>
</ol>
<p><font color='red'>就是当缓存中和数据库中都不存在客户端请求的数据时，就设置一个空值作为缓存，并为缓存设置过期时间（一般很短），当客户端再次发送同样的请求时就会命中缓存，不会请求数据库，从而减小数据库压力。</font></p>
<ol start="2">
<li>布隆过滤</li>
</ol>
<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20220925182649818.png" srcset="/img/loading.gif" lazyload alt="image-20220925182649818"></p>
<h2 id="13-6缓存雪崩"><a href="#13-6缓存雪崩" class="headerlink" title="13.6缓存雪崩"></a>13.6缓存雪崩</h2><h3 id="13-6-1缓存雪崩的定义"><a href="#13-6-1缓存雪崩的定义" class="headerlink" title="13.6.1缓存雪崩的定义"></a>13.6.1缓存雪崩的定义</h3><p>&#x3D;&#x3D;缓存雪崩&#x3D;&#x3D;是指在<font color='red'>一段时间内大量的缓存key同时失效或者Redis服务故障，使大量请求到达数据库，从而导致数据库崩溃。</font></p>
<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20220925194225291.png" srcset="/img/loading.gif" lazyload alt="image-20220925194225291"></p>
<h3 id="13-6-2缓存雪崩的解决方案"><a href="#13-6-2缓存雪崩的解决方案" class="headerlink" title="13.6.2缓存雪崩的解决方案"></a>13.6.2缓存雪崩的解决方案</h3><ul>
<li><p>给不同的Key的TTL添加随机值（<font color='red'>应对大量key失效的问题</font>）</p>
</li>
<li><p>利用Redis集群提高服务的可用性</p>
</li>
<li><p>给缓存业务添加降级限流策略</p>
</li>
<li><p>给业务添加多级缓存</p>
</li>
</ul>
<h2 id="13-7缓存击穿"><a href="#13-7缓存击穿" class="headerlink" title="13.7缓存击穿"></a>13.7缓存击穿</h2><h3 id="13-7-1缓存击穿的定义"><a href="#13-7-1缓存击穿的定义" class="headerlink" title="13.7.1缓存击穿的定义"></a>13.7.1缓存击穿的定义</h3><p><strong>缓存击穿问题</strong>也叫热点Key问题，就是一个被&#x3D;&#x3D;<strong>高并发访问</strong>&#x3D;&#x3D;并且&#x3D;&#x3D;<strong>缓存重建业务较复杂</strong>&#x3D;&#x3D;的<font color='red'>key突然失效</font>了，<font color='red'>无数的请求访问会在瞬间给数据库带来巨大的冲击。</font></p>
<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20220925202304851.png" srcset="/img/loading.gif" lazyload alt="image-20220925202304851"></p>
<h3 id="13-7-2缓存击穿的解决方案"><a href="#13-7-2缓存击穿的解决方案" class="headerlink" title="13.7.2缓存击穿的解决方案"></a>13.7.2缓存击穿的解决方案</h3><p><strong>一：互斥锁</strong></p>
<p>&#x3D;&#x3D;当同个业务不同线程访问redis未命中时，<font color='red'>先获取一把互斥锁</font>，然后进行数据库操作，<font color='red'>此时另外一个线程未命中时，拿不到锁，等待一段时间后重新查询缓存，此时之前的线程已经重新把数据加载到redis之中了，线程二就直接缓存命中</font>。这样就不会使得大量访问进入数据库&#x3D;&#x3D;</p>
<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20220925202841444.png" srcset="/img/loading.gif" lazyload alt="image-20220925202841444"></p>
<p><strong><font color='cornflowerblue'>互斥锁的实现方式：</font></strong><br>            <strong>使用setnx实现互斥锁</strong></p>
<p>​		setnx要求只有当key不存在的时候才能设置key，所以可以采用setnx模拟互斥锁，当一个进程未命中缓存，要查询数据库的时候就添加setnx，并设置过期时间（<font color='red'>为了防止忘记释放锁，出现死锁问题</font>）。当其它线程请求时就会等待，等互斥锁时间过期就能获取到缓存中的数据。</p>
<p><strong>二：逻辑过期</strong></p>
<p>给缓存设置一个<font color='red'>逻辑过期时间</font>，什么意思呢？缓存本来在redis之中，正常情况下除了主动更新它是不会变的，<font color='red'>为了防止缓存击穿，我们以一种预判或者说保守的方式，主动设置一个过期时间，当然这个时间过期了，缓存里面的数据是不会消失的</font>，但是我们只需要根据这个假设的过期时间。来进行经常的动态的缓存数据的更新。可以对缓存击穿起一定的预防作用。</p>
<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20220925202909388.png" srcset="/img/loading.gif" lazyload alt="image-20220925202909388"></p>
<p><strong>三：互斥锁和逻辑过期的优缺点比较</strong></p>
<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20220925205842685.png" srcset="/img/loading.gif" lazyload alt="image-20220925205842685"></p>
<h2 id="13-8缓存工具封装"><a href="#13-8缓存工具封装" class="headerlink" title="13.8缓存工具封装"></a>13.8缓存工具封装</h2><h3 id="13-8-1解决缓存穿透方法封装"><a href="#13-8-1解决缓存穿透方法封装" class="headerlink" title="13.8.1解决缓存穿透方法封装"></a>13.8.1解决缓存穿透方法封装</h3><p>步骤1：&#x3D;&#x3D;将任意Java对象序列化为json并存储在string类型的key中，并且可以设置TTL过期时间（为了在解决缓存穿透时向缓存中添加有效缓存的数据的方法）&#x3D;&#x3D;</p>
<p>步骤2：&#x3D;&#x3D;根据指定的key查询缓存，并反序列化为指定类型，利用缓存空值的方式解决缓存穿透问题&#x3D;&#x3D;</p>
<p><font color='red'>封装的方法：</font></p>
<figure><div class="code-wrapper"><pre class="line-numbers language-java" data-language="java"><code class="language-java">    <span class="token comment">//    将任意Java对象序列化为json并存储在string类型的key中，并且可以设置TTL过期时间</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setCacheByThroughPass</span><span class="token punctuation">(</span><span class="token class-name">String</span> key<span class="token punctuation">,</span> <span class="token class-name">Object</span> object<span class="token punctuation">,</span> <span class="token class-name">Long</span> time<span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span> timeUnit<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
<span class="token comment">//        将对象序列化为Json</span>
        stringRedisTemplate<span class="token punctuation">.</span><span class="token function">opsForValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> <span class="token class-name">JSONUtil</span><span class="token punctuation">.</span><span class="token function">toJsonStr</span><span class="token punctuation">(</span>object<span class="token punctuation">)</span><span class="token punctuation">,</span> time<span class="token punctuation">,</span> timeUnit<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token punctuation">&#125;</span>

    <span class="token comment">//    根据指定的key查询缓存，并反序列化为指定类型，利用缓存空值的方式解决缓存穿透问题</span>
    <span class="token keyword">public</span> <span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">,</span>ID<span class="token punctuation">></span></span> <span class="token class-name">T</span> <span class="token function">cachePassThrough</span><span class="token punctuation">(</span><span class="token class-name">String</span> keyPrefix<span class="token punctuation">,</span>       <span class="token comment">//key的前缀</span>
                                     <span class="token class-name">ID</span> id<span class="token punctuation">,</span>                  <span class="token comment">//id类型不确定</span>
                                     <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">></span></span> type<span class="token punctuation">,</span>          <span class="token comment">//操作的对象类型,由此对象类型来决定返回值类型T</span>
                                     <span class="token class-name">Function</span><span class="token generics"><span class="token punctuation">&lt;</span>ID<span class="token punctuation">,</span><span class="token class-name">T</span><span class="token punctuation">></span></span> dbResult<span class="token punctuation">,</span><span class="token comment">//函数式编程（数据库查询的逻辑），ID为参数类型，T为返回值类型</span>
                                     <span class="token class-name">Long</span> time<span class="token punctuation">,</span>              <span class="token comment">//缓存过期时间</span>
                                     <span class="token class-name">TimeUnit</span> timeUnit<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token comment">//时间单位</span>

        <span class="token comment">//        从redis查询用户缓存</span>
        <span class="token class-name">String</span> jsonStr <span class="token operator">=</span> stringRedisTemplate<span class="token punctuation">.</span><span class="token function">opsForValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>keyPrefix <span class="token operator">+</span> id<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//        判断缓存中是否存在</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">StrUtil</span><span class="token punctuation">.</span><span class="token function">isNotBlank</span><span class="token punctuation">(</span>jsonStr<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
<span class="token comment">//        存在对象字符串，直接返回</span>
            <span class="token keyword">return</span> <span class="token class-name">JSONUtil</span><span class="token punctuation">.</span><span class="token function">toBean</span><span class="token punctuation">(</span>jsonStr<span class="token punctuation">,</span> type<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>

<span class="token comment">//        判断命中的是否为空字符串</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>jsonStr <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
<span class="token comment">//            不为空就是空字符串，就是解决缓存穿透时设置的空值</span>
            <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>

<span class="token comment">//        缓存中不存在，且不为空字符串就去查数据</span>
        <span class="token class-name">T</span> obj <span class="token operator">=</span> dbResult<span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//        数据库中不存在就缓存空值</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>obj <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            stringRedisTemplate<span class="token punctuation">.</span><span class="token function">opsForValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token constant">CACHE_SHOP_KEY</span> <span class="token operator">+</span> id<span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">,</span> <span class="token constant">CACHE_NULL_TTL</span><span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span><span class="token constant">MINUTES</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>

<span class="token comment">//        存在就写入缓存,并设置缓存超时时间</span>
        <span class="token function">setCacheByThroughPass</span><span class="token punctuation">(</span>keyPrefix <span class="token operator">+</span> id<span class="token punctuation">,</span>obj<span class="token punctuation">,</span>time<span class="token punctuation">,</span>timeUnit<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">//        返回商户信息</span>
        <span class="token keyword">return</span> obj<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure>

<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20220927150229698.png" srcset="/img/loading.gif" lazyload alt="image-20220927150229698"></p>
<p><font color='red'>调用封装的方法：</font>font&gt;</p>
<figure><div class="code-wrapper"><pre class="line-numbers language-java" data-language="java"><code class="language-java">    <span class="token comment">//    根据id查询商户信息</span>
    <span class="token keyword">public</span> <span class="token class-name">Result</span> <span class="token function">queryById</span><span class="token punctuation">(</span><span class="token class-name">Long</span> id<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
<span class="token comment">//        利用设置空值解决缓存穿透问题</span>
        <span class="token class-name">Shop</span> shop <span class="token operator">=</span> cacheResolve<span class="token punctuation">.</span><span class="token function">cachePassThroughByNull</span><span class="token punctuation">(</span>
                <span class="token constant">CACHE_SHOP_KEY</span><span class="token punctuation">,</span>
                id<span class="token punctuation">,</span><span class="token class-name">Shop</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span>
<span class="token comment">//                this表示当前对象即IService接口，将方法中的参数id作为数据库查询的参数</span>
                <span class="token keyword">this</span><span class="token operator">::</span><span class="token function">getById</span><span class="token punctuation">,</span>
                <span class="token constant">CACHE_NULL_TTL</span><span class="token punctuation">,</span>
                <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span><span class="token constant">MINUTES</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>shop <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
            <span class="token keyword">return</span> <span class="token class-name">Result</span><span class="token punctuation">.</span><span class="token function">fail</span><span class="token punctuation">(</span><span class="token string">"商户不存在！！！"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
<span class="token comment">//        返回</span>
        <span class="token keyword">return</span> <span class="token class-name">Result</span><span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span>shop<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure>

<p>测试：查询缓存和数据库中都不存在的数据：成功向缓存中存入空值</p>
<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20220927160436457.png" srcset="/img/loading.gif" lazyload alt="image-20220927160436457"></p>
<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20220927160358481.png" srcset="/img/loading.gif" lazyload alt="image-20220927160358481"></p>
<h3 id="13-8-2解决缓存击穿方法封装"><a href="#13-8-2解决缓存击穿方法封装" class="headerlink" title="13.8.2解决缓存击穿方法封装"></a>13.8.2解决缓存击穿方法封装</h3><p>步骤1：&#x3D;&#x3D;将任意Java对象序列化为json并存储在string类型的key中，并且可以设置逻辑过期时间，用于处理缓存击穿问题&#x3D;&#x3D;</p>
<p>步骤2：&#x3D;&#x3D;根据指定的key查询缓存，并反序列化为指定类型，需要利用逻辑过期解决缓存击穿问题&#x3D;&#x3D;</p>
<figure><div class="code-wrapper"><pre class="line-numbers language-java" data-language="java"><code class="language-java">   <span class="token comment">//    获取缓存重建线程池</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">ExecutorService</span> <span class="token constant">CACHE_REBUILD_EXECUTOR</span> <span class="token operator">=</span> <span class="token class-name">Executors</span><span class="token punctuation">.</span><span class="token function">newFixedThreadPool</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">//    将任意Java对象序列化为json并存储在string类型的key中，并且可以设置逻辑过期时间</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setCacheByAttackPass</span><span class="token punctuation">(</span><span class="token class-name">String</span> key<span class="token punctuation">,</span> <span class="token class-name">Object</span> object<span class="token punctuation">,</span> <span class="token class-name">Long</span> time<span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span> timeUnit<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
<span class="token comment">//        设置逻辑过期</span>
        <span class="token class-name">RedisData</span> redisData <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RedisData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        redisData<span class="token punctuation">.</span><span class="token function">setData</span><span class="token punctuation">(</span>object<span class="token punctuation">)</span><span class="token punctuation">;</span>
        redisData<span class="token punctuation">.</span><span class="token function">setExpireTime</span><span class="token punctuation">(</span><span class="token class-name">LocalDateTime</span><span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">plusSeconds</span><span class="token punctuation">(</span>timeUnit<span class="token punctuation">.</span><span class="token function">toSeconds</span><span class="token punctuation">(</span>time<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        stringRedisTemplate<span class="token punctuation">.</span><span class="token function">opsForValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> <span class="token class-name">JSONUtil</span><span class="token punctuation">.</span><span class="token function">toJsonStr</span><span class="token punctuation">(</span>redisData<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token comment">//    利用逻辑过期的方式解决缓存击穿的问题</span>
    <span class="token keyword">public</span> <span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">,</span>ID<span class="token punctuation">></span></span> <span class="token class-name">T</span> <span class="token function">cacheAttackThroughByLogicExpire</span><span class="token punctuation">(</span>
            <span class="token class-name">String</span> keyPrefix<span class="token punctuation">,</span>
            <span class="token class-name">ID</span> id<span class="token punctuation">,</span>
            <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">></span></span> type<span class="token punctuation">,</span>
            <span class="token class-name">Function</span><span class="token generics"><span class="token punctuation">&lt;</span>ID<span class="token punctuation">,</span><span class="token class-name">T</span><span class="token punctuation">></span></span> dbResult<span class="token punctuation">,</span>
            <span class="token class-name">Long</span> time<span class="token punctuation">,</span>
            <span class="token class-name">TimeUnit</span> timeUnit<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
<span class="token comment">//        查询缓存</span>
        <span class="token class-name">String</span> jsonStr <span class="token operator">=</span> stringRedisTemplate<span class="token punctuation">.</span><span class="token function">opsForValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>keyPrefix <span class="token operator">+</span> id<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">StrUtil</span><span class="token punctuation">.</span><span class="token function">isBlank</span><span class="token punctuation">(</span>jsonStr<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
            <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
<span class="token comment">//        缓存命中，将Json字符串反序列化为对象，判断逻辑过期时间</span>
        <span class="token class-name">RedisData</span> redisData <span class="token operator">=</span> <span class="token class-name">JSONUtil</span><span class="token punctuation">.</span><span class="token function">toBean</span><span class="token punctuation">(</span>jsonStr<span class="token punctuation">,</span> <span class="token class-name">RedisData</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">T</span> cacheObj <span class="token operator">=</span> <span class="token class-name">JSONUtil</span><span class="token punctuation">.</span><span class="token function">toBean</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">JSONObject</span><span class="token punctuation">)</span> redisData<span class="token punctuation">.</span><span class="token function">getData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> type<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">LocalDateTime</span> expireTime <span class="token operator">=</span> redisData<span class="token punctuation">.</span><span class="token function">getExpireTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//        判断逻辑过期时间是否在当前时间之后</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>expireTime<span class="token punctuation">.</span><span class="token function">isAfter</span><span class="token punctuation">(</span><span class="token class-name">LocalDateTime</span><span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
<span class="token comment">//        未过期返回对象信息</span>
            <span class="token keyword">return</span> cacheObj<span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
<span class="token comment">//        过期,缓存重建,获取互斥锁</span>
        <span class="token class-name">String</span> lockKey <span class="token operator">=</span> <span class="token constant">SHOP_LOCK_KEY</span> <span class="token operator">+</span> id<span class="token punctuation">;</span>
        <span class="token keyword">boolean</span> flag <span class="token operator">=</span> <span class="token function">tryLock</span><span class="token punctuation">(</span>lockKey<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">//        获取互斥锁成功,利用线程池开启独立线程,实现缓存重建</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>flag<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
            <span class="token constant">CACHE_REBUILD_EXECUTOR</span><span class="token punctuation">.</span><span class="token function">submit</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-></span> <span class="token punctuation">&#123;</span>
                <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
<span class="token comment">//                    查询数据库重建缓存</span>
                    <span class="token class-name">T</span> obj <span class="token operator">=</span> dbResult<span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token function">setCacheByAttackPass</span><span class="token punctuation">(</span>keyPrefix <span class="token operator">+</span> id<span class="token punctuation">,</span>obj<span class="token punctuation">,</span>time<span class="token punctuation">,</span>timeUnit<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">&#125;</span> <span class="token keyword">finally</span> <span class="token punctuation">&#123;</span>
                    <span class="token function">releaseLock</span><span class="token punctuation">(</span>lockKey<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">&#125;</span>
            <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
<span class="token comment">//        获取互斥锁失败，返回过期商铺信息系</span>
        <span class="token keyword">return</span> cacheObj<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token comment">//      获取锁</span>
    <span class="token keyword">private</span> <span class="token keyword">boolean</span> <span class="token function">tryLock</span><span class="token punctuation">(</span><span class="token class-name">String</span> key<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">Boolean</span> flag <span class="token operator">=</span> stringRedisTemplate<span class="token punctuation">.</span><span class="token function">opsForValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setIfAbsent</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> <span class="token string">"互斥锁"</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span><span class="token constant">SECONDS</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//        为了防止自动拆箱的过程中出现空指针的现象采用手动拆箱</span>
        <span class="token keyword">return</span> <span class="token class-name">BooleanUtil</span><span class="token punctuation">.</span><span class="token function">isTrue</span><span class="token punctuation">(</span>flag<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token comment">//    释放锁</span>
    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">releaseLock</span><span class="token punctuation">(</span><span class="token class-name">String</span> key<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        stringRedisTemplate<span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure>

<p><font color='red'>调用封装的方法：</font></p>
<figure><div class="code-wrapper"><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">//        利用逻辑过期解决缓存击穿问题</span>
        <span class="token class-name">Shop</span> shop <span class="token operator">=</span> cacheResolve<span class="token punctuation">.</span><span class="token function">cacheAttackThroughByLogicExpire</span><span class="token punctuation">(</span>
            <span class="token constant">CACHE_SHOP_KEY</span><span class="token punctuation">,</span> 
            id<span class="token punctuation">,</span> 
            <span class="token class-name">Shop</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> 
            <span class="token keyword">this</span><span class="token operator">::</span><span class="token function">getById</span><span class="token punctuation">,</span> 
            <span class="token constant">CACHE_EXPIRE_TTL</span><span class="token punctuation">,</span> 
            <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span><span class="token constant">MINUTES</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>shop <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
            <span class="token keyword">return</span> <span class="token class-name">Result</span><span class="token punctuation">.</span><span class="token function">fail</span><span class="token punctuation">(</span><span class="token string">"商户不存在！！！"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
<span class="token comment">//        返回</span>
        <span class="token keyword">return</span> <span class="token class-name">Result</span><span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span>shop<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure>

<p>测试，修改数据库数据，采用JMeter模拟高并发场景</p>
<p>控制台打印一条数据库查询信息</p>
<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20220927204824395.png" srcset="/img/loading.gif" lazyload alt="image-20220927204824395"></p>
<h1 id="14-分布式锁"><a href="#14-分布式锁" class="headerlink" title="14.分布式锁"></a>14.分布式锁</h1><h2 id="14-1分布式锁的概念"><a href="#14-1分布式锁的概念" class="headerlink" title="14.1分布式锁的概念"></a>14.1分布式锁的概念</h2><p>为了解决集群部署模式下多线程并发安全问题，引入分布式锁的概念。</p>
<p><strong>分布式锁：满足分布式系统或集群模式下多进程可见并且互斥的锁</strong></p>
<p><font color='red'>多个服务器使用同一个锁监视器。</font></p>
<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20220929141853911.png" srcset="/img/loading.gif" lazyload alt="image-20220929141853911"></p>
<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20220929142356583.png" srcset="/img/loading.gif" lazyload alt="image-20220929142356583"></p>
<h2 id="14-2分布式锁的实现方式的比较"><a href="#14-2分布式锁的实现方式的比较" class="headerlink" title="14.2分布式锁的实现方式的比较"></a>14.2分布式锁的实现方式的比较</h2><p>分布式锁的核心是实现多进程之间互斥，而满足这一点的方式有很多，常见的有三种：</p>
<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20220929142554884.png" srcset="/img/loading.gif" lazyload alt="image-20220929142554884"></p>
<p><font color='red'>在15.7.7章节使用悲观锁(synchronized)来实现一人一单功能，但是在集群部署模式下，因为synchronized锁只能局限于当前服务器的线程，所以在多个服务器之间不能实现锁共享。</font></p>
<p>&#x3D;&#x3D;因为由于Redis缓存中的数据在多个服务器之间是共享的，所以可以采用Redis的setnx来实现共享锁监视器&#x3D;&#x3D;</p>
<h2 id="14-3Redis分布式锁实现思路"><a href="#14-3Redis分布式锁实现思路" class="headerlink" title="14.3Redis分布式锁实现思路"></a>14.3Redis分布式锁实现思路</h2><p><font color='red'>Redis实现分布式锁时需要实现两个基本方法：</font></p>
<ol>
<li><p>获取锁</p>
<ul>
<li>互斥：确保只有一个线程获取锁</li>
<li>非阻塞：尝试一次，成功返回True，失败返回false</li>
</ul>
<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20220929143757097.png" srcset="/img/loading.gif" lazyload alt="image-20220929143757097"></p>
</li>
<li><p>释放锁</p>
<ul>
<li><p>手动释放</p>
</li>
<li><p>超时释放：获取锁时添加一个过期时间</p>
<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20220929143924493.png" srcset="/img/loading.gif" lazyload alt="image-20220929143924493"></p>
<p>setnx原子操作：设置过期时间并设置其原子性</p>
<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20220929145208372.png" srcset="/img/loading.gif" lazyload alt="image-20220929145208372"></p>
<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20220929143950115.png" srcset="/img/loading.gif" lazyload alt="image-20220929143950115"></p>
</li>
</ul>
</li>
</ol>
<h2 id="14-4Redis实现分布式锁初级版本"><a href="#14-4Redis实现分布式锁初级版本" class="headerlink" title="14.4Redis实现分布式锁初级版本"></a>14.4Redis实现分布式锁初级版本</h2><p>需求：定义一个类，实现下面接口，利用Redis实现分布式锁功能。</p>
<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20220929145913084.png" srcset="/img/loading.gif" lazyload alt="image-20220929145913084"></p>
<figure><div class="code-wrapper"><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ILockService</span> <span class="token keyword">implements</span> <span class="token class-name">ILock</span> <span class="token punctuation">&#123;</span>
    <span class="token annotation punctuation">@Resource</span>
    <span class="token keyword">private</span> <span class="token class-name">StringRedisTemplate</span> stringRedisTemplate<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Resource</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> keyName<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">tryLock</span><span class="token punctuation">(</span><span class="token class-name">Long</span> timeOutSec<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
<span class="token comment">//        获取线程id</span>
        <span class="token keyword">long</span> id <span class="token operator">=</span> <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//        获取锁，以当前线程的id作为value</span>
        <span class="token class-name">Boolean</span> flag <span class="token operator">=</span> stringRedisTemplate<span class="token punctuation">.</span><span class="token function">opsForValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setIfAbsent</span><span class="token punctuation">(</span><span class="token constant">DISTRI_LOCK_KEY</span> <span class="token operator">+</span> keyName<span class="token punctuation">,</span> id<span class="token operator">+</span><span class="token string">""</span><span class="token punctuation">,</span> timeOutSec<span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span><span class="token constant">SECONDS</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token class-name">BooleanUtil</span><span class="token punctuation">.</span><span class="token function">isFalse</span><span class="token punctuation">(</span>flag<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">releseLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
<span class="token comment">//        释放锁</span>
        stringRedisTemplate<span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span><span class="token constant">DISTRI_LOCK_KEY</span> <span class="token operator">+</span> keyName<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure>

<p>测试单元见 17.7.9</p>
<h2 id="14-5Redis分布式锁误删问题"><a href="#14-5Redis分布式锁误删问题" class="headerlink" title="14.5Redis分布式锁误删问题"></a>14.5Redis分布式锁误删问题</h2><p>场景描述：线程1首先获取到分布式锁，但是线程1执行过程中出现<font color='red'>业务阻塞</font>，<font color='red'>导致分布式锁没有被主动释放，超时之后才被释放。释放后，线程2开始获取到分布式锁，并开始执行业务，在此期间，线程1的业务完成，并释放分布式锁（释放的锁是线程2的锁）</font>。分布式锁被释放，其他线程就能获取到分布式锁。</p>
<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20220929171149126.png" srcset="/img/loading.gif" lazyload alt="image-20220929171149126"></p>
<p>解决分布式锁误删的方案：&#x3D;&#x3D;在释放锁之前判断Redis缓存当中线程号是否和当前线程的线程号相同，相同就是放，不同就不释放。&#x3D;&#x3D;</p>
<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20220929173645529.png" srcset="/img/loading.gif" lazyload alt="image-20220929173645529"></p>
<img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/GIF%202022-9-29%2017-45-17.gif" srcset="/img/loading.gif" lazyload alt="GIF 2022-9-29 17-45-17" style="zoom:80%;" />

<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20220929174620218.png" srcset="/img/loading.gif" lazyload alt="image-20220929174620218"></p>
<h2 id="14-6解决分布式锁的误删问题"><a href="#14-6解决分布式锁的误删问题" class="headerlink" title="14.6解决分布式锁的误删问题"></a>14.6解决分布式锁的误删问题</h2><p>需求：修改之前的分布式锁实现，满足：</p>
<p><font color='red'>1.在获取锁时存入线程标示（可以用UUID表示）</font></p>
<p><font color='red'>2.在释放锁时先获取锁中的线程标示，判断是否与当前线程标示一致</font></p>
<ul>
<li><p>如果一致则释放锁</p>
</li>
<li><p>如果不一致则不释放锁</p>
</li>
</ul>
<p>之前采用的锁标识方案为采用线程id（<font color='cornflowerblue'>线程id是自增的</font>），但是在集群模式下，<font color='red'>多个JVM有可能会产生相同的线程id，所以要加上UUID。</font></p>
<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20220929180028901.png" srcset="/img/loading.gif" lazyload alt="image-20220929180028901"></p>
<p>测试单元见17.7.10</p>
<h2 id="14-7分布式锁的原子性问题"><a href="#14-7分布式锁的原子性问题" class="headerlink" title="14.7分布式锁的原子性问题"></a>14.7分布式锁的原子性问题</h2><p>场景描述：&#x3D;&#x3D;线程1获取到分布式锁，当线程完成业务查询分布式锁标识和自己的相符后，准备释放锁时，线程阻塞 ，随后超时释放。另一个线程开始获得分布式锁，执行自己的业务。但是线程1这事从阻塞状态转为就绪状态，因为已经判断过了分布式锁标识，随后就直接释放线程2的分布式锁。&#x3D;&#x3D;</p>
<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20220929205026829.png" srcset="/img/loading.gif" lazyload alt="image-20220929205026829"></p>
<p><strong>使用Lua脚本实现<font color='red'>“判断分布式锁标识”</font>和<font color='red'>“释放锁”</font>两个业务的原子性</strong></p>
<p>Redis提供了Lua脚本功能，在一个脚本中编写多条Redis命令，确保多条命令执行时的原子性。Lua是一种编程语言，它的基本语法大家可以参考网站：<a target="_blank" rel="noopener" href="https://www.runoob.com/lua/lua-tutorial.html">https://www.runoob.com/lua/lua-tutorial.html</a></p>
<h2 id="14-8Lua脚本语言"><a href="#14-8Lua脚本语言" class="headerlink" title="14.8Lua脚本语言"></a>14.8Lua脚本语言</h2><p>Lua是一种轻量小巧的脚本语言，可以很方便的和其他程序进行集成和扩展（C#，Java…..），&#x3D;&#x3D;其设计目的是为了嵌入应用程序中，为应用程序提供灵活的扩展和定制功能。&#x3D;&#x3D;</p>
<p>在使用<code>redis</code>的过程中，发现有些时候需要<code>原子性</code>去操作redis命令，而redis的<code>lua</code>脚本正好可以实现这一功能。<strong>比如：</strong> 扣减库存操作、限流操作等等。</p>
<p>Redis提供的Lua脚本调用函数语法如下：</p>
<figure><div class="code-wrapper"><pre class="line-numbers language-lua" data-language="lua"><code class="language-lua">redis<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token string">'命令名称'</span><span class="token punctuation">,</span><span class="token string">'key'</span><span class="token punctuation">,</span><span class="token string">'其他参数'</span><span class="token punctuation">,</span><span class="token punctuation">....</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></div></figure>

<p>写好脚本以后，需要用Redis命令来调用脚本，调用脚本的常见命令如下：</p>
<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20220930114114253.png" srcset="/img/loading.gif" lazyload alt="image-20220930114114253"></p>
<p>例如，我们要执行&#x3D;&#x3D;redis.call(‘set’, ‘name’, ‘jack’)&#x3D;&#x3D;这个脚本，语法如下：</p>
<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20220930114247666.png" srcset="/img/loading.gif" lazyload alt="image-20220930114247666"></p>
<p>如果脚本中的key、value不想写死，可以作为参数传递。key类型参数会放入KEYS数组，其它参数会放入ARGV数组，在脚本中可以从KEYS和ARGV数组获取这些参数：</p>
<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20220930114152142.png" srcset="/img/loading.gif" lazyload alt="image-20220930114152142"></p>
<p>在idea中安装Lua脚本的相关插件</p>
<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20220930124512891.png" srcset="/img/loading.gif" lazyload alt="image-20220930124512891"></p>
<p>使用Lua脚本实现分布式锁的原执行操作，测试单元见15.7.11</p>
<h1 id="15-Redisson框架"><a href="#15-Redisson框架" class="headerlink" title="15.Redisson框架"></a>15.Redisson框架</h1><h2 id="15-2Redisson引入"><a href="#15-2Redisson引入" class="headerlink" title="15.2Redisson引入"></a>15.2Redisson引入</h2><p><font color='red'>基于setnx实现的分布式锁会出现以下问题：</font></p>
<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20220930175106321.png" srcset="/img/loading.gif" lazyload alt="image-20220930175106321"></p>
<h2 id="15-2Redisson框架简介"><a href="#15-2Redisson框架简介" class="headerlink" title="15.2Redisson框架简介"></a>15.2Redisson框架简介</h2><p>之前用的Redis，<code>都是用的原生的RedisTempale或者是StringRedisTemplate，各种API非常的难易记忆</code>，每次用的时候还得去网上查询API文档。</p>
<p>Redisson是一个在Redis的基础上实现的<code>Java驻内存数据网格</code>。<font color='red'>它不仅提供了一系列的分布式的Java常用对象，还提供了许多分布式服务</font>。其中就包含了各种分布式锁的实现。**<font color='cornflowerblue'>Redisson是Java的Redis客户端之一，提供了一些API方便操作Redis</font>。**</p>
<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20220930132520671.png" srcset="/img/loading.gif" lazyload alt="image-20220930132520671"></p>
<h2 id="15-3Redisson配置"><a href="#15-3Redisson配置" class="headerlink" title="15.3Redisson配置"></a>15.3Redisson配置</h2><p><strong>一：引入Redisson依赖</strong></p>
<figure><div class="code-wrapper"><pre class="line-numbers language-markup" data-language="markup"><code class="language-markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>org.redisson<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>redisson<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">></span></span>3.13.6<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure>

<p><strong>二：创建配置对象</strong></p>
<figure><div class="code-wrapper"><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Configuration</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">RedissonConfig</span> <span class="token punctuation">&#123;</span>

    <span class="token annotation punctuation">@Bean</span>
<span class="token comment">//    RedissonClient是Redisson的工厂类</span>
    <span class="token keyword">public</span> <span class="token class-name">RedissonClient</span> <span class="token function">redissonClient</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
<span class="token comment">//        创建配置对象</span>
        <span class="token class-name">Config</span> config <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Config</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//        设置redis地址和密码</span>
        config<span class="token punctuation">.</span><span class="token function">useSingleServer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setAddress</span><span class="token punctuation">(</span><span class="token string">"redis://43.143.117.57"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setPassword</span><span class="token punctuation">(</span><span class="token string">"xu123456"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//        创建RedissonClient对象</span>
        <span class="token keyword">return</span> <span class="token class-name">Redisson</span><span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure>

<p>三：在使用的类中注入RedissonClient，获取锁，释放锁</p>
<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20220930135342792.png" srcset="/img/loading.gif" lazyload alt="image-20220930135342792"></p>
<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20220930140444176.png" srcset="/img/loading.gif" lazyload alt="image-20220930140444176"></p>
<p>测试单元在15.7.12</p>
<h2 id="15-5读写锁"><a href="#15-5读写锁" class="headerlink" title="15.5读写锁"></a>15.5读写锁</h2><p>​	&#x3D;&#x3D;读写锁能够保证每次读取到的数据都是新数据。&#x3D;&#x3D;</p>
<p>​	<strong>修改数据期间：写锁是一个互斥锁，读锁是一个共享锁</strong></p>
<table>
<thead>
<tr>
<th>模式</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>读+读</td>
<td>相当于无锁，并发读</td>
</tr>
<tr>
<td>写+读</td>
<td>等待写锁释放，读锁再执行</td>
</tr>
<tr>
<td>读+写</td>
<td>等待读锁释放，写锁再执行</td>
</tr>
<tr>
<td>写+写</td>
<td>阻塞方式</td>
</tr>
</tbody></table>
<p>​		<font color='red'>写锁没有释放，读锁就必须等待</font></p>
<figure><div class="code-wrapper"><pre class="line-numbers language-java" data-language="java"><code class="language-java">    <span class="token annotation punctuation">@ResponseBody</span>
    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">"/write"</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">writeValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">String</span> uuid <span class="token operator">=</span> <span class="token constant">UUID</span><span class="token punctuation">.</span><span class="token function">randomUUID</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//        1.创建读写锁</span>
        <span class="token class-name">RReadWriteLock</span> readWriteLock <span class="token operator">=</span> redissonClient<span class="token punctuation">.</span><span class="token function">getReadWriteLock</span><span class="token punctuation">(</span><span class="token string">"readWriteLock"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
<span class="token comment">//        2.添加写锁</span>
            readWriteLock<span class="token punctuation">.</span><span class="token function">writeLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">20000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            stringRedisTemplate<span class="token punctuation">.</span><span class="token function">opsForValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">"uuid"</span><span class="token punctuation">,</span> uuid<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span> <span class="token keyword">finally</span> <span class="token punctuation">&#123;</span>
<span class="token comment">//        3.释放写锁</span>
            readWriteLock<span class="token punctuation">.</span><span class="token function">writeLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token keyword">return</span> uuid<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token annotation punctuation">@ResponseBody</span>
    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">"/read"</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">readValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
<span class="token comment">//        1.创建读写锁</span>
        <span class="token class-name">RReadWriteLock</span> readWriteLock <span class="token operator">=</span> redissonClient<span class="token punctuation">.</span><span class="token function">getReadWriteLock</span><span class="token punctuation">(</span><span class="token string">"readWriteLock"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span> uuid <span class="token operator">=</span> <span class="token string">""</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
<span class="token comment">//        2.添加读锁</span>
            readWriteLock<span class="token punctuation">.</span><span class="token function">readLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            uuid <span class="token operator">=</span> stringRedisTemplate<span class="token punctuation">.</span><span class="token function">opsForValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"uuid"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span> <span class="token keyword">finally</span> <span class="token punctuation">&#123;</span>
<span class="token comment">//         3.释放读锁</span>
            readWriteLock<span class="token punctuation">.</span><span class="token function">readLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token keyword">return</span> uuid<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure>



<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20230119164617762.png" srcset="/img/loading.gif" lazyload alt="image-20230119164617762"></p>
<h2 id="15-6信号量"><a href="#15-6信号量" class="headerlink" title="15.6信号量"></a>15.6信号量</h2><p><strong>每当释放信号量的时候，信号量字段就会加1，获取到信号量的时候信号量字段就会减1。</strong></p>
<figure><div class="code-wrapper"><pre class="line-numbers language-java" data-language="java"><code class="language-java">    <span class="token annotation punctuation">@ResponseBody</span>
    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">"/park"</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">park</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
<span class="token comment">//        1.创建信号量</span>
        <span class="token class-name">RSemaphore</span> park <span class="token operator">=</span> redissonClient<span class="token punctuation">.</span><span class="token function">getSemaphore</span><span class="token punctuation">(</span><span class="token string">"park"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
<span class="token comment">//        2.获取到信号量</span>
            park<span class="token punctuation">.</span><span class="token function">acquire</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token keyword">return</span> <span class="token string">"park"</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token annotation punctuation">@ResponseBody</span>
    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">"/go"</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">go</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
<span class="token comment">//        1.创建信号量</span>
        <span class="token class-name">RSemaphore</span> park <span class="token operator">=</span> redissonClient<span class="token punctuation">.</span><span class="token function">getSemaphore</span><span class="token punctuation">(</span><span class="token string">"park"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//        2.释放信号量</span>
        park<span class="token punctuation">.</span><span class="token function">release</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token string">"go"</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure>

<p>同时信号量也可以做分布式限流，使用<code>tryAcquire()</code>来进行判断信号量是否获取成功。</p>
<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20230119185520885.png" srcset="/img/loading.gif" lazyload alt="image-20230119185520885"></p>
<h2 id="15-7闭锁"><a href="#15-7闭锁" class="headerlink" title="15.7闭锁"></a>15.7闭锁</h2><figure><div class="code-wrapper"><pre class="line-numbers language-java" data-language="java"><code class="language-java">    <span class="token annotation punctuation">@ResponseBody</span>
    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">"/lockDoor"</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">lockDoor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">&#123;</span>
<span class="token comment">//        1.创建闭锁对象</span>
        <span class="token class-name">RCountDownLatch</span> door <span class="token operator">=</span> redissonClient<span class="token punctuation">.</span><span class="token function">getCountDownLatch</span><span class="token punctuation">(</span><span class="token string">"door"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        door<span class="token punctuation">.</span><span class="token function">trySetCount</span><span class="token punctuation">(</span><span class="token number">5L</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//        2.等待闭锁完成</span>
        door<span class="token punctuation">.</span><span class="token function">await</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token string">"可以关门了"</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token annotation punctuation">@ResponseBody</span>
    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">"/lockDoor/&#123;id&#125;"</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">vacation</span><span class="token punctuation">(</span><span class="token annotation punctuation">@PathVariable</span><span class="token punctuation">(</span><span class="token string">"id"</span><span class="token punctuation">)</span> <span class="token class-name">Long</span> id<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
<span class="token comment">//        1.创建闭锁对象</span>
        <span class="token class-name">RCountDownLatch</span> vacation <span class="token operator">=</span> redissonClient<span class="token punctuation">.</span><span class="token function">getCountDownLatch</span><span class="token punctuation">(</span><span class="token string">"door"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//        2.计算减1</span>
        vacation<span class="token punctuation">.</span><span class="token function">countDown</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> id <span class="token operator">+</span> <span class="token string">"班的人走了"</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure>



<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20230119190851118.png" srcset="/img/loading.gif" lazyload alt="image-20230119190851118"></p>
<h2 id="15-8Redisson可重入锁原理"><a href="#15-8Redisson可重入锁原理" class="headerlink" title="15.8Redisson可重入锁原理"></a>15.8Redisson可重入锁原理</h2><p>&#x3D;&#x3D;一个线程连续两次获取锁就是锁的重入。&#x3D;&#x3D;</p>
<p><code>以下方式是采用setnx自定义锁的方式，当一个线程获取到锁后，调用另一个方法再次获取到锁，但是由于是因为基于setnx实现的，再次获取所就会失败</code>。</p>
<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20220930155343521.png" srcset="/img/loading.gif" lazyload alt="image-20220930155343521"></p>
<p><font color='red'>而Redisson实现重入锁的原理就是判断获取分布式锁的线程是否是当前线程，并且记录线程获取锁的次数。</font><font color='cornflowerblue'>当当前线程再次获取分布式锁的时候获取锁的次数就会增加，释放锁后再释放。</font></p>
<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20220930155354691.png" srcset="/img/loading.gif" lazyload alt="image-20220930155354691"></p>
<p>Redisson的分布式锁的创建过程：</p>
<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20220930172621981.png" srcset="/img/loading.gif" lazyload alt="image-20220930172621981"></p>
<p>查看RedissionClient接口的实现类，实现类是Redisson</p>
<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20220930172415055.png" srcset="/img/loading.gif" lazyload alt="image-20220930172415055"></p>
<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20220930172646343.png" srcset="/img/loading.gif" lazyload alt="image-20220930172646343"></p>
<p>getLock方法中调用了<strong>RedissonLock类</strong>中的构造器</p>
<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20220930172933548.png" srcset="/img/loading.gif" lazyload alt="image-20220930172933548"></p>
<p>找到创建锁的lua脚本</p>
<figure><div class="code-wrapper"><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">></span></span> <span class="token class-name">RFuture</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">></span></span> <span class="token function">tryLockInnerAsync</span><span class="token punctuation">(</span><span class="token keyword">long</span> waitTime<span class="token punctuation">,</span> <span class="token keyword">long</span> leaseTime<span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span> unit<span class="token punctuation">,</span> <span class="token keyword">long</span> threadId<span class="token punctuation">,</span> <span class="token class-name">RedisStrictCommand</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">></span></span> command<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    internalLockLeaseTime <span class="token operator">=</span> unit<span class="token punctuation">.</span><span class="token function">toMillis</span><span class="token punctuation">(</span>leaseTime<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> <span class="token function">evalWriteAsync</span><span class="token punctuation">(</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">LongCodec</span><span class="token punctuation">.</span><span class="token constant">INSTANCE</span><span class="token punctuation">,</span> command<span class="token punctuation">,</span>
            <span class="token comment">//若锁不存在，就创建锁</span>
            <span class="token string">"if (redis.call('exists', KEYS[1]) == 0) then "</span> <span class="token operator">+</span>
                          <span class="token comment">//redis中hash的value加1</span>
                    <span class="token string">"redis.call('hincrby', KEYS[1], ARGV[2], 1); "</span> <span class="token operator">+</span>
                          <span class="token comment">//设置过期时间</span>
                    <span class="token string">"redis.call('pexpire', KEYS[1], ARGV[1]); "</span> <span class="token operator">+</span>
                    <span class="token string">"return nil; "</span> <span class="token operator">+</span>
                    <span class="token string">"end; "</span> <span class="token operator">+</span>
                          <span class="token comment">//若锁存在</span>
                    <span class="token string">"if (redis.call('hexists', KEYS[1], ARGV[2]) == 1) then "</span> <span class="token operator">+</span>
                          <span class="token comment">//hash的value加1</span>
                    <span class="token string">"redis.call('hincrby', KEYS[1], ARGV[2], 1); "</span> <span class="token operator">+</span>
                          <span class="token comment">//重设过期时间</span>
                    <span class="token string">"redis.call('pexpire', KEYS[1], ARGV[1]); "</span> <span class="token operator">+</span>
                    <span class="token string">"return nil; "</span> <span class="token operator">+</span>
                    <span class="token string">"end; "</span> <span class="token operator">+</span>
                    <span class="token string">"return redis.call('pttl', KEYS[1]);"</span><span class="token punctuation">,</span>
            <span class="token class-name">Collections</span><span class="token punctuation">.</span><span class="token function">singletonList</span><span class="token punctuation">(</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> internalLockLeaseTime<span class="token punctuation">,</span> <span class="token function">getLockName</span><span class="token punctuation">(</span>threadId<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure>



<p>测试：</p>
<figure><div class="code-wrapper"><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Slf4j</span>
<span class="token annotation punctuation">@SpringBootTest</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ThreadRedissonTest</span> <span class="token punctuation">&#123;</span>

    <span class="token annotation punctuation">@Resource</span>
    <span class="token keyword">private</span> <span class="token class-name">RedissonClient</span> redissonClient<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">RLock</span> lock<span class="token punctuation">;</span>


    <span class="token comment">//    创建锁对象</span>
    <span class="token annotation punctuation">@BeforeEach</span>
    <span class="token keyword">void</span> <span class="token function">createLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        lock <span class="token operator">=</span> redissonClient<span class="token punctuation">.</span><span class="token function">getLock</span><span class="token punctuation">(</span><span class="token constant">DISTRI_LOCK_KEY</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token annotation punctuation">@Test</span>
    <span class="token keyword">void</span> <span class="token function">method1</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
<span class="token comment">//        获取到锁</span>
        <span class="token keyword">boolean</span> flag <span class="token operator">=</span> lock<span class="token punctuation">.</span><span class="token function">tryLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>flag<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
<span class="token comment">//            获取锁失败</span>
            log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">"Method1 acquire lock fail"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
<span class="token comment">//            获取锁成功</span>
            log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"Method1 acquire lock success"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">method2</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"Method1 Begin execute work"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span> <span class="token keyword">finally</span> <span class="token punctuation">&#123;</span>
<span class="token comment">//            释放锁</span>
            log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"Method1 begin release lock"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            lock<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">void</span> <span class="token function">method2</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
<span class="token comment">//        获取到锁</span>
        <span class="token keyword">boolean</span> flag <span class="token operator">=</span> lock<span class="token punctuation">.</span><span class="token function">tryLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>flag<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">"Method2 acquire lock fail"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
            log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"Method2 acquire lock success"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"Method2 Begin execute work"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span> <span class="token keyword">finally</span> <span class="token punctuation">&#123;</span>
            <span class="token comment">//            释放锁</span>
            log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"Method2 begin release lock"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            lock<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure>



<p>执行方法1，获取锁成功，在缓存中存入锁的标识和获取重入次数，当前次数为1</p>
<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20220930163223406.png" srcset="/img/loading.gif" lazyload alt="image-20220930163223406"></p>
<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20220930163206382.png" srcset="/img/loading.gif" lazyload alt="image-20220930163206382"></p>
<p><font color='red'>执行到方法2，获取锁成功，重入次数变为2</font></p>
<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20220930164706665.png" srcset="/img/loading.gif" lazyload alt="image-20220930164706665"></p>
<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20220930164647640.png" srcset="/img/loading.gif" lazyload alt="image-20220930164647640"></p>
<p><font color='red'>方法2执行后释放锁，重入次数变为1，再执行方法1，重入次数变为0</font></p>
<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20220930164758697.png" srcset="/img/loading.gif" lazyload alt="image-20220930164758697"></p>
<p>控制台业务流程：</p>
<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20220930165209183.png" srcset="/img/loading.gif" lazyload alt="image-20220930165209183"></p>
<h2 id="15-9Redisson锁重试和WatchDog机制"><a href="#15-9Redisson锁重试和WatchDog机制" class="headerlink" title="15.9Redisson锁重试和WatchDog机制"></a>15.9Redisson锁重试和WatchDog机制</h2><p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20220930193352555.png" srcset="/img/loading.gif" lazyload alt="image-20220930193352555"></p>
<p><strong>Redisson分布式锁原理：</strong></p>
<p>•<strong>可重入</strong>：&#x3D;&#x3D;利用hash结构记录线程id和重入次数&#x3D;&#x3D;</p>
<p>•<strong>可重试</strong>：&#x3D;&#x3D;利用信号量和PubSub功能实现等待、唤醒，获取锁失败的重试机制&#x3D;&#x3D;</p>
<p>•<strong>超时续约</strong>：&#x3D;&#x3D;利用watchDog，每隔一段时间（<strong>时间间隔为<code>lockWatchdogTimeout</code>&#x2F; 3</strong>），重置超时时间。默认情况下，看门狗的检查锁的超时时间是30秒钟，也可以通过修改<code>Config.lockWatchdogTimeout</code>来另行指定。&#x3D;&#x3D;</p>
<p>​													</p>
<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20230119155718831.png" srcset="/img/loading.gif" lazyload alt="image-20230119155718831"></p>
<h2 id="15-10Redisson分布式锁主从一致性问题"><a href="#15-10Redisson分布式锁主从一致性问题" class="headerlink" title="15.10Redisson分布式锁主从一致性问题"></a>15.10Redisson分布式锁主从一致性问题</h2><p>主从一致性就是一个主节点连有两个从节点，<code>主节点和从节点之间存在主从同步</code>，当一个线程获取锁的时候，主节点存入分布式锁标识。<font color='red'>但是在未完成主从同步的时候主节点发生宕机。发生宕机后哨兵会在剩下的从节点中选出一个作为主节点，但是此主节点中并没有分布式锁标识。这就是导致主从一致性的问题。</font></p>
<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20220930193625245.png" srcset="/img/loading.gif" lazyload alt="image-20220930193625245"></p>
<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20220930195201331.png" srcset="/img/loading.gif" lazyload alt="image-20220930195201331"></p>
<p>解决主从一致性问题的方法：</p>
<p>只要有任意节点存活，其他线程就获取不到锁，不会出现锁失效问题。</p>
<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/GIF%202022-9-30%2020-01-23.gif" srcset="/img/loading.gif" lazyload alt="GIF 2022-9-30 20-01-23"></p>
<h2 id="15-11锁的粒度"><a href="#15-11锁的粒度" class="headerlink" title="15.11锁的粒度"></a>15.11锁的粒度</h2><p>如果是粗粒度锁会出现以下问题：</p>
<ul>
<li><strong>每次锁住所有的资源，导致事务碰撞率提高，影响效率</strong></li>
<li><strong>一旦发生异常影响锁的释放，会产生死锁</strong></li>
</ul>
<p>&#x3D;&#x3D;我们可以为集合中的每个资源提供一个锁，这样可以避免每次的操作都会锁住所有的资源，其次我们为每一个锁设置一个超时时间，避免<a target="_blank" rel="noopener" href="https://so.csdn.net/so/search?q=%E6%AD%BB%E9%94%81&spm=1001.2101.3001.7020">死锁</a>情况的出现。</p>
<h1 id="16-消息队列"><a href="#16-消息队列" class="headerlink" title="16.消息队列"></a>16.消息队列</h1><h2 id="16-2消息队列的概念"><a href="#16-2消息队列的概念" class="headerlink" title="16.2消息队列的概念"></a>16.2消息队列的概念</h2><p><strong>消息队列</strong>（<strong>M</strong>essage <strong>Q</strong>ueue）一般简称为MQ。&#x3D;&#x3D;是指利用高效可靠的消息传递机制进行与平台无关的数据交流，并基于数据通信来进行分布式系统的集成，是在消息的传输过程中保存消息的容器。消息队列本质上是一个队列，而队列中存放的是一个个消息。&#x3D;&#x3D;</p>
<p>最简单的消息队列模型包括3个角色：</p>
<ul>
<li><p><strong>生产者</strong>：<code>发送消息到消息队列</code></p>
</li>
<li><p><strong>消息队列</strong>：<code>存储和管理消息，也被称为消息代理</code>（Message Broker）</p>
</li>
<li><p><strong>消费者</strong>：<code>从消息队列获取消息并处理消息</code></p>
</li>
</ul>
<p>消息队列让生产者和消费者之间解耦合</p>
<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20221001171602059.png" srcset="/img/loading.gif" lazyload alt="image-20221001171602059"></p>
<p>可以采用市面上提供的消息队列，如Kafka、RabbitMQ、RocketMQ等等，但是Redis也提供了三种不同的方式来实现消息队列：</p>
<ul>
<li><p><strong>list结构</strong>：基于List结构模拟消息队列</p>
</li>
<li><p><strong>PubSub</strong>：基本的点对点消息模型</p>
</li>
<li><p><strong>Stream</strong>：比较完善的消息队列模型</p>
</li>
</ul>
<h2 id="16-3消息队列-list结构"><a href="#16-3消息队列-list结构" class="headerlink" title="16.3消息队列-list结构"></a>16.3消息队列-list结构</h2><p><font color='red'>队列底层的实现是双向链表</font>，是入口和出口不在一边，因此我们可以利用：<code>LPUSH 结合 RPOP、或者 RPUSH 结合 LPOP来实现。</code></p>
<p>&#x3D;&#x3D;不过要注意的是，当队列中没有消息时RPOP或LPOP操作会返回null，并不像JVM的阻塞队列那样会阻塞并等待消息。因此这里应该使用<strong>BRPOP</strong>或者<strong>BLPOP</strong>来实现阻塞效果。&#x3D;&#x3D;</p>
<p>Redis <code>brpop命令移出并获取列表最右侧的元素</code>。&#x3D;&#x3D;如果列表没有元素会阻塞列表直到等待超时或发现可弹出元素为止。&#x3D;&#x3D;</p>
<p>blpop是相反方向。</p>
<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/GIF%202022-10-1%2018-42-28.gif" srcset="/img/loading.gif" lazyload alt="GIF 2022-10-1 18-42-28"></p>
<p>基于List的消息队列有哪些优缺点？</p>
<p><font color='red'>优点：</font></p>
<ul>
<li><p>利用Redis存储，不受限于JVM内存上限</p>
</li>
<li><p>基于Redis的持久化机制，数据安全性有保证 </p>
</li>
<li><p>可以满足消息有序性</p>
</li>
</ul>
<p><font color='red'>缺点：</font></p>
<ul>
<li><p>无法避免消息丢失</p>
</li>
<li><p>只支持单消费者</p>
</li>
</ul>
<h2 id="16-4消息队列-PubSub"><a href="#16-4消息队列-PubSub" class="headerlink" title="16.4消息队列-PubSub"></a>16.4消息队列-PubSub</h2><p><strong>PubSub</strong>（发布订阅）是Redis2.0版本引入的消息传递模型。顾名思义，<font color='red'>消费者可以订阅一个或多个channel，生产者向对应channel发送消息后，所有订阅者都能收到相关消息。</font></p>
<ul>
<li><p><strong>SUBSCRIBE channel [channel]</strong> ：&#x3D;&#x3D;订阅一个或多个频道&#x3D;&#x3D;</p>
</li>
<li><p><strong>PUBLISH channel msg</strong> ：&#x3D;&#x3D;向一个频道发布消息&#x3D;&#x3D;</p>
</li>
<li><p><strong>PSUBSCRIBE pattern[pattern]</strong> ：&#x3D;&#x3D;订阅与pattern格式匹配的所有频道&#x3D;&#x3D;</p>
</li>
</ul>
<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/GIF%202022-10-1%2019-04-16.gif" srcset="/img/loading.gif" lazyload alt="GIF 2022-10-1 19-04-16"></p>
<p>基于PubSub的消息队列有哪些优缺点？</p>
<p><font color='red'>优点：</font></p>
<ul>
<li>采用发布订阅模型，支持多生产、多消费</li>
</ul>
<p><font color='red'>缺点：</font></p>
<ul>
<li><p>不支持数据持久化</p>
</li>
<li><p>无法避免消息丢失</p>
</li>
<li><p>消息堆积有上限，超出时数据丢失</p>
</li>
</ul>
<h2 id="16-5消息队列-Stream"><a href="#16-5消息队列-Stream" class="headerlink" title="16.5消息队列-Stream"></a>16.5消息队列-Stream</h2><p>Stream 是 Redis 5.0 引入的一种新数据类型，可以实现一个功能非常完善的消息队列。</p>
<p>发送消息的命令：</p>
<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20221001191049074.png" srcset="/img/loading.gif" lazyload alt="image-20221001191049074"></p>
<p>例如：</p>
<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20221001191109176.png" srcset="/img/loading.gif" lazyload alt="image-20221001191109176"></p>
<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20221001192200568.png" srcset="/img/loading.gif" lazyload alt="image-20221001192200568"></p>
<p>读取消息的方式1：XREAD</p>
<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20221001192250864.png" srcset="/img/loading.gif" lazyload alt="image-20221001192250864"></p>
<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20221001192409848.png" srcset="/img/loading.gif" lazyload alt="image-20221001192409848"></p>
<p><strong>XREAD阻塞方式，阻塞读取最新的消息：</strong></p>
<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20221001192547209.png" srcset="/img/loading.gif" lazyload alt="image-20221001192547209"></p>
<p>在业务开发中，我们可以循环的调用XREAD阻塞方式来查询最新消息，从而实现持续监听队列的效果，伪代码如下</p>
<p><font color='red'>阻塞读取消息队列中的最新的一条消息，最多等待2s</font></p>
<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20221001192623949.png" srcset="/img/loading.gif" lazyload alt="image-20221001192623949"></p>
<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20221001192800661.png" srcset="/img/loading.gif" lazyload alt="image-20221001192800661"></p>
<p><strong>STREAM类型消息队列的XREAD的优缺点：</strong></p>
<p><font color='red'>优点：</font></p>
<ul>
<li><p>消息可回溯</p>
</li>
<li><p>一个消息可以被多个消费者读取</p>
</li>
<li><p>可以阻塞读取</p>
</li>
</ul>
<p><font color='red'>缺点：</font></p>
<ul>
<li>有消息漏读的风险</li>
</ul>
<h1 id="17-Redis企业实战项目"><a href="#17-Redis企业实战项目" class="headerlink" title="17.Redis企业实战项目"></a>17.Redis企业实战项目</h1><h2 id="17-1项目主要业务功能"><a href="#17-1项目主要业务功能" class="headerlink" title="17.1项目主要业务功能"></a>17.1项目主要业务功能</h2><p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20220924102523302.png" srcset="/img/loading.gif" lazyload alt="image-20220924102523302"></p>
<h2 id="17-2项目架构"><a href="#17-2项目架构" class="headerlink" title="17.2项目架构"></a>17.2项目架构</h2><p>&#x3D;&#x3D;该项目是一个前后端分离项目，前端部署在Nginx动态代理服务器上。后端部署在Tomcat上面。&#x3D;&#x3D;</p>
<p>客户端向Nginx发送请求获取到静态资源，页面通过Nginx向服务端发送请求查询数据，数据可能来自于MySQL集群，也有可能来自Redis集群。</p>
<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20220924103518514.png" srcset="/img/loading.gif" lazyload alt="image-20220924103518514"></p>
<h2 id="17-3项目初始化"><a href="#17-3项目初始化" class="headerlink" title="17.3项目初始化"></a>17.3项目初始化</h2><p><strong>一：创建数据库，导入SQL文件</strong></p>
<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20220924103101946.png" srcset="/img/loading.gif" lazyload alt="image-20220924103101946"></p>
<p>其中的表有：</p>
<ul>
<li><p>ltb_user：用户表</p>
</li>
<li><p>ltb_user_info：用户详情表</p>
</li>
<li><p>ltb_shop：商户信息表</p>
</li>
<li><p>ltb_shop_type：商户类型表</p>
</li>
<li><p>ltb_blog：用户日记表（达人探店日记）</p>
</li>
<li><p>ltb_follow：用户关注表</p>
</li>
<li><p>ltb_voucher：优惠券表</p>
</li>
<li><p>ltb_voucher_order：优惠券的订单表</p>
</li>
</ul>
<p><strong>二：导入后端项目</strong></p>
<p>在Gitee中获取到远程仓库的地址</p>
<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20220924111543504.png" srcset="/img/loading.gif" lazyload alt="image-20220924111543504"></p>
<p>idea克隆项目</p>
<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20220924111609773.png" srcset="/img/loading.gif" lazyload alt="image-20220924111609773"></p>
<p>初始为master分支，切换分支为init分支</p>
<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20220924115154192.png" srcset="/img/loading.gif" lazyload alt="image-20220924115154192"></p>
<p><strong>三：pom文件内容</strong></p>
<figure><div class="code-wrapper"><pre class="line-numbers language-markup" data-language="markup"><code class="language-markup">    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependencies</span><span class="token punctuation">></span></span>
<span class="token comment">&lt;!--        redis的相关依赖--></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>spring-boot-starter-data-redis<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span>
<span class="token comment">&lt;!--        连接池--></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>org.apache.commons<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>commons-pool2<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span>
<span class="token comment">&lt;!--        Web场景启动器--></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>spring-boot-starter-web<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span>
<span class="token comment">&lt;!--        数据库驱动--></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>mysql<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>mysql-connector-java<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>scope</span><span class="token punctuation">></span></span>runtime<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>scope</span><span class="token punctuation">></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span>
<span class="token comment">&lt;!--        lombok插件--></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>org.projectlombok<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>lombok<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>optional</span><span class="token punctuation">></span></span>true<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>optional</span><span class="token punctuation">></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span>
<span class="token comment">&lt;!--        单元测试--></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>spring-boot-starter-test<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>scope</span><span class="token punctuation">></span></span>test<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>scope</span><span class="token punctuation">></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span>
<span class="token comment">&lt;!--        mybatis-plus相关依赖--></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>com.baomidou<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>mybatis-plus-boot-starter<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">></span></span>3.4.3<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span>
        <span class="token comment">&lt;!--hutool--></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>cn.hutool<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>hutool-all<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">></span></span>5.7.17<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependencies</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure>

<p>Hutool是一个小而全的Java工具类库，通过静态方法封装，降低相关<a target="_blank" rel="noopener" href="https://so.csdn.net/so/search?q=API&spm=1001.2101.3001.7020">API</a>的学习成本，提高工作效率，使Java拥有函数式语言般的优雅；<br>提供了Java基础工具类，对文件、流、<a target="_blank" rel="noopener" href="https://so.csdn.net/so/search?q=%E5%8A%A0%E5%AF%86&spm=1001.2101.3001.7020">加密</a>解密、转码、正则、线程、XML等JDK方法进行封装，组成各种Util工具类，同时提供以下组件</p>
<p>如随机工具：</p>
<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20220924134018833.png" srcset="/img/loading.gif" lazyload alt="image-20220924134018833"></p>
<p><strong>四：SpringBoot配置文件</strong></p>
<figure><div class="code-wrapper"><pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token comment"># 项目运行端口</span>
<span class="token key atrule">server</span><span class="token punctuation">:</span>
  <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">8081</span>
<span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">application</span><span class="token punctuation">:</span>
    <span class="token key atrule">name</span><span class="token punctuation">:</span> hmdp
<span class="token comment">#    MySQL的相关配置</span>
  <span class="token key atrule">datasource</span><span class="token punctuation">:</span>
    <span class="token key atrule">driver-class-name</span><span class="token punctuation">:</span> com.mysql.cj.jdbc.Driver
    <span class="token key atrule">url</span><span class="token punctuation">:</span> jdbc<span class="token punctuation">:</span>mysql<span class="token punctuation">:</span>//127.0.0.1<span class="token punctuation">:</span>3306/hmdp<span class="token punctuation">?</span>useSSL=false<span class="token important">&amp;serverTimezone=UTC</span>
    <span class="token key atrule">username</span><span class="token punctuation">:</span> root
    <span class="token key atrule">password</span><span class="token punctuation">:</span> xu123456
<span class="token comment">#    redis的相关配置</span>
  <span class="token key atrule">redis</span><span class="token punctuation">:</span>
    <span class="token key atrule">host</span><span class="token punctuation">:</span> 192.168.26.133
    <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">6379</span>
    <span class="token key atrule">password</span><span class="token punctuation">:</span> xu123456
<span class="token comment">#    lettuce连接池配置</span>
    <span class="token key atrule">lettuce</span><span class="token punctuation">:</span>
      <span class="token key atrule">pool</span><span class="token punctuation">:</span>
        <span class="token key atrule">max-active</span><span class="token punctuation">:</span> <span class="token number">10</span>
        <span class="token key atrule">max-idle</span><span class="token punctuation">:</span> <span class="token number">10</span>
        <span class="token key atrule">min-idle</span><span class="token punctuation">:</span> <span class="token number">1</span>
        <span class="token key atrule">time-between-eviction-runs</span><span class="token punctuation">:</span> 10s
  <span class="token key atrule">jackson</span><span class="token punctuation">:</span>
    <span class="token key atrule">default-property-inclusion</span><span class="token punctuation">:</span> non_null <span class="token comment"># JSON处理时忽略非空字段</span>
<span class="token key atrule">mybatis-plus</span><span class="token punctuation">:</span>
  <span class="token key atrule">type-aliases-package</span><span class="token punctuation">:</span> com.hmdp.entity <span class="token comment"># 别名扫描包</span>
<span class="token key atrule">logging</span><span class="token punctuation">:</span>
  <span class="token key atrule">level</span><span class="token punctuation">:</span>
    <span class="token key atrule">com.hmdp</span><span class="token punctuation">:</span> debug<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure>

<p><strong>五：启动项目，进行测试</strong></p>
<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20220924120346764.png" srcset="/img/loading.gif" lazyload alt="image-20220924120346764"></p>
<p><strong>六：导入前端项目</strong></p>
<p>将已经准备好的Nginx文件夹放到目录下：</p>
<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20220924121130360.png" srcset="/img/loading.gif" lazyload alt="image-20220924121130360"></p>
<p>​		该文件夹内已经准备好了前端项目</p>
<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20220924121030327.png" srcset="/img/loading.gif" lazyload alt="image-20220924121030327">	</p>
<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20220924121155161.png" srcset="/img/loading.gif" lazyload alt="image-20220924121155161"></p>
<p><strong>七：启动前端项目</strong></p>
<p>在nginx所在目录下打开一个CMD窗口，输入命令：</p>
<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20220924121341136.png" srcset="/img/loading.gif" lazyload alt="image-20220924121341136"></p>
<p>打开浏览器，打开设备工具栏，输入前端运行端口8080</p>
<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20220924121703220.png" srcset="/img/loading.gif" lazyload alt="image-20220924121703220"></p>
<h2 id="17-4基于Session短信登录"><a href="#17-4基于Session短信登录" class="headerlink" title="17.4基于Session短信登录"></a>17.4基于Session短信登录</h2><h3 id="17-4-1发送短信验证码"><a href="#17-4-1发送短信验证码" class="headerlink" title="17.4.1发送短信验证码"></a>17.4.1发送短信验证码</h3><p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20220924131940534.png" srcset="/img/loading.gif" lazyload alt="image-20220924131940534"></p>
<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20220924132419293.png" srcset="/img/loading.gif" lazyload alt="image-20220924132419293"></p>
<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20220924132453901.png" srcset="/img/loading.gif" lazyload alt="image-20220924132453901"></p>
<p>找到对应的控制器方法，调用Service层接口，传递参数phone和session</p>
<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20220924132846372.png" srcset="/img/loading.gif" lazyload alt="image-20220924132846372"></p>
<p>在Service层实现类中编写相应的业务流程</p>
<p>业务流程实现过程：&#x3D;&#x3D;用户输入手机号点击发送验证码后，首先检验手机号是否合法，如果合法就随机生成验证码，并将验证码存入session&#x3D;&#x3D;</p>
<figure><div class="code-wrapper"><pre class="line-numbers language-java" data-language="java"><code class="language-java">    <span class="token keyword">public</span> <span class="token class-name">Result</span> <span class="token function">sendCode</span><span class="token punctuation">(</span><span class="token class-name">String</span> phone<span class="token punctuation">,</span> <span class="token class-name">HttpSession</span> session<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
<span class="token comment">//        校验手机号</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">RegexUtils</span><span class="token punctuation">.</span><span class="token function">isPhoneInvalid</span><span class="token punctuation">(</span>phone<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
            <span class="token comment">//        不符合，返回错误信息</span>
            <span class="token keyword">return</span> <span class="token class-name">Result</span><span class="token punctuation">.</span><span class="token function">fail</span><span class="token punctuation">(</span><span class="token string">"手机号格式错误！"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
<span class="token comment">//        符合，随机生成6位验证码</span>
        <span class="token class-name">String</span> code <span class="token operator">=</span> <span class="token class-name">RandomUtil</span><span class="token punctuation">.</span><span class="token function">randomNumbers</span><span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//        保存验证码到session</span>
        session<span class="token punctuation">.</span><span class="token function">setAttribute</span><span class="token punctuation">(</span><span class="token string">"code"</span><span class="token punctuation">,</span>code<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//        发送验证码(打印日志信息)</span>
        log<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">"发送验证码成功，验证码为："</span><span class="token operator">+</span>code<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//        返回OK</span>
        <span class="token keyword">return</span> <span class="token class-name">Result</span><span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure>

<p>运行项目，再次测试。</p>
<p>返回成功信息</p>
<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20220924135351218.png" srcset="/img/loading.gif" lazyload alt="image-20220924135351218"></p>
<p>控制台打印日志信息</p>
<p><img src="/Redis.assets/image-20220924135440309.png" srcset="/img/loading.gif" lazyload alt="image-20220924135440309"></p>
<h3 id="17-4-2验证码登录和注册"><a href="#17-4-2验证码登录和注册" class="headerlink" title="17.4.2验证码登录和注册"></a>17.4.2验证码登录和注册</h3><p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20220924135646120.png" srcset="/img/loading.gif" lazyload alt="image-20220924135646120"></p>
<p>业务流程实现过程：&#x3D;&#x3D;当用户点击登录按钮后，获取到用户在前端提交的表格信息中的手机号和验证码，首先验证手机号是否合法，再验证输入的验证码是否和存在session中的验证码是否一致。验证完成后根据手机号查询用户状态，如果用户存在则登录，若不存在就首先创建用户。最后将用户信息存入session。&#x3D;&#x3D;</p>
<figure><div class="code-wrapper"><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">/*
* 实现登录功能
* */</span>
    <span class="token keyword">public</span> <span class="token class-name">Result</span> <span class="token function">login</span><span class="token punctuation">(</span><span class="token class-name">LoginFormDTO</span> loginForm<span class="token punctuation">,</span> <span class="token class-name">HttpSession</span> session<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
<span class="token comment">//        获取到用户输入的手机号和验证码</span>
        <span class="token class-name">String</span> phone <span class="token operator">=</span> loginForm<span class="token punctuation">.</span><span class="token function">getPhone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span> code <span class="token operator">=</span> loginForm<span class="token punctuation">.</span><span class="token function">getCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//        校验手机号</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">RegexUtils</span><span class="token punctuation">.</span><span class="token function">isPhoneInvalid</span><span class="token punctuation">(</span>phone<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
            <span class="token keyword">return</span> <span class="token class-name">Result</span><span class="token punctuation">.</span><span class="token function">fail</span><span class="token punctuation">(</span><span class="token string">"手机号格式有误！"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
<span class="token comment">//        校验验证码</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>loginForm<span class="token punctuation">.</span><span class="token function">getCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> <span class="token operator">!</span>session<span class="token punctuation">.</span><span class="token function">getAttribute</span><span class="token punctuation">(</span><span class="token string">"code"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>code<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
<span class="token comment">//        不一致，提示错误信息</span>
            <span class="token keyword">return</span> <span class="token class-name">Result</span><span class="token punctuation">.</span><span class="token function">fail</span><span class="token punctuation">(</span><span class="token string">"验证码错误！"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
<span class="token comment">//        一致,根据手机号查询用户</span>
        <span class="token class-name">User</span> user <span class="token operator">=</span> <span class="token function">query</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">eq</span><span class="token punctuation">(</span><span class="token string">"phone"</span><span class="token punctuation">,</span> phone<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">one</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//        判断用户是否存在</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>user <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
<span class="token comment">//        不存在,创建新用户并保存</span>
           user <span class="token operator">=</span> <span class="token function">createUserWithPhone</span><span class="token punctuation">(</span>phone<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
<span class="token comment">//        保存用户信息到session当中</span>
        session<span class="token punctuation">.</span><span class="token function">setAttribute</span><span class="token punctuation">(</span><span class="token string">"user"</span><span class="token punctuation">,</span>user<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token class-name">Result</span><span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

<span class="token comment">/*
*   创建新用户
* */</span>
    <span class="token keyword">private</span> <span class="token class-name">User</span> <span class="token function">createUserWithPhone</span><span class="token punctuation">(</span><span class="token class-name">String</span> phone<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">User</span> user <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">User</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        user<span class="token punctuation">.</span><span class="token function">setPhone</span><span class="token punctuation">(</span>phone<span class="token punctuation">)</span><span class="token punctuation">;</span>
        user<span class="token punctuation">.</span><span class="token function">setNickName</span><span class="token punctuation">(</span><span class="token constant">USER_NICK_NAME_PREFIX</span> <span class="token operator">+</span> <span class="token class-name">RandomUtil</span><span class="token punctuation">.</span><span class="token function">randomString</span><span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//      保存用户</span>
        <span class="token function">save</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> user<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure>

<h3 id="17-4-3拦截器实现登陆验证"><a href="#17-4-3拦截器实现登陆验证" class="headerlink" title="17.4.3拦截器实现登陆验证"></a>17.4.3拦截器实现登陆验证</h3><p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20220924150514674.png" srcset="/img/loading.gif" lazyload alt="image-20220924150514674"></p>
<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20220924153254648.png" srcset="/img/loading.gif" lazyload alt="image-20220924153254648"></p>
<p>业务流程实现过程：&#x3D;&#x3D;当用户执行登录的时候，已经在sessino中存入了用户的相关信息。用户登录状态的校验在很多地方都需要执行，这样就会比较麻烦，所以配置拦截器来做用户登陆验证。所以在前端向Controller层发送请求的时候，都会先由拦截器判断用户的登录状态，如果用户信息已经在session中就证明用户已经登录，否则返回401状态码。&#x3D;&#x3D;</p>
<figure><div class="code-wrapper"><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">LoginIntercepter</span> <span class="token keyword">implements</span> <span class="token class-name">HandlerInterceptor</span> <span class="token punctuation">&#123;</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">preHandle</span><span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">,</span> <span class="token class-name">HttpServletResponse</span> response<span class="token punctuation">,</span> <span class="token class-name">Object</span> handler<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">&#123;</span>
<span class="token comment">//        获取到session</span>
        <span class="token class-name">HttpSession</span> session <span class="token operator">=</span> request<span class="token punctuation">.</span><span class="token function">getSession</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//        获取到session中的用户信息</span>
        <span class="token class-name">Object</span> user <span class="token operator">=</span> session<span class="token punctuation">.</span><span class="token function">getAttribute</span><span class="token punctuation">(</span><span class="token string">"user"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//        判断用户是否存在</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>user <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
<span class="token comment">//        不存在就拦截</span>
            response<span class="token punctuation">.</span><span class="token function">setStatus</span><span class="token punctuation">(</span><span class="token number">401</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
<span class="token comment">//        存在，保存用户信息到ThreadLocal(存在线程当中)</span>
        <span class="token class-name">UserHolder</span><span class="token punctuation">.</span><span class="token function">saveUser</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">User</span><span class="token punctuation">)</span> user<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//        放行</span>
        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">afterCompletion</span><span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">,</span> <span class="token class-name">HttpServletResponse</span> response<span class="token punctuation">,</span> <span class="token class-name">Object</span> handler<span class="token punctuation">,</span> <span class="token class-name">Exception</span> ex<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">&#123;</span>
<span class="token comment">//        移除用户</span>
        <span class="token class-name">UserHolder</span><span class="token punctuation">.</span><span class="token function">removeUser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure>

<p>配置拦截器规则</p>
<figure><div class="code-wrapper"><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">//    添加拦截器</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">addInterceptors</span><span class="token punctuation">(</span><span class="token class-name">InterceptorRegistry</span> registry<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        registry<span class="token punctuation">.</span><span class="token function">addInterceptor</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">LoginIntercepter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token comment">//                排除拦截的路径</span>
                <span class="token punctuation">.</span><span class="token function">excludePathPatterns</span><span class="token punctuation">(</span>
                        <span class="token string">"/user/code"</span><span class="token punctuation">,</span>
                        <span class="token string">"/user/login"</span><span class="token punctuation">,</span>
                        <span class="token string">"/blog/hot"</span><span class="token punctuation">,</span>
                        <span class="token string">"/shop/**"</span><span class="token punctuation">,</span>
                        <span class="token string">"/shop-type/**"</span><span class="token punctuation">,</span>
                        <span class="token string">"/upload/**"</span><span class="token punctuation">,</span>
                        <span class="token string">"/voucher/**"</span>
                <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure>

<p>测试登录成功，显示用户信息。</p>
<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20220924155609880.png" srcset="/img/loading.gif" lazyload alt="image-20220924155609880"></p>
<h3 id="17-4-4隐藏用户敏感信息"><a href="#17-4-4隐藏用户敏感信息" class="headerlink" title="17.4.4隐藏用户敏感信息"></a>17.4.4隐藏用户敏感信息</h3><p>从响应信息中可以看出存在用户的敏感信息，如手机号，密码等等。这是因为向session中存入对象时是将用户的所有属性都存了进去。</p>
<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20220924170943721.png" srcset="/img/loading.gif" lazyload alt="image-20220924170943721"></p>
<p>下面进行隐藏用户的敏感信息，即更改存储到session中的对象属性</p>
<p>UserDTO只有以下三个属性，刚好满足我们的需求。</p>
<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20220924171410258.png" srcset="/img/loading.gif" lazyload alt="image-20220924171410258"></p>
<p>&#x3D;&#x3D;采用hutool的对象拷贝方法实现根据数据源对象获取到新对象，即存入session的对象类型为UserDTO&#x3D;&#x3D;</p>
<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20220924171745879.png" srcset="/img/loading.gif" lazyload alt="image-20220924171745879"></p>
<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20220924172501501.png" srcset="/img/loading.gif" lazyload alt="image-20220924172501501"></p>
<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20220924172420153.png" srcset="/img/loading.gif" lazyload alt="image-20220924172420153"></p>
<h3 id="17-4-5集群的session的共享问题"><a href="#17-4-5集群的session的共享问题" class="headerlink" title="17.4.5集群的session的共享问题"></a>17.4.5集群的session的共享问题</h3><p><strong>session</strong>共享问题：<font color='red'>多台Tomcat并不共享session存储空间，当请求切换到不同tomcat服务时导致数据丢失的问题。</font></p>
<p>session的替换方案应该满足以下特点：</p>
<ul>
<li>数据共享</li>
<li>内存存储</li>
<li>key、value结构</li>
</ul>
<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20220924172844522.png" srcset="/img/loading.gif" lazyload alt="image-20220924172844522"></p>
<h2 id="17-5基于Redis实现短信登录"><a href="#17-5基于Redis实现短信登录" class="headerlink" title="17.5基于Redis实现短信登录"></a>17.5基于Redis实现短信登录</h2><h3 id="17-5-1为什么要使用redis代替session"><a href="#17-5-1为什么要使用redis代替session" class="headerlink" title="17.5.1为什么要使用redis代替session"></a>17.5.1为什么要使用redis代替session</h3><p>&#x3D;&#x3D;前面已经提到，当项目部署在一个服务器当中的时候，session可以实现共享。但是负载均衡操作时将一个项目部署在多台服务器上，那么服务器之间的session共享问题就很显而易见了，如果多台服务器之间相互拷贝必将造成数据冗余和存储压力。所以采用Redis做持久化缓存就很有必要，它可以实现存储数据可以在多台服务器之间进行共享。&#x3D;&#x3D;</p>
<h3 id="17-5-1Redis代替session的业务流程"><a href="#17-5-1Redis代替session的业务流程" class="headerlink" title="17.5.1Redis代替session的业务流程"></a>17.5.1Redis代替session的业务流程</h3><p>redis替代短信验证码的业务流程</p>
<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20220924174302871.png" srcset="/img/loading.gif" lazyload alt="image-20220924174302871"></p>
<p>redis替代校验登录状态的业务流程</p>
<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20220924174321935.png" srcset="/img/loading.gif" lazyload alt="image-20220924174321935"></p>
<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20220924173950100.png" srcset="/img/loading.gif" lazyload alt="image-20220924173950100"></p>
<h3 id="17-5-2-Redis实现短信登录"><a href="#17-5-2-Redis实现短信登录" class="headerlink" title="17.5.2 Redis实现短信登录"></a>17.5.2 Redis实现短信登录</h3><figure><div class="code-wrapper"><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Slf4j</span>
<span class="token annotation punctuation">@Service</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">UserServiceImpl</span> <span class="token keyword">extends</span> <span class="token class-name">ServiceImpl</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">UserMapper</span><span class="token punctuation">,</span> <span class="token class-name">User</span><span class="token punctuation">></span></span> <span class="token keyword">implements</span> <span class="token class-name">IUserService</span> <span class="token punctuation">&#123;</span>
    <span class="token annotation punctuation">@Resource</span>
    <span class="token keyword">private</span> <span class="token class-name">StringRedisTemplate</span> stringRedisTemplate<span class="token punctuation">;</span>

<span class="token comment">/*
* 获取到验证码
* */</span>
    <span class="token keyword">public</span> <span class="token class-name">Result</span> <span class="token function">sendCode</span><span class="token punctuation">(</span><span class="token class-name">String</span> phone<span class="token punctuation">,</span> <span class="token class-name">HttpSession</span> session<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
<span class="token comment">//        校验手机号</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">RegexUtils</span><span class="token punctuation">.</span><span class="token function">isPhoneInvalid</span><span class="token punctuation">(</span>phone<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
            <span class="token comment">//        不符合，返回错误信息</span>
            <span class="token keyword">return</span> <span class="token class-name">Result</span><span class="token punctuation">.</span><span class="token function">fail</span><span class="token punctuation">(</span><span class="token string">"手机号格式错误！"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
<span class="token comment">//        符合，随机生成6位验证码</span>
        <span class="token class-name">String</span> code <span class="token operator">=</span> <span class="token class-name">RandomUtil</span><span class="token punctuation">.</span><span class="token function">randomNumbers</span><span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">//        分别以phone和code为key-value保存验证码到redis</span>
        stringRedisTemplate<span class="token punctuation">.</span><span class="token function">opsForValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token constant">LOGIN_CODE_KEY</span> <span class="token operator">+</span> phone<span class="token punctuation">,</span>code<span class="token punctuation">,</span><span class="token constant">LOGIN_CODE_TTL</span><span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span><span class="token constant">MINUTES</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//        发送验证码(打印日志信息)</span>
        log<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">"发送验证码成功，验证码为："</span><span class="token operator">+</span>code<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">//        返回OK</span>
        <span class="token keyword">return</span> <span class="token class-name">Result</span><span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

<span class="token comment">/*
* 实现登录功能
* */</span>
    <span class="token keyword">public</span> <span class="token class-name">Result</span> <span class="token function">login</span><span class="token punctuation">(</span><span class="token class-name">LoginFormDTO</span> loginForm<span class="token punctuation">,</span> <span class="token class-name">HttpSession</span> session<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
<span class="token comment">//        获取到用户输入的手机号和验证码</span>
        <span class="token class-name">String</span> phone <span class="token operator">=</span> loginForm<span class="token punctuation">.</span><span class="token function">getPhone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span> code <span class="token operator">=</span> loginForm<span class="token punctuation">.</span><span class="token function">getCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">//        校验手机号</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">RegexUtils</span><span class="token punctuation">.</span><span class="token function">isPhoneInvalid</span><span class="token punctuation">(</span>phone<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
            <span class="token keyword">return</span> <span class="token class-name">Result</span><span class="token punctuation">.</span><span class="token function">fail</span><span class="token punctuation">(</span><span class="token string">"手机号格式有误！"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
<span class="token comment">//        从redis获取到验证码并校验</span>
        <span class="token class-name">String</span> redisCode <span class="token operator">=</span> stringRedisTemplate<span class="token punctuation">.</span><span class="token function">opsForValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token constant">LOGIN_CODE_KEY</span> <span class="token operator">+</span> phone<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>loginForm<span class="token punctuation">.</span><span class="token function">getCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> <span class="token operator">!</span>redisCode<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>code<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
<span class="token comment">//        不一致，提示错误信息</span>
            <span class="token keyword">return</span> <span class="token class-name">Result</span><span class="token punctuation">.</span><span class="token function">fail</span><span class="token punctuation">(</span><span class="token string">"验证码错误！"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>

<span class="token comment">//        一致,根据手机号查询用户</span>
        <span class="token class-name">User</span> user <span class="token operator">=</span> <span class="token function">query</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">eq</span><span class="token punctuation">(</span><span class="token string">"phone"</span><span class="token punctuation">,</span> phone<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">one</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//        判断用户是否存在</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>user <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
<span class="token comment">//        不存在,创建新用户并保存</span>
           user <span class="token operator">=</span> <span class="token function">createUserWithPhone</span><span class="token punctuation">(</span>phone<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>

<span class="token comment">//        存储用户信息到redis</span>
<span class="token comment">//        随机生成token,作为登录令牌</span>
        <span class="token class-name">String</span> token <span class="token operator">=</span> <span class="token constant">UUID</span><span class="token punctuation">.</span><span class="token function">randomUUID</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//        对象拷贝</span>
        <span class="token class-name">UserDTO</span> userDTO <span class="token operator">=</span> <span class="token class-name">BeanUtil</span><span class="token punctuation">.</span><span class="token function">copyProperties</span><span class="token punctuation">(</span>user<span class="token punctuation">,</span> <span class="token class-name">UserDTO</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//        将对象转为HashMap类型(方便后续向redis中批量存储),其中要将id类型由Long转为String，因为stringRedisTemplate只支持字符串类型</span>
        <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">></span></span> userMap <span class="token operator">=</span> <span class="token class-name">BeanUtil</span><span class="token punctuation">.</span><span class="token function">beanToMap</span><span class="token punctuation">(</span>
                userDTO<span class="token punctuation">,</span>
                <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token class-name">CopyOptions</span><span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setFieldValueEditor</span><span class="token punctuation">(</span><span class="token punctuation">(</span>fieldName<span class="token punctuation">,</span> fieldValue<span class="token punctuation">)</span> <span class="token operator">-></span> fieldValue<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//        存储对象采用Hash结构</span>
        stringRedisTemplate<span class="token punctuation">.</span><span class="token function">opsForHash</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">putAll</span><span class="token punctuation">(</span><span class="token constant">LOGIN_USER_TOKEN</span> <span class="token operator">+</span> token<span class="token punctuation">,</span>userMap<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//        设置过期时间</span>
        stringRedisTemplate<span class="token punctuation">.</span><span class="token function">expire</span><span class="token punctuation">(</span><span class="token constant">LOGIN_USER_TOKEN</span> <span class="token operator">+</span> token<span class="token punctuation">,</span><span class="token constant">LOGIN_USER_TTL</span><span class="token punctuation">,</span><span class="token class-name">TimeUnit</span><span class="token punctuation">.</span><span class="token constant">MINUTES</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token class-name">Result</span><span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span>token<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

<span class="token comment">/*
*   创建新用户
* */</span>
    <span class="token keyword">private</span> <span class="token class-name">User</span> <span class="token function">createUserWithPhone</span><span class="token punctuation">(</span><span class="token class-name">String</span> phone<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">User</span> user <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">User</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        user<span class="token punctuation">.</span><span class="token function">setPhone</span><span class="token punctuation">(</span>phone<span class="token punctuation">)</span><span class="token punctuation">;</span>
        user<span class="token punctuation">.</span><span class="token function">setNickName</span><span class="token punctuation">(</span><span class="token constant">USER_NICK_NAME_PREFIX</span> <span class="token operator">+</span> <span class="token class-name">RandomUtil</span><span class="token punctuation">.</span><span class="token function">randomString</span><span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//      保存用户</span>
        <span class="token function">save</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> user<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure>



<p>&#x3D;&#x3D;在拦截器中设置redis存储中登录对象的过期时间，因为拦截器可以检测用户的登录状态，只要前端向后端发送请求拦截器就会判断用户的登录状态，如果用户处在登录状态，就重设redis缓存的过期时间&#x3D;&#x3D;</p>
<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20220924235848837.png" srcset="/img/loading.gif" lazyload alt="image-20220924235848837"></p>
<p><font color='red'>但是如果只有一个拦截器，当用户访问公共资源的时候并不会触发拦截器，这就导致当用户一直停留在公共资源的时候redis缓存中的数据更新时间并不会发生变化，直到缓存数据失效，用户登录状态变为未登录。</font></p>
<p>&#x3D;&#x3D;为解决以上问题，采用两个拦截器优化，第一个拦截器拦截所有路径，负责将用户信息存入redis缓存，存入线程并刷新token有效期。第二个只判断线程中是否有用户信息，没有就拦截。&#x3D;&#x3D;</p>
<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20220925000215851.png" srcset="/img/loading.gif" lazyload alt="image-20220925000215851"></p>
<p><font color='red'>存储用户信息，更新token的拦截器</font></p>
<figure><div class="code-wrapper"><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span>  <span class="token class-name">RefreshTokenIntercepter</span> <span class="token keyword">implements</span> <span class="token class-name">HandlerInterceptor</span> <span class="token punctuation">&#123;</span>
<span class="token comment">/*
*  为什么拦截器中不能注入Bean？主要原因就是springboot拦截器是在Bean实例化之前执行的，Bean实例无法注入，
  拦截器中没有实例化StringRedisTemplate，需要在加入拦截器之前，先进行bean处理。
* */</span>
    <span class="token keyword">private</span> <span class="token class-name">StringRedisTemplate</span> stringRedisTemplate<span class="token punctuation">;</span>

<span class="token comment">//    采用构造函数注入</span>
    <span class="token keyword">public</span> <span class="token class-name">RefreshTokenIntercepter</span><span class="token punctuation">(</span><span class="token class-name">StringRedisTemplate</span> stringRedisTemplate<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>stringRedisTemplate <span class="token operator">=</span> stringRedisTemplate<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">preHandle</span><span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">,</span> <span class="token class-name">HttpServletResponse</span> response<span class="token punctuation">,</span> <span class="token class-name">Object</span> handler<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">&#123;</span>
<span class="token comment">//        获取到前端请求头中的token</span>
        <span class="token class-name">String</span> token <span class="token operator">=</span> request<span class="token punctuation">.</span><span class="token function">getHeader</span><span class="token punctuation">(</span><span class="token string">"authorization"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">//        使用工具类判断字符串是否为空</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">StrUtil</span><span class="token punctuation">.</span><span class="token function">isBlank</span><span class="token punctuation">(</span>token<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
            <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
<span class="token comment">//        基于Token获取到redis中的用户</span>
        <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Object</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">></span></span> userMap <span class="token operator">=</span> stringRedisTemplate<span class="token punctuation">.</span><span class="token function">opsForHash</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">entries</span><span class="token punctuation">(</span><span class="token constant">LOGIN_USER_TOKEN</span> <span class="token operator">+</span> token<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//        判断用户是否存在</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>userMap<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
            <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
<span class="token comment">//        将查询到的Hash数据转为UserDTO对象</span>
        <span class="token class-name">UserDTO</span> userDTO <span class="token operator">=</span> <span class="token class-name">BeanUtil</span><span class="token punctuation">.</span><span class="token function">fillBeanWithMap</span><span class="token punctuation">(</span>userMap<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">UserDTO</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//        存在，保存用户信息到ThreadLocal(存在线程当中)</span>
        <span class="token class-name">UserHolder</span><span class="token punctuation">.</span><span class="token function">saveUser</span><span class="token punctuation">(</span>userDTO<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//        刷新token的有效期</span>
        stringRedisTemplate<span class="token punctuation">.</span><span class="token function">expire</span><span class="token punctuation">(</span><span class="token constant">LOGIN_USER_TOKEN</span> <span class="token operator">+</span> token<span class="token punctuation">,</span><span class="token constant">LOGIN_USER_TTL</span><span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span><span class="token constant">MINUTES</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//        放行</span>
        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">afterCompletion</span><span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">,</span> <span class="token class-name">HttpServletResponse</span> response<span class="token punctuation">,</span> <span class="token class-name">Object</span> handler<span class="token punctuation">,</span> <span class="token class-name">Exception</span> ex<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">&#123;</span>
<span class="token comment">//        移除用户</span>
        <span class="token class-name">UserHolder</span><span class="token punctuation">.</span><span class="token function">removeUser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure>

<p>登录拦截器，用于专门验证用户登录状态</p>
<figure><div class="code-wrapper"><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">LoginIntercepter</span> <span class="token keyword">implements</span> <span class="token class-name">HandlerInterceptor</span> <span class="token punctuation">&#123;</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">preHandle</span><span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">,</span> <span class="token class-name">HttpServletResponse</span> response<span class="token punctuation">,</span> <span class="token class-name">Object</span> handler<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"这里是登录验证拦截器"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//        判断是否需要进行拦截（ThreadLocal中是否有用户）</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">UserHolder</span><span class="token punctuation">.</span><span class="token function">getUser</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
            response<span class="token punctuation">.</span><span class="token function">setStatus</span><span class="token punctuation">(</span><span class="token number">401</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">afterCompletion</span><span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">,</span> <span class="token class-name">HttpServletResponse</span> response<span class="token punctuation">,</span> <span class="token class-name">Object</span> handler<span class="token punctuation">,</span> <span class="token class-name">Exception</span> ex<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">&#123;</span>
<span class="token comment">//        移除用户</span>
        <span class="token class-name">UserHolder</span><span class="token punctuation">.</span><span class="token function">removeUser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure>

<p><font color='cornflowerblue'>拦截器的配置，设置拦截器等级，让刷新token、存储用户信息的拦截器首先执行，登录验证拦截器后执行。</font></p>
<figure><div class="code-wrapper"><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Configuration</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MvcConfig</span> <span class="token keyword">implements</span> <span class="token class-name">WebMvcConfigurer</span> <span class="token punctuation">&#123;</span>

    <span class="token annotation punctuation">@Resource</span>
    <span class="token keyword">private</span> <span class="token class-name">StringRedisTemplate</span> stringRedisTemplate<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Override</span>
<span class="token comment">//    登录拦截器</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">addInterceptors</span><span class="token punctuation">(</span><span class="token class-name">InterceptorRegistry</span> registry<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        registry<span class="token punctuation">.</span><span class="token function">addInterceptor</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">LoginIntercepter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token comment">//                排除拦截的路径</span>
                <span class="token punctuation">.</span><span class="token function">excludePathPatterns</span><span class="token punctuation">(</span>
                        <span class="token string">"/user/code"</span><span class="token punctuation">,</span>
                        <span class="token string">"/user/login"</span><span class="token punctuation">,</span>
                        <span class="token string">"/blog/hot"</span><span class="token punctuation">,</span>
                        <span class="token string">"/shop/**"</span><span class="token punctuation">,</span>
                        <span class="token string">"/shop-type/**"</span><span class="token punctuation">,</span>
                        <span class="token string">"/upload/**"</span><span class="token punctuation">,</span>
                        <span class="token string">"/voucher/**"</span>
                <span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">order</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//        token刷新拦截器</span>
        registry<span class="token punctuation">.</span><span class="token function">addInterceptor</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">RefreshTokenIntercepter</span><span class="token punctuation">(</span>stringRedisTemplate<span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">addPathPatterns</span><span class="token punctuation">(</span>
<span class="token comment">//              拦截所有请求,order控制拦截器的执行顺序，数字越小执行等级越高</span>
                <span class="token string">"/**"</span>
        <span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">order</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure>

<p>查看存在redis中的验证码</p>
<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20220924230254706.png" srcset="/img/loading.gif" lazyload alt="image-20220924230254706"></p>
<p>请求头中的token设置方式：</p>
<p>​		当调用login接口后，service层会返回toekn字符串，再经由控制层返回给前端，前端将token信息保存到sessionStorage会话存储中。</p>
<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20220925104751495.png" srcset="/img/loading.gif" lazyload alt="image-20220925104751495"></p>
<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20220925104812003.png" srcset="/img/loading.gif" lazyload alt="image-20220925104812003"></p>
<p><font color='red'>在前端设置拦截器，每次发送请求时都会从sessionStorage获取到token，并在请求头中添加token信息</font></p>
<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20220925105113613.png" srcset="/img/loading.gif" lazyload alt="image-20220925105113613"></p>
<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20220925104347290.png" srcset="/img/loading.gif" lazyload alt="image-20220925104347290"></p>
<p>&#x3D;&#x3D;有了请求头中的token， 就能够在后端拦截器中获取到token，进而通过token去获取到存储在redis中的用户信息，刷新用户信息存储时间&#x3D;&#x3D;</p>
<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20220925104208714.png" srcset="/img/loading.gif" lazyload alt="image-20220925104208714"></p>
<p>重新发送请求后token过期时间刷新</p>
<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20220925104229998.png" srcset="/img/loading.gif" lazyload alt="image-20220925104229998"></p>
<h2 id="17-6商户查询缓存"><a href="#17-6商户查询缓存" class="headerlink" title="17.6商户查询缓存"></a>17.6商户查询缓存</h2><h3 id="17-6-1添加商户缓存"><a href="#17-6-1添加商户缓存" class="headerlink" title="17.6.1添加商户缓存"></a>17.6.1添加商户缓存</h3><p>添加商户缓存业务流程图</p>
<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20220925114703860.png" srcset="/img/loading.gif" lazyload alt="image-20220925114703860"></p>
<figure><div class="code-wrapper"><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">//    根据id查询商户信息</span>
    <span class="token keyword">public</span> <span class="token class-name">Result</span> <span class="token function">queryById</span><span class="token punctuation">(</span><span class="token class-name">Long</span> id<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
<span class="token comment">//        从redis查询用户缓存</span>
        <span class="token class-name">String</span> shopStr <span class="token operator">=</span> stringRedisTemplate<span class="token punctuation">.</span><span class="token function">opsForValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token constant">CACHE_SHOP_KEY</span> <span class="token operator">+</span> id<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//        判断是否存在</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">StrUtil</span><span class="token punctuation">.</span><span class="token function">isNotBlank</span><span class="token punctuation">(</span>shopStr<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
<span class="token comment">//        存在，直接返回</span>
            <span class="token class-name">Shop</span> shop <span class="token operator">=</span> <span class="token class-name">JSONUtil</span><span class="token punctuation">.</span><span class="token function">toBean</span><span class="token punctuation">(</span>shopStr<span class="token punctuation">,</span> <span class="token class-name">Shop</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token class-name">Result</span><span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span>shop<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>

<span class="token comment">//        不存在，根据id查询关系型数据库</span>
        <span class="token class-name">Shop</span> shopById <span class="token operator">=</span> <span class="token function">getById</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//        关系型数据库中不存在就返回错误</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>shopById <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
            <span class="token keyword">return</span> <span class="token class-name">Result</span><span class="token punctuation">.</span><span class="token function">fail</span><span class="token punctuation">(</span><span class="token string">"店铺不存在！"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>

<span class="token comment">//        存在就写入缓存</span>
        stringRedisTemplate<span class="token punctuation">.</span><span class="token function">opsForValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token constant">CACHE_SHOP_KEY</span> <span class="token operator">+</span> id<span class="token punctuation">,</span><span class="token class-name">JSONUtil</span><span class="token punctuation">.</span><span class="token function">toJsonStr</span><span class="token punctuation">(</span>shopById<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">//        返回</span>
        <span class="token keyword">return</span> <span class="token class-name">Result</span><span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span>shopById<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure>

<p>查看缓存</p>
<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20220925143553182.png" srcset="/img/loading.gif" lazyload alt="image-20220925143553182"></p>
<h3 id="17-6-2采用缓存更新策略优化商户缓存"><a href="#17-6-2采用缓存更新策略优化商户缓存" class="headerlink" title="17.6.2采用缓存更新策略优化商户缓存"></a>17.6.2采用缓存更新策略优化商户缓存</h3><p>修改ShopController中的业务逻辑，满足下面的需求：</p>
<p>&#x3D;&#x3D;①根据id查询店铺时，如果缓存未命中，则查询数据库，将数据库结果写入缓存，并设置超时时间&#x3D;&#x3D;</p>
<p>&#x3D;&#x3D;②根据id修改店铺时，先修改数据库，再删除缓存&#x3D;&#x3D;</p>
<p>在添加缓存的时候设置过期时间</p>
<figure><div class="code-wrapper"><pre class="line-numbers language-java" data-language="java"><code class="language-java">    <span class="token annotation punctuation">@Resource</span>
    <span class="token class-name">StringRedisTemplate</span> stringRedisTemplate<span class="token punctuation">;</span>

<span class="token comment">//    根据id查询商户信息</span>
    <span class="token keyword">public</span> <span class="token class-name">Result</span> <span class="token function">queryById</span><span class="token punctuation">(</span><span class="token class-name">Long</span> id<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
<span class="token comment">//        从redis查询用户缓存</span>
        <span class="token class-name">String</span> shopStr <span class="token operator">=</span> stringRedisTemplate<span class="token punctuation">.</span><span class="token function">opsForValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token constant">CACHE_SHOP_KEY</span> <span class="token operator">+</span> id<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//        判断是否存在</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">StrUtil</span><span class="token punctuation">.</span><span class="token function">isNotBlank</span><span class="token punctuation">(</span>shopStr<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
<span class="token comment">//        存在，直接返回</span>
            <span class="token class-name">Shop</span> shop <span class="token operator">=</span> <span class="token class-name">JSONUtil</span><span class="token punctuation">.</span><span class="token function">toBean</span><span class="token punctuation">(</span>shopStr<span class="token punctuation">,</span> <span class="token class-name">Shop</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token class-name">Result</span><span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span>shop<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>

<span class="token comment">//        不存在，根据id查询关系型数据库</span>
        <span class="token class-name">Shop</span> shopById <span class="token operator">=</span> <span class="token function">getById</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//        关系型数据库中不存在就返回错误</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>shopById <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
            <span class="token keyword">return</span> <span class="token class-name">Result</span><span class="token punctuation">.</span><span class="token function">fail</span><span class="token punctuation">(</span><span class="token string">"店铺不存在！"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>

<span class="token comment">//        存在就写入缓存,并设置缓存过期时间</span>
        stringRedisTemplate<span class="token punctuation">.</span><span class="token function">opsForValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token constant">CACHE_SHOP_KEY</span> <span class="token operator">+</span> id<span class="token punctuation">,</span><span class="token class-name">JSONUtil</span><span class="token punctuation">.</span><span class="token function">toJsonStr</span><span class="token punctuation">(</span>shopById<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token constant">CACHE_EXPIRE_TTL</span><span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span><span class="token constant">MINUTES</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">//        返回</span>
        <span class="token keyword">return</span> <span class="token class-name">Result</span><span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span>shopById<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure>

<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20220925165509965.png" srcset="/img/loading.gif" lazyload alt="image-20220925165509965"></p>
<p>找到shopController，将之前在控制层直接更改数据库的操作放到service层</p>
<figure><div class="code-wrapper"><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@PutMapping</span>
<span class="token keyword">public</span> <span class="token class-name">Result</span> <span class="token function">updateShop</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestBody</span> <span class="token class-name">Shop</span> shop<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">// 写入数据库</span>
    <span class="token keyword">return</span> shopService<span class="token punctuation">.</span><span class="token function">updateShop</span><span class="token punctuation">(</span>shop<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure>

<p>在service层首先更改数据库数据，然后删除缓存</p>
<figure><div class="code-wrapper"><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">//  根据id修改商户信息</span>
    <span class="token annotation punctuation">@Transactional</span>
    <span class="token keyword">public</span> <span class="token class-name">Result</span> <span class="token function">updateShop</span><span class="token punctuation">(</span><span class="token class-name">Shop</span> shop<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">Long</span> id <span class="token operator">=</span> shop<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>id <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
            <span class="token keyword">return</span> <span class="token class-name">Result</span><span class="token punctuation">.</span><span class="token function">fail</span><span class="token punctuation">(</span><span class="token string">"商户id不能为空"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
<span class="token comment">//        更新数据库信息</span>
        <span class="token function">updateById</span><span class="token punctuation">(</span>shop<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//        删除缓存</span>
        stringRedisTemplate<span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span><span class="token constant">CACHE_SHOP_KEY</span> <span class="token operator">+</span> shop<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token class-name">Result</span><span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure>

<p>采用postman进行接口测试：</p>
<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20220925180150495.png" srcset="/img/loading.gif" lazyload alt="image-20220925180150495"></p>
<p>数据库内容修改成功</p>
<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20220925180250705.png" srcset="/img/loading.gif" lazyload alt="image-20220925180250705"></p>
<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20220925180400296.png" srcset="/img/loading.gif" lazyload alt="image-20220925180400296"></p>
<p>再次请求，缓存重建</p>
<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20220925180528141.png" srcset="/img/loading.gif" lazyload alt="image-20220925180528141"></p>
<h3 id="17-6-3解决查询商户不存在时出现的缓存穿透问题"><a href="#17-6-3解决查询商户不存在时出现的缓存穿透问题" class="headerlink" title="17.6.3解决查询商户不存在时出现的缓存穿透问题"></a>17.6.3解决查询商户不存在时出现的缓存穿透问题</h3><p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20220925183234201.png" srcset="/img/loading.gif" lazyload alt="image-20220925183234201"></p>
<figure><div class="code-wrapper"><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">//    根据id查询商户信息</span>
    <span class="token keyword">public</span> <span class="token class-name">Result</span> <span class="token function">queryById</span><span class="token punctuation">(</span><span class="token class-name">Long</span> id<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
<span class="token comment">//        从redis查询用户缓存</span>
        <span class="token class-name">String</span> shopStr <span class="token operator">=</span> stringRedisTemplate<span class="token punctuation">.</span><span class="token function">opsForValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token constant">CACHE_SHOP_KEY</span> <span class="token operator">+</span> id<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//        判断缓存中是否存在</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">StrUtil</span><span class="token punctuation">.</span><span class="token function">isNotBlank</span><span class="token punctuation">(</span>shopStr<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
<span class="token comment">//        存在，直接返回</span>
            <span class="token class-name">Shop</span> shop <span class="token operator">=</span> <span class="token class-name">JSONUtil</span><span class="token punctuation">.</span><span class="token function">toBean</span><span class="token punctuation">(</span>shopStr<span class="token punctuation">,</span> <span class="token class-name">Shop</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token class-name">Result</span><span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span>shop<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>

<span class="token comment">//        判断命中的是否为空字符串</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>shopStr <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
<span class="token comment">//            不为空就是空字符串，就是解决缓存穿透时设置的空值</span>
            <span class="token keyword">return</span> <span class="token class-name">Result</span><span class="token punctuation">.</span><span class="token function">fail</span><span class="token punctuation">(</span><span class="token string">"商户不存在"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>

<span class="token comment">//        缓存中不存在，且不为空字符串就去查数据库</span>
        <span class="token class-name">Shop</span> shopById <span class="token operator">=</span> <span class="token function">getById</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//        数据库中不存在就缓存空对象</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>shopById <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
            stringRedisTemplate<span class="token punctuation">.</span><span class="token function">opsForValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token constant">CACHE_SHOP_KEY</span> <span class="token operator">+</span> id<span class="token punctuation">,</span><span class="token string">""</span><span class="token punctuation">,</span><span class="token constant">CACHE_NULL_TTL</span><span class="token punctuation">,</span><span class="token class-name">TimeUnit</span><span class="token punctuation">.</span><span class="token constant">MINUTES</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token class-name">Result</span><span class="token punctuation">.</span><span class="token function">fail</span><span class="token punctuation">(</span><span class="token string">"店铺不存在！"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>

<span class="token comment">//        存在就写入缓存,并设置缓存超时时间</span>
        stringRedisTemplate<span class="token punctuation">.</span><span class="token function">opsForValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token constant">CACHE_SHOP_KEY</span> <span class="token operator">+</span> id<span class="token punctuation">,</span><span class="token class-name">JSONUtil</span><span class="token punctuation">.</span><span class="token function">toJsonStr</span><span class="token punctuation">(</span>shopById<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token constant">CACHE_EXPIRE_TTL</span><span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span><span class="token constant">MINUTES</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">//        返回</span>
        <span class="token keyword">return</span> <span class="token class-name">Result</span><span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span>shopById<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure>

<p>测试：</p>
<p>&#x3D;&#x3D;一：redis中没有真实商铺的缓存数据，也没有空值&#x3D;&#x3D;</p>
<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20220925190744519.png" srcset="/img/loading.gif" lazyload alt="image-20220925190744519"></p>
<p>postman进行测试</p>
<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20220925190807020.png" srcset="/img/loading.gif" lazyload alt="image-20220925190807020"></p>
<p>控制台打印查询数据库信息：</p>
<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20220925190837067.png" srcset="/img/loading.gif" lazyload alt="image-20220925190837067"></p>
<p>将数据存入缓存</p>
<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20220925191013245.png" srcset="/img/loading.gif" lazyload alt="image-20220925191013245"></p>
<p><font color='cornflowerblue'>在缓存未过期的时间内再次发送请求会获取到缓存中的数据，而不会获取数据库中的数据，控制台没有sql信息</font></p>
<p>&#x3D;&#x3D;二：测试数据库中和缓存中都不存在的情况&#x3D;&#x3D;</p>
<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20220925191413050.png" srcset="/img/loading.gif" lazyload alt="image-20220925191413050"></p>
<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20220925191400399.png" srcset="/img/loading.gif" lazyload alt="image-20220925191400399"></p>
<p>打印信息为商铺不存在</p>
<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20220925191454141.png" srcset="/img/loading.gif" lazyload alt="image-20220925191454141"></p>
<h3 id="17-6-4基于互斥锁的方式解决缓存击穿问题"><a href="#17-6-4基于互斥锁的方式解决缓存击穿问题" class="headerlink" title="17.6.4基于互斥锁的方式解决缓存击穿问题"></a>17.6.4基于互斥锁的方式解决缓存击穿问题</h3><p>需求：&#x3D;&#x3D;修改根据id查询商铺的业务，基于互斥锁方式来解决缓存击穿问题&#x3D;&#x3D;</p>
<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20220926110512415.png" srcset="/img/loading.gif" lazyload alt="image-20220926110512415"></p>
<figure><div class="code-wrapper"><pre class="line-numbers language-java" data-language="java"><code class="language-java">    
    <span class="token comment">//    根据id查询商户信息</span>
    <span class="token keyword">public</span> <span class="token class-name">Result</span> <span class="token function">queryById</span><span class="token punctuation">(</span><span class="token class-name">Long</span> id<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
<span class="token comment">//        利用互斥锁解决缓存击穿问题</span>
        <span class="token class-name">Shop</span> shop <span class="token operator">=</span> <span class="token class-name">CacheAttackThroughByMutex</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>shop <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
            <span class="token keyword">return</span> <span class="token class-name">Result</span><span class="token punctuation">.</span><span class="token function">fail</span><span class="token punctuation">(</span><span class="token string">"商户不存在！！！"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
<span class="token comment">//        返回</span>
        <span class="token keyword">return</span> <span class="token class-name">Result</span><span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span>shop<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

<span class="token comment">//    利用互斥锁解决缓存击穿问题</span>
    <span class="token keyword">public</span> <span class="token class-name">Shop</span> <span class="token class-name">CacheAttackThroughByMutex</span><span class="token punctuation">(</span><span class="token class-name">Long</span> id<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
<span class="token comment">//        查询缓存</span>
        <span class="token class-name">String</span> shopStr <span class="token operator">=</span> stringRedisTemplate<span class="token punctuation">.</span><span class="token function">opsForValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token constant">CACHE_SHOP_KEY</span> <span class="token operator">+</span> id<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">StrUtil</span><span class="token punctuation">.</span><span class="token function">isNotBlank</span><span class="token punctuation">(</span>shopStr<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
<span class="token comment">//            缓存存在对象字符串就返回</span>
            <span class="token keyword">return</span> <span class="token class-name">JSONUtil</span><span class="token punctuation">.</span><span class="token function">toBean</span><span class="token punctuation">(</span>shopStr<span class="token punctuation">,</span> <span class="token class-name">Shop</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>

<span class="token comment">//        判断命中的是否为空值</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>shopStr <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
<span class="token comment">//            是空值就返回空</span>
            <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>

        <span class="token class-name">Shop</span> shop <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
<span class="token comment">//        获取互斥锁</span>
            <span class="token class-name">String</span> lockKey <span class="token operator">=</span> <span class="token constant">SHOP_LOCK_KEY</span> <span class="token operator">+</span> id<span class="token punctuation">;</span>
            <span class="token keyword">boolean</span> flag <span class="token operator">=</span> <span class="token function">tryLock</span><span class="token punctuation">(</span>lockKey<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//        获取互斥锁失败就休眠返回</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>flag<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                <span class="token comment">//            让当前线程停止</span>
                <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">50</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">//            递归调用当前方法</span>
                <span class="token keyword">return</span> <span class="token class-name">CacheAttackThroughByMutex</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
<span class="token comment">//        获取互斥锁成功就查询数据库</span>
            shop <span class="token operator">=</span> <span class="token function">getById</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//            模拟缓存重建延时</span>
            <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//            如果数据库中没有就设置空值</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>shop <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                stringRedisTemplate<span class="token punctuation">.</span><span class="token function">opsForValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token constant">CACHE_SHOP_KEY</span> <span class="token operator">+</span> id<span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">,</span> <span class="token constant">CACHE_NULL_TTL</span><span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span><span class="token constant">MINUTES</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
            <span class="token comment">//          存在将查询的数据存到缓存当中</span>
            stringRedisTemplate<span class="token punctuation">.</span><span class="token function">opsForValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token constant">CACHE_SHOP_KEY</span> <span class="token operator">+</span> id<span class="token punctuation">,</span> <span class="token class-name">JSONUtil</span><span class="token punctuation">.</span><span class="token function">toJsonStr</span><span class="token punctuation">(</span>shop<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token constant">CACHE_EXPIRE_TTL</span><span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span><span class="token constant">MINUTES</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span> <span class="token keyword">finally</span> <span class="token punctuation">&#123;</span>
            <span class="token comment">//        释放互斥锁</span>
            <span class="token function">releaseLock</span><span class="token punctuation">(</span><span class="token constant">SHOP_LOCK_KEY</span> <span class="token operator">+</span> id<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token keyword">return</span> shop<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>


    <span class="token comment">//      获取锁</span>
    <span class="token keyword">private</span> <span class="token keyword">boolean</span> <span class="token function">tryLock</span><span class="token punctuation">(</span><span class="token class-name">String</span> key<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">Boolean</span> flag <span class="token operator">=</span> stringRedisTemplate<span class="token punctuation">.</span><span class="token function">opsForValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setIfAbsent</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> <span class="token string">"互斥锁"</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span><span class="token constant">SECONDS</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//        为了防止自动拆箱的过程中出现空指针的现象采用手动拆箱</span>
        <span class="token keyword">return</span> <span class="token class-name">BooleanUtil</span><span class="token punctuation">.</span><span class="token function">isTrue</span><span class="token punctuation">(</span>flag<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token comment">//    释放锁</span>
    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">releaseLock</span><span class="token punctuation">(</span><span class="token class-name">String</span> key<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        stringRedisTemplate<span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure>



<p><font color='red'> 一：采用性能测试工具JMeter进行高并发请求测试，以用来检验基于互斥锁实现的解决缓存击穿的问题是否能够得到解决。</font></p>
<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20220926162538938.png" srcset="/img/loading.gif" lazyload alt="image-20220926162538938"></p>
<p>二：设置线程组规则，测试1000条线程在5秒内请求完成</p>
<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20220926162604512.png" srcset="/img/loading.gif" lazyload alt="image-20220926162604512"></p>
<p>三：设置HTTP请求</p>
<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20220927132237331.png" srcset="/img/loading.gif" lazyload alt="image-20220927132237331"></p>
<p>四：开始测试</p>
<p>所有请求均已得到响应</p>
<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20220926163626502.png" srcset="/img/loading.gif" lazyload alt="image-20220926163626502"></p>
<p><font color='red'>可以看到控制台只打印一条数据库查询信息</font></p>
<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20220926163352396.png" srcset="/img/loading.gif" lazyload alt="image-20220926163352396"></p>
<p>redis中已经存入缓存</p>
<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20220926163443326.png" srcset="/img/loading.gif" lazyload alt="image-20220926163443326"></p>
<h3 id="17-6-5基于逻辑过期的方式解决缓存击穿问题"><a href="#17-6-5基于逻辑过期的方式解决缓存击穿问题" class="headerlink" title="17.6.5基于逻辑过期的方式解决缓存击穿问题"></a>17.6.5基于逻辑过期的方式解决缓存击穿问题</h3><p>需求：修改根据id查询商铺的业务，基于逻辑过期方式来解决缓存击穿问题</p>
<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20220926164225987.png" srcset="/img/loading.gif" lazyload alt="image-20220926164225987"></p>
<p><font color='red'>一：设置工具类，添加过期时间属性和对象属性，这个对象属性就是返回给前端的数据</font></p>
<figure><div class="code-wrapper"><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Data</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">RedisData</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">private</span> <span class="token class-name">LocalDateTime</span> expireTime<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">Object</span> data<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure>

<p>&#x3D;&#x3D;二：设置热点数据，并采用单元测试的方式进行热点数据写入缓存&#x3D;&#x3D;</p>
<figure><div class="code-wrapper"><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">//    设置热点数据，由于热点数据需要提前导入，因为没有管理系统，所以采用单元测试的方式进行热点数据的导入</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">saveShopToRedis</span><span class="token punctuation">(</span><span class="token class-name">Long</span> id<span class="token punctuation">,</span><span class="token keyword">long</span> expireSeconds<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
<span class="token comment">//        查询店铺数据</span>
        <span class="token class-name">Shop</span> shop <span class="token operator">=</span> <span class="token function">getById</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//        封装数据和逻辑过期时间</span>
        <span class="token class-name">RedisData</span> redisData <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RedisData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        redisData<span class="token punctuation">.</span><span class="token function">setData</span><span class="token punctuation">(</span>shop<span class="token punctuation">)</span><span class="token punctuation">;</span>
        redisData<span class="token punctuation">.</span><span class="token function">setExpireTime</span><span class="token punctuation">(</span><span class="token class-name">LocalDateTime</span><span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">plusSeconds</span><span class="token punctuation">(</span>expireSeconds<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//        存入缓存，不设置过期时间</span>
        stringRedisTemplate<span class="token punctuation">.</span><span class="token function">opsForValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token constant">CACHE_SHOP_KEY</span> <span class="token operator">+</span> id<span class="token punctuation">,</span><span class="token class-name">JSONUtil</span><span class="token punctuation">.</span><span class="token function">toJsonStr</span><span class="token punctuation">(</span>redisData<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure>

<figure><div class="code-wrapper"><pre class="line-numbers language-java" data-language="java"><code class="language-java">    <span class="token annotation punctuation">@Test</span>
<span class="token comment">//    测试逻辑过期解决缓存击穿</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">test1</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
<span class="token comment">//        查询所有商户</span>
        <span class="token class-name">QueryWrapper</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Shop</span><span class="token punctuation">></span></span> queryWrapper <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">QueryWrapper</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        queryWrapper<span class="token punctuation">.</span><span class="token function">select</span><span class="token punctuation">(</span><span class="token string">"*"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Shop</span><span class="token punctuation">></span></span> shops <span class="token operator">=</span> shopMapper<span class="token punctuation">.</span><span class="token function">selectList</span><span class="token punctuation">(</span>queryWrapper<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Shop</span> shop <span class="token operator">:</span> shops<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
<span class="token comment">//            根据商户id存入缓存</span>
            shopService<span class="token punctuation">.</span><span class="token function">saveShopToRedis</span><span class="token punctuation">(</span>shop<span class="token punctuation">,</span><span class="token number">10L</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure>

<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20220926171304663.png" srcset="/img/loading.gif" lazyload alt="image-20220926171304663"></p>
<p>二：由于之前向缓存中提前加入热点数据的时候设置的逻辑过期时间为10s，所以逻辑时间已经过期。</p>
<figure><div class="code-wrapper"><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">//    获取缓存重建线程池</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">ExecutorService</span> <span class="token constant">CACHE_REBUILD_EXECUTOR</span> <span class="token operator">=</span> <span class="token class-name">Executors</span><span class="token punctuation">.</span><span class="token function">newFixedThreadPool</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//    利用逻辑过期的方式解决缓存击穿的问题</span>
    <span class="token keyword">public</span> <span class="token class-name">Shop</span> <span class="token class-name">CacheAttackThroughByLogicExpire</span><span class="token punctuation">(</span><span class="token class-name">Long</span> id<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
<span class="token comment">//        查询缓存</span>
        <span class="token class-name">String</span> shopStr <span class="token operator">=</span> stringRedisTemplate<span class="token punctuation">.</span><span class="token function">opsForValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token constant">CACHE_SHOP_KEY</span> <span class="token operator">+</span> id<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">StrUtil</span><span class="token punctuation">.</span><span class="token function">isBlank</span><span class="token punctuation">(</span>shopStr<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
            <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
<span class="token comment">//        缓存命中，将Json字符串反序列化为对象，判断逻辑过期时间</span>
        <span class="token class-name">RedisData</span> redisData <span class="token operator">=</span> <span class="token class-name">JSONUtil</span><span class="token punctuation">.</span><span class="token function">toBean</span><span class="token punctuation">(</span>shopStr<span class="token punctuation">,</span> <span class="token class-name">RedisData</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Shop</span> shop <span class="token operator">=</span> <span class="token class-name">JSONUtil</span><span class="token punctuation">.</span><span class="token function">toBean</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">JSONObject</span><span class="token punctuation">)</span> redisData<span class="token punctuation">.</span><span class="token function">getData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">Shop</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">LocalDateTime</span> expireTime <span class="token operator">=</span> redisData<span class="token punctuation">.</span><span class="token function">getExpireTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//        判断逻辑过期时间是否在当前时间之后</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>expireTime<span class="token punctuation">.</span><span class="token function">isAfter</span><span class="token punctuation">(</span><span class="token class-name">LocalDateTime</span><span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
<span class="token comment">//        未过期返回商户信息</span>
            <span class="token keyword">return</span> shop<span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
<span class="token comment">//        过期,获取互斥锁，重建缓存</span>
        <span class="token class-name">String</span> lockKey <span class="token operator">=</span> <span class="token constant">SHOP_LOCK_KEY</span> <span class="token operator">+</span> id<span class="token punctuation">;</span>
        <span class="token keyword">boolean</span> flag <span class="token operator">=</span> <span class="token function">tryLock</span><span class="token punctuation">(</span>lockKey<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">//        获取互斥锁成功,利用线程池开启独立线程,实现缓存重建</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>flag<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
            <span class="token constant">CACHE_REBUILD_EXECUTOR</span><span class="token punctuation">.</span><span class="token function">submit</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-></span> <span class="token punctuation">&#123;</span>
                <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
                    <span class="token function">saveShopToRedis</span><span class="token punctuation">(</span>id<span class="token punctuation">,</span> <span class="token number">20L</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">&#125;</span> <span class="token keyword">finally</span> <span class="token punctuation">&#123;</span>
                    <span class="token function">releaseLock</span><span class="token punctuation">(</span>lockKey<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">&#125;</span>
            <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
<span class="token comment">//        获取互斥锁失败，返回过期商铺信息系</span>
        <span class="token keyword">return</span> shop<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

<span class="token comment">//    设置热点数据，由于热点数据需要提前导入，因为没有管理系统，所以第一次采用单元测试的方式进行热点数据的导入</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">saveShopToRedis</span><span class="token punctuation">(</span><span class="token class-name">Long</span> id<span class="token punctuation">,</span><span class="token keyword">long</span> expireSeconds<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
<span class="token comment">//        查询店铺数据</span>
        <span class="token class-name">Shop</span> shop <span class="token operator">=</span> <span class="token function">getById</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//        封装数据和逻辑过期时间</span>
        <span class="token class-name">RedisData</span> redisData <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RedisData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        redisData<span class="token punctuation">.</span><span class="token function">setData</span><span class="token punctuation">(</span>shop<span class="token punctuation">)</span><span class="token punctuation">;</span>
        redisData<span class="token punctuation">.</span><span class="token function">setExpireTime</span><span class="token punctuation">(</span><span class="token class-name">LocalDateTime</span><span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">plusSeconds</span><span class="token punctuation">(</span>expireSeconds<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//        存入缓存，不设置过期时间</span>
        stringRedisTemplate<span class="token punctuation">.</span><span class="token function">opsForValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token constant">CACHE_SHOP_KEY</span> <span class="token operator">+</span> id<span class="token punctuation">,</span><span class="token class-name">JSONUtil</span><span class="token punctuation">.</span><span class="token function">toJsonStr</span><span class="token punctuation">(</span>redisData<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token comment">//      获取锁</span>
    <span class="token keyword">private</span> <span class="token keyword">boolean</span> <span class="token function">tryLock</span><span class="token punctuation">(</span><span class="token class-name">String</span> key<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">Boolean</span> flag <span class="token operator">=</span> stringRedisTemplate<span class="token punctuation">.</span><span class="token function">opsForValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setIfAbsent</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> <span class="token string">"互斥锁"</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span><span class="token constant">SECONDS</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//        为了防止自动拆箱的过程中出现空指针的现象采用手动拆箱</span>
        <span class="token keyword">return</span> <span class="token class-name">BooleanUtil</span><span class="token punctuation">.</span><span class="token function">isTrue</span><span class="token punctuation">(</span>flag<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token comment">//    释放锁</span>
    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">releaseLock</span><span class="token punctuation">(</span><span class="token class-name">String</span> key<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        stringRedisTemplate<span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure>

<p>测试：</p>
<p>​		一：在高并发情况下，会不会出现多个线程重建缓存的情况（并发的安全问题）</p>
<p>​		二：数据一致性的问题（<font color='red'>在缓存重建之前查询的是旧数据</font>）</p>
<p>缓存中的热点数据</p>
<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20220927132400677.png" srcset="/img/loading.gif" lazyload alt="image-20220927132400677"></p>
<p>修改数据库</p>
<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20220927132413596.png" srcset="/img/loading.gif" lazyload alt="image-20220927132413596"></p>
<p>&#x3D;&#x3D;在JMeter模拟高并发场景，查看逻辑过期后重新构建缓存查询数据库时，数据前后是否一致。&#x3D;&#x3D;</p>
<p>可以看到数据前后不一致。</p>
<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/GIF%202022-9-27%2013-26-56.gif" srcset="/img/loading.gif" lazyload alt="GIF 2022-9-27 13-26-56"></p>
<p>热点数据已经更改</p>
<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20220927132806777.png" srcset="/img/loading.gif" lazyload alt="image-20220927132806777"></p>
<h2 id="17-7优惠券秒杀"><a href="#17-7优惠券秒杀" class="headerlink" title="17.7优惠券秒杀"></a>17.7优惠券秒杀</h2><h3 id="17-7-1全局ID生成器"><a href="#17-7-1全局ID生成器" class="headerlink" title="17.7.1全局ID生成器"></a>17.7.1全局ID生成器</h3><p>当用户购买商品时，就会生成订单并保存到tb_voucher_order这张表中，而订单表如果使用数据库自增ID就存在一些问题</p>
<ul>
<li>id的规律性太明显</li>
<li>受单表数据量的限制</li>
</ul>
<p>这样的情况下可以考虑使用全局ID生成器</p>
<p>全局唯一ID生成策略：</p>
<ul>
<li><p>UUID</p>
</li>
<li><p>&#x3D;&#x3D;Redis自增&#x3D;&#x3D;</p>
</li>
<li><p>snowflake算法</p>
</li>
<li><p>数据库自增</p>
</li>
</ul>
<p>Redis自增ID策略：</p>
<ul>
<li><p>&#x3D;&#x3D;每天一个key，方便统计订单量&#x3D;&#x3D;</p>
</li>
<li><p>&#x3D;&#x3D;ID构造是 时间戳 + 计数器&#x3D;&#x3D;</p>
</li>
</ul>
<p>&#x3D;&#x3D;全局ID生成器，是一种在分布式系统下用来生成全局唯一ID的工具，一般要满足下列特性：&#x3D;&#x3D;</p>
<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20220928085301679.png" srcset="/img/loading.gif" lazyload alt="image-20220928085301679"></p>
<p>为了增加ID的安全性，我们可以<font color='red'>不直接使用Redis自增的数值，而是拼接一些其它信息：</font></p>
<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20220928085815475.png" srcset="/img/loading.gif" lazyload alt="image-20220928085815475"></p>
<p>ID的组成部分：</p>
<ul>
<li>符号位：1bit，永远为0，表示为正数</li>
<li>时间戳：31bit，以秒为单位，可以使用69年</li>
<li>序列号：32bit，秒内的<font color='red'>计数器</font>，每秒支持2*32次方个不同的ID</li>
</ul>
<figure><div class="code-wrapper"><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">//    设置左移位数</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token constant">COUNT_BITS</span> <span class="token operator">=</span> <span class="token number">32</span><span class="token punctuation">;</span>

        <span class="token annotation punctuation">@Resource</span>
        <span class="token class-name">StringRedisTemplate</span> stringRedisTemplate<span class="token punctuation">;</span>
        <span class="token keyword">public</span> <span class="token keyword">long</span> <span class="token function">uniqueId</span><span class="token punctuation">(</span><span class="token class-name">String</span> keyPrefix<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
    <span class="token comment">//        1.生成时间戳</span>
            <span class="token class-name">LocalDateTime</span> now <span class="token operator">=</span> <span class="token class-name">LocalDateTime</span><span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">long</span> nowTime <span class="token operator">=</span> now<span class="token punctuation">.</span><span class="token function">toEpochSecond</span><span class="token punctuation">(</span><span class="token class-name">ZoneOffset</span><span class="token punctuation">.</span><span class="token constant">UTC</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//        2.生成序列号</span>
    <span class="token comment">//        获取到当前日期</span>
            <span class="token class-name">String</span> date <span class="token operator">=</span> now<span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token class-name">DateTimeFormatter</span><span class="token punctuation">.</span><span class="token function">ofPattern</span><span class="token punctuation">(</span><span class="token string">"yyyyMMdd"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">long</span> increment <span class="token operator">=</span> stringRedisTemplate<span class="token punctuation">.</span><span class="token function">opsForValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">increment</span><span class="token punctuation">(</span><span class="token string">"icr:"</span> <span class="token operator">+</span> keyPrefix <span class="token operator">+</span> <span class="token string">":"</span> <span class="token operator">+</span> date<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//        3.拼接并返回</span>
            <span class="token keyword">return</span> nowTime <span class="token operator">&lt;&lt;</span> <span class="token constant">COUNT_BITS</span> <span class="token operator">|</span> increment<span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure>

<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20220928101106193.png" srcset="/img/loading.gif" lazyload alt="image-20220928101106193"></p>
<h3 id="17-7-2添加优惠券"><a href="#17-7-2添加优惠券" class="headerlink" title="17.7.2添加优惠券"></a>17.7.2添加优惠券</h3><p>每个店铺都可以发布优惠券，分为平价券和特价券。平价券可以任意购买，而特价券需要秒杀抢购：</p>
<p>在VoucherController中提供了一个接口，可以添加秒杀优惠券：</p>
<p>Controller层：</p>
<figure><div class="code-wrapper"><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@PostMapping</span><span class="token punctuation">(</span><span class="token string">"seckill"</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">Result</span> <span class="token function">addSeckillVoucher</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestBody</span> <span class="token class-name">Voucher</span> voucher<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    voucherService<span class="token punctuation">.</span><span class="token function">addSeckillVoucher</span><span class="token punctuation">(</span>voucher<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token class-name">Result</span><span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span>voucher<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure>

<p>Service层：</p>
<figure><div class="code-wrapper"><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Resource</span>
<span class="token keyword">private</span> <span class="token class-name">ISeckillVoucherService</span> seckillVoucherService<span class="token punctuation">;</span>

<span class="token annotation punctuation">@Transactional</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">addSeckillVoucher</span><span class="token punctuation">(</span><span class="token class-name">Voucher</span> voucher<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">// 保存优惠券</span>
    <span class="token function">save</span><span class="token punctuation">(</span>voucher<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 保存秒杀信息(另外一张表)</span>
    <span class="token class-name">SeckillVoucher</span> seckillVoucher <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SeckillVoucher</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    seckillVoucher<span class="token punctuation">.</span><span class="token function">setVoucherId</span><span class="token punctuation">(</span>voucher<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    seckillVoucher<span class="token punctuation">.</span><span class="token function">setStock</span><span class="token punctuation">(</span>voucher<span class="token punctuation">.</span><span class="token function">getStock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    seckillVoucher<span class="token punctuation">.</span><span class="token function">setBeginTime</span><span class="token punctuation">(</span>voucher<span class="token punctuation">.</span><span class="token function">getBeginTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    seckillVoucher<span class="token punctuation">.</span><span class="token function">setEndTime</span><span class="token punctuation">(</span>voucher<span class="token punctuation">.</span><span class="token function">getEndTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    seckillVoucherService<span class="token punctuation">.</span><span class="token function">save</span><span class="token punctuation">(</span>seckillVoucher<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure>



<p>进行接口测试：</p>
<p>JSON数据</p>
<figure><div class="code-wrapper"><pre class="line-numbers language-json" data-language="json"><code class="language-json"><span class="token punctuation">&#123;</span>
    <span class="token property">"shopId"</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
    <span class="token property">"title"</span><span class="token operator">:</span> <span class="token string">"100元代金券"</span><span class="token punctuation">,</span>
    <span class="token property">"subTitle"</span><span class="token operator">:</span> <span class="token string">"周一至周五均可使用"</span><span class="token punctuation">,</span>
    <span class="token property">"rules"</span><span class="token operator">:</span> <span class="token string">"全场通用\\n无需预约\\n可无限叠加\\不兑现、不找零\\n仅限堂食"</span><span class="token punctuation">,</span>
    <span class="token property">"payValue"</span><span class="token operator">:</span> <span class="token number">8000</span><span class="token punctuation">,</span>
    <span class="token property">"actualValue"</span><span class="token operator">:</span> <span class="token number">10000</span><span class="token punctuation">,</span>
    <span class="token property">"type"</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
    <span class="token property">"stock"</span><span class="token operator">:</span> <span class="token number">100</span><span class="token punctuation">,</span>
    <span class="token property">"beginTime"</span><span class="token operator">:</span> <span class="token string">"2022-09-28T10:00:00"</span><span class="token punctuation">,</span>
    <span class="token property">"endTime"</span><span class="token operator">:</span> <span class="token string">"2022-09-28T16:00:00"</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure>

<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20220928110259408.png" srcset="/img/loading.gif" lazyload alt="image-20220928110259408"></p>
<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20220928110236221.png" srcset="/img/loading.gif" lazyload alt="image-20220928110236221"></p>
<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20220928110245058.png" srcset="/img/loading.gif" lazyload alt="image-20220928110245058"></p>
<p>优惠券添加成功</p>
<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20220928110227221.png" srcset="/img/loading.gif" lazyload alt="image-20220928110227221"></p>
<h3 id="17-7-3实现秒杀下单"><a href="#17-7-3实现秒杀下单" class="headerlink" title="17.7.3实现秒杀下单"></a>17.7.3实现秒杀下单</h3><p>用户可以在店铺页面中抢购这些优惠券</p>
<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20220928110410022.png" srcset="/img/loading.gif" lazyload alt="image-20220928110410022"></p>
<p>下单时需要判断两点：</p>
<ul>
<li><p>秒杀是否开始或结束，如果尚未开始或已经结束则无法下单</p>
</li>
<li><p>库存是否充足，不足则无法下单</p>
</li>
</ul>
<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20220928110653585.png" srcset="/img/loading.gif" lazyload alt="image-20220928110653585"></p>
<figure><div class="code-wrapper"><pre class="line-numbers language-java" data-language="java"><code class="language-java">    <span class="token annotation punctuation">@Resource</span>
    <span class="token keyword">private</span> <span class="token class-name">ISeckillVoucherService</span> seckillVoucherService<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Resource</span>
    <span class="token keyword">private</span> <span class="token class-name">SeckillVoucherMapper</span> seckillVoucherMapper<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Resource</span>
    <span class="token keyword">private</span> <span class="token class-name">RedisIdWorker</span> redisIdWorker<span class="token punctuation">;</span>

    <span class="token comment">//    秒杀优惠券订单</span>
    <span class="token annotation punctuation">@Transactional</span>
    <span class="token keyword">public</span> <span class="token class-name">Result</span> <span class="token function">seckillVoucherOrder</span><span class="token punctuation">(</span><span class="token class-name">Long</span> voucherId<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
<span class="token comment">//        1.根据id查询优惠券</span>
        <span class="token class-name">SeckillVoucher</span> seckillVoucher <span class="token operator">=</span> seckillVoucherService<span class="token punctuation">.</span><span class="token function">getById</span><span class="token punctuation">(</span>voucherId<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//        2.判断秒杀是否开始</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>seckillVoucher<span class="token punctuation">.</span><span class="token function">getBeginTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isAfter</span><span class="token punctuation">(</span><span class="token class-name">LocalDateTime</span><span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
<span class="token comment">//           秒杀未开始</span>
            <span class="token keyword">return</span> <span class="token class-name">Result</span><span class="token punctuation">.</span><span class="token function">fail</span><span class="token punctuation">(</span><span class="token string">"秒杀尚未开始"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
<span class="token comment">//        3.判断秒杀是否结束</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>seckillVoucher<span class="token punctuation">.</span><span class="token function">getEndTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isBefore</span><span class="token punctuation">(</span><span class="token class-name">LocalDateTime</span><span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
<span class="token comment">//           秒杀已经结束</span>
            <span class="token keyword">return</span> <span class="token class-name">Result</span><span class="token punctuation">.</span><span class="token function">fail</span><span class="token punctuation">(</span><span class="token string">"秒杀已经结束"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
<span class="token comment">//        4.判断库存是否充足</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>seckillVoucher<span class="token punctuation">.</span><span class="token function">getStock</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
<span class="token comment">//           库存不足</span>
            <span class="token keyword">return</span> <span class="token class-name">Result</span><span class="token punctuation">.</span><span class="token function">fail</span><span class="token punctuation">(</span><span class="token string">"库存不足"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
<span class="token comment">//        5.扣减库存</span>
        <span class="token class-name">UpdateWrapper</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SeckillVoucher</span><span class="token punctuation">></span></span> updateWrapper <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">UpdateWrapper</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        updateWrapper<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">"stock"</span><span class="token punctuation">,</span>seckillVoucher<span class="token punctuation">.</span><span class="token function">getStock</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> update <span class="token operator">=</span> seckillVoucherMapper<span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> updateWrapper<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//        6.创建订单</span>
        <span class="token class-name">VoucherOrder</span> voucherOrder <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">VoucherOrder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//        订单id</span>
        <span class="token keyword">long</span> orderId <span class="token operator">=</span> redisIdWorker<span class="token punctuation">.</span><span class="token function">uniqueId</span><span class="token punctuation">(</span><span class="token string">"order"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        voucherOrder<span class="token punctuation">.</span><span class="token function">setId</span><span class="token punctuation">(</span>orderId<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//        用户id</span>
        voucherOrder<span class="token punctuation">.</span><span class="token function">setVoucherId</span><span class="token punctuation">(</span><span class="token class-name">UserHolder</span><span class="token punctuation">.</span><span class="token function">getUser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//        代金券id</span>
        voucherOrder<span class="token punctuation">.</span><span class="token function">setUserId</span><span class="token punctuation">(</span>voucherId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">save</span><span class="token punctuation">(</span>voucherOrder<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//        7.返回订单id</span>
        <span class="token keyword">return</span> <span class="token class-name">Result</span><span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span>orderId<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure>

<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20220928122449012.png" srcset="/img/loading.gif" lazyload alt="image-20220928122449012"></p>
<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20220928122537698.png" srcset="/img/loading.gif" lazyload alt="image-20220928122537698"></p>
<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20220928122627618.png" srcset="/img/loading.gif" lazyload alt="image-20220928122627618"></p>
<h3 id="17-7-4库存超卖问题-多线程并发问题-分析"><a href="#17-7-4库存超卖问题-多线程并发问题-分析" class="headerlink" title="17.7.4库存超卖问题(多线程并发问题)分析"></a>17.7.4库存超卖问题(多线程并发问题)分析</h3><p>就是在高并发的场景下，可能会有多个线程同时进行查询，当商品数量仅剩1个时，多个线程同时查询，都判断为1，都会进行下单。 </p>
<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20220928132007688.png" srcset="/img/loading.gif" lazyload alt="image-20220928132007688"></p>
<p>使用ApiFox测试接口是否可用：</p>
<img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20220928130317459.png" srcset="/img/loading.gif" lazyload alt="image-20220928130317459" style="zoom:67%;" />

<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20220928130526594.png" srcset="/img/loading.gif" lazyload alt="image-20220928130526594"></p>
<p>模拟高并发场景下，库存的超卖问题</p>
<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20220928123601022.png" srcset="/img/loading.gif" lazyload alt="image-20220928123601022"></p>
<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20220928130644209.png" srcset="/img/loading.gif" lazyload alt="image-20220928130644209"></p>
<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20220928130856298.png" srcset="/img/loading.gif" lazyload alt="image-20220928130856298"></p>
<p>测试：</p>
<p>出现超卖问题，最多只能卖100件，在高并发的场景下却卖出了200件</p>
<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20220928131448336.png" srcset="/img/loading.gif" lazyload alt="image-20220928131448336"></p>
<h3 id="17-7-5悲观锁和乐观锁"><a href="#17-7-5悲观锁和乐观锁" class="headerlink" title="17.7.5悲观锁和乐观锁"></a>17.7.5悲观锁和乐观锁</h3><p>超卖问题是典型的多线程安全问题，针对这一问题的常见解决方案就是加锁：</p>
<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20220928132910969.png" srcset="/img/loading.gif" lazyload alt="image-20220928132910969"></p>
<p><font color='cornflowerblue'>1.悲观锁：添加同步锁，让线程串行执行</font></p>
<ul>
<li><p>优点：简单粗暴</p>
</li>
<li><p>缺点：性能一般</p>
</li>
</ul>
<p><font color='cornflowerblue'>2.乐观锁：不加锁，在更新时判断是否有其它线程再修改</font></p>
<ul>
<li><p>优点：性能好</p>
</li>
<li><p>缺点：存在成功率低的问题</p>
</li>
</ul>
<p><strong>乐观锁</strong></p>
<p><font color='red'>乐观锁的关键是判断之前查询得到的数据是否有被修改过，常见的方式有两种：</font></p>
<ul>
<li><p>&#x3D;&#x3D;版本号法&#x3D;&#x3D;</p>
<p><font color='cornflowerblue'>设置一个版本的标识号，用于数据更新的标记。就是相当于Git版本控制一样。一个线程先查询需要修改的数据和版本号，修改的时候再去判断当前版本是否和开始查询的版本是否相同，如果相同就修改，不同就不修改。</font></p>
</li>
</ul>
<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20220928133713819.png" srcset="/img/loading.gif" lazyload alt="image-20220928133713819"></p>
<ul>
<li>&#x3D;&#x3D;<strong>CAS法（Campare And Swap）</strong>&#x3D;&#x3D;</li>
</ul>
<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20220928202235222.png" srcset="/img/loading.gif" lazyload alt="image-20220928202235222"></p>
<h3 id="17-7-6使用乐观锁解决库存超卖-多线程并发安全"><a href="#17-7-6使用乐观锁解决库存超卖-多线程并发安全" class="headerlink" title="17.7.6使用乐观锁解决库存超卖(多线程并发安全)"></a>17.7.6使用乐观锁解决库存超卖(多线程并发安全)</h3><p>采用CAS法解决多线程并发安全问题：</p>
<figure><div class="code-wrapper"><pre class="line-numbers language-java" data-language="java"><code class="language-java">    <span class="token annotation punctuation">@Resource</span>
    <span class="token keyword">private</span> <span class="token class-name">ISeckillVoucherService</span> seckillVoucherService<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Resource</span>
    <span class="token keyword">private</span> <span class="token class-name">SeckillVoucherMapper</span> seckillVoucherMapper<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Resource</span>
    <span class="token keyword">private</span> <span class="token class-name">RedisIdWorker</span> redisIdWorker<span class="token punctuation">;</span>

    <span class="token comment">//    秒杀优惠券订单</span>
    <span class="token annotation punctuation">@Transactional</span>
    <span class="token keyword">public</span> <span class="token class-name">Result</span> <span class="token function">seckillVoucherOrder</span><span class="token punctuation">(</span><span class="token class-name">Long</span> voucherId<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
<span class="token comment">//        1.根据id查询优惠券</span>
        <span class="token class-name">SeckillVoucher</span> seckillVoucher <span class="token operator">=</span> seckillVoucherService<span class="token punctuation">.</span><span class="token function">getById</span><span class="token punctuation">(</span>voucherId<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//        2.判断秒杀是否开始</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>seckillVoucher<span class="token punctuation">.</span><span class="token function">getBeginTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isAfter</span><span class="token punctuation">(</span><span class="token class-name">LocalDateTime</span><span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
<span class="token comment">//           秒杀未开始</span>
            <span class="token keyword">return</span> <span class="token class-name">Result</span><span class="token punctuation">.</span><span class="token function">fail</span><span class="token punctuation">(</span><span class="token string">"秒杀尚未开始"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
<span class="token comment">//        3.判断秒杀是否结束</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>seckillVoucher<span class="token punctuation">.</span><span class="token function">getEndTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isBefore</span><span class="token punctuation">(</span><span class="token class-name">LocalDateTime</span><span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
<span class="token comment">//           秒杀已经结束</span>
            <span class="token keyword">return</span> <span class="token class-name">Result</span><span class="token punctuation">.</span><span class="token function">fail</span><span class="token punctuation">(</span><span class="token string">"秒杀已经结束"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
<span class="token comment">//        4.判断库存是否充足</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>seckillVoucher<span class="token punctuation">.</span><span class="token function">getStock</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
<span class="token comment">//           库存不足</span>
            <span class="token keyword">return</span> <span class="token class-name">Result</span><span class="token punctuation">.</span><span class="token function">fail</span><span class="token punctuation">(</span><span class="token string">"库存不足"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
<span class="token comment">//        5.扣减库存</span>
        <span class="token keyword">boolean</span> update <span class="token operator">=</span> seckillVoucherService
                <span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">setSql</span><span class="token punctuation">(</span><span class="token string">"stock = stock -1"</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">eq</span><span class="token punctuation">(</span><span class="token string">"voucher_id"</span><span class="token punctuation">,</span> voucherId<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">gt</span><span class="token punctuation">(</span><span class="token string">"stock"</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">//设置库存大于0</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>update<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
            <span class="token keyword">return</span> <span class="token class-name">Result</span><span class="token punctuation">.</span><span class="token function">fail</span><span class="token punctuation">(</span><span class="token string">"库存不足！"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>

<span class="token comment">//        6.创建订单</span>
        <span class="token class-name">VoucherOrder</span> voucherOrder <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">VoucherOrder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//        订单id</span>
        <span class="token keyword">long</span> orderId <span class="token operator">=</span> redisIdWorker<span class="token punctuation">.</span><span class="token function">uniqueId</span><span class="token punctuation">(</span><span class="token string">"order"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        voucherOrder<span class="token punctuation">.</span><span class="token function">setId</span><span class="token punctuation">(</span>orderId<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//        用户id</span>
        voucherOrder<span class="token punctuation">.</span><span class="token function">setUserId</span><span class="token punctuation">(</span><span class="token class-name">UserHolder</span><span class="token punctuation">.</span><span class="token function">getUser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//        代金券id</span>
        voucherOrder<span class="token punctuation">.</span><span class="token function">setVoucherId</span><span class="token punctuation">(</span>voucherId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">save</span><span class="token punctuation">(</span>voucherOrder<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//        7.返回订单id</span>
        <span class="token keyword">return</span> <span class="token class-name">Result</span><span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span>orderId<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure>

<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20220929094457920.png" srcset="/img/loading.gif" lazyload alt="image-20220929094457920"></p>
<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20220929094512125.png" srcset="/img/loading.gif" lazyload alt="image-20220929094512125"></p>
<h3 id="17-7-7使用悲观锁实现一人一单功能"><a href="#17-7-7使用悲观锁实现一人一单功能" class="headerlink" title="17.7.7使用悲观锁实现一人一单功能"></a>17.7.7使用悲观锁实现一人一单功能</h3><p>需求：修改秒杀业务，要求同一个优惠券，一个用户只能下一单</p>
<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20220929100334687.png" srcset="/img/loading.gif" lazyload alt="image-20220929100334687"></p>
<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20220929095056798.png" srcset="/img/loading.gif" lazyload alt="image-20220929095056798"></p>
<figure><div class="code-wrapper"><pre class="line-numbers language-markup" data-language="markup"><code class="language-markup"><span class="token comment">&lt;!--        基于aop代理工厂面向切面编程所需依赖--></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>org.aspectj<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>aspectjweaver<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure>

<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20220929104104007.png" srcset="/img/loading.gif" lazyload alt="image-20220929104104007"></p>
<figure><div class="code-wrapper"><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Service</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">VoucherOrderServiceImpl</span> <span class="token keyword">extends</span> <span class="token class-name">ServiceImpl</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">VoucherOrderMapper</span><span class="token punctuation">,</span> <span class="token class-name">VoucherOrder</span><span class="token punctuation">></span></span> <span class="token keyword">implements</span> <span class="token class-name">IVoucherOrderService</span> <span class="token punctuation">&#123;</span>

    <span class="token annotation punctuation">@Resource</span>
    <span class="token keyword">private</span> <span class="token class-name">ISeckillVoucherService</span> seckillVoucherService<span class="token punctuation">;</span>
    

    <span class="token annotation punctuation">@Resource</span>
    <span class="token keyword">private</span> <span class="token class-name">RedisIdWorker</span> redisIdWorker<span class="token punctuation">;</span>

    <span class="token comment">//    秒杀优惠券订单</span>
    <span class="token keyword">public</span> <span class="token class-name">Result</span> <span class="token function">seckillVoucherOrder</span><span class="token punctuation">(</span><span class="token class-name">Long</span> voucherId<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
<span class="token comment">//        1.根据id查询优惠券</span>
        <span class="token class-name">SeckillVoucher</span> seckillVoucher <span class="token operator">=</span> seckillVoucherService<span class="token punctuation">.</span><span class="token function">getById</span><span class="token punctuation">(</span>voucherId<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//        2.判断秒杀是否开始</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>seckillVoucher<span class="token punctuation">.</span><span class="token function">getBeginTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isAfter</span><span class="token punctuation">(</span><span class="token class-name">LocalDateTime</span><span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
<span class="token comment">//           秒杀未开始</span>
            <span class="token keyword">return</span> <span class="token class-name">Result</span><span class="token punctuation">.</span><span class="token function">fail</span><span class="token punctuation">(</span><span class="token string">"秒杀尚未开始"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
<span class="token comment">//        3.判断秒杀是否结束</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>seckillVoucher<span class="token punctuation">.</span><span class="token function">getEndTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isBefore</span><span class="token punctuation">(</span><span class="token class-name">LocalDateTime</span><span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
<span class="token comment">//           秒杀已经结束</span>
            <span class="token keyword">return</span> <span class="token class-name">Result</span><span class="token punctuation">.</span><span class="token function">fail</span><span class="token punctuation">(</span><span class="token string">"秒杀已经结束"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
<span class="token comment">//        4.判断库存是否充足</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>seckillVoucher<span class="token punctuation">.</span><span class="token function">getStock</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
<span class="token comment">//           库存不足</span>
            <span class="token keyword">return</span> <span class="token class-name">Result</span><span class="token punctuation">.</span><span class="token function">fail</span><span class="token punctuation">(</span><span class="token string">"库存不足"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token class-name">Long</span> userId <span class="token operator">=</span> <span class="token class-name">UserHolder</span><span class="token punctuation">.</span><span class="token function">getUser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//        确保当用户id一样时，锁就会一样</span>
        <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>userId<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">intern</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
<span class="token comment">//          createVoucherOrder不具有事务功能，需要获得当前对象的代理对象</span>
            <span class="token class-name">IVoucherOrderService</span> proxy <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">IVoucherOrderService</span><span class="token punctuation">)</span> <span class="token class-name">AopContext</span><span class="token punctuation">.</span><span class="token function">currentProxy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> proxy<span class="token punctuation">.</span><span class="token function">createVoucherOrder</span><span class="token punctuation">(</span>voucherId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>


    <span class="token annotation punctuation">@Transactional</span>
    <span class="token keyword">public</span> <span class="token class-name">Result</span> <span class="token function">createVoucherOrder</span><span class="token punctuation">(</span><span class="token class-name">Long</span> voucherId<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">Long</span> userId <span class="token operator">=</span> <span class="token class-name">UserHolder</span><span class="token punctuation">.</span><span class="token function">getUser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//查询用户是否已经购买过了</span>
        <span class="token keyword">int</span> count <span class="token operator">=</span> <span class="token function">query</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">eq</span><span class="token punctuation">(</span><span class="token string">"user_id"</span><span class="token punctuation">,</span> userId<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">eq</span><span class="token punctuation">(</span><span class="token string">"voucher_id"</span><span class="token punctuation">,</span> voucherId<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">count</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>count <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">return</span> <span class="token class-name">Result</span><span class="token punctuation">.</span><span class="token function">fail</span><span class="token punctuation">(</span><span class="token string">"您已经购买过了！"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>

<span class="token comment">//        6.扣减库存</span>
        <span class="token keyword">boolean</span> update <span class="token operator">=</span> seckillVoucherService
                <span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">setSql</span><span class="token punctuation">(</span><span class="token string">"stock = stock -1"</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">eq</span><span class="token punctuation">(</span><span class="token string">"voucher_id"</span><span class="token punctuation">,</span> voucherId<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">gt</span><span class="token punctuation">(</span><span class="token string">"stock"</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>update<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">return</span> <span class="token class-name">Result</span><span class="token punctuation">.</span><span class="token function">fail</span><span class="token punctuation">(</span><span class="token string">"库存不足！"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>

<span class="token comment">//        7.创建订单</span>
        <span class="token class-name">VoucherOrder</span> voucherOrder <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">VoucherOrder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//        订单id</span>
        <span class="token keyword">long</span> orderId <span class="token operator">=</span> redisIdWorker<span class="token punctuation">.</span><span class="token function">uniqueId</span><span class="token punctuation">(</span><span class="token string">"order"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        voucherOrder<span class="token punctuation">.</span><span class="token function">setId</span><span class="token punctuation">(</span>orderId<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//        用户id</span>
        voucherOrder<span class="token punctuation">.</span><span class="token function">setUserId</span><span class="token punctuation">(</span>userId<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//        代金券id</span>
        voucherOrder<span class="token punctuation">.</span><span class="token function">setVoucherId</span><span class="token punctuation">(</span>voucherId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">save</span><span class="token punctuation">(</span>voucherOrder<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//        8.返回订单id</span>
        <span class="token keyword">return</span> <span class="token class-name">Result</span><span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span>orderId<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure>

<p>测试：</p>
<p>发现只有第一个请求成功了</p>
<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/GIF%202022-9-29%2011-04-03.gif" srcset="/img/loading.gif" lazyload alt="GIF 2022-9-29 11-04-03"></p>
<p>查看数据库：</p>
<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20220929110549071.png" srcset="/img/loading.gif" lazyload alt="image-20220929110549071"></p>
<p>订单表中只有一条订单信息</p>
<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20220929110527765.png" srcset="/img/loading.gif" lazyload alt="image-20220929110527765"></p>
<h3 id="17-7-8集群下线程并发安全问题"><a href="#17-7-8集群下线程并发安全问题" class="headerlink" title="17.7.8集群下线程并发安全问题"></a>17.7.8集群下线程并发安全问题</h3><p>将当前项目放到两台Tomcat服务器下进行运行：</p>
<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20220929111505233.png" srcset="/img/loading.gif" lazyload alt="image-20220929111505233">	</p>
<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20220929111643770.png" srcset="/img/loading.gif" lazyload alt="image-20220929111643770"></p>
<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20220929112133772.png" srcset="/img/loading.gif" lazyload alt="image-20220929112133772"></p>
<p>修改nginx的conf目录下的nginx.conf文件，配置反向代理和负载均衡</p>
<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20220929112425840.png" srcset="/img/loading.gif" lazyload alt="image-20220929112425840"></p>
<p>重启nginx服务（不行就关机重启）</p>
<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20220929112758429.png" srcset="/img/loading.gif" lazyload alt="image-20220929112758429"></p>
<p>访问两次测试端口：</p>
<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20220929120454902.png" srcset="/img/loading.gif" lazyload alt="image-20220929120454902"></p>
<p>两个端口下都有日志信息，表名该项目已经在两台服务器上部署。</p>
<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/GIF%202022-9-29%2012-03-56.gif" srcset="/img/loading.gif" lazyload alt="GIF 2022-9-29 12-03-56"></p>
<p>测试订单接口</p>
<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20220929132810099.png" srcset="/img/loading.gif" lazyload alt="image-20220929132810099"></p>
<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20220929132627481.png" srcset="/img/loading.gif" lazyload alt="image-20220929132627481"></p>
<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20220929132656891.png" srcset="/img/loading.gif" lazyload alt="image-20220929132656891"></p>
<p>放行之后数据库中有两条数据</p>
<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20220929133128504.png" srcset="/img/loading.gif" lazyload alt="image-20220929133128504"></p>
<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20220929133117924.png" srcset="/img/loading.gif" lazyload alt="image-20220929133117924"></p>
<p>出现以上问题的原因是因为多个JVM都是属于自己的锁监视器，每个JVM中的线程运行时，都会根据自己的锁监视器进行多线程之间的调用。而不会和其他JVM中的锁监视器有关系。<font color='red'>所以集群部署的方式下，使用synchronized锁并不能解决多线程并发安全问题。</font></p>
<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20220929135545706.png" srcset="/img/loading.gif" lazyload alt="image-20220929135545706"></p>
<p><font color='cornflowerblue'>为了解决集群模式下多线程并发的安全问题，可以采用<strong>分布式锁</strong>的办法解决。</font></p>
<h3 id="15-7-9使用分布式锁优化一人一单问题"><a href="#15-7-9使用分布式锁优化一人一单问题" class="headerlink" title="15.7.9使用分布式锁优化一人一单问题"></a>15.7.9使用分布式锁优化一人一单问题</h3><p>使用悲观锁解决一人一单问题时时采用synchronize(同步锁)的方式来实现，但是在集群部署的模式下并不能解决多线程并发的安全性问题。<font color='cornflowerblue'>所以可以采用Redis中的setnx在集群当中充当锁监视器，实现在多个服务器当中只有一个锁。</font></p>
<p><strong>创建锁监视器</strong></p>
<figure><div class="code-wrapper"><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ILockService</span> <span class="token keyword">implements</span> <span class="token class-name">ILock</span> <span class="token punctuation">&#123;</span>

    <span class="token keyword">private</span> <span class="token class-name">String</span> keyName<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">StringRedisTemplate</span> stringRedisTemplate<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token class-name">ILockService</span><span class="token punctuation">(</span><span class="token class-name">String</span> keyName<span class="token punctuation">,</span> <span class="token class-name">StringRedisTemplate</span> stringRedisTemplate<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>keyName <span class="token operator">=</span> keyName<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>stringRedisTemplate <span class="token operator">=</span> stringRedisTemplate<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">tryLock</span><span class="token punctuation">(</span><span class="token class-name">Long</span> timeOutSec<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
<span class="token comment">//        获取线程id</span>
        <span class="token keyword">long</span> id <span class="token operator">=</span> <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//        获取锁，以当前线程的id作为value</span>
        <span class="token class-name">Boolean</span> flag <span class="token operator">=</span> stringRedisTemplate<span class="token punctuation">.</span><span class="token function">opsForValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setIfAbsent</span><span class="token punctuation">(</span><span class="token constant">DISTRI_LOCK_KEY</span> <span class="token operator">+</span> keyName<span class="token punctuation">,</span> id<span class="token operator">+</span><span class="token string">""</span><span class="token punctuation">,</span> timeOutSec<span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span><span class="token constant">SECONDS</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token class-name">BooleanUtil</span><span class="token punctuation">.</span><span class="token function">isTrue</span><span class="token punctuation">(</span>flag<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">releseLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
<span class="token comment">//        释放锁</span>
        stringRedisTemplate<span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span><span class="token constant">DISTRI_LOCK_KEY</span> <span class="token operator">+</span> keyName<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure>

<p>调用分布式锁，实现一人一单功能优化，在集群部署下不会出现多线程并发的安全性问题。</p>
<figure><div class="code-wrapper"><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Service</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">VoucherOrderServiceImpl</span> <span class="token keyword">extends</span> <span class="token class-name">ServiceImpl</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">VoucherOrderMapper</span><span class="token punctuation">,</span> <span class="token class-name">VoucherOrder</span><span class="token punctuation">></span></span> <span class="token keyword">implements</span> <span class="token class-name">IVoucherOrderService</span> <span class="token punctuation">&#123;</span>

    <span class="token annotation punctuation">@Resource</span>
    <span class="token keyword">private</span> <span class="token class-name">ISeckillVoucherService</span> seckillVoucherService<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Resource</span>
    <span class="token class-name">StringRedisTemplate</span> stringRedisTemplate<span class="token punctuation">;</span>


    <span class="token annotation punctuation">@Resource</span>
    <span class="token keyword">private</span> <span class="token class-name">RedisIdWorker</span> redisIdWorker<span class="token punctuation">;</span>

    <span class="token comment">//    秒杀优惠券订单</span>
    <span class="token keyword">public</span> <span class="token class-name">Result</span> <span class="token function">seckillVoucherOrder</span><span class="token punctuation">(</span><span class="token class-name">Long</span> voucherId<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
<span class="token comment">//        1.根据id查询优惠券</span>
        <span class="token class-name">SeckillVoucher</span> seckillVoucher <span class="token operator">=</span> seckillVoucherService<span class="token punctuation">.</span><span class="token function">getById</span><span class="token punctuation">(</span>voucherId<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//        2.判断秒杀是否开始</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>seckillVoucher<span class="token punctuation">.</span><span class="token function">getBeginTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isAfter</span><span class="token punctuation">(</span><span class="token class-name">LocalDateTime</span><span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
<span class="token comment">//           秒杀未开始</span>
            <span class="token keyword">return</span> <span class="token class-name">Result</span><span class="token punctuation">.</span><span class="token function">fail</span><span class="token punctuation">(</span><span class="token string">"秒杀尚未开始"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
<span class="token comment">//        3.判断秒杀是否结束</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>seckillVoucher<span class="token punctuation">.</span><span class="token function">getEndTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isBefore</span><span class="token punctuation">(</span><span class="token class-name">LocalDateTime</span><span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
<span class="token comment">//           秒杀已经结束</span>
            <span class="token keyword">return</span> <span class="token class-name">Result</span><span class="token punctuation">.</span><span class="token function">fail</span><span class="token punctuation">(</span><span class="token string">"秒杀已经结束"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
<span class="token comment">//        4.判断库存是否充足</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>seckillVoucher<span class="token punctuation">.</span><span class="token function">getStock</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
<span class="token comment">//           库存不足</span>
            <span class="token keyword">return</span> <span class="token class-name">Result</span><span class="token punctuation">.</span><span class="token function">fail</span><span class="token punctuation">(</span><span class="token string">"库存不足"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token class-name">Long</span> userId <span class="token operator">=</span> <span class="token class-name">UserHolder</span><span class="token punctuation">.</span><span class="token function">getUser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//        创建分布式锁对象</span>
        <span class="token class-name">ILockService</span> distriLock <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ILockService</span><span class="token punctuation">(</span><span class="token string">"order:"</span> <span class="token operator">+</span> userId<span class="token punctuation">,</span> stringRedisTemplate<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">boolean</span> isLock <span class="token operator">=</span> distriLock<span class="token punctuation">.</span><span class="token function">tryLock</span><span class="token punctuation">(</span><span class="token number">1200L</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//        判断是否获取锁成功</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>isLock<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
<span class="token comment">//            获取锁失败</span>
            <span class="token keyword">return</span> <span class="token class-name">Result</span><span class="token punctuation">.</span><span class="token function">fail</span><span class="token punctuation">(</span><span class="token string">"不允许重复下单"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
<span class="token comment">//        获取锁成功</span>
<span class="token comment">//        createVoucherOrder不具有事务功能，需要获得当前对象的代理对象</span>
        <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
            <span class="token class-name">IVoucherOrderService</span> proxy <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">IVoucherOrderService</span><span class="token punctuation">)</span> <span class="token class-name">AopContext</span><span class="token punctuation">.</span><span class="token function">currentProxy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> proxy<span class="token punctuation">.</span><span class="token function">createVoucherOrder</span><span class="token punctuation">(</span>voucherId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span> <span class="token keyword">finally</span> <span class="token punctuation">&#123;</span>
            distriLock<span class="token punctuation">.</span><span class="token function">releseLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>

<span class="token comment">//    扣减库存、创建订单</span>
    <span class="token annotation punctuation">@Transactional</span>
    <span class="token keyword">public</span> <span class="token class-name">Result</span> <span class="token function">createVoucherOrder</span><span class="token punctuation">(</span><span class="token class-name">Long</span> voucherId<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">Long</span> userId <span class="token operator">=</span> <span class="token class-name">UserHolder</span><span class="token punctuation">.</span><span class="token function">getUser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//查询用户是否已经购买过了</span>
        <span class="token keyword">int</span> count <span class="token operator">=</span> <span class="token function">query</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">eq</span><span class="token punctuation">(</span><span class="token string">"user_id"</span><span class="token punctuation">,</span> userId<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">eq</span><span class="token punctuation">(</span><span class="token string">"voucher_id"</span><span class="token punctuation">,</span> voucherId<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">count</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>count <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">return</span> <span class="token class-name">Result</span><span class="token punctuation">.</span><span class="token function">fail</span><span class="token punctuation">(</span><span class="token string">"您已经购买过了！"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>

<span class="token comment">//        6.扣减库存</span>
        <span class="token keyword">boolean</span> update <span class="token operator">=</span> seckillVoucherService
                <span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">setSql</span><span class="token punctuation">(</span><span class="token string">"stock = stock -1"</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">eq</span><span class="token punctuation">(</span><span class="token string">"voucher_id"</span><span class="token punctuation">,</span> voucherId<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">gt</span><span class="token punctuation">(</span><span class="token string">"stock"</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>update<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">return</span> <span class="token class-name">Result</span><span class="token punctuation">.</span><span class="token function">fail</span><span class="token punctuation">(</span><span class="token string">"库存不足！"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>

<span class="token comment">//        7.创建订单</span>
        <span class="token class-name">VoucherOrder</span> voucherOrder <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">VoucherOrder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//        订单id</span>
        <span class="token keyword">long</span> orderId <span class="token operator">=</span> redisIdWorker<span class="token punctuation">.</span><span class="token function">uniqueId</span><span class="token punctuation">(</span><span class="token string">"order"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        voucherOrder<span class="token punctuation">.</span><span class="token function">setId</span><span class="token punctuation">(</span>orderId<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//        用户id</span>
        voucherOrder<span class="token punctuation">.</span><span class="token function">setUserId</span><span class="token punctuation">(</span>userId<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//        代金券id</span>
        voucherOrder<span class="token punctuation">.</span><span class="token function">setVoucherId</span><span class="token punctuation">(</span>voucherId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">save</span><span class="token punctuation">(</span>voucherOrder<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//        8.返回订单id</span>
        <span class="token keyword">return</span> <span class="token class-name">Result</span><span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span>orderId<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure>



<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20220929162743743.png" srcset="/img/loading.gif" lazyload alt="image-20220929162743743">	 </p>
<p> 采用ApiFox进行测试：</p>
<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20220929165644503.png" srcset="/img/loading.gif" lazyload alt="image-20220929165644503"></p>
<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20220929165412039.png" srcset="/img/loading.gif" lazyload alt="image-20220929165412039"></p>
<p>​	<img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20220929165441201.png" srcset="/img/loading.gif" lazyload alt="image-20220929165441201"></p>
<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20220929165532704.png" srcset="/img/loading.gif" lazyload alt="image-20220929165532704"></p>
<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20220929165550772.png" srcset="/img/loading.gif" lazyload alt="image-20220929165550772"></p>
<h3 id="17-7-10分布式锁误删优化"><a href="#17-7-10分布式锁误删优化" class="headerlink" title="17.7.10分布式锁误删优化"></a>17.7.10分布式锁误删优化</h3><p>&#x3D;&#x3D;为了防止因为线程阻塞而导致的分布式锁误删问题，在线程获取分布式锁的时候，<font color='red'>向缓存中添加分布式锁的标识。当线程要释放锁的时候，查询缓存中的分布式锁的标识是否和自己的相同，相同的话就释放锁，不同的话就不做操作</font>。&#x3D;&#x3D;</p>
<p>让第1台服务器获取到分布式锁</p>
<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20220929184433007.png" srcset="/img/loading.gif" lazyload alt="image-20220929184433007"></p>
<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20220929184505129.png" srcset="/img/loading.gif" lazyload alt="image-20220929184505129"></p>
<p><font color='cornflowerblue'>删除刚刚生成的分布式锁，模拟超时过期，让服务器2获取到分布式锁</font></p>
<p><strong><font color='red'>服务器2成功获取到分布式锁</font></strong></p>
<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20220929200726254.png" srcset="/img/loading.gif" lazyload alt="image-20220929200726254"></p>
<p>服务器2成功获取到分布式锁并且最后释放锁。</p>
<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20220929201547916.png" srcset="/img/loading.gif" lazyload alt="image-20220929201547916"></p>
<p>数据库新增一条数据</p>
<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20220929202630878.png" srcset="/img/loading.gif" lazyload alt="image-20220929202630878"></p>
<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20220929202637500.png" srcset="/img/loading.gif" lazyload alt="image-20220929202637500"></p>
<h3 id="17-7-11使用Lua脚本实现分布式锁的原子性"><a href="#17-7-11使用Lua脚本实现分布式锁的原子性" class="headerlink" title="17.7.11使用Lua脚本实现分布式锁的原子性"></a>17.7.11使用Lua脚本实现分布式锁的原子性</h3><p>一：首先编写Lua脚本</p>
<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20220930124858402.png" srcset="/img/loading.gif" lazyload alt="image-20220930124858402"></p>
<figure><div class="code-wrapper"><pre class="line-numbers language-lua" data-language="lua"><code class="language-lua"><span class="token keyword">if</span> <span class="token punctuation">(</span>redis<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token string">'get'</span><span class="token punctuation">,</span>KEYS<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">==</span> ARGV<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token keyword">then</span>
<span class="token comment">--    释放锁</span>
    <span class="token keyword">return</span> redis<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token string">'del'</span><span class="token punctuation">,</span>KEYS<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token keyword">end</span>
<span class="token keyword">return</span> <span class="token number">0</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure>

<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20220930125203359.png" srcset="/img/loading.gif" lazyload alt="image-20220930125203359"></p>
<figure><div class="code-wrapper"><pre class="line-numbers language-java" data-language="java"><code class="language-java">    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">DefaultRedisScript</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">></span></span> <span class="token constant">UNLOCK_SCRIPT</span><span class="token punctuation">;</span>
    <span class="token keyword">static</span> <span class="token punctuation">&#123;</span>
        <span class="token constant">UNLOCK_SCRIPT</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DefaultRedisScript</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//        设置脚本位置</span>
        <span class="token constant">UNLOCK_SCRIPT</span><span class="token punctuation">.</span><span class="token function">setLocation</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ClassPathResource</span><span class="token punctuation">(</span><span class="token string">"distri_lock.lua"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token constant">UNLOCK_SCRIPT</span><span class="token punctuation">.</span><span class="token function">setResultType</span><span class="token punctuation">(</span><span class="token class-name">Long</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token comment">//    释放锁</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">releseLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
<span class="token comment">//        调用Lua脚本</span>
    stringRedisTemplate<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token constant">UNLOCK_SCRIPT</span><span class="token punctuation">,</span> <span class="token class-name">Collections</span><span class="token punctuation">.</span><span class="token function">singletonList</span><span class="token punctuation">(</span>keyName<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token constant">THREADUUID</span> <span class="token operator">+</span> <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure>

<h3 id="17-7-12使用Redisson实现分布式锁"><a href="#17-7-12使用Redisson实现分布式锁" class="headerlink" title="17.7.12使用Redisson实现分布式锁"></a>17.7.12使用Redisson实现分布式锁</h3><p>Redisson是一个在Redis的基础上实现的<code>Java驻内存数据网格</code>。<font color='red'>它不仅提供了一系列的分布式的Java常用对象，还提供了许多分布式服务</font>。其中就包含了各种分布式锁的实现。</p>
<figure><div class="code-wrapper"><pre class="line-numbers language-java" data-language="java"><code class="language-java">    <span class="token annotation punctuation">@Resource</span>
    <span class="token keyword">private</span> <span class="token class-name">ISeckillVoucherService</span> seckillVoucherService<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Resource</span>
    <span class="token class-name">RedissonClient</span> redissonClient<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Resource</span>
    <span class="token keyword">private</span> <span class="token class-name">RedisIdWorker</span> redisIdWorker<span class="token punctuation">;</span>

    <span class="token comment">//    秒杀优惠券订单</span>
    <span class="token keyword">public</span> <span class="token class-name">Result</span> <span class="token function">seckillVoucherOrder</span><span class="token punctuation">(</span><span class="token class-name">Long</span> voucherId<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
<span class="token comment">//        1.根据id查询优惠券</span>
        <span class="token class-name">SeckillVoucher</span> seckillVoucher <span class="token operator">=</span> seckillVoucherService<span class="token punctuation">.</span><span class="token function">getById</span><span class="token punctuation">(</span>voucherId<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//        2.判断秒杀是否开始</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>seckillVoucher<span class="token punctuation">.</span><span class="token function">getBeginTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isAfter</span><span class="token punctuation">(</span><span class="token class-name">LocalDateTime</span><span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
<span class="token comment">//           秒杀未开始</span>
            <span class="token keyword">return</span> <span class="token class-name">Result</span><span class="token punctuation">.</span><span class="token function">fail</span><span class="token punctuation">(</span><span class="token string">"秒杀尚未开始"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
<span class="token comment">//        3.判断秒杀是否结束</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>seckillVoucher<span class="token punctuation">.</span><span class="token function">getEndTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isBefore</span><span class="token punctuation">(</span><span class="token class-name">LocalDateTime</span><span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
<span class="token comment">//           秒杀已经结束</span>
            <span class="token keyword">return</span> <span class="token class-name">Result</span><span class="token punctuation">.</span><span class="token function">fail</span><span class="token punctuation">(</span><span class="token string">"秒杀已经结束"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
<span class="token comment">//        4.判断库存是否充足</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>seckillVoucher<span class="token punctuation">.</span><span class="token function">getStock</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
<span class="token comment">//           库存不足</span>
            <span class="token keyword">return</span> <span class="token class-name">Result</span><span class="token punctuation">.</span><span class="token function">fail</span><span class="token punctuation">(</span><span class="token string">"库存不足"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token class-name">Long</span> userId <span class="token operator">=</span> <span class="token class-name">UserHolder</span><span class="token punctuation">.</span><span class="token function">getUser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">RLock</span> lock <span class="token operator">=</span> redissonClient<span class="token punctuation">.</span><span class="token function">getLock</span><span class="token punctuation">(</span><span class="token constant">DISTRI_LOCK_KEY</span> <span class="token operator">+</span> userId<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">boolean</span> isLock <span class="token operator">=</span> lock<span class="token punctuation">.</span><span class="token function">tryLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//        判断是否获取锁成功</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>isLock<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
<span class="token comment">//            获取锁失败</span>
            <span class="token keyword">return</span> <span class="token class-name">Result</span><span class="token punctuation">.</span><span class="token function">fail</span><span class="token punctuation">(</span><span class="token string">"不允许重复下单"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
<span class="token comment">//        获取锁成功，创建订单</span>
        <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">return</span> <span class="token function">createVoucherOrder</span><span class="token punctuation">(</span>voucherId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span> <span class="token keyword">finally</span> <span class="token punctuation">&#123;</span>
            lock<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>


    <span class="token comment">//    扣减库存、创建订单</span>
    <span class="token annotation punctuation">@Transactional</span>
    <span class="token keyword">public</span> <span class="token class-name">Result</span> <span class="token function">createVoucherOrder</span><span class="token punctuation">(</span><span class="token class-name">Long</span> voucherId<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">Long</span> userId <span class="token operator">=</span> <span class="token class-name">UserHolder</span><span class="token punctuation">.</span><span class="token function">getUser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//查询用户是否已经购买过了</span>
        <span class="token keyword">int</span> count <span class="token operator">=</span> <span class="token function">query</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">eq</span><span class="token punctuation">(</span><span class="token string">"user_id"</span><span class="token punctuation">,</span> userId<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">eq</span><span class="token punctuation">(</span><span class="token string">"voucher_id"</span><span class="token punctuation">,</span> voucherId<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">count</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>count <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">return</span> <span class="token class-name">Result</span><span class="token punctuation">.</span><span class="token function">fail</span><span class="token punctuation">(</span><span class="token string">"您已经购买过了！"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>

<span class="token comment">//        6.扣减库存</span>
        <span class="token keyword">boolean</span> update <span class="token operator">=</span> seckillVoucherService
                <span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">setSql</span><span class="token punctuation">(</span><span class="token string">"stock = stock -1"</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">eq</span><span class="token punctuation">(</span><span class="token string">"voucher_id"</span><span class="token punctuation">,</span> voucherId<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">gt</span><span class="token punctuation">(</span><span class="token string">"stock"</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>update<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">return</span> <span class="token class-name">Result</span><span class="token punctuation">.</span><span class="token function">fail</span><span class="token punctuation">(</span><span class="token string">"库存不足！"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>

<span class="token comment">//        7.创建订单</span>
        <span class="token class-name">VoucherOrder</span> voucherOrder <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">VoucherOrder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//        订单id</span>
        <span class="token keyword">long</span> orderId <span class="token operator">=</span> redisIdWorker<span class="token punctuation">.</span><span class="token function">uniqueId</span><span class="token punctuation">(</span><span class="token string">"order"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        voucherOrder<span class="token punctuation">.</span><span class="token function">setId</span><span class="token punctuation">(</span>orderId<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//        用户id</span>
        voucherOrder<span class="token punctuation">.</span><span class="token function">setUserId</span><span class="token punctuation">(</span>userId<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//        代金券id</span>
        voucherOrder<span class="token punctuation">.</span><span class="token function">setVoucherId</span><span class="token punctuation">(</span>voucherId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">save</span><span class="token punctuation">(</span>voucherOrder<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//        8.返回订单id</span>
        <span class="token keyword">return</span> <span class="token class-name">Result</span><span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span>orderId<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure>

<p>使用ApiFox测试接口：</p>
<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20220930142057772.png" srcset="/img/loading.gif" lazyload alt="image-20220930142057772"></p>
<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20220930142106257.png" srcset="/img/loading.gif" lazyload alt="image-20220930142106257"></p>
<p>使用JMeter进行压力测试：</p>
<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20220930143429220.png" srcset="/img/loading.gif" lazyload alt="image-20220930143429220"></p>
<p>数据库只有一条数据</p>
<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20220930143445318.png" srcset="/img/loading.gif" lazyload alt="image-20220930143445318"> 	<img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20220930143453970.png" srcset="/img/loading.gif" lazyload alt="image-20220930143453970"></p>
<h3 id="17-7-13秒杀优化（异步秒杀）"><a href="#17-7-13秒杀优化（异步秒杀）" class="headerlink" title="17.7.13秒杀优化（异步秒杀）"></a>17.7.13秒杀优化（异步秒杀）</h3><p>问题描述：&#x3D;&#x3D;在之前的秒杀业务中，客户端向Nginx代理服务器发送请求，Nginx做负载代理到Tomcat服务器，整个业务流程中，<font color='red'>查询优惠券、查询订单、减库存、创建订单</font>都是操作数据库来完成的。对数据库做太多的读写操作的话整个业务耗时就会很长，并发能力就会很差。&#x3D;&#x3D;</p>
<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20221001092112196.png" srcset="/img/loading.gif" lazyload alt="image-20221001092112196"></p>
<p>该如何解决以上问题呢？<font color='cornflowerblue'>可以采用异步操作来完成</font>。</p>
<p>&#x3D;&#x3D;将校验用户购买资格的业务流程放到Redis缓存当中，当客户端发送请求时就会在缓存当中判断用户的购买资格，如果没有购买资格就直接返回错误。&#x3D;&#x3D;</p>
<p>&#x3D;&#x3D;如果有购买资格就保存优惠券、用户、订单id到阻塞队列，然后后台数据库异步读取队列中的信息，完成下单。&#x3D;&#x3D;</p>
<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20221001094637017.png" srcset="/img/loading.gif" lazyload alt="image-20221001094637017"></p>
<p>为了保证判断用户是否有购买资格的业务的原子性，需要使用Lua脚本执行业务。</p>
<p>如果用户没有购买资格，就直接返回异常。如果有购买资格，完成将优惠券、用户、订单id写入阻塞队列，等待数据库完成异步下单操作。</p>
<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20221001095150144.png" srcset="/img/loading.gif" lazyload alt="image-20221001095150144"></p>
<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20221001095934027.png" srcset="/img/loading.gif" lazyload alt="image-20221001095934027"></p>
<p>需求：</p>
<ol>
<li><p>&#x3D;&#x3D;新增秒杀优惠券的同时，将优惠券信息保存到Redis中&#x3D;&#x3D;</p>
</li>
<li><p>基于Lua脚本，判断秒杀库存、一人一单，决定用户是否抢购成功 </p>
</li>
<li><p>&#x3D;&#x3D;如果抢购成功，将优惠券id和用户id封装后存入阻塞队列&#x3D;&#x3D;</p>
</li>
<li><p>开启线程任务，不断从阻塞队列中获取信息，实现异步下单功能</p>
</li>
</ol>
<p>开始创建需求</p>
<p><strong>1.在创建秒杀券的同时将秒杀券的库存存入缓存当中。</strong></p>
<figure><div class="code-wrapper"><pre class="line-numbers language-java" data-language="java"><code class="language-java">    <span class="token annotation punctuation">@Transactional</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">addSeckillVoucher</span><span class="token punctuation">(</span><span class="token class-name">Voucher</span> voucher<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">// 保存优惠券</span>
        <span class="token function">save</span><span class="token punctuation">(</span>voucher<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 保存秒杀信息(另外一张表)</span>
        <span class="token class-name">SeckillVoucher</span> seckillVoucher <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SeckillVoucher</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        seckillVoucher<span class="token punctuation">.</span><span class="token function">setVoucherId</span><span class="token punctuation">(</span>voucher<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        seckillVoucher<span class="token punctuation">.</span><span class="token function">setStock</span><span class="token punctuation">(</span>voucher<span class="token punctuation">.</span><span class="token function">getStock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        seckillVoucher<span class="token punctuation">.</span><span class="token function">setBeginTime</span><span class="token punctuation">(</span>voucher<span class="token punctuation">.</span><span class="token function">getBeginTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        seckillVoucher<span class="token punctuation">.</span><span class="token function">setEndTime</span><span class="token punctuation">(</span>voucher<span class="token punctuation">.</span><span class="token function">getEndTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        seckillVoucherService<span class="token punctuation">.</span><span class="token function">save</span><span class="token punctuation">(</span>seckillVoucher<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">//        保存秒杀库到Redis缓存当中</span>
        stringRedisTemplate<span class="token punctuation">.</span><span class="token function">opsForValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token constant">SECKILL_STOCK</span> <span class="token operator">+</span> voucher<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>voucher<span class="token punctuation">.</span><span class="token function">getStock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        
    <span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure>

<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20221001103123435.png" srcset="/img/loading.gif" lazyload alt="image-20221001103123435"></p>
<p>查看数据库</p>
<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20221001103155796.png" srcset="/img/loading.gif" lazyload alt="image-20221001103155796"></p>
<p>查看缓存中有秒杀券库存数量：</p>
<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20221001103305220.png" srcset="/img/loading.gif" lazyload alt="image-20221001103305220"></p>
<p><strong>2.基于Lua脚本完成用户下单资格验证</strong></p>
<p>lua脚本文件内容</p>
<figure><div class="code-wrapper"><pre class="line-numbers language-lua" data-language="lua"><code class="language-lua"><span class="token comment">--1.列表参数</span>
<span class="token comment">--1.1优惠券id</span>
<span class="token keyword">local</span> voucherId <span class="token operator">=</span> ARGV<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>
<span class="token comment">--1.2用户id</span>
<span class="token keyword">local</span> userId <span class="token operator">=</span> ARGV<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span>

<span class="token comment">--2.数据key</span>
<span class="token comment">--2.1库存key</span>
<span class="token keyword">local</span> stockSky <span class="token operator">=</span> <span class="token string">'seckill:stock:'</span> <span class="token operator">..</span> voucherId
<span class="token comment">--2.1订单key</span>
<span class="token keyword">local</span> orderSky <span class="token operator">=</span> <span class="token string">'seckill:order:'</span> <span class="token operator">..</span> voucherId

<span class="token comment">--3.脚本业务</span>
<span class="token comment">--3.1判断库存是否充足</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">tonumber</span><span class="token punctuation">(</span>redis<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token string">'get'</span><span class="token punctuation">,</span>stockSky<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">then</span>
    <span class="token comment">--3.2库存不足</span>
    <span class="token keyword">return</span> <span class="token number">1</span>
<span class="token keyword">end</span>

<span class="token comment">--3.3判断用户是否下单</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>redis<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token string">'sismember'</span><span class="token punctuation">,</span>orderSky<span class="token punctuation">,</span>userId<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token keyword">then</span>
<span class="token comment">--    3.4不能重复下单</span>
    <span class="token keyword">return</span> <span class="token number">2</span>
<span class="token keyword">end</span>

<span class="token comment">--3.5扣库存</span>
redis<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token string">'incrby'</span><span class="token punctuation">,</span>stockSky<span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
<span class="token comment">--3.6创建订单</span>
redis<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token string">'sadd'</span><span class="token punctuation">,</span>orderSky<span class="token punctuation">,</span>userId<span class="token punctuation">)</span>
<span class="token keyword">return</span> <span class="token number">0</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure>

<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20221001113455374.png" srcset="/img/loading.gif" lazyload alt="image-20221001113455374"></p>
<p>缓存中订单数加1，库存数减1</p>
<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/GIF%202022-10-1%2011-59-27.gif" srcset="/img/loading.gif" lazyload alt="GIF 2022-10-1 11-59-27"></p>
<p>同一用户再次下单显示不能再次下单</p>
<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20221001120226230.png" srcset="/img/loading.gif" lazyload alt="image-20221001120226230"></p>
<ol start="3">
<li><p>&#x3D;&#x3D;<strong>如果抢购成功，将优惠券id和用户id封装后存入阻塞队列</strong>&#x3D;&#x3D;</p>
</li>
<li><p><strong>开启线程任务，不断从阻塞队列中获取信息，实现异步下单功能</strong></p>
</li>
</ol>
<p>  使用ApiFox进行测试：</p>
<p>  第一次下单成功</p>
<p>  <img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20221001164130769.png" srcset="/img/loading.gif" lazyload alt="image-20221001164130769"></p>
<p>数据库完成异步更新</p>
<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20221001164213734.png" srcset="/img/loading.gif" lazyload alt="image-20221001164213734"></p>
<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20221001164223941.png" srcset="/img/loading.gif" lazyload alt="image-20221001164223941"></p>
<p>同一用户再次发送请求失败</p>
<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20221001164250445.png" srcset="/img/loading.gif" lazyload alt="image-20221001164250445"></p>
<p>使用JMeter进行高并发测试：</p>
<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20221001165831322.png" srcset="/img/loading.gif" lazyload alt="image-20221001165831322"></p>
<p>数据库只填加一条信息</p>
<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20221001165808148.png" srcset="/img/loading.gif" lazyload alt="image-20221001165808148"></p>
<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20221001165801283.png" srcset="/img/loading.gif" lazyload alt="image-20221001165801283"> </p>
<p><strong>秒杀业务的优化思路是什么？</strong></p>
<ol>
<li><p>&#x3D;&#x3D;先利用Redis完成库存余量、一人一单判断，完成抢单业务&#x3D;&#x3D;</p>
</li>
<li><p>&#x3D;&#x3D;<font color='red'>再将下单业务放入阻塞队列，利用独立线程异步下单</font>&#x3D;&#x3D;</p>
<p>基于阻塞队列的异步秒杀存在哪些问题？</p>
<p><strong>一：内存限制问题</strong></p>
<p>​	因为实现异步秒杀功能所使用的阻塞队列是<font color='red'>JDK的阻塞队列，JDK的阻塞队列会使用JVM的内存</font>，<code>在高并发的场景下，会有无数的订单对象被创建并被放到阻塞队列里，可能会导致内存溢出。</code></p>
<p><strong>二：数据安全问题</strong></p>
<p>​	基于缓存保存的订单信息，如果服务崩溃，则所有的订单信息都会失效。</p>
</li>
</ol>
<h2 id="17-8达人探店"><a href="#17-8达人探店" class="headerlink" title="17.8达人探店"></a>17.8达人探店</h2><h3 id="17-8-1发布探店博客"><a href="#17-8-1发布探店博客" class="headerlink" title="17.8.1发布探店博客"></a>17.8.1发布探店博客</h3><p>探店笔记类似点评网站的评价，往往是图文结合。对应的表有两个：</p>
<ul>
<li><p>tb_blog：探店笔记表，包含笔记中的标题、文字、图片等</p>
</li>
<li><p>tb_blog_comments：其他用户对探店笔记的评价</p>
</li>
</ul>
<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20221001201046753.png" srcset="/img/loading.gif" lazyload alt="image-20221001201046753"></p>
<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20221001201622052.png" srcset="/img/loading.gif" lazyload alt="image-20221001201622052"></p>
<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20221001201659022.png" srcset="/img/loading.gif" lazyload alt="image-20221001201659022"></p>
<p><strong>上传图片的接口：</strong></p>
<figure><div class="code-wrapper"><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@PostMapping</span><span class="token punctuation">(</span><span class="token string">"blog"</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">Result</span> <span class="token function">uploadImage</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestParam</span><span class="token punctuation">(</span><span class="token string">"file"</span><span class="token punctuation">)</span> <span class="token class-name">MultipartFile</span> image<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">// 获取原始文件名称</span>
        <span class="token class-name">String</span> originalFilename <span class="token operator">=</span> image<span class="token punctuation">.</span><span class="token function">getOriginalFilename</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 生成新文件名</span>
        <span class="token class-name">String</span> fileName <span class="token operator">=</span> <span class="token function">createNewFileName</span><span class="token punctuation">(</span>originalFilename<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 设置上传文件目录，保存文件</span>
        image<span class="token punctuation">.</span><span class="token function">transferTo</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">File</span><span class="token punctuation">(</span><span class="token class-name">SystemConstants</span><span class="token punctuation">.</span><span class="token constant">IMAGE_UPLOAD_DIR</span><span class="token punctuation">,</span> fileName<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 返回结果</span>
        log<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">"文件上传成功，&#123;&#125;"</span><span class="token punctuation">,</span> fileName<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token class-name">Result</span><span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span>fileName<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span><span class="token string">"文件上传失败"</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure>

<p>设置图片的保存地址：</p>
<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20221001201923905.png" srcset="/img/loading.gif" lazyload alt="image-20221001201923905"></p>
<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20221001202010567.png" srcset="/img/loading.gif" lazyload alt="image-20221001202010567"></p>
<p><strong>发布的接口：</strong></p>
<figure><div class="code-wrapper"><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@PostMapping</span>
<span class="token keyword">public</span> <span class="token class-name">Result</span> <span class="token function">saveBlog</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestBody</span> <span class="token class-name">Blog</span> blog<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">// 获取登录用户</span>
    <span class="token class-name">UserDTO</span> user <span class="token operator">=</span> <span class="token class-name">UserHolder</span><span class="token punctuation">.</span><span class="token function">getUser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    blog<span class="token punctuation">.</span><span class="token function">setUserId</span><span class="token punctuation">(</span>user<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 保存探店博文</span>
    blogService<span class="token punctuation">.</span><span class="token function">save</span><span class="token punctuation">(</span>blog<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 返回id</span>
    <span class="token keyword">return</span> <span class="token class-name">Result</span><span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span>blog<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure>

<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20221001205045986.png" srcset="/img/loading.gif" lazyload alt="image-20221001205045986"></p>
<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20221001205108659.png" srcset="/img/loading.gif" lazyload alt="image-20221001205108659"></p>
<h3 id="17-8-2查看探店博客"><a href="#17-8-2查看探店博客" class="headerlink" title="17.8.2查看探店博客"></a>17.8.2查看探店博客</h3><p>需求：点击首页的探店笔记，会进入详情页面，实现该页面的查询接口：</p>
<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20221001205244620.png" srcset="/img/loading.gif" lazyload alt="image-20221001205244620"></p>
<p>在Blog类中有三个不属于Blog类的字段，分别是用户id，用户头像和用户姓名，用于在博客页面展示用户信息 </p>
<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20221001205938724.png" srcset="/img/loading.gif" lazyload alt="image-20221001205938724"></p>
<p>控制层</p>
<figure><div class="code-wrapper"><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">"/blog/&#123;id&#125;"</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">Result</span> <span class="token function">showBlog</span><span class="token punctuation">(</span><span class="token annotation punctuation">@PathVariable</span><span class="token punctuation">(</span><span class="token string">"id"</span><span class="token punctuation">)</span> <span class="token class-name">Long</span> id<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
    <span class="token keyword">return</span> blogService<span class="token punctuation">.</span><span class="token function">queryBlogById</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre></div></figure>

<p>service层</p>
<figure><div class="code-wrapper"><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">//    根据用户id查询博客</span>
    <span class="token keyword">public</span> <span class="token class-name">Result</span> <span class="token function">queryBlogById</span><span class="token punctuation">(</span><span class="token class-name">Long</span> id<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">Blog</span> blog <span class="token operator">=</span> <span class="token function">getById</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>blog <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
            <span class="token keyword">return</span> <span class="token class-name">Result</span><span class="token punctuation">.</span><span class="token function">fail</span><span class="token punctuation">(</span><span class="token string">"博客不存在！"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token function">queryBlogUser</span><span class="token punctuation">(</span>blog<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token class-name">Result</span><span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span>blog<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

<span class="token comment">//    查询与博客有关的用户信息</span>
    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">queryBlogUser</span><span class="token punctuation">(</span><span class="token class-name">Blog</span> blog<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">//        存在就查询与博客有关的用户id</span>
        <span class="token class-name">Long</span> userId <span class="token operator">=</span> blog<span class="token punctuation">.</span><span class="token function">getUserId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//        根据id查询和用户有关的信息</span>
        <span class="token class-name">User</span> user <span class="token operator">=</span> userService<span class="token punctuation">.</span><span class="token function">getById</span><span class="token punctuation">(</span>userId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        blog<span class="token punctuation">.</span><span class="token function">setName</span><span class="token punctuation">(</span>user<span class="token punctuation">.</span><span class="token function">getNickName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        blog<span class="token punctuation">.</span><span class="token function">setIcon</span><span class="token punctuation">(</span>user<span class="token punctuation">.</span><span class="token function">getIcon</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure>

<p>实现成功</p>
<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20221001212553145.png" srcset="/img/loading.gif" lazyload alt="image-20221001212553145"></p>
<h3 id="17-8-3点赞博客-限制点赞次数"><a href="#17-8-3点赞博客-限制点赞次数" class="headerlink" title="17.8.3点赞博客(限制点赞次数)"></a>17.8.3点赞博客(限制点赞次数)</h3><p>在首页的探店笔记排行榜和探店图文详情页面都有点赞的功能：</p>
<p>需求：</p>
<ul>
<li><p>同一个用户只能点赞一次，再次点击则取消点赞</p>
</li>
<li><p>如果当前用户已经点赞，则点赞按钮高亮显示（前端已实现，判断字段Blog类的isLike属性）</p>
</li>
</ul>
<p>实现步骤：</p>
<p>①给Blog类中添加一个isLike字段，标示是否被当前用户点赞</p>
<p>②修改点赞功能，&#x3D;&#x3D;利用Redis的set集合判断是否点赞过，未点赞过则点赞数+1，已点赞过则点赞数-1&#x3D;&#x3D;</p>
<p>③修改根据id查询Blog的业务，判断当前登录用户是否点赞过，赋值给isLike字段</p>
<p>④修改分页查询Blog业务，判断当前登录用户是否点赞过，赋值给isLike字段</p>
<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20221001212755548.png" srcset="/img/loading.gif" lazyload alt="image-20221001212755548"></p>
<p>实现步骤：</p>
<p>为Blog添加isLike属性，表示点赞的状态</p>
<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20221001213942276.png" srcset="/img/loading.gif" lazyload alt="image-20221001213942276"></p>
<figure><div class="code-wrapper"><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Service</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">BlogServiceImpl</span> <span class="token keyword">extends</span> <span class="token class-name">ServiceImpl</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">BlogMapper</span><span class="token punctuation">,</span> <span class="token class-name">Blog</span><span class="token punctuation">></span></span> <span class="token keyword">implements</span> <span class="token class-name">IBlogService</span> <span class="token punctuation">&#123;</span>

    <span class="token annotation punctuation">@Resource</span>
    <span class="token keyword">private</span> <span class="token class-name">IUserService</span> userService<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Resource</span>
    <span class="token keyword">private</span> <span class="token class-name">StringRedisTemplate</span> stringRedisTemplate<span class="token punctuation">;</span>

    <span class="token comment">//    根据用户id查询博客</span>
    <span class="token keyword">public</span> <span class="token class-name">Result</span> <span class="token function">queryBlogById</span><span class="token punctuation">(</span><span class="token class-name">Long</span> id<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">Blog</span> blog <span class="token operator">=</span> <span class="token function">getById</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>blog <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">return</span> <span class="token class-name">Result</span><span class="token punctuation">.</span><span class="token function">fail</span><span class="token punctuation">(</span><span class="token string">"博客不存在！"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token function">queryBlogUser</span><span class="token punctuation">(</span>blog<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//        查询blog是否被点赞</span>
        <span class="token function">isBlogLiked</span><span class="token punctuation">(</span>blog<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token class-name">Result</span><span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span>blog<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

<span class="token comment">//    判断博客的点赞情况</span>
    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">isBlogLiked</span><span class="token punctuation">(</span><span class="token class-name">Blog</span> blog<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">//        1.获取到登录用户的id</span>
        <span class="token class-name">Long</span> userId <span class="token operator">=</span> <span class="token class-name">UserHolder</span><span class="token punctuation">.</span><span class="token function">getUser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//        2.根据用户id和博客id判断当前用户是否已经点赞</span>
        <span class="token class-name">Boolean</span> flag <span class="token operator">=</span> stringRedisTemplate<span class="token punctuation">.</span><span class="token function">opsForSet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isMember</span><span class="token punctuation">(</span><span class="token constant">BLOG_LIKED</span> <span class="token operator">+</span> blog<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> userId<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        blog<span class="token punctuation">.</span><span class="token function">setIsLike</span><span class="token punctuation">(</span><span class="token class-name">BooleanUtil</span><span class="token punctuation">.</span><span class="token function">isTrue</span><span class="token punctuation">(</span>flag<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token comment">//    查询与博客有关的用户信息</span>
    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">queryBlogUser</span><span class="token punctuation">(</span><span class="token class-name">Blog</span> blog<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">//        存在就查询与博客有关的用户id</span>
        <span class="token class-name">Long</span> userId <span class="token operator">=</span> blog<span class="token punctuation">.</span><span class="token function">getUserId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//        根据id查询和用户有关的信息</span>
        <span class="token class-name">User</span> user <span class="token operator">=</span> userService<span class="token punctuation">.</span><span class="token function">getById</span><span class="token punctuation">(</span>userId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        blog<span class="token punctuation">.</span><span class="token function">setName</span><span class="token punctuation">(</span>user<span class="token punctuation">.</span><span class="token function">getNickName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        blog<span class="token punctuation">.</span><span class="token function">setIcon</span><span class="token punctuation">(</span>user<span class="token punctuation">.</span><span class="token function">getIcon</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>


    <span class="token comment">//  查询热门博客</span>
    <span class="token keyword">public</span> <span class="token class-name">Result</span> <span class="token function">queryHotBlog</span><span class="token punctuation">(</span><span class="token class-name">Integer</span> current<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">// 根据用户查询</span>
        <span class="token class-name">Page</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Blog</span><span class="token punctuation">></span></span> page <span class="token operator">=</span> <span class="token function">query</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">orderByDesc</span><span class="token punctuation">(</span><span class="token string">"liked"</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">page</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Page</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span>current<span class="token punctuation">,</span> <span class="token class-name">SystemConstants</span><span class="token punctuation">.</span><span class="token constant">MAX_PAGE_SIZE</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 获取当前页数据</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Blog</span><span class="token punctuation">></span></span> records <span class="token operator">=</span> page<span class="token punctuation">.</span><span class="token function">getRecords</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 查询用户</span>
        records<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>blog <span class="token operator">-></span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">queryBlogUser</span><span class="token punctuation">(</span>blog<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">isBlogLiked</span><span class="token punctuation">(</span>blog<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token class-name">Result</span><span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span>records<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token comment">//  点赞功能</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">blogLike</span><span class="token punctuation">(</span><span class="token class-name">Long</span> id<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
<span class="token comment">//        1.获取到登录用户的id</span>
        <span class="token class-name">Long</span> userId <span class="token operator">=</span> <span class="token class-name">UserHolder</span><span class="token punctuation">.</span><span class="token function">getUser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//        2.根据用户id和博客id判断当前用户是否已经点赞</span>
        <span class="token class-name">Boolean</span> flag <span class="token operator">=</span> stringRedisTemplate<span class="token punctuation">.</span><span class="token function">opsForSet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isMember</span><span class="token punctuation">(</span><span class="token constant">BLOG_LIKED</span> <span class="token operator">+</span> id<span class="token punctuation">,</span> userId<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//        3.未点赞可以点赞</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">BooleanUtil</span><span class="token punctuation">.</span><span class="token function">isFalse</span><span class="token punctuation">(</span>flag<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
<span class="token comment">//        4.数据库点赞数加1</span>
            <span class="token keyword">boolean</span> isSuccess <span class="token operator">=</span> <span class="token function">update</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setSql</span><span class="token punctuation">(</span><span class="token string">"liked = liked + 1"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">eq</span><span class="token punctuation">(</span><span class="token string">"id"</span><span class="token punctuation">,</span> id<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//        5.保存博客id和用户id到缓存中的set集合</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>isSuccess<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                stringRedisTemplate<span class="token punctuation">.</span><span class="token function">opsForSet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token constant">BLOG_LIKED</span> <span class="token operator">+</span> id<span class="token punctuation">,</span> userId<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>

        <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
<span class="token comment">//        6.再次点击取消点赞,数据库点赞数减1</span>
            <span class="token keyword">boolean</span> isSuccess <span class="token operator">=</span> <span class="token function">update</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setSql</span><span class="token punctuation">(</span><span class="token string">"liked = liked - 1"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">eq</span><span class="token punctuation">(</span><span class="token string">"id"</span><span class="token punctuation">,</span> id<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//        7.从set集合当中移除用户</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>isSuccess<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                stringRedisTemplate<span class="token punctuation">.</span><span class="token function">opsForSet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span><span class="token constant">BLOG_LIKED</span> <span class="token operator">+</span> id<span class="token punctuation">,</span>userId<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure>

<img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/GIF%202022-10-1%2022-07-17.gif" srcset="/img/loading.gif" lazyload alt="GIF 2022-10-1 22-07-17" style="zoom:67%;" />

<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20221001221314975.png" srcset="/img/loading.gif" lazyload alt="image-20221001221314975"></p>
<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20221001221332473.png" srcset="/img/loading.gif" lazyload alt="image-20221001221332473"></p>
<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20221001220925594.png" srcset="/img/loading.gif" lazyload alt="image-20221001220925594"></p>
<h3 id="17-8-4点赞排行榜"><a href="#17-8-4点赞排行榜" class="headerlink" title="17.8.4点赞排行榜"></a>17.8.4点赞排行榜</h3><p>在探店笔记的详情页面，应该把给该笔记点赞的人显示出来，比如最早点赞的TOP5，形成点赞排行榜：</p>
<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20221002082341801.png" srcset="/img/loading.gif" lazyload alt="image-20221002082341801"></p>
<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20221002083249392.png" srcset="/img/loading.gif" lazyload alt="image-20221002083249392">  </p>
<p>可以采用Redis中的有序列表进行排序，以博客id为key，用户id为value，用户点赞时间戳为score，以score作为排序的条件。</p>
<figure><div class="code-wrapper"><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Service</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">BlogServiceImpl</span> <span class="token keyword">extends</span> <span class="token class-name">ServiceImpl</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">BlogMapper</span><span class="token punctuation">,</span> <span class="token class-name">Blog</span><span class="token punctuation">></span></span> <span class="token keyword">implements</span> <span class="token class-name">IBlogService</span> <span class="token punctuation">&#123;</span>

    <span class="token annotation punctuation">@Resource</span>
    <span class="token keyword">private</span> <span class="token class-name">IUserService</span> userService<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Resource</span>
    <span class="token keyword">private</span> <span class="token class-name">StringRedisTemplate</span> stringRedisTemplate<span class="token punctuation">;</span>

    <span class="token comment">//    根据用户id查询博客</span>
    <span class="token keyword">public</span> <span class="token class-name">Result</span> <span class="token function">queryBlogById</span><span class="token punctuation">(</span><span class="token class-name">Long</span> id<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">Blog</span> blog <span class="token operator">=</span> <span class="token function">getById</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>blog <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">return</span> <span class="token class-name">Result</span><span class="token punctuation">.</span><span class="token function">fail</span><span class="token punctuation">(</span><span class="token string">"博客不存在！"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token function">queryBlogUser</span><span class="token punctuation">(</span>blog<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//        查询blog是否被点赞</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">isBlogLiked</span><span class="token punctuation">(</span>blog<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token class-name">Result</span><span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span>blog<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

<span class="token comment">//    判断博客的点赞情况</span>
    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">isBlogLiked</span><span class="token punctuation">(</span><span class="token class-name">Blog</span> blog<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
<span class="token comment">//        判断用户是否登录</span>
        <span class="token class-name">UserDTO</span> user <span class="token operator">=</span> <span class="token class-name">UserHolder</span><span class="token punctuation">.</span><span class="token function">getUser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//        用户未登录就不查询点赞情况</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>user <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token comment">//        1.获取到登录用户的id</span>
        <span class="token class-name">Long</span> userId <span class="token operator">=</span> user<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//        2.根据博客id和用户id判断当前用户是否已经点赞</span>
        <span class="token class-name">Double</span> score <span class="token operator">=</span> stringRedisTemplate<span class="token punctuation">.</span><span class="token function">opsForZSet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">score</span><span class="token punctuation">(</span><span class="token constant">BLOG_LIKED_KEY</span> <span class="token operator">+</span> blog<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> userId<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        blog<span class="token punctuation">.</span><span class="token function">setIsLike</span><span class="token punctuation">(</span>score <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token comment">//    公共方法：查询与博客有关的用户信息</span>
    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">queryBlogUser</span><span class="token punctuation">(</span><span class="token class-name">Blog</span> blog<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">//        存在就查询与博客有关的用户id</span>
        <span class="token class-name">Long</span> userId <span class="token operator">=</span> blog<span class="token punctuation">.</span><span class="token function">getUserId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//        根据id查询和用户有关的信息</span>
        <span class="token class-name">User</span> user <span class="token operator">=</span> userService<span class="token punctuation">.</span><span class="token function">getById</span><span class="token punctuation">(</span>userId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        blog<span class="token punctuation">.</span><span class="token function">setName</span><span class="token punctuation">(</span>user<span class="token punctuation">.</span><span class="token function">getNickName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        blog<span class="token punctuation">.</span><span class="token function">setIcon</span><span class="token punctuation">(</span>user<span class="token punctuation">.</span><span class="token function">getIcon</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>


    <span class="token comment">//  查询热门博客</span>
    <span class="token keyword">public</span> <span class="token class-name">Result</span> <span class="token function">queryHotBlog</span><span class="token punctuation">(</span><span class="token class-name">Integer</span> current<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">// 根据用户查询</span>
        <span class="token class-name">Page</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Blog</span><span class="token punctuation">></span></span> page <span class="token operator">=</span> <span class="token function">query</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">orderByDesc</span><span class="token punctuation">(</span><span class="token string">"liked"</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">page</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Page</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span>current<span class="token punctuation">,</span> <span class="token class-name">SystemConstants</span><span class="token punctuation">.</span><span class="token constant">MAX_PAGE_SIZE</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 获取当前页数据</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Blog</span><span class="token punctuation">></span></span> records <span class="token operator">=</span> page<span class="token punctuation">.</span><span class="token function">getRecords</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 查询用户</span>
        records<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>blog <span class="token operator">-></span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">queryBlogUser</span><span class="token punctuation">(</span>blog<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">isBlogLiked</span><span class="token punctuation">(</span>blog<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token class-name">Result</span><span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span>records<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token comment">//  点赞功能</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">blogLike</span><span class="token punctuation">(</span><span class="token class-name">Long</span> id<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
<span class="token comment">//        1.获取到登录用户的id</span>
        <span class="token class-name">Long</span> userId <span class="token operator">=</span> <span class="token class-name">UserHolder</span><span class="token punctuation">.</span><span class="token function">getUser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//        2.根据用户id和博客id判断当前用户是否已经点赞</span>
        <span class="token class-name">Double</span> score <span class="token operator">=</span> stringRedisTemplate<span class="token punctuation">.</span><span class="token function">opsForZSet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">score</span><span class="token punctuation">(</span><span class="token constant">BLOG_LIKED_KEY</span> <span class="token operator">+</span> id<span class="token punctuation">,</span> userId<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//        3.未点赞可以点赞</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>score <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
<span class="token comment">//        4.数据库点赞数加1</span>
            <span class="token keyword">boolean</span> isSuccess <span class="token operator">=</span> <span class="token function">update</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setSql</span><span class="token punctuation">(</span><span class="token string">"liked = liked + 1"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">eq</span><span class="token punctuation">(</span><span class="token string">"id"</span><span class="token punctuation">,</span> id<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//        5.以博客id为key、用户id为value，当前时间戳为score</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>isSuccess<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                stringRedisTemplate<span class="token punctuation">.</span><span class="token function">opsForZSet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token constant">BLOG_LIKED_KEY</span> <span class="token operator">+</span> id<span class="token punctuation">,</span> userId<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>

        <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
<span class="token comment">//        6.再次点击取消点赞,数据库点赞数减1</span>
            <span class="token keyword">boolean</span> isSuccess <span class="token operator">=</span> <span class="token function">update</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setSql</span><span class="token punctuation">(</span><span class="token string">"liked = liked - 1"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">eq</span><span class="token punctuation">(</span><span class="token string">"id"</span><span class="token punctuation">,</span> id<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//        7.从set集合当中移除用户</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>isSuccess<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                stringRedisTemplate<span class="token punctuation">.</span><span class="token function">opsForZSet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span><span class="token constant">BLOG_LIKED_KEY</span> <span class="token operator">+</span> id<span class="token punctuation">,</span>userId<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token comment">/**
     * 查询点赞博客的前五名用户
     * @param id
     * @return
     */</span>
    <span class="token keyword">public</span> <span class="token class-name">Result</span> <span class="token function">queryBlogLikes</span><span class="token punctuation">(</span><span class="token class-name">Long</span> id<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
<span class="token comment">//        查询出前五名的用户id</span>
        <span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">></span></span> userSet <span class="token operator">=</span> stringRedisTemplate<span class="token punctuation">.</span><span class="token function">opsForZSet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">range</span><span class="token punctuation">(</span><span class="token constant">BLOG_LIKED_KEY</span> <span class="token operator">+</span> id<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>userSet <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> userSet<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
            <span class="token keyword">return</span> <span class="token class-name">Result</span><span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
<span class="token comment">//        解析出set集合中的用户id</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">></span></span> usersId <span class="token operator">=</span> userSet<span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token class-name">Long</span><span class="token operator">::</span><span class="token function">valueOf</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token class-name">Collectors</span><span class="token punctuation">.</span><span class="token function">toList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//        根据用户id查询用户</span>
        <span class="token class-name">String</span> ids <span class="token operator">=</span> <span class="token class-name">StrUtil</span><span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">","</span><span class="token punctuation">,</span> usersId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">UserDTO</span><span class="token punctuation">></span></span> userDTOS <span class="token operator">=</span> userService<span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token comment">//                解决数据库传入的字段顺序问题</span>
                <span class="token punctuation">.</span><span class="token function">in</span><span class="token punctuation">(</span><span class="token string">"id"</span><span class="token punctuation">,</span>usersId<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">last</span><span class="token punctuation">(</span><span class="token string">"ORDER BY FIELD(id,"</span> <span class="token operator">+</span> ids <span class="token operator">+</span> <span class="token string">")"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">list</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>user <span class="token operator">-></span> <span class="token class-name">BeanUtil</span><span class="token punctuation">.</span><span class="token function">copyProperties</span><span class="token punctuation">(</span>user<span class="token punctuation">,</span> <span class="token class-name">UserDTO</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token class-name">Collectors</span><span class="token punctuation">.</span><span class="token function">toList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token class-name">Result</span><span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span>userDTOS<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure>

<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20221002085404269.png" srcset="/img/loading.gif" lazyload alt="image-20221002085404269"></p>
<p>解决查询数据库in字段顺序不一致问题</p>
<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20221002095129673.png" srcset="/img/loading.gif" lazyload alt="image-20221002095129673"></p>
<p>添加ORDER BY FIELD字段指定参数顺序</p>
<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20221002095335560.png" srcset="/img/loading.gif" lazyload alt="image-20221002095335560"></p>
<p>修改前</p>
<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20221002095722986.png" srcset="/img/loading.gif" lazyload alt="image-20221002095722986"></p>
<p>修改后</p>
<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20221002095959440.png" srcset="/img/loading.gif" lazyload alt="image-20221002095959440"></p>
<h3 id="17-8-5关注和取关"><a href="#17-8-5关注和取关" class="headerlink" title="17.8.5关注和取关"></a>17.8.5关注和取关</h3><p>在探店图文的详情页面中，可以关注发布博客的作者：</p>
<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20221002100918952.png" srcset="/img/loading.gif" lazyload alt="image-20221002100918952"></p>
<p><strong>需求</strong>：基于该表数据结构，实现两个接口：</p>
<p>①关注和取关接口</p>
<p>②判断是否关注的接口</p>
<p>关注是User之间的关系，是博主与粉丝的关系，数据库中有一张tb_follow表来标示：</p>
<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20221002100946647.png" srcset="/img/loading.gif" lazyload alt="image-20221002100946647"></p>
<p>控制层</p>
<figure><div class="code-wrapper"><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">/**
 * 关注和取关
 * @param followUserId
 * @param isFollow
 * @return
 */</span>
<span class="token annotation punctuation">@PutMapping</span><span class="token punctuation">(</span><span class="token string">"/&#123;id&#125;/&#123;isFollow&#125;"</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">Result</span> <span class="token function">follow</span><span class="token punctuation">(</span><span class="token annotation punctuation">@PathVariable</span><span class="token punctuation">(</span><span class="token string">"id"</span><span class="token punctuation">)</span> <span class="token class-name">Long</span> followUserId<span class="token punctuation">,</span><span class="token annotation punctuation">@PathVariable</span><span class="token punctuation">(</span><span class="token string">"isFollow"</span><span class="token punctuation">)</span> <span class="token class-name">Boolean</span> isFollow<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
    <span class="token keyword">return</span> followService<span class="token punctuation">.</span><span class="token function">follow</span><span class="token punctuation">(</span>followUserId<span class="token punctuation">,</span>isFollow<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token comment">/**
 * 判断关注状态，加载页面时自动查询
 * @param followUserId
 * @return
 */</span>
<span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">"/or/not/&#123;id&#125;"</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">Result</span> <span class="token function">queryFollow</span><span class="token punctuation">(</span><span class="token annotation punctuation">@PathVariable</span><span class="token punctuation">(</span><span class="token string">"id"</span><span class="token punctuation">)</span> <span class="token class-name">Long</span> followUserId <span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
    <span class="token keyword">return</span> followService<span class="token punctuation">.</span><span class="token function">queryFollow</span><span class="token punctuation">(</span>followUserId<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure>

<p>Service层</p>
<figure><div class="code-wrapper"><pre class="line-numbers language-java" data-language="java"><code class="language-java">    <span class="token comment">/**
     * 关注和取关
     *
     * @param followUserId
     * @param isFollow
     * @return
     */</span>

    <span class="token annotation punctuation">@Resource</span>
    <span class="token keyword">private</span> <span class="token class-name">IFollowService</span> followService<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">Result</span> <span class="token function">follow</span><span class="token punctuation">(</span><span class="token class-name">Long</span> followUserId<span class="token punctuation">,</span> <span class="token class-name">Boolean</span> isFollow<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
<span class="token comment">//        1.获取到登录用户id</span>
        <span class="token class-name">Long</span> userId <span class="token operator">=</span> <span class="token class-name">UserHolder</span><span class="token punctuation">.</span><span class="token function">getUser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//        2.判断是关注还是取关</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>isFollow<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
<span class="token comment">//        3.关注，新增数据</span>
            <span class="token class-name">Follow</span> follow <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Follow</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//          设置用户id</span>
            follow<span class="token punctuation">.</span><span class="token function">setUserId</span><span class="token punctuation">(</span>userId<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//          设置博主id</span>
            follow<span class="token punctuation">.</span><span class="token function">setFollowUserId</span><span class="token punctuation">(</span>followUserId<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">save</span><span class="token punctuation">(</span>follow<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
<span class="token comment">//        4.取关，删除数据 delete from tb_follow where userId = ? and follow_user_id = ?</span>
            <span class="token class-name">QueryWrapper</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Follow</span><span class="token punctuation">></span></span> queryWrapper <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">QueryWrapper</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            queryWrapper<span class="token punctuation">.</span><span class="token function">eq</span><span class="token punctuation">(</span><span class="token string">"user_id"</span><span class="token punctuation">,</span> userId<span class="token punctuation">)</span><span class="token punctuation">;</span>
            queryWrapper<span class="token punctuation">.</span><span class="token function">eq</span><span class="token punctuation">(</span><span class="token string">"follow_user_id"</span><span class="token punctuation">,</span> followUserId<span class="token punctuation">)</span><span class="token punctuation">;</span>
            followService<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>queryWrapper<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token keyword">return</span> <span class="token class-name">Result</span><span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token comment">/**
     * 判断用户是否关注状态
     * @param followUserId
     * @return
     */</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">Result</span> <span class="token function">queryFollow</span><span class="token punctuation">(</span><span class="token class-name">Long</span> followUserId<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
<span class="token comment">//        select * from tb_follow where userId = ? and follow_user_id = ?</span>
        <span class="token comment">//        1.获取到登录用户id</span>
        <span class="token class-name">Long</span> userId <span class="token operator">=</span> <span class="token class-name">UserHolder</span><span class="token punctuation">.</span><span class="token function">getUser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Integer</span> count <span class="token operator">=</span> <span class="token function">query</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">eq</span><span class="token punctuation">(</span><span class="token string">"user_id"</span><span class="token punctuation">,</span> userId<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">eq</span><span class="token punctuation">(</span><span class="token string">"follow_user_id"</span><span class="token punctuation">,</span> followUserId<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">count</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token class-name">Result</span><span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span>count <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure>

<img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/GIF%202022-10-2%2016-41-56.gif" srcset="/img/loading.gif" lazyload alt="GIF 2022-10-2 16-41-56" style="zoom:67%;" />

<p>关注成功，数据库插入一条数据</p>
<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20221002164309404.png" srcset="/img/loading.gif" lazyload alt="image-20221002164309404"></p>
<h3 id="17-8-6共同关注"><a href="#17-8-6共同关注" class="headerlink" title="17.8.6共同关注"></a>17.8.6共同关注</h3><p>&#x3D;&#x3D;共同关注就是当前登录的用户和查看的博主共同关注的人&#x3D;&#x3D;</p>
<p>点击博主头像，可以进入博主首页：</p>
<p>首先<font color='red'>实现点击用户头像进入博主页面，博主页面有博主信息和发布的博客信息。</font></p>
<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20221002165827342.png" srcset="/img/loading.gif" lazyload alt="image-20221002165827342"></p>
<blockquote>
<p>查询用户信息的url   <a target="_blank" rel="noopener" href="http://localhost:8080/api/user/%7B%E7%94%A8%E6%88%B7id%7D">http://localhost:8080/api/user/{用户id}</a>  </p>
</blockquote>
<blockquote>
<p>获取到用户博客信息的url <a target="_blank" rel="noopener" href="http://localhost:8080/api/of/user">http://localhost:8080/api/of/user</a></p>
</blockquote>
<p>Service层</p>
<figure><div class="code-wrapper"><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">/**
 * 根据id查询用户
 * @param id
 * @return
 */</span>
<span class="token keyword">public</span> <span class="token class-name">Result</span> <span class="token function">queryUserById</span><span class="token punctuation">(</span><span class="token class-name">Long</span> id<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token class-name">User</span> user <span class="token operator">=</span> <span class="token function">getById</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>user <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> <span class="token class-name">Result</span><span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token class-name">UserDTO</span> userDTO <span class="token operator">=</span> <span class="token class-name">BeanUtil</span><span class="token punctuation">.</span><span class="token function">copyProperties</span><span class="token punctuation">(</span>user<span class="token punctuation">,</span> <span class="token class-name">UserDTO</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token class-name">Result</span><span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span>userDTO<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure>

<figure><div class="code-wrapper"><pre class="line-numbers language-java" data-language="java"><code class="language-java">    <span class="token comment">/**
     * 查询博主的所有博客
     */</span>
    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">"/of/user"</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">Result</span> <span class="token function">queryUserBlog</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestParam</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">"current"</span><span class="token punctuation">,</span> defaultValue <span class="token operator">=</span> <span class="token string">"1"</span><span class="token punctuation">)</span> <span class="token class-name">Integer</span> current<span class="token punctuation">,</span>
                                <span class="token annotation punctuation">@RequestParam</span><span class="token punctuation">(</span><span class="token string">"id"</span><span class="token punctuation">)</span> <span class="token class-name">Long</span> id<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
<span class="token comment">//        根据用户id查询博客信息</span>
        <span class="token class-name">Page</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Blog</span><span class="token punctuation">></span></span> page <span class="token operator">=</span> blogService<span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">eq</span><span class="token punctuation">(</span><span class="token string">"user_id"</span><span class="token punctuation">,</span> id<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">page</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Page</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span>current<span class="token punctuation">,</span> <span class="token class-name">SystemConstants</span><span class="token punctuation">.</span><span class="token constant">MAX_PAGE_SIZE</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//        获取当前页信息</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Blog</span><span class="token punctuation">></span></span> records <span class="token operator">=</span> page<span class="token punctuation">.</span><span class="token function">getRecords</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token class-name">Result</span><span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span>records<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure>

<p>实现完成，接下实现共同关注</p>
<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20221002171218256.png" srcset="/img/loading.gif" lazyload alt="image-20221002171218256"></p>
<p><strong>实现共同关注</strong></p>
<p>需求：利用Redis中恰当的数据结构，实现共同关注功能。在博主个人页面展示出当前用户与博主的共同好友。</p>
<blockquote>
<p>查询博主和当前用户的共同关注接口 <a target="_blank" rel="noopener" href="http://localhost:8080/api/follow/common/%7B%E5%8D%9A%E4%B8%BBid%7D">http://localhost:8080/api/follow/common/{博主id}</a></p>
</blockquote>
<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20221002171346858.png" srcset="/img/loading.gif" lazyload alt="image-20221002171346858"></p>
<p>在之间的关注功能业务里添加：当关注一个博主时，将以当前登录用户id做为key，关注的博主id做为value。查询两个用户的共同关注就求缓存中两个用户关注列表的交集。</p>
<p>Service层的FollowServiceImpl</p>
<p>添加用户关注博主时的缓存信息</p>
<figure><div class="code-wrapper"><pre class="line-numbers language-java" data-language="java"><code class="language-java">    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">Result</span> <span class="token function">follow</span><span class="token punctuation">(</span><span class="token class-name">Long</span> followUserId<span class="token punctuation">,</span> <span class="token class-name">Boolean</span> isFollow<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
<span class="token comment">//        1.获取到登录用户id</span>
        <span class="token class-name">Long</span> userId <span class="token operator">=</span> <span class="token class-name">UserHolder</span><span class="token punctuation">.</span><span class="token function">getUser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//        2.判断是关注还是取关</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>isFollow<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
<span class="token comment">//        3.关注，新增数据</span>
            <span class="token class-name">Follow</span> follow <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Follow</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//          设置用户id</span>
            follow<span class="token punctuation">.</span><span class="token function">setUserId</span><span class="token punctuation">(</span>userId<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//          设置博主id</span>
            follow<span class="token punctuation">.</span><span class="token function">setFollowUserId</span><span class="token punctuation">(</span>followUserId<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">boolean</span> isSave <span class="token operator">=</span> <span class="token function">save</span><span class="token punctuation">(</span>follow<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>isSave<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
<span class="token comment">//                成功关注后以用户id作为key,关注的博主id作为value存入redis</span>
                stringRedisTemplate<span class="token punctuation">.</span><span class="token function">opsForSet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token constant">FOLLOW_BLOGGER_KEY</span> <span class="token operator">+</span> userId<span class="token punctuation">,</span> followUserId<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
<span class="token comment">//        4.取关，删除数据 delete from tb_follow where userId = ? and follow_user_id = ?</span>
            <span class="token class-name">QueryWrapper</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Follow</span><span class="token punctuation">></span></span> queryWrapper <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">QueryWrapper</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            queryWrapper<span class="token punctuation">.</span><span class="token function">eq</span><span class="token punctuation">(</span><span class="token string">"user_id"</span><span class="token punctuation">,</span> userId<span class="token punctuation">)</span><span class="token punctuation">;</span>
            queryWrapper<span class="token punctuation">.</span><span class="token function">eq</span><span class="token punctuation">(</span><span class="token string">"follow_user_id"</span><span class="token punctuation">,</span> followUserId<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">boolean</span> remove <span class="token operator">=</span> followService<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>queryWrapper<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>remove<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                <span class="token comment">//            在Redis集合中移除关注的用户id</span>
                stringRedisTemplate<span class="token punctuation">.</span><span class="token function">opsForSet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span><span class="token constant">FOLLOW_BLOGGER_KEY</span> <span class="token operator">+</span> userId<span class="token punctuation">,</span> followUserId<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token keyword">return</span> <span class="token class-name">Result</span><span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token comment">/**
     * 根据博主id查询和当前用的共同关注
     * @param followUserId
     * @return
     */</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">Result</span> <span class="token function">queryFollowCommon</span><span class="token punctuation">(</span><span class="token class-name">Long</span> followUserId<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
<span class="token comment">//        获取当前用户id</span>
        <span class="token class-name">Long</span> userId <span class="token operator">=</span> <span class="token class-name">UserHolder</span><span class="token punctuation">.</span><span class="token function">getUser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//        传入两个key，求当前用户和博主的交集</span>
        <span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">></span></span> intersect <span class="token operator">=</span> stringRedisTemplate<span class="token punctuation">.</span><span class="token function">opsForSet</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">intersect</span><span class="token punctuation">(</span><span class="token constant">FOLLOW_BLOGGER_KEY</span> <span class="token operator">+</span> userId<span class="token punctuation">,</span> <span class="token constant">FOLLOW_BLOGGER_KEY</span> <span class="token operator">+</span> followUserId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>intersect <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> intersect<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
            <span class="token keyword">return</span> <span class="token class-name">Result</span><span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span><span class="token class-name">Collections</span><span class="token punctuation">.</span><span class="token function">emptyList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
<span class="token comment">//        将set集合类型解析为Long型的List集合</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">></span></span> ids <span class="token operator">=</span> intersect<span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token class-name">Long</span><span class="token operator">::</span><span class="token function">valueOf</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token class-name">Collectors</span><span class="token punctuation">.</span><span class="token function">toList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//        根据id集合查询用户</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">UserDTO</span><span class="token punctuation">></span></span> users <span class="token operator">=</span> userService<span class="token punctuation">.</span><span class="token function">listByIds</span><span class="token punctuation">(</span>ids<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>user <span class="token operator">-></span> <span class="token class-name">BeanUtil</span><span class="token punctuation">.</span><span class="token function">copyProperties</span><span class="token punctuation">(</span>user<span class="token punctuation">,</span><span class="token class-name">UserDTO</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token class-name">Collectors</span><span class="token punctuation">.</span><span class="token function">toList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token class-name">Result</span><span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span>users<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure>

<p>测试：</p>
<p>​	<font color='red'>登录三个用户，分别是 阳光、可爱多、可可今天不吃肉，让前两者关注后者，在阳光账户下查看可爱多的共同关注列表。</font></p>
<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20221002180636566.png" srcset="/img/loading.gif" lazyload alt="image-20221002180636566"></p>
<p>缓存信息，&#x3D;&#x3D;id为1（阳光）和id为5（可爱多）的用户共同关注了id为2（可可今天不吃肉）的用户&#x3D;&#x3D;</p>
<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/GIF%202022-10-2%2018-07-53.gif" srcset="/img/loading.gif" lazyload alt="GIF 2022-10-2 18-07-53"></p>
<h3 id="17-8-7关注推送-Feed流"><a href="#17-8-7关注推送-Feed流" class="headerlink" title="17.8.7关注推送(Feed流)"></a>17.8.7关注推送(Feed流)</h3><p>关注推送也叫做<font color='red'>Feed流</font>，直译为投喂。为用户持续的提供“沉浸式”的体验，通过无限下拉刷新获取新的信息。</p>
<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20221002184404688.png" srcset="/img/loading.gif" lazyload alt="image-20221002184404688"></p>
<p><strong>Feed流的模式：</strong></p>
<p>Feed流产品有两种常见模式：</p>
<p><strong>Timeline</strong>：<font color='red'>不做内容筛选，简单的按照内容发布时间排序，常用于好友或关注</font>。例如朋友圈</p>
<ul>
<li><p>优点：信息全面，不会有缺失。并且实现也相对简单</p>
</li>
<li><p>缺点：信息噪音较多，用户不一定感兴趣，内容获取效率低</p>
</li>
</ul>
<p><strong>智能排序</strong>：<font color='red'>利用智能算法屏蔽掉违规的、用户不感兴趣的内容。推送用户感兴趣信息来吸引用户</font></p>
<ul>
<li><p>优点：投喂用户感兴趣信息，用户粘度很高，容易沉迷</p>
</li>
<li><p>缺点：如果算法不精准，可能起到反作用</p>
</li>
</ul>
<p>本例中的个人页面，<font color='cornflowerblue'>是基于关注的好友来做Feed流，因此采用Timeline的模式</font>。该模式的实现方案有三种：</p>
<ol>
<li><p>&#x3D;&#x3D;拉模式&#x3D;&#x3D;</p>
</li>
<li><p>&#x3D;&#x3D;推模式&#x3D;&#x3D;</p>
</li>
<li><p>&#x3D;&#x3D;推拉结合&#x3D;&#x3D;</p>
<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20221002191559541.png" srcset="/img/loading.gif" lazyload alt="image-20221002191559541"></p>
</li>
</ol>
<p>&#x3D;&#x3D;一：拉模式&#x3D;&#x3D;</p>
<p>用户可以根据关注的博主对其发件箱中的内容进行拉取，然后将拉取的内容按照时间进行排序。</p>
<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/GIF%202022-10-2%2019-10-27-1664709264861.gif" srcset="/img/loading.gif" lazyload alt="GIF 2022-10-2 19-10-27"></p>
<p>&#x3D;&#x3D;二：推模式&#x3D;&#x3D;</p>
<p>博主会将内容推送给所有的粉丝的收件箱中，并且会进行排序好。粉丝每次可以在收件箱中直接进行读取。</p>
<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/GIF%202022-10-2%2019-12-06.gif" srcset="/img/loading.gif" lazyload alt="GIF 2022-10-2 19-12-06"></p>
<p>&#x3D;&#x3D;三：推拉结合&#x3D;&#x3D;</p>
<p>活跃粉丝采用推模式，普通粉丝采用拉模式。</p>
<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/GIF%202022-10-2%2019-13-23.gif" srcset="/img/loading.gif" lazyload alt="GIF 2022-10-2 19-13-23"></p>
<h3 id="17-8-9Feed的分页问题"><a href="#17-8-9Feed的分页问题" class="headerlink" title="17.8.9Feed的分页问题"></a>17.8.9Feed的分页问题</h3><p><font color='cornflowerblue'>Feed流中的数据会不断更新，所以数据的角标也在变化，会读取到重复的数据</font>。因此不能采用传统的分页模式。</p>
<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20221002193403702.png" srcset="/img/loading.gif" lazyload alt="image-20221002193403702"></p>
<p><strong>Feed流的滚动分页</strong></p>
<p><font color='red'>记录上次最后的一条记录，下次分页在此记录之后进行分页</font></p>
<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20221002193820703.png" srcset="/img/loading.gif" lazyload alt="image-20221002193820703"></p>
<h3 id="17-8-8基于Timeline模式的推方式实现关注推送"><a href="#17-8-8基于Timeline模式的推方式实现关注推送" class="headerlink" title="17.8.8基于Timeline模式的推方式实现关注推送"></a>17.8.8基于Timeline模式的推方式实现关注推送</h3><p><strong>需求</strong>：</p>
<p>①修改新增探店笔记的业务，<font color='cornflowerblue'>在保存blog到数据库的同时，遍历当前用户的粉丝，并将blog推送到粉丝的收件箱。</font></p>
<p>②<font color='cornflowerblue'>收件箱满足可以根据时间戳排序，必须用Redis的数据结构实现。</font><code>收件箱是以粉丝的id作为key，发布的新博客id作为value，时间戳为score。</code></p>
<p>③<font color='red'>查询收件箱数据时，可以实现分页查询</font></p>
<figure><div class="code-wrapper"><pre class="line-numbers language-java" data-language="java"><code class="language-java">    <span class="token keyword">public</span> <span class="token class-name">Result</span> <span class="token function">saveBlog</span><span class="token punctuation">(</span><span class="token class-name">Blog</span> blog<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
<span class="token comment">//        获取到当前登录用户的id</span>
        <span class="token class-name">Long</span> userId <span class="token operator">=</span> <span class="token class-name">UserHolder</span><span class="token punctuation">.</span><span class="token function">getUser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        blog<span class="token punctuation">.</span><span class="token function">setUserId</span><span class="token punctuation">(</span>userId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">boolean</span> isSave <span class="token operator">=</span> <span class="token function">save</span><span class="token punctuation">(</span>blog<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>isSave<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
            <span class="token keyword">return</span> <span class="token class-name">Result</span><span class="token punctuation">.</span><span class="token function">fail</span><span class="token punctuation">(</span><span class="token string">"添加博客失败"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
<span class="token comment">//        查询当前用户的所有粉丝select * from tb_follow where follow_user_id = ?</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Follow</span><span class="token punctuation">></span></span> follows <span class="token operator">=</span> followService<span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">eq</span><span class="token punctuation">(</span><span class="token string">"follow_user_id"</span><span class="token punctuation">,</span> userId<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">list</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//        推送笔记给所有粉丝</span>
        <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token class-name">Follow</span> follow<span class="token operator">:</span>follows<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
<span class="token comment">//            获取到粉丝id</span>
            <span class="token class-name">Long</span> followId <span class="token operator">=</span> follow<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//            推送：以粉丝的id作为key，发布的新博客id作为value，时间戳为score</span>
            stringRedisTemplate<span class="token punctuation">.</span><span class="token function">opsForZSet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token constant">FEED_FOLLOWS_KEY</span> <span class="token operator">+</span> followId<span class="token punctuation">,</span>blog<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token keyword">return</span> <span class="token class-name">Result</span><span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span>blog<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure>

<h3 id="17-8-9实现关注页面的分页查询"><a href="#17-8-9实现关注页面的分页查询" class="headerlink" title="17.8.9实现关注页面的分页查询"></a>17.8.9实现关注页面的分页查询</h3><p>需求：在个人主页的“关注”卡片中，查询并展示推送的Blog信息：</p>
<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20221002201036116.png" srcset="/img/loading.gif" lazyload alt="image-20221002201036116"></p>
<figure><div class="code-wrapper"><pre class="line-numbers language-java" data-language="java"><code class="language-java">    <span class="token comment">/**
     * 查询用户的关注者发布的所有博客
     *
     * @param max
     * @param offset
     * @return
     */</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">Result</span> <span class="token function">queryBlogOfFollow</span><span class="token punctuation">(</span><span class="token class-name">Long</span> max<span class="token punctuation">,</span> <span class="token class-name">Integer</span> offset<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
<span class="token comment">//        1.获取到当前用户</span>
        <span class="token class-name">Long</span> userId <span class="token operator">=</span> <span class="token class-name">UserHolder</span><span class="token punctuation">.</span><span class="token function">getUser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//        2.查询收件箱 zrangebyscore key min max [limit offset count]</span>
        <span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ZSetOperations<span class="token punctuation">.</span>TypedTuple</span><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">></span><span class="token punctuation">></span></span> typedTuples <span class="token operator">=</span> stringRedisTemplate<span class="token punctuation">.</span><span class="token function">opsForZSet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>
                <span class="token function">reverseRangeByScoreWithScores</span><span class="token punctuation">(</span><span class="token constant">FEED_FOLLOWS_KEY</span> <span class="token operator">+</span> userId<span class="token punctuation">,</span>
                        <span class="token number">0</span><span class="token punctuation">,</span> max<span class="token punctuation">,</span> offset<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//        3.判断是否为空</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>typedTuples <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> typedTuples<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">return</span> <span class="token class-name">Result</span><span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
<span class="token comment">//        4.解析blogId、score(时间戳)、offset(上次查询最小的相同的个数)</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">></span></span> idList <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span>typedTuples<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">long</span> minTime <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> offsets <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">ZSetOperations<span class="token punctuation">.</span>TypedTuple</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">></span></span> tuple <span class="token operator">:</span> typedTuples<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
<span class="token comment">//                4.1获取blog的id</span>
            idList<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token class-name">Long</span><span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span>tuple<span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//                4.2获取时间戳</span>
            <span class="token keyword">long</span> time <span class="token operator">=</span> tuple<span class="token punctuation">.</span><span class="token function">getScore</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">longValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//                4.3判断获取的时间戳是不是最小的</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>time <span class="token operator">==</span> minTime<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                offsets<span class="token operator">++</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
                minTime <span class="token operator">=</span> time<span class="token punctuation">;</span> <span class="token comment">//最小时间</span>
                offsets <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span>
<span class="token comment">//            StrUtil.join将数组用分隔字符串合(,)并为字符串</span>
        <span class="token class-name">String</span> idStr <span class="token operator">=</span> <span class="token class-name">StrUtil</span><span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">","</span><span class="token punctuation">,</span> idList<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//        4.根据blog的id查询blog</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Blog</span><span class="token punctuation">></span></span> blogs <span class="token operator">=</span> <span class="token function">query</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">in</span><span class="token punctuation">(</span><span class="token string">"id"</span><span class="token punctuation">,</span> idList<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">last</span><span class="token punctuation">(</span><span class="token string">"ORDER BY FIELD(id,"</span> <span class="token operator">+</span> idStr <span class="token operator">+</span> <span class="token string">")"</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">list</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Blog</span> blog <span class="token operator">:</span> blogs<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
<span class="token comment">//        4.1查询博主信息</span>
            <span class="token function">queryBlogUser</span><span class="token punctuation">(</span>blog<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//        4.2查询blog是否被点赞</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">isBlogLiked</span><span class="token punctuation">(</span>blog<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
<span class="token comment">//        5.封装ScrollResult对象</span>
        <span class="token class-name">ScrollResult</span> scrollResult <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ScrollResult</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        scrollResult<span class="token punctuation">.</span><span class="token function">setList</span><span class="token punctuation">(</span>blogs<span class="token punctuation">)</span><span class="token punctuation">;</span>
        scrollResult<span class="token punctuation">.</span><span class="token function">setMinTime</span><span class="token punctuation">(</span>minTime<span class="token punctuation">)</span><span class="token punctuation">;</span>
        scrollResult<span class="token punctuation">.</span><span class="token function">setOffset</span><span class="token punctuation">(</span>offsets<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token class-name">Result</span><span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span>scrollResult<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure>



<img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/GIF%202022-10-3%208-31-38.gif" srcset="/img/loading.gif" lazyload alt="GIF 2022-10-3 8-31-38" style="zoom:67%;" />

<h2 id="17-9附近商户"><a href="#17-9附近商户" class="headerlink" title="17.9附近商户"></a>17.9附近商户</h2><h3 id="17-9-1GEO数据结构概念"><a href="#17-9-1GEO数据结构概念" class="headerlink" title="17.9.1GEO数据结构概念"></a>17.9.1GEO数据结构概念</h3><p><code>GEO就是Geolocation(地理坐标)的简写形式</code>。Redis在3.2版本中加入了对GEO的支持，允许存储地理坐标信息，帮助我们根据经纬度来检索数据。常见的命令有：</p>
<p><a target="_blank" rel="noopener" href="https://redis.io/commands/geoadd">GEOADD</a>：添加一个地理空间信息，包含：经度（longitude）、纬度（latitude）、值（member）</p>
<p><a target="_blank" rel="noopener" href="https://redis.io/commands/geodist">GEODIST</a>：计算指定的两个点之间的距离并返回</p>
<p><a target="_blank" rel="noopener" href="https://redis.io/commands/geohash">GEOHASH</a>：将指定member的坐标转为hash字符串形式并返回</p>
<p><a target="_blank" rel="noopener" href="https://redis.io/commands/geopos">GEOPOS</a>：返回指定member的坐标</p>
<p><a target="_blank" rel="noopener" href="https://redis.io/commands/geosearch">GEOSEARCH</a>：在指定范围内搜索member，并按照与指定点之间的距离排序后返回。范围可以是圆形或矩形。6.2.新功能</p>
<p><a target="_blank" rel="noopener" href="https://redis.io/commands/geosearchstore">GEOSEARCHSTORE</a>：与GEOSEARCH功能一致，不过可以把结果存储到一个指定的key。 6.2.新功能</p>
<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20221003085145257.png" srcset="/img/loading.gif" lazyload alt="image-20221003085145257"></p>
<h3 id="17-9-2GEO数据结构练习"><a href="#17-9-2GEO数据结构练习" class="headerlink" title="17.9.2GEO数据结构练习"></a>17.9.2GEO数据结构练习</h3><p><strong>1.添加下面几条数据：</strong></p>
<ul>
<li><p>北京南站（ 116.378248 39.865275 ）</p>
</li>
<li><p>北京站（ 116.42803 39.903738 ）</p>
</li>
<li><p>北京西站（ 116.322287 39.893729 ）</p>
</li>
</ul>
<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20221003085340116.png" srcset="/img/loading.gif" lazyload alt="image-20221003085340116"></p>
<p>查看缓存</p>
<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20221003085407014.png" srcset="/img/loading.gif" lazyload alt="image-20221003085407014"></p>
<p><strong>2.计算北京西站到北京站的距离</strong></p>
<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20221003085750135.png" srcset="/img/loading.gif" lazyload alt="image-20221003085750135"></p>
<p><strong>3.搜索天安门（ 116.397904 39.909005 ）附近10km内的所有火车站，并按照距离升序排序</strong></p>
<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20221003090711008.png" srcset="/img/loading.gif" lazyload alt="image-20221003090711008"></p>
<h3 id="17-9-3将商户按照类型分组并存入缓存"><a href="#17-9-3将商户按照类型分组并存入缓存" class="headerlink" title="17.9.3将商户按照类型分组并存入缓存"></a>17.9.3将商户按照类型分组并存入缓存</h3><p>在首页中点击某个频道，即可看到频道下的商户：</p>
<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20221003090952966.png" srcset="/img/loading.gif" lazyload alt="image-20221003090952966"></p>
<p>按照商户类型做分组，类型相同的商户作为同一组，以typeId为key存入同一个GEO集合中即可</p>
<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20221003092137543.png" srcset="/img/loading.gif" lazyload alt="image-20221003092137543"></p>
<figure><div class="code-wrapper"><pre class="line-numbers language-java" data-language="java"><code class="language-java">    <span class="token annotation punctuation">@Test</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">addShop</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
<span class="token comment">//        1.查询商户信息</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Shop</span><span class="token punctuation">></span></span> shopList <span class="token operator">=</span> shopService<span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">list</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//        2.按照商户的typeId进行分组</span>
        <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">,</span> <span class="token class-name">List</span><span class="token punctuation">&lt;</span><span class="token class-name">Shop</span><span class="token punctuation">></span><span class="token punctuation">></span></span> shopMap <span class="token operator">=</span> shopList
                <span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token class-name">Collectors</span><span class="token punctuation">.</span><span class="token function">groupingBy</span><span class="token punctuation">(</span>shop <span class="token operator">-></span> shop<span class="token punctuation">.</span><span class="token function">getTypeId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//        3.分批写入redis</span>
<span class="token comment">//        3.1Map.Entry里面包含getKey()和getValue()方法,该方法返回值就是这个map中各个键值对映射关系的集合。</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Map<span class="token punctuation">.</span>Entry</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">,</span> <span class="token class-name">List</span><span class="token punctuation">&lt;</span><span class="token class-name">Shop</span><span class="token punctuation">></span><span class="token punctuation">></span></span> entry <span class="token operator">:</span> shopMap<span class="token punctuation">.</span><span class="token function">entrySet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
<span class="token comment">//        3.2获取到类型id</span>
            <span class="token class-name">Long</span> typeId <span class="token operator">=</span> entry<span class="token punctuation">.</span><span class="token function">getKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//        3.2获取同类型店铺的集合</span>
            <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Shop</span><span class="token punctuation">></span></span> shops <span class="token operator">=</span> entry<span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//        3.3写入redis GEOADD key 精度 维度 member</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Shop</span> shop <span class="token operator">:</span> shops<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                stringRedisTemplate<span class="token punctuation">.</span><span class="token function">opsForGeo</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                        <span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token constant">SHOP_GEO_KEY</span> <span class="token operator">+</span> typeId<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Point</span><span class="token punctuation">(</span>shop<span class="token punctuation">.</span><span class="token function">getX</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> shop<span class="token punctuation">.</span><span class="token function">getY</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> shop<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure>

<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20221003100319843.png" srcset="/img/loading.gif" lazyload alt="image-20221003100319843"></p>
<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20221003100152877.png" srcset="/img/loading.gif" lazyload alt="image-20221003100152877"></p>
<h3 id="17-9-4搜索附近商户"><a href="#17-9-4搜索附近商户" class="headerlink" title="17.9.4搜索附近商户"></a>17.9.4搜索附近商户</h3><p>因为GEO是在redis3.2版本加入的，所以对redis的依赖和lettuce连接池版本要求高。</p>
<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20221003113946568.png" srcset="/img/loading.gif" lazyload alt="image-20221003113946568"></p>
<p>进行排除，添加高版本的相关依赖</p>
<figure><div class="code-wrapper"><pre class="line-numbers language-markup" data-language="markup"><code class="language-markup"><span class="token comment">&lt;!--        redis依赖--></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>org.springframework.data<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>spring-data-redis<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">></span></span>2.7.3<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span>
<span class="token comment">&lt;!--        lettuce连接池--></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>io.lettuce<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>lettuce-core<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">></span></span>6.1.9.RELEASE<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure>

<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20221003114342647.png" srcset="/img/loading.gif" lazyload alt="image-20221003114342647"></p>
<figure><div class="code-wrapper"><pre class="line-numbers language-java" data-language="java"><code class="language-java">    <span class="token comment">/**
     * 按照商户类型进行距离查询
     *
     * @param typeId
     * @param current
     * @param x
     * @param y
     * @return
     */</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">Result</span> <span class="token function">queryShopByType</span><span class="token punctuation">(</span><span class="token class-name">Integer</span> typeId<span class="token punctuation">,</span> <span class="token class-name">Integer</span> current<span class="token punctuation">,</span> <span class="token class-name">Double</span> x<span class="token punctuation">,</span> <span class="token class-name">Double</span> y<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
<span class="token comment">//        1.判断是否需要根据坐标查询</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>x <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> y <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token comment">// 根据类型分页查询</span>
            <span class="token class-name">Page</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Shop</span><span class="token punctuation">></span></span> page <span class="token operator">=</span> <span class="token function">query</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">eq</span><span class="token punctuation">(</span><span class="token string">"type_id"</span><span class="token punctuation">,</span> typeId<span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">page</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Page</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span>current<span class="token punctuation">,</span> <span class="token class-name">SystemConstants</span><span class="token punctuation">.</span><span class="token constant">DEFAULT_PAGE_SIZE</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 返回数据</span>
            <span class="token keyword">return</span> <span class="token class-name">Result</span><span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span>page<span class="token punctuation">.</span><span class="token function">getRecords</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
<span class="token comment">//        2.计算分页参数</span>
        <span class="token keyword">int</span> start <span class="token operator">=</span> <span class="token punctuation">(</span>current <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token class-name">SystemConstants</span><span class="token punctuation">.</span><span class="token constant">DEFAULT_PAGE_SIZE</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> end <span class="token operator">=</span> current <span class="token operator">*</span> <span class="token class-name">SystemConstants</span><span class="token punctuation">.</span><span class="token constant">DEFAULT_PAGE_SIZE</span><span class="token punctuation">;</span>
<span class="token comment">//        3.查询redis、按照距离排序、分页。结果：shopId、distance</span>
        <span class="token class-name">GeoResults</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">RedisGeoCommands<span class="token punctuation">.</span>GeoLocation</span><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">></span><span class="token punctuation">></span></span> results <span class="token operator">=</span> stringRedisTemplate<span class="token punctuation">.</span><span class="token function">opsForGeo</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">search</span><span class="token punctuation">(</span><span class="token constant">SHOP_GEO_KEY</span> <span class="token operator">+</span> typeId<span class="token punctuation">,</span>
                        <span class="token class-name">GeoReference</span><span class="token punctuation">.</span><span class="token function">fromCoordinate</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span> y<span class="token punctuation">)</span><span class="token punctuation">,</span>
                        <span class="token keyword">new</span> <span class="token class-name">Distance</span><span class="token punctuation">(</span><span class="token number">5000</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                        <span class="token class-name">RedisGeoCommands<span class="token punctuation">.</span>
                                GeoSearchCommandArgs</span><span class="token punctuation">.</span>
                                <span class="token function">newGeoSearchArgs</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>
                                <span class="token function">includeDistance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>
                                <span class="token function">limit</span><span class="token punctuation">(</span>end<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>results <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
            <span class="token keyword">return</span> <span class="token class-name">Result</span><span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">GeoResult</span><span class="token punctuation">&lt;</span><span class="token class-name">RedisGeoCommands<span class="token punctuation">.</span>GeoLocation</span><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">></span><span class="token punctuation">></span><span class="token punctuation">></span></span> list <span class="token operator">=</span> results<span class="token punctuation">.</span><span class="token function">getContent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>list<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;=</span> start<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
<span class="token comment">//            没有下一页，返回空</span>
            <span class="token keyword">return</span> <span class="token class-name">Result</span><span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
<span class="token comment">//        4.截取start-end部分</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">></span></span> ids <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span><span class="token class-name">Distance</span><span class="token punctuation">></span></span> distanceMap <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span>list<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        list<span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">skip</span><span class="token punctuation">(</span>start<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>result <span class="token operator">-></span><span class="token punctuation">&#123;</span>
<span class="token comment">//            获取商户id</span>
            <span class="token class-name">String</span> shopIdStr <span class="token operator">=</span> result<span class="token punctuation">.</span><span class="token function">getContent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            ids<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token class-name">Long</span><span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span>shopIdStr<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//            获取距离</span>
            <span class="token class-name">Distance</span> distance <span class="token operator">=</span> result<span class="token punctuation">.</span><span class="token function">getDistance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            distanceMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>shopIdStr<span class="token punctuation">,</span>distance<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//        5.根据id查询Shop</span>
        <span class="token class-name">String</span> idStr <span class="token operator">=</span> <span class="token class-name">StrUtil</span><span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">","</span><span class="token punctuation">,</span> ids<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Shop</span><span class="token punctuation">></span></span> shops <span class="token operator">=</span> <span class="token function">query</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">in</span><span class="token punctuation">(</span><span class="token string">"id"</span><span class="token punctuation">,</span> ids<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">last</span><span class="token punctuation">(</span><span class="token string">"ORDER BY FIELD(id,"</span> <span class="token operator">+</span> idStr <span class="token operator">+</span> <span class="token string">")"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">list</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Shop</span> shop <span class="token operator">:</span> shops<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            shop<span class="token punctuation">.</span><span class="token function">setDistance</span><span class="token punctuation">(</span>distanceMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>shop<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token keyword">return</span> <span class="token class-name">Result</span><span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span>shops<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure>

<img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/GIF%202022-10-3%2012-50-42.gif" srcset="/img/loading.gif" lazyload alt="GIF 2022-10-3 12-50-42" style="zoom:67%;" />

<h2 id="17-10用户签到"><a href="#17-10用户签到" class="headerlink" title="17.10用户签到"></a>17.10用户签到</h2><h3 id="17-10-1BitMap的用法"><a href="#17-10-1BitMap的用法" class="headerlink" title="17.10.1BitMap的用法"></a>17.10.1BitMap的用法</h3><p>假如我们用一张表来存储用户签到信息，其结构应该如下：</p>
<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20221003125403603.png" srcset="/img/loading.gif" lazyload alt="image-20221003125403603"></p>
<p>假如有1000万用户，平均每人每年签到次数为10次，则这张表一年的数据量为 1亿条</p>
<p>每签到一次需要使用（8 + 8 + 1 + 1 + 3 + 1）共22 字节的内存，一个月则最多需要600多字节</p>
<p>我们按月来统计用户签到信息，签到记录为1，未签到则记录为0.</p>
<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20221003131332901.png" srcset="/img/loading.gif" lazyload alt="image-20221003131332901"></p>
<p><strong>Redis</strong>中<strong>是利用string类型数据结构实现</strong>BitMap<strong>，</strong>因此最大上限是512M，转换为bit则是 2^32个bit位。</p>
<p>BitMap的操作命令有：</p>
<p><a target="_blank" rel="noopener" href="https://redis.io/commands/setbit">SETBIT</a>：向指定位置（offset）存入一个0或1</p>
<p><a target="_blank" rel="noopener" href="https://redis.io/commands/getbit">GETBIT</a> ：获取指定位置（offset）的bit值</p>
<p><a target="_blank" rel="noopener" href="https://redis.io/commands/bitcount">BITCOUNT</a> ：统计BitMap中值为1的bit位的数量</p>
<p><a target="_blank" rel="noopener" href="https://redis.io/commands/bitfield">BITFIELD</a> ：&#x3D;&#x3D;操作（查询、修改、自增）BitMap中bit数组中的指定位置（offset）的值&#x3D;&#x3D;</p>
<p><a target="_blank" rel="noopener" href="https://redis.io/commands/bitfield_ro">BITFIELD_RO</a> ：获取BitMap中bit数组，并以十进制形式返回</p>
<p><a target="_blank" rel="noopener" href="https://redis.io/commands/bitop">BITOP</a> ：将多个BitMap的结果做位运算（与 、或、异或）</p>
<p><a target="_blank" rel="noopener" href="https://redis.io/commands/bitpos">BITPOS</a> ：查找bit数组中指定范围内第一个0或1出现的位置</p>
<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20221003132904312.png" srcset="/img/loading.gif" lazyload alt="image-20221003132904312"></p>
<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20221003132913046.png" srcset="/img/loading.gif" lazyload alt="image-20221003132913046"></p>
<p>查询某一天的签到情况</p>
<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20221003133022078.png" srcset="/img/loading.gif" lazyload alt="image-20221003133022078"></p>
<p>使用BITFIELD命令查询指定位置的数值，返回的是十进制。</p>
<p>​	u表示是无符号(即正值)，0表示从头开始查询</p>
<p>​	查询结果为7，即二进制111的十进制结果</p>
<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20221003134435325.png" srcset="/img/loading.gif" lazyload alt="image-20221003134435325"></p>
<h3 id="17-10-2实现签到功能"><a href="#17-10-2实现签到功能" class="headerlink" title="17.10.2实现签到功能"></a>17.10.2实现签到功能</h3><p>需求：实现签到接口，将当前用户当天签到信息保存到Redis中</p>
<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20221003134731177.png" srcset="/img/loading.gif" lazyload alt="image-20221003134731177"></p>
<p>提示：因为BitMap底层是基于String数据结构，因此其操作也都封装在字符串相关操作中了。</p>
<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20221003134941602.png" srcset="/img/loading.gif" lazyload alt="image-20221003134941602"></p>
<figure><div class="code-wrapper"><pre class="line-numbers language-java" data-language="java"><code class="language-java">    <span class="token comment">/**
     * 用户签到
     * @return
     */</span>
    <span class="token keyword">public</span> <span class="token class-name">Result</span> <span class="token function">userSign</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">//        1.获取当前用户</span>
        <span class="token class-name">Long</span> userId <span class="token operator">=</span> <span class="token class-name">UserHolder</span><span class="token punctuation">.</span><span class="token function">getUser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//        2.获取当前日期</span>
        <span class="token class-name">LocalDateTime</span> now <span class="token operator">=</span> <span class="token class-name">LocalDateTime</span><span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span> keySuffix <span class="token operator">=</span> now<span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token class-name">DateTimeFormatter</span><span class="token punctuation">.</span><span class="token function">ofPattern</span><span class="token punctuation">(</span><span class="token string">":yyyyMM"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//        3.拼接key</span>
        <span class="token class-name">String</span> key <span class="token operator">=</span> <span class="token constant">SIGN_TIME_KEY</span> <span class="token operator">+</span> userId <span class="token operator">+</span> keySuffix<span class="token punctuation">;</span>
<span class="token comment">//        4.获取当前是本月的第几天(offset)</span>
        <span class="token keyword">int</span> dayOfMonth <span class="token operator">=</span> now<span class="token punctuation">.</span><span class="token function">getDayOfMonth</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//        5.存入缓存 SETBIT key offset 0/1,因为setbit是从0开始的，所以这里要减1</span>
        stringRedisTemplate<span class="token punctuation">.</span><span class="token function">opsForValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setBit</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span>dayOfMonth <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">,</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token class-name">Result</span><span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure>

<p>测试签到接口，签到成功。</p>
<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20221003142830433.png" srcset="/img/loading.gif" lazyload alt="image-20221003142830433"></p>
<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20221003143022197.png" srcset="/img/loading.gif" lazyload alt="image-20221003143022197"></p>
<h3 id="17-10-3统计连续签到"><a href="#17-10-3统计连续签到" class="headerlink" title="17.10.3统计连续签到"></a>17.10.3统计连续签到</h3><p><strong>问题1</strong>：什么叫做连续签到天数？</p>
<p>从最后一次签到开始向前统计，直到遇到第一次未签到为止，计算总的签到次数，就是连续签到天数。</p>
<p><strong>问题2</strong>：如何得到本月到今天为止的所有签到数据？</p>
<blockquote>
<p>BITFIELD key GET u[dayOfMonth] 0</p>
</blockquote>
<p><strong>问题3</strong>：如何从后向前遍历每个bit位？</p>
<p>与 1 做与运算，就能得到最后一个bit位。</p>
<p>随后右移1位，下一个bit位就成为了最后一个bit位。</p>
<p>需求：实现下面接口，统计当前用户截止当前时间在本月的连续签到天数</p>
<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20221003144457265.png" srcset="/img/loading.gif" lazyload alt="image-20221003144457265"></p>
<figure><div class="code-wrapper"><pre class="line-numbers language-java" data-language="java"><code class="language-java">    <span class="token comment">/**
     * 统计用户的签到次数
     *
     * @return
     */</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">Result</span> <span class="token function">signCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
<span class="token comment">//        1.获取当前用户</span>
        <span class="token class-name">Long</span> userId <span class="token operator">=</span> <span class="token class-name">UserHolder</span><span class="token punctuation">.</span><span class="token function">getUser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//        2.获取当前日期</span>
        <span class="token class-name">LocalDateTime</span> now <span class="token operator">=</span> <span class="token class-name">LocalDateTime</span><span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span> keySuffix <span class="token operator">=</span> now<span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token class-name">DateTimeFormatter</span><span class="token punctuation">.</span><span class="token function">ofPattern</span><span class="token punctuation">(</span><span class="token string">":yyyyMM"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//        3.拼接key</span>
        <span class="token class-name">String</span> key <span class="token operator">=</span> <span class="token constant">SIGN_TIME_KEY</span> <span class="token operator">+</span> userId <span class="token operator">+</span> keySuffix<span class="token punctuation">;</span>
<span class="token comment">//        4.获取当前是本月的第几天(offset)</span>
        <span class="token keyword">int</span> dayOfMonth <span class="token operator">=</span> now<span class="token punctuation">.</span><span class="token function">getDayOfMonth</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">//        5.获取到本月截止到今天为止所有的签到记录，返回的时一个十进制数 BITFIELD sign:1:202210 GET u3 0</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">></span></span> result <span class="token operator">=</span> stringRedisTemplate<span class="token punctuation">.</span><span class="token function">opsForValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">bitField</span><span class="token punctuation">(</span>
                key<span class="token punctuation">,</span>
                <span class="token class-name">BitFieldSubCommands</span>
                        <span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                        <span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token class-name">BitFieldSubCommands<span class="token punctuation">.</span>BitFieldType</span><span class="token punctuation">.</span><span class="token function">unsigned</span><span class="token punctuation">(</span>dayOfMonth<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">valueAt</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
        <span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>result <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> result<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">return</span> <span class="token class-name">Result</span><span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token class-name">Long</span> num <span class="token operator">=</span> result<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>num <span class="token operator">==</span> <span class="token number">0</span> <span class="token operator">||</span> num <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">return</span> <span class="token class-name">Result</span><span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
<span class="token comment">//        6.循环遍历</span>
        <span class="token keyword">int</span> count <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>num <span class="token operator">&amp;</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
<span class="token comment">//                6.1为0未签到，循环结束</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
<span class="token comment">//                6.2签到，计算器加1</span>
                count<span class="token operator">++</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
<span class="token comment">//            6.3先右移一位，再赋值给num            </span>
            num <span class="token operator">>>>=</span> <span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token keyword">return</span> <span class="token class-name">Result</span><span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span>count<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure>

<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20221003154007115.png" srcset="/img/loading.gif" lazyload alt="image-20221003154007115"></p>
<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20221003154016664.png" srcset="/img/loading.gif" lazyload alt="image-20221003154016664"></p>
<h2 id="17-11UV统计"><a href="#17-11UV统计" class="headerlink" title="17.11UV统计"></a>17.11UV统计</h2><h3 id="17-11-1HyperLogLog用法"><a href="#17-11-1HyperLogLog用法" class="headerlink" title="17.11.1HyperLogLog用法"></a>17.11.1HyperLogLog用法</h3><p><strong>UV</strong>：<strong>全称</strong>U**nique **Visitor，也叫独立访客量，是指通过互联网访问、浏览这个网页的自然人。<font color='red'>1天内同一个用户多次访问该网站，只记录1次。</font></p>
<p><strong>PV</strong>：<strong>全称</strong>P**age **View，<font color='red'>也叫页面访问量或点击量，用户每访问网站的一个页面，记录1次PV，用户多次打开页面，则记录多次PV。往往用来衡量网站的流量。</font></p>
<p>UV统计在服务端做会比较麻烦，因为要判断该用户是否已经统计过了，需要将统计过的用户信息保存。<font color='red'>但是如果每个访问的用户都保存到Redis中，数据量会非常恐怖。</font></p>
<p>Hyperloglog(HLL)是从Loglog算法派生的概率算法，用于确定非常大的集合的基数，而不需要存储其所有值。Redis中的HLL是基于string结构实现的，&#x3D;&#x3D;单个HLL的内存永远小于16kb&#x3D;&#x3D;，内存占用低的令人发指！作为代价，其测量结果是概率性的，有小于0.81％的误差。不过对于UV统计来说，这完全可以忽略。</p>
<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20221003160702979.png" srcset="/img/loading.gif" lazyload alt="image-20221003160702979"></p>
<h2 id="17-11-2实现UV统计"><a href="#17-11-2实现UV统计" class="headerlink" title="17.11.2实现UV统计"></a>17.11.2实现UV统计</h2><p>测试插入100万条数据</p>
<figure><div class="code-wrapper"><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Test</span>
<span class="token keyword">void</span> <span class="token function">testHyperLogLog</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> values <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token number">1000</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> j <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">1000000</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        j <span class="token operator">=</span> i <span class="token operator">%</span> <span class="token number">1000</span><span class="token punctuation">;</span>
        values<span class="token punctuation">[</span>j<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"user_"</span> <span class="token operator">+</span> i<span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>j <span class="token operator">==</span> <span class="token number">999</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
            <span class="token comment">// 发送到 Redis</span>
            stringRedisTemplate<span class="token punctuation">.</span><span class="token function">opsForHyperLogLog</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token string">"hl2"</span><span class="token punctuation">,</span> values<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token comment">// 统计数量</span>
    <span class="token class-name">Long</span> count <span class="token operator">=</span> stringRedisTemplate<span class="token punctuation">.</span><span class="token function">opsForHyperLogLog</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token string">"hl2"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"count = "</span> <span class="token operator">+</span> count<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure>

<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20221003162238285.png" srcset="/img/loading.gif" lazyload alt="image-20221003162238285"></p>
<p>插入之前的内存大小</p>
<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20221003162435502.png" srcset="/img/loading.gif" lazyload alt="image-20221003162435502"></p>
<p>插入之后内存大小</p>
<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20221003162605587.png" srcset="/img/loading.gif" lazyload alt="image-20221003162605587"></p>
<p>2415512-2401128&#x3D;14384</p>
<p>14384&#x2F;1024约等于14kb，小于16kb</p>
<h1 id="18-分布式缓存"><a href="#18-分布式缓存" class="headerlink" title="18.分布式缓存"></a>18.分布式缓存</h1><h2 id="18-1采用分布式缓存的原因"><a href="#18-1采用分布式缓存的原因" class="headerlink" title="18.1采用分布式缓存的原因"></a>18.1采用分布式缓存的原因</h2><p>在前面的章节中都是使用&#x3D;&#x3D;redis的单节点部署&#x3D;&#x3D;，单点redis会出现很多问题。</p>
<ol>
<li><p><strong><code>数据丢失问题</code></strong></p>
<p><font color='red'>Redis是内存存储，服务重启可能会丢失数据</font></p>
<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20221003183049353.png" srcset="/img/loading.gif" lazyload alt="image-20221003183049353"></p>
</li>
<li><p><strong><code>并发能力问题</code></strong></p>
<p><font color='red'>单节点Redis并发能力虽然不错，但也无法满足如618这样的高并发场景</font></p>
<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20221003183104004.png" srcset="/img/loading.gif" lazyload alt="image-20221003183104004"></p>
</li>
<li><p><strong><code>故障恢复问题</code></strong></p>
<p><font color='red'>如果Redis宕机，则服务不可用，需要一种自动的故障恢复手段</font></p>
<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20221003183109607.png" srcset="/img/loading.gif" lazyload alt="image-20221003183109607"></p>
</li>
<li><p><strong><code>存储能力问题</code></strong></p>
<p><font color='red'>Redis基于内存，单节点能存储的数据量难以满足海量数据需求</font></p>
<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20221003183113792.png" srcset="/img/loading.gif" lazyload alt="image-20221003183113792"></p>
</li>
</ol>
<p>单点Redis出现的问题的解决方案如下：</p>
<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20221003183333096.png" srcset="/img/loading.gif" lazyload alt="image-20221003183333096"></p>
<h2 id="18-2Redis持久化"><a href="#18-2Redis持久化" class="headerlink" title="18.2Redis持久化"></a>18.2Redis持久化</h2><h3 id="18-2-1RDB持久化"><a href="#18-2-1RDB持久化" class="headerlink" title="18.2.1RDB持久化"></a>18.2.1RDB持久化</h3><p>RDB全称Redis Database Backup file（&#x3D;&#x3D;Redis数据备份文件&#x3D;&#x3D;），也被叫做Redis数据快照。<font color='red'>简单来说就是把内存中的所有数据都记录到磁盘中。当Redis实例故障重启后，从磁盘读取快照文件，恢复数据。</font></p>
<p>快照文件称为RDB文件，默认是保存在当前运行目录。</p>
<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20221003201311232.png" srcset="/img/loading.gif" lazyload alt="image-20221003201311232"></p>
<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20221003184206641.png" srcset="/img/loading.gif" lazyload alt="image-20221003184206641"></p>
<p><code>Redis停机时会执行一次RDB。</code></p>
<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20221003200418206.png" srcset="/img/loading.gif" lazyload alt="image-20221003200418206"></p>
<p>Redis内部有触发RDB的机制，可以在redis.conf文件中找到，格式如下：	</p>
<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20221003184920087.png" srcset="/img/loading.gif" lazyload alt="image-20221003184920087"></p>
<p>RDB的其它配置也可以在redis.conf文件中设置：</p>
<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20221003184935414.png" srcset="/img/loading.gif" lazyload alt="image-20221003184935414"></p>
<p>采用vim编辑器进入redis.conf文件</p>
<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20221003190023036.png" srcset="/img/loading.gif" lazyload alt="image-20221003190023036"></p>
<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20221003190048637.png" srcset="/img/loading.gif" lazyload alt="image-20221003190048637"></p>
<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20221003190130752.png" srcset="/img/loading.gif" lazyload alt="image-20221003190130752"></p>
<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20221003190335045.png" srcset="/img/loading.gif" lazyload alt="image-20221003190335045"></p>
<p><font color='red'>bgsave开始时会fork主进程得到子进程</font>，子进程共享主进程的内存数据。完成fork后读取内存数据并写入 RDB 文件。</p>
<p>fork采用的是copy-on-write技术：</p>
<ul>
<li><p>当主进程执行读操作时，访问共享内存；</p>
</li>
<li><p>当主进程执行写操作时，则会拷贝一份数据，执行写操作。</p>
</li>
</ul>
<p>​																					<strong><font color='cornflowerblue'>读时共享，写时复制</font></strong></p>
<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20221003191301996.png" srcset="/img/loading.gif" lazyload alt="image-20221003191301996"></p>
<p>RDB方式bgsave的基本流程？</p>
<ul>
<li><p><font color='red'>fork主进程得到一个子进程，共享内存空间</font></p>
</li>
<li><p><font color='red'>子进程读取内存数据并写入新的RDB文件</font></p>
</li>
<li><p><font color='red'>用新RDB文件替换旧的RDB文件。</font></p>
</li>
</ul>
<p>RDB会在什么时候执行？save 60 1000代表什么含义？</p>
<ul>
<li><p><font color='cornflowerblue'>默认是服务停止时。</font></p>
</li>
<li><p><font color='cornflowerblue'>代表60秒内至少执行1000次修改则触发RDB</font></p>
</li>
</ul>
<p>RDB的缺点？</p>
<ul>
<li><p><font color='orange'>RDB执行间隔时间长，两次RDB之间写入数据有丢失的风险</font></p>
</li>
<li><p><font color='orange'>fork子进程、压缩、写出RDB文件都比较耗时</font></p>
</li>
</ul>
<h3 id="18-2-2AOF持久化"><a href="#18-2-2AOF持久化" class="headerlink" title="18.2.2AOF持久化"></a>18.2.2AOF持久化</h3><p>AOF全称为Append Only File（<font color='red'>追加文件</font>）。Redis处理的每一个写命令都会记录在AOF文件，可以看做是&#x3D;&#x3D;命令日志文件。&#x3D;&#x3D;</p>
<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20221003191822257.png" srcset="/img/loading.gif" lazyload alt="image-20221003191822257"></p>
<p>AOF默认是关闭的，需要修改redis.conf配置文件来开启AOF：</p>
<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20221003192333841.png" srcset="/img/loading.gif" lazyload alt="image-20221003192333841"></p>
<p>AOF的命令记录的频率也可以通过redis.conf文件来配：</p>
<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20221003192403949.png" srcset="/img/loading.gif" lazyload alt="image-20221003192403949"></p>
<table>
<thead>
<tr>
<th><strong>配置项</strong></th>
<th><strong>刷盘时机</strong></th>
<th><strong>优点</strong></th>
<th><strong>缺点</strong></th>
</tr>
</thead>
<tbody><tr>
<td>Always</td>
<td>同步刷盘</td>
<td>可靠性高，几乎不丢数据</td>
<td>性能影响大</td>
</tr>
<tr>
<td>everysec</td>
<td>每秒刷盘</td>
<td>性能适中</td>
<td>最多丢失1秒数据</td>
</tr>
<tr>
<td>no</td>
<td>操作系统控制</td>
<td>性能最好</td>
<td>可靠性较差，可能丢失大量数据</td>
</tr>
</tbody></table>
<p>为了验证AOF能否实现持久化的效果，首先禁用RDB</p>
<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20221003193521706.png" srcset="/img/loading.gif" lazyload alt="image-20221003193521706"></p>
<p>开启AOF</p>
<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20221003194000856.png" srcset="/img/loading.gif" lazyload alt="image-20221003194000856"></p>
<p>设置刷盘方式为每秒钟1次</p>
<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20221003194013843.png" srcset="/img/loading.gif" lazyload alt="image-20221003194013843"></p>
<p>测试：</p>
<p>存储一条数据</p>
<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20221003202047024.png" srcset="/img/loading.gif" lazyload alt="image-20221003202047024"></p>
<p>在redis目录下生成了aof文件</p>
<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20221003202319342.png" srcset="/img/loading.gif" lazyload alt="image-20221003202319342"></p>
<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20221003202254135.png" srcset="/img/loading.gif" lazyload alt="image-20221003202254135"></p>
<p>在存储一条数据</p>
<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20221003202519439.png" srcset="/img/loading.gif" lazyload alt="image-20221003202519439"></p>
<p>查看aof文件</p>
<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20221003202507955.png" srcset="/img/loading.gif" lazyload alt="image-20221003202507955"></p>
<p>测试关闭redis服务</p>
<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20221003202727599.png" srcset="/img/loading.gif" lazyload alt="image-20221003202727599"></p>
<p>再次启动redis服务</p>
<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20221003202826813.png" srcset="/img/loading.gif" lazyload alt="image-20221003202826813"></p>
<p>数据依然存在</p>
<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20221003202938039.png" srcset="/img/loading.gif" lazyload alt="image-20221003202938039"></p>
<p><font color='red'>AOF文件存在的问题</font></p>
<p>因为是记录命令，AOF文件会比RDB文件大的多。<font color='red'>而且AOF会记录对同一个key的多次写操作，但只有最后一次写操作才有意义</font>。<font color='cornflowerblue'>通过执行bgrewriteaof命令，可以让AOF文件执行重写功能，用最少的命令达到相同效果。</font></p>
<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20221003203209040.png" srcset="/img/loading.gif" lazyload alt="image-20221003203209040"></p>
<p>查看当前aof文件</p>
<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20221003203520334.png" srcset="/img/loading.gif" lazyload alt="image-20221003203520334"></p>
<p>使用<code>bgrewriteaof</code>命令进行aof文件重写操作</p>
<blockquote>
<p>bgrewriteaof</p>
</blockquote>
<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20221003203641762.png" srcset="/img/loading.gif" lazyload alt="image-20221003203641762"></p>
<p>重启服务数据依旧存在</p>
<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20221003204508894.png" srcset="/img/loading.gif" lazyload alt="image-20221003204508894"></p>
<p>Redis也会在触发阈值时<code>自动去重写AOF文件</code>。阈值也可以在redis.conf中配置：</p>
<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20221003203228453.png" srcset="/img/loading.gif" lazyload alt="image-20221003203228453"></p>
<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20221003204659152.png" srcset="/img/loading.gif" lazyload alt="image-20221003204659152"></p>
<h3 id="18-2-3RDB持久化和AOF持久化比较"><a href="#18-2-3RDB持久化和AOF持久化比较" class="headerlink" title="18.2.3RDB持久化和AOF持久化比较"></a>18.2.3RDB持久化和AOF持久化比较</h3><p>RDB和AOF各有自己的优缺点，如果对数据安全性要求较高，<code>在实际开发中往往会结合两者来使用</code>。</p>
<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20221003204829650.png" srcset="/img/loading.gif" lazyload alt="image-20221003204829650"></p>
<h2 id="18-3Redis主从"><a href="#18-3Redis主从" class="headerlink" title="18.3Redis主从"></a>18.3Redis主从</h2><h3 id="18-3-1主从复制简介"><a href="#18-3-1主从复制简介" class="headerlink" title="18.3.1主从复制简介"></a>18.3.1主从复制简介</h3><p>​    主从复制，简单来说就是<strong>主机</strong>数据更新后根据配置和策略， 自动同步到<strong>从机</strong>的master&#x2F;slaver机制，Master以写为主，Slave以读为主。</p>
<p><font color='cornflowerblue'>主节点承担写操作</font>，并将数据同步到多个从节点上，实现数据同步。</p>
<p><font color='cornflowerblue'>多个从节点承担读操作</font>，提高读操作的并发能力。</p>
<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20221004140112317.png" srcset="/img/loading.gif" lazyload alt="image-20221004140112317"></p>
<h3 id="18-3-2主从集群搭建"><a href="#18-3-2主从集群搭建" class="headerlink" title="18.3.2主从集群搭建"></a>18.3.2主从集群搭建</h3><p>单节点Redis的并发能力是有上限的，要进一步提高Redis的并发能力，就需要<code>搭建主从集群，实现读写分离。</code></p>
<p>​	&#x3D;&#x3D;要在同一台虚拟机开启3个实例，必须准备三份不同的配置文件和目录，配置文件所在目录也就是工作目录。&#x3D;&#x3D;</p>
<p>​	将redis.conf文件内容恢复到初始状态，并创建三个文件，将redis的配置文件redis.conf复制到这三个文件夹当中。</p>
<p>​	                                     <img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20221004145122591.png" srcset="/img/loading.gif" lazyload alt="image-20221004145122591"></p>
<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20221004145229165.png" srcset="/img/loading.gif" lazyload alt="image-20221004145229165"></p>
<p><font color='cornflowerblue'>修改各个配置文件当中redis服务的端口号和修改数据保存目录（原始是dir。表示当前目录）</font></p>
<figure><div class="code-wrapper"><pre class="line-numbers language-java" data-language="java"><code class="language-java">sed <span class="token operator">-</span>i <span class="token operator">-</span>e 's<span class="token operator">/</span><span class="token number">6379</span><span class="token operator">/</span><span class="token number">7001</span><span class="token operator">/</span>g<span class="token char">' -e '</span>s<span class="token operator">/</span>dir <span class="token punctuation">.</span>\<span class="token operator">/</span><span class="token operator">/</span>dir \<span class="token operator">/</span>opt\<span class="token operator">/</span><span class="token number">7001</span>\<span class="token operator">/</span><span class="token operator">/</span>g' <span class="token number">7001</span><span class="token operator">/</span>redis<span class="token punctuation">.</span>conf
sed <span class="token operator">-</span>i <span class="token operator">-</span>e 's<span class="token operator">/</span><span class="token number">6379</span><span class="token operator">/</span><span class="token number">7002</span><span class="token operator">/</span>g<span class="token char">' -e '</span>s<span class="token operator">/</span>dir <span class="token punctuation">.</span>\<span class="token operator">/</span><span class="token operator">/</span>dir \<span class="token operator">/</span>opt\<span class="token operator">/</span><span class="token number">7002</span>\<span class="token operator">/</span><span class="token operator">/</span>g' <span class="token number">7002</span><span class="token operator">/</span>redis<span class="token punctuation">.</span>conf
sed <span class="token operator">-</span>i <span class="token operator">-</span>e 's<span class="token operator">/</span><span class="token number">6379</span><span class="token operator">/</span><span class="token number">7003</span><span class="token operator">/</span>g<span class="token char">' -e '</span>s<span class="token operator">/</span>dir <span class="token punctuation">.</span>\<span class="token operator">/</span><span class="token operator">/</span>dir \<span class="token operator">/</span>opt\<span class="token operator">/</span><span class="token number">7003</span>\<span class="token operator">/</span><span class="token operator">/</span>g' <span class="token number">7003</span><span class="token operator">/</span>redis<span class="token punctuation">.</span>conf<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre></div></figure>

<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20221004145618613.png" srcset="/img/loading.gif" lazyload alt="image-20221004145618613"></p>
<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20221004145835922.png" srcset="/img/loading.gif" lazyload alt="image-20221004145835922"></p>
<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20221004150443612.png" srcset="/img/loading.gif" lazyload alt="image-20221004150443612"></p>
<p>修改每个实例的声明IP</p>
<p>虚拟机本身有多个IP，为了避免将来混乱，我们需要在redis.conf文件中指定每一个实例的绑定ip信息，格式如下：</p>
<blockquote>
<p>redis实例的声明 IP</p>
<p>replica-announce-ip 192.168.150.101</p>
</blockquote>
<p>每个目录都要改，我们一键完成修改（在&#x2F;opt目录执行下列命令）：</p>
<figure><div class="code-wrapper"><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 逐一执行</span>
<span class="token function">sed</span> <span class="token parameter variable">-i</span> <span class="token string">'1a replica-announce-ip 192.168.150.101'</span> <span class="token number">7001</span>/redis.conf
<span class="token function">sed</span> <span class="token parameter variable">-i</span> <span class="token string">'1a replica-announce-ip 192.168.150.101'</span> <span class="token number">7002</span>/redis.conf
<span class="token function">sed</span> <span class="token parameter variable">-i</span> <span class="token string">'1a replica-announce-ip 192.168.150.101'</span> <span class="token number">7003</span>/redis.conf

<span class="token comment"># 或者一键修改</span>
<span class="token builtin class-name">printf</span> <span class="token string">'%s\n'</span> <span class="token number">7001</span> <span class="token number">7002</span> <span class="token number">7003</span> <span class="token operator">|</span> <span class="token function">xargs</span> -I<span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span> <span class="token parameter variable">-t</span> <span class="token function">sed</span> <span class="token parameter variable">-i</span> <span class="token string">'1a replica-announce-ip 192.168.150.101'</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>/redis.conf<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure>

<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20221004151210984.png" srcset="/img/loading.gif" lazyload alt="image-20221004151210984"></p>
<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20221004151241219.png" srcset="/img/loading.gif" lazyload alt="image-20221004151241219"></p>
<p>启动</p>
<p>为了方便查看日志，我们打开3个ssh窗口，分别启动3个redis实例，启动命令：</p>
<figure><div class="code-wrapper"><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 第1个</span>
redis-server <span class="token number">7001</span>/redis.conf
<span class="token comment"># 第2个</span>
redis-server <span class="token number">7002</span>/redis.conf
<span class="token comment"># 第3个</span>
redis-server <span class="token number">7003</span>/redis.conf<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure>

<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20221004154353292.png" srcset="/img/loading.gif" lazyload alt="image-20221004154353292"></p>
<p>在新建的三个实例中同时开启redis服务</p>
<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20221004165734318.png" srcset="/img/loading.gif" lazyload alt="image-20221004165734318"></p>
<h3 id="18-3-3开启主从关系"><a href="#18-3-3开启主从关系" class="headerlink" title="18.3.3开启主从关系"></a>18.3.3开启主从关系</h3><p>现在三个实例还没有任何关系，要配置主从可以使用replicaof 或者slaveof（5.0以前）命令。</p>
<p>有临时和永久两种模式：</p>
<ul>
<li><p>修改配置文件（永久生效）</p>
<ul>
<li>在redis.conf中添加一行配置：<code>slaveof &lt;masterip&gt; &lt;masterport&gt;</code></li>
</ul>
</li>
<li><p>使用redis-cli客户端连接到redis服务，执行slaveof命令（重启后失效）：</p>
</li>
</ul>
<figure><div class="code-wrapper"><pre class="line-numbers language-none"><code class="language-none">slaveof &lt;masterip&gt; &lt;masterport&gt;<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></div></figure>



<p>&#x3D;&#x3D;设置将7001作为主节点，7002和7003做为从节点。&#x3D;&#x3D;</p>
<p><font color='red'>关闭主节点保护模式，不关闭从节点连接不上主节点</font></p>
<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20221004170734409.png" srcset="/img/loading.gif" lazyload alt="image-20221004170734409"></p>
<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20221004160037789.png" srcset="/img/loading.gif" lazyload alt="image-20221004160037789"></p>
<p>从节点7002、7003日志信息改变</p>
<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20221004171210108.png" srcset="/img/loading.gif" lazyload alt="image-20221004171210108"></p>
<p>在主节点下查看主从架构状态信息</p>
<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20221004171226784.png" srcset="/img/loading.gif" lazyload alt="image-20221004171226784"></p>
<p>可以发现7001为主节点，旗下有两个从节点，端口号分别是7002、7003</p>
<h3 id="18-3-4测试主从读写"><a href="#18-3-4测试主从读写" class="headerlink" title="18.3.4测试主从读写"></a>18.3.4测试主从读写</h3><p>在主节点上进行读写测试</p>
<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20221004171615883.png" srcset="/img/loading.gif" lazyload alt="image-20221004171615883"></p>
<p>在从节点进行读写操作</p>
<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20221004171722448.png" srcset="/img/loading.gif" lazyload alt="image-20221004171722448"></p>
<h3 id="18-3-5主从数据同步原理"><a href="#18-3-5主从数据同步原理" class="headerlink" title="18.3.5主从数据同步原理"></a>18.3.5主从数据同步原理</h3><h4 id="18-3-5-1全量同步"><a href="#18-3-5-1全量同步" class="headerlink" title="18.3.5.1全量同步"></a>18.3.5.1全量同步</h4><p>主从第一次同步是<strong>全量同步</strong>：</p>
<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20221004172948822.png" srcset="/img/loading.gif" lazyload alt="image-20221004172948822"></p>
<p>master如何判断slave是不是第一次来同步数据？这里会用到两个很重要的概念：</p>
<p>•<strong>Replication Id</strong>：简称replid，&#x3D;&#x3D;是数据集的标记&#x3D;&#x3D;，<font color='red'>id一致则说明是同一数据集。每一个master都有唯一的replid，slave则会继承master节点的replid</font></p>
<p>•<strong>offset</strong>：&#x3D;&#x3D;偏移量&#x3D;&#x3D;，随着记录在repl_baklog中的数据增多而逐渐增大。<font color='red'>slave完成同步时也会记录当前同步的offset。如果slave的offset小于master的offset，说明slave数据落后于master，需要更新</font>。</p>
<p>&#x3D;&#x3D;因此slave做数据同步，必须向master声明自己的replication id 和offset，master才可以判断到底需要同步哪些数据&#x3D;&#x3D;</p>
<p>全量同步的流程</p>
<ul>
<li><p>slave节点请求增量同步</p>
</li>
<li><p>master节点判断replid，发现不一致，拒绝增量同步</p>
</li>
<li><p>master将完整内存数据生成RDB，发送RDB到slave</p>
</li>
<li><p>slave清空本地数据，加载master的RDB</p>
</li>
<li><p><font color='red'>master将RDB期间的命令记录在repl_baklog，并持续将log中的命令发送给slave</font></p>
</li>
<li><p>slave执行接收到的命令，保持与master之间的同步</p>
</li>
</ul>
<h4 id="18-3-5-2增量同步"><a href="#18-3-5-2增量同步" class="headerlink" title="18.3.5.2增量同步"></a>18.3.5.2增量同步</h4><p>主从第一次同步是<strong>全量同步</strong>，但如果slave重启后同步，则执行<strong>增量同步</strong></p>
<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20221004180449650.png" srcset="/img/loading.gif" lazyload alt="image-20221004180449650"></p>
<h4 id="18-3-5-3从主优化"><a href="#18-3-5-3从主优化" class="headerlink" title="18.3.5.3从主优化"></a>18.3.5.3从主优化</h4><ul>
<li><p>在master中配置repl-diskless-sync yes启用无磁盘复制，避免全量同步时的磁盘IO。</p>
</li>
<li><p>Redis单节点上的内存占用不要太大，减少RDB导致的过多磁盘IO</p>
</li>
<li><p>适当提高repl_baklog的大小，发现slave宕机时尽快实现故障恢复，尽可能避免全量同步</p>
</li>
<li><p>限制一个master上的slave节点数量，如果实在是太多slave，则可以采用主-从-从链式结构，减少master压力</p>
</li>
</ul>
<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20221004181511031.png" srcset="/img/loading.gif" lazyload alt="image-20221004181511031"></p>
<h4 id="18-3-5-4全量同步和增量同步的区别"><a href="#18-3-5-4全量同步和增量同步的区别" class="headerlink" title="18.3.5.4全量同步和增量同步的区别"></a>18.3.5.4全量同步和增量同步的区别</h4><p>简述全量同步和增量同步区别？</p>
<ul>
<li><p>全量同步：master将完整内存数据生成RDB，发送RDB到slave。后续命令则记录在repl_baklog，逐个发送给slave。</p>
</li>
<li><p>增量同步：slave提交自己的offset到master，master获取repl_baklog中从offset之后的命令给slave</p>
</li>
</ul>
<p>什么时候执行全量同步？</p>
<ul>
<li><p>slave节点第一次连接master节点时</p>
</li>
<li><p>slave节点断开时间太久，repl_baklog中的offset已经被覆盖时</p>
</li>
</ul>
<p>什么时候执行增量同步？</p>
<ul>
<li>slave节点断开又恢复，并且在repl_baklog中能找到offset时</li>
</ul>
<h2 id="18-4Redis哨兵"><a href="#18-4Redis哨兵" class="headerlink" title="18.4Redis哨兵"></a>18.4Redis哨兵</h2><p><font color='red'>slave节点宕机恢复后可以找master节点同步数据，那master节点宕机怎么办？Redis中的哨兵机制可以解决这个问题</font></p>
<h3 id="18-4-1哨兵的作用"><a href="#18-4-1哨兵的作用" class="headerlink" title="18.4.1哨兵的作用"></a>18.4.1哨兵的作用</h3><p><code>Redis提供了哨兵（Sentinel）机制来实现主从集群的自动故障恢复</code>。哨兵的结构和作用如下：</p>
<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20221004182302272.png" srcset="/img/loading.gif" lazyload alt="image-20221004182302272"></p>
<p>作用：</p>
<ul>
<li><p><strong>监控</strong>：Sentinel 会不断检查您的master和slave是否按预期工作</p>
</li>
<li><p><strong>自动故障恢复</strong>：如果master故障，Sentinel会将一个slave提升为master。当故障实例恢复后也以新的master为主</p>
</li>
<li><p><strong>通知</strong>：Sentinel充当Redis客户端的服务发现来源，当集群发生故障转移时，会将最新信息推送给Redis的客户端</p>
</li>
</ul>
<h3 id="18-4-2哨兵的工作原理"><a href="#18-4-2哨兵的工作原理" class="headerlink" title="18.4.2哨兵的工作原理"></a>18.4.2哨兵的工作原理</h3><p>Sentinel基于<code>心跳机制监测服务状态</code>，<font color='red'>每隔1秒向集群的每个实例发送ping命令</font>：</p>
<ul>
<li><p>主观下线：如果某sentinel节点发现某实例未在规定时间响应，则认为该实例<strong>主观下线</strong>。</p>
</li>
<li><p>客观下线：<code>若超过指定数量（quorum）</code>的sentinel都认为该实例主观下线，则该实例<strong>客观下线</strong>。</p>
<p><code>quorum值最好超过Sentinel实例数量的一半</code>。</p>
</li>
</ul>
<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/GIF%202022-10-4%2018-46-25-1664880412506.gif" srcset="/img/loading.gif" lazyload alt="GIF 2022-10-4 18-46-25"></p>
<h3 id="18-4-3主节点的选取方式"><a href="#18-4-3主节点的选取方式" class="headerlink" title="18.4.3主节点的选取方式"></a>18.4.3主节点的选取方式</h3><p>判定主节点下线后哨兵会从从节点中选取一个新的节点作为主节点</p>
<ul>
<li><p><font color='red'>首先会判断slave节点与master节点断开时间长短，如果超过指定值（down-after-milliseconds * 10）则会排除该slave节点</font></p>
</li>
<li><p><font color='red'>然后判断slave节点的slave-priority值，越小优先级越高，如果是0则永不参与选举(默认都一样)</font></p>
</li>
<li><p><font color='red'>如果slave-prority一样，则判断slave节点的offset值，<code>越大说明数据越新，优先级越高</code></font></p>
</li>
<li><p><font color='red'>最后是判断slave节点的运行id大小，越小优先级越高。</font></p>
</li>
</ul>
<h3 id="18-4-4故障转移"><a href="#18-4-4故障转移" class="headerlink" title="18.4.4故障转移"></a>18.4.4故障转移</h3><p>当选中了其中一个slave为新的master后（例如slave1），故障的转移的步骤如下</p>
<ul>
<li><p>sentinel给备选的slave1节点发送<code>slaveof no one</code>命令，让该节点成为master</p>
</li>
<li><p><font color='red'>sentinel给所有其它slave发送slaveof 192.168.150.101 7002 命令，让这些slave成为新master的从节点，开始从新的master上同步数据。</font></p>
</li>
<li><p>最后，sentinel将故障节点标记为slave，<font color='red'>当故障节点恢复后会自动成为新的master的slave节点</font></p>
</li>
</ul>
<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20221004190640540.png" srcset="/img/loading.gif" lazyload alt="image-20221004190640540"></p>
<p>总结：</p>
<p>Sentinel的三个作用是什么？</p>
<ul>
<li><p>&#x3D;&#x3D;监控&#x3D;&#x3D;</p>
</li>
<li><p>&#x3D;&#x3D;故障转移&#x3D;&#x3D;</p>
</li>
<li><p>&#x3D;&#x3D;通知&#x3D;&#x3D;</p>
</li>
</ul>
<p>Sentinel如何判断一个redis实例是否健康？</p>
<ul>
<li><p><font color='cornflowerblue'>每隔1秒发送一次ping命令，如果超过一定时间没有相向则认为是主观下线</font></p>
</li>
<li><p><font color='cornflowerblue'>如果大多数sentinel都认为实例主观下线，则判定服务客观下线</font></p>
</li>
</ul>
<p>故障转移步骤有哪些？</p>
<ul>
<li><p><font color='orange'>首先选定一个slave作为新的master，执行slaveof no one</font></p>
</li>
<li><p><font color='orange'>然后让所有节点都执行slaveof 新master</font></p>
</li>
<li><p><font color='orange'>修改故障节点，执行slaveof 新master</font></p>
</li>
</ul>
<h3 id="18-4-5搭建哨兵集群"><a href="#18-4-5搭建哨兵集群" class="headerlink" title="18.4.5搭建哨兵集群"></a>18.4.5搭建哨兵集群</h3><p>这里我们搭建一个三节点形成的Sentinel集群，来监管之前的Redis主从集群。如图：</p>
<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20221004192644162.png" srcset="/img/loading.gif" lazyload alt="image-20221004192644162"></p>
<p>三个sentinel实例信息如下：</p>
<table>
<thead>
<tr>
<th>节点</th>
<th align="center">IP</th>
<th align="center">PORT</th>
</tr>
</thead>
<tbody><tr>
<td>s1</td>
<td align="center">192.168.26.133</td>
<td align="center">27001</td>
</tr>
<tr>
<td>s2</td>
<td align="center">192.168.26.133</td>
<td align="center">27002</td>
</tr>
<tr>
<td>s3</td>
<td align="center">192.168.26.133</td>
<td align="center">27003</td>
</tr>
</tbody></table>
<p>要在同一台虚拟机开启3个实例，必须准备三份不同的配置文件和目录，配置文件所在目录也就是工作目录。</p>
<p>我们创建三个文件夹，名字分别叫s1、s2、s3：</p>
<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20221004193516559.png" srcset="/img/loading.gif" lazyload alt="image-20221004193516559"></p>
<p>然后我们在s1目录创建一个sentinel.conf文件，添加下面的内容：</p>
<figure><div class="code-wrapper"><pre class="line-numbers language-ini" data-language="ini"><code class="language-ini">port 27001
sentinel announce-ip 192.168.26.133
sentinel monitor mymaster 192.168.26.133 7001 2
sentinel down-after-milliseconds mymaster 5000
sentinel failover-timeout mymaster 60000
<span class="token comment">#主节点密码</span>
<span class="token comment">#sentinel auth-pass &lt;master-name> &lt;password></span>
sentinel auth-pass mymaster 主节点密码
dir "/opt/s1"<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure>

<p>解读：</p>
<ul>
<li><p><code>port 27001</code>：是当前sentinel实例的端口</p>
</li>
<li><p><code>sentinel monitor mymaster 192.168.26.133 7001 2</code>：指定主节点信息</p>
<ul>
<li><code>mymaster</code>：主节点名称，自定义，任意写</li>
<li><code>192.168.26.133 7001</code>：主节点的ip和端口</li>
<li><code>2</code>：选举master时的quorum值</li>
</ul>
<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20221004194546436.png" srcset="/img/loading.gif" lazyload alt="image-20221004194546436"></p>
</li>
</ul>
<p>然后将s1&#x2F;sentinel.conf文件拷贝到s2、s3两个目录中（在&#x2F;opt目录执行下列命令）：</p>
<figure><div class="code-wrapper"><pre class="line-numbers language-ini" data-language="ini"><code class="language-ini"><span class="token comment"># 方式一：逐个拷贝</span>
cp s1/sentinel.conf s2
cp s1/sentinel.conf s3
<span class="token comment"># 方式二：管道组合命令，一键拷贝</span>
echo s2 s3 | xargs -t -n 1 cp s1/sentinel.conf<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure>

<p>修改s2、s3两个文件夹内的配置文件，将端口分别修改为27002、27003：</p>
<figure><div class="code-wrapper"><pre class="line-numbers language-ini" data-language="ini"><code class="language-ini">sed -i -e 's/27001/27002/g' -e 's/s1/s2/g' s2/sentinel.conf
sed -i -e 's/27001/27003/g' -e 's/s1/s3/g' s3/sentinel.conf<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre></div></figure>

<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20221004195122603.png" srcset="/img/loading.gif" lazyload alt="image-20221004195122603"></p>
<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20221004194811016.png" srcset="/img/loading.gif" lazyload alt="image-20221004194811016"></p>
<p><strong>启动哨兵集群</strong></p>
<p>为了方便查看日志，我们打开3个ssh窗口，分别启动3个redis实例，启动命令：</p>
<figure><div class="code-wrapper"><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 第1个</span>
redis-sentinel s1/sentinel.conf
<span class="token comment"># 第2个</span>
redis-sentinel s2/sentinel.conf
<span class="token comment"># 第3个</span>
redis-sentinel s3/sentinel.conf<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure>

<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20221004195535229.png" srcset="/img/loading.gif" lazyload alt="image-20221004195535229"></p>
<p><strong>开始监控主从集群</strong></p>
<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20221005084919798.png" srcset="/img/loading.gif" lazyload alt="image-20221005084919798"></p>
<p>测试：</p>
<p><strong>尝试让master节点7001宕机，查看sentinel日志：</strong></p>
<p>主节点停机之后，从节点连接失败</p>
<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20221004200642567.png" srcset="/img/loading.gif" lazyload alt="image-20221004200642567"></p>
<p>&#x3D;&#x3D;主节点宕机后，哨兵集群会选出最先发现主节点宕机的哨兵作为leader在slave中选出新的主节点&#x3D;&#x3D;</p>
<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20221005141838068.png" srcset="/img/loading.gif" lazyload alt="image-20221005141838068"></p>
<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20221005142114246.png" srcset="/img/loading.gif" lazyload alt="image-20221005142114246"></p>
<p><strong>7003的主模式启用</strong></p>
<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20221005142226797.png" srcset="/img/loading.gif" lazyload alt="image-20221005142226797"></p>
<p><strong>恢复7001从节点</strong></p>
<p>7001从节点读取RDB文件进行全量同步</p>
<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20221005142421339.png" srcset="/img/loading.gif" lazyload alt="image-20221005142421339"></p>
<p>7003主节点开始同步7001从节点</p>
<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20221005142502783.png" srcset="/img/loading.gif" lazyload alt="image-20221005142502783"></p>
<p><strong>在7003查看主从架构信息</strong></p>
<p>7003为主节点，7001和7002是他的从节点</p>
<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20221005142703145.png" srcset="/img/loading.gif" lazyload alt="image-20221005142703145"></p>
<h3 id="18-4-6RedisTemplate连接哨兵集群"><a href="#18-4-6RedisTemplate连接哨兵集群" class="headerlink" title="18.4.6RedisTemplate连接哨兵集群"></a>18.4.6RedisTemplate连接哨兵集群</h3><p><strong><font color='red'>首先关闭虚拟机防火墙，并重启redis和sentinel</font></strong></p>
<p>在Sentinel集群监管下的Redis主从集群，其节点会因为自动故障转移而发生变化，&#x3D;&#x3D;Redis的客户端必须感知这种变化，及时更新连接信息。&#x3D;&#x3D;<font color='red'>Spring的RedisTemplate底层利用lettuce实现了节点的感知和自动切换。</font></p>
<p>一：在pom文件当中添加SpringBoot对Redis的开发场景</p>
<figure><div class="code-wrapper"><pre class="line-numbers language-markup" data-language="markup"><code class="language-markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>spring-boot-starter-data-redis<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre></div></figure>

<p>二：在SpringBoot配置文件当中指定sentinel(哨兵)的信息</p>
<figure><div class="code-wrapper"><pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">redis</span><span class="token punctuation">:</span>
    <span class="token key atrule">sentinel</span><span class="token punctuation">:</span>
      <span class="token key atrule">master</span><span class="token punctuation">:</span> mymaster  <span class="token comment">#指定主节点名称</span>
      <span class="token key atrule">nodes</span><span class="token punctuation">:</span>            <span class="token comment"># 指定redis-sentinel集群信息</span>
        <span class="token punctuation">-</span> 192.168.26.133<span class="token punctuation">:</span><span class="token number">27001</span>
        <span class="token punctuation">-</span> 192.168.26.133<span class="token punctuation">:</span><span class="token number">27002</span>
        <span class="token punctuation">-</span> 192.168.26.133<span class="token punctuation">:</span><span class="token number">27003</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure>

<p>三：配置Redis主从读写分离（可以在配置文件当中或主类当中配置）</p>
<figure><div class="code-wrapper"><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Bean</span>
<span class="token keyword">public</span> <span class="token class-name">LettuceClientConfigurationBuilderCustomizer</span> <span class="token function">configurationBuilderCustomizer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
    <span class="token keyword">return</span> clientConfigurationBuilder <span class="token operator">-></span> 			                    	                          clientConfigurationBuilder
        <span class="token punctuation">.</span><span class="token function">readFrom</span><span class="token punctuation">(</span><span class="token class-name">ReadFrom</span><span class="token punctuation">.</span><span class="token constant">REPLICA_PREFERRED</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure>

<p>这里的ReadFrom是配置Redis的读取策略，是一个枚举，包括下面选择：</p>
<ul>
<li><p>MASTER：从主节点读取</p>
</li>
<li><p>MASTER_PREFERRED：优先从master节点读取，master不可用才读取replica</p>
</li>
<li><p>&#x3D;&#x3D;REPLICA：从slave（replica）节点读取&#x3D;&#x3D;</p>
</li>
<li><p>&#x3D;&#x3D;REPLICA _PREFERRED：优先从slave（replica）节点读取，所有的slave都不可用才读取master&#x3D;&#x3D;</p>
</li>
</ul>
<p>项目结构：</p>
<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20221004211701235.png" srcset="/img/loading.gif" lazyload alt="image-20221004211701235"></p>
<p>控制器：</p>
<figure><div class="code-wrapper"><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@RestController</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">HelloController</span> <span class="token punctuation">&#123;</span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">StringRedisTemplate</span> redisTemplate<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">"/get/&#123;key&#125;"</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">hi</span><span class="token punctuation">(</span><span class="token annotation punctuation">@PathVariable</span> <span class="token class-name">String</span> key<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> redisTemplate<span class="token punctuation">.</span><span class="token function">opsForValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">"/set/&#123;key&#125;/&#123;value&#125;"</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">hi</span><span class="token punctuation">(</span><span class="token annotation punctuation">@PathVariable</span> <span class="token class-name">String</span> key<span class="token punctuation">,</span> <span class="token annotation punctuation">@PathVariable</span> <span class="token class-name">String</span> value<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        redisTemplate<span class="token punctuation">.</span><span class="token function">opsForValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token string">"success"</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure>

<p>启动项目，测试接口。</p>
<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20221005152850867.png" srcset="/img/loading.gif" lazyload alt="image-20221005152850867"></p>
<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20221005152931361.png" srcset="/img/loading.gif" lazyload alt="image-20221005152931361"></p>
<p>读操作：</p>
<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20221005151152656.png" srcset="/img/loading.gif" lazyload alt="image-20221005151152656"></p>
<p>写操作是在主节点7002完成的</p>
<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20221005152254597.png" srcset="/img/loading.gif" lazyload alt="image-20221005152254597"></p>
<p>写操作：</p>
<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20221005151226087.png" srcset="/img/loading.gif" lazyload alt="image-20221005151226087"></p>
<p>写操作是在主节点7001完成的</p>
<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20221005152159350.png" srcset="/img/loading.gif" lazyload alt="image-20221005152159350"></p>
<h3 id="18-4-7测试lettuce的节点感知和自动切换"><a href="#18-4-7测试lettuce的节点感知和自动切换" class="headerlink" title="18.4.7测试lettuce的节点感知和自动切换"></a>18.4.7测试lettuce的节点感知和自动切换</h3><p>使主节点宕机，让哨兵集群选出新的主节点</p>
<p>主节点变为7003</p>
<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20221005153434661.png" srcset="/img/loading.gif" lazyload alt="image-20221005153434661"></p>
<p>执行写操作，查看控制台</p>
<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20221005153825177.png" srcset="/img/loading.gif" lazyload alt="image-20221005153825177"></p>
<h2 id="18-5Redis分片集群"><a href="#18-5Redis分片集群" class="headerlink" title="18.5Redis分片集群"></a>18.5Redis分片集群</h2><p> 主从和哨兵可以解决高可用、高并发读的问题。但是依然有两个问题没有解决：</p>
<ul>
<li><p><font color='red'>海量数据存储问题</font></p>
</li>
<li><p><font color='red'>高并发写的问题</font></p>
</li>
</ul>
<p>使用分片集群可以解决上述问题，分片集群特征：</p>
<ul>
<li><p><code>集群中有多个master，每个master保存不同数据</code></p>
</li>
<li><p><code>每个master都可以有多个slave节点</code></p>
</li>
<li><p><code>master之间通过ping监测彼此健康状态</code></p>
</li>
<li><p><code>客户端请求可以访问集群任意节点，最终都会被转发到正确节点</code></p>
</li>
</ul>
<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20221005154402149.png" srcset="/img/loading.gif" lazyload alt="image-20221005154402149"></p>
<h3 id="18-5-1搭建分片集群"><a href="#18-5-1搭建分片集群" class="headerlink" title="18.5.1搭建分片集群"></a>18.5.1搭建分片集群</h3><p>分片集群需要的节点数量较多，这里我们搭建一个最小的分片集群，包含<code>3个master节点，每个master包含一个slave节点，结构如下：</code></p>
<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20221005155242975.png" srcset="/img/loading.gif" lazyload alt="image-20221005155242975"></p>
<p>这里我们会在同一台虚拟机中开启6个redis实例，模拟分片集群，信息如下：</p>
<table>
<thead>
<tr>
<th align="center">IP</th>
<th align="center">PORT</th>
<th align="center">角色</th>
</tr>
</thead>
<tbody><tr>
<td align="center">192.168.26.133</td>
<td align="center">7001</td>
<td align="center">master</td>
</tr>
<tr>
<td align="center">192.168.26.133</td>
<td align="center">7002</td>
<td align="center">master</td>
</tr>
<tr>
<td align="center">192.168.26.133</td>
<td align="center">7003</td>
<td align="center">master</td>
</tr>
<tr>
<td align="center">192.168.26.133</td>
<td align="center">8001</td>
<td align="center">slave</td>
</tr>
<tr>
<td align="center">192.168.26.133</td>
<td align="center">8002</td>
<td align="center">slave</td>
</tr>
<tr>
<td align="center">192.168.26.133</td>
<td align="center">8003</td>
<td align="center">slave</td>
</tr>
</tbody></table>
<p>删除搭建主从集群的文件夹，重新创建文件</p>
<figure><div class="code-wrapper"><pre class="line-numbers language-ini" data-language="ini"><code class="language-ini"><span class="token comment"># 进入/opt目录</span>
cd /opt
<span class="token comment"># 删除旧的，避免配置干扰</span>
rm -rf 7001 7002 7003
<span class="token comment"># 创建目录</span>
mkdir 7001 7002 7003 8001 8002 8003<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure>

<p>在7001下准备一个新的redis.conf文件，内容如下：</p>
<figure><div class="code-wrapper"><pre class="line-numbers language-ini" data-language="ini"><code class="language-ini">port 6379
<span class="token comment"># 开启集群功能</span>
cluster-enabled yes
<span class="token comment"># 集群的配置文件名称，不需要我们创建，由redis自己维护</span>
cluster-config-file /tmp/6379/nodes.conf
<span class="token comment"># 节点心跳失败的超时时间</span>
cluster-node-timeout 5000
<span class="token comment"># 持久化文件存放目录</span>
dir /opt/6379
<span class="token comment"># 绑定地址</span>
bind 0.0.0.0
<span class="token comment"># 让redis后台运行</span>
daemonize yes
<span class="token comment"># 注册的实例ip</span>
replica-announce-ip ip地址
<span class="token comment"># 保护模式</span>
protected-mode no
<span class="token comment"># 数据库数量</span>
databases 1
<span class="token comment"># 日志</span>
logfile /opt/6379/run.log<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure>

<p>将这个文件拷贝到其他几个文件下：</p>
<p>修改每个redis.conf中的端口信息</p>
<figure><div class="code-wrapper"><pre class="line-numbers language-ini" data-language="ini"><code class="language-ini">printf '%s\n' 7001 7002 7003 8001 8002 8003 | xargs -I&#123;&#125; -t sed -i 's/6379/&#123;&#125;/g' &#123;&#125;/redis.conf<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></div></figure>

<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20221005160531098.png" srcset="/img/loading.gif" lazyload alt="image-20221005160531098"></p>
<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20221005160922256.png" srcset="/img/loading.gif" lazyload alt="image-20221005160922256"></p>
<p>启动所有redis服务</p>
<figure><div class="code-wrapper"><pre class="line-numbers language-ini" data-language="ini"><code class="language-ini"><span class="token comment"># 一键启动所有服务</span>
 printf '%s\n' 7001 7002 7003 8001 8002 8003 | xargs -I&#123;&#125; -t redis-server &#123;&#125;/redis.conf<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre></div></figure>

<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20221005161414132.png" srcset="/img/loading.gif" lazyload alt="image-20221005161414132">	</p>
<p>虽然服务启动了，但是目前每个服务之间都是独立的，没有任何关联。</p>
<p>我们需要执行命令来创建集群，在Redis5.0之前创建集群比较麻烦，5.0之后集群管理命令都集成到了redis-cli中。</p>
<p>我们使用的是Redis5.0以上的版本，集群管理以及集成到了redis-cli中，格式如下：</p>
<figure><div class="code-wrapper"><pre class="line-numbers language-ini" data-language="ini"><code class="language-ini">redis-cli --cluster create --cluster-replicas 1 192.168.150.101:7001 192.168.150.101:7002 192.168.150.101:7003 192.168.150.101:8001 192.168.150.101:8002 192.168.150.101:8003<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></div></figure>

<p>命令说明：</p>
<ul>
<li><code>redis-cli --cluster</code>或者<code>./redis-trib.rb</code>：代表集群操作命令</li>
<li><code>create</code>：代表是创建集群</li>
<li><code>--replicas 1</code>或者<code>--cluster-replicas 1</code> ：指定集群中每个master的副本个数为1，此时<code>节点总数 ÷ (replicas + 1)</code> 得到的就是master的数量。因此节点列表中的前n个就是master，其它节点都是slave节点，随机分配到不同master</li>
</ul>
<img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20221005163603507.png" srcset="/img/loading.gif" lazyload alt="image-20221005163603507" style="zoom:80%;" />

<p>查看集群状态</p>
<figure><div class="code-wrapper"><pre class="line-numbers language-ini" data-language="ini"><code class="language-ini">redis-cli -p 7001 cluster nodes<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></div></figure>

<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20221005163927377.png" srcset="/img/loading.gif" lazyload alt="image-20221005163927377"></p>
<h3 id="18-5-2散列插槽"><a href="#18-5-2散列插槽" class="headerlink" title="18.5.2散列插槽"></a>18.5.2散列插槽</h3><p>在创建分片集群的时候，每一个主节点后都有slots，这是散列插槽</p>
<p>Redis会把每一个master节点映射到0~16383共16384个插槽（hash slot）上，查看集群信息时就能看到：</p>
<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20221005165754153.png" srcset="/img/loading.gif" lazyload alt="image-20221005165754153"></p>
<p>由上图可以看出：</p>
<p>​		主节点7001分配的插槽范围是[0-5460]</p>
<p>​		主节点7002分配的插槽范围是[5461-10922]</p>
<p>​		主节点7003分配的插槽范围是[10923-16383]</p>
<p><code>数据key不是与节点绑定，而是与插槽绑定。redis会根据key的有效部分计算插槽值</code>，分两种情况：</p>
<ul>
<li><p>key中包含”{}”，且“{}”中至少包含1个字符，“{}”中的部分是有效部分</p>
</li>
<li><p>key中不包含“{}”，整个key都是有效部分</p>
</li>
</ul>
<p>例如：key是num，那么就根据num计算，如果是{itcast}num，则根据itcast计算。计算方式是利用CRC16算法得到一个hash值，然后对16384取余，得到的结果就是slot值。</p>
<p>测试插槽：</p>
<figure><div class="code-wrapper"><pre class="line-numbers language-none"><code class="language-none">redis-cli -p 端口号<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></div></figure>

<p>&#x3D;&#x3D;可以查看存入值后插槽位置是14315，属于主节点7003，则将客户端切换到7003&#x3D;&#x3D;</p>
<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20221005171130873.png" srcset="/img/loading.gif" lazyload alt="image-20221005171130873"></p>
<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20221005171334508.png" srcset="/img/loading.gif" lazyload alt="image-20221005171334508"></p>
<p>总结：</p>
<p><strong>Redis如何判断某个key应该在哪个实例？</strong></p>
<ul>
<li><p>将16384个插槽分配到不同的实例</p>
</li>
<li><p>根据key的有效部分计算哈希值，对16384取余</p>
</li>
<li><p>余数作为插槽，寻找插槽所在实例即可</p>
</li>
</ul>
<p><strong>如何将同一类数据固定的保存在同一个Redis实例？</strong></p>
<ul>
<li>这一类数据使用相同的有效部分，例如key都以{typeId}为前缀</li>
</ul>
<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20221005172740944.png" srcset="/img/loading.gif" lazyload alt="image-20221005172740944"></p>
<h3 id="18-5-3集群伸缩"><a href="#18-5-3集群伸缩" class="headerlink" title="18.5.3集群伸缩"></a>18.5.3集群伸缩</h3><p>redis-cli –cluster提供了很多操作集群的命令，可以通过下面方式查看</p>
<img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20221005173401793.png" srcset="/img/loading.gif" lazyload alt="image-20221005173401793" style="zoom:80%;" />

<p>向集群中添加一个新的master节点，并向其中存储 num &#x3D; 10</p>
<p>需求：</p>
<ul>
<li><p>启动一个新的redis实例，端口为7004</p>
</li>
<li><p>添加7004到之前的集群，并作为一个master节点</p>
</li>
<li><p>给7004节点分配插槽，使得num这个key可以存储到7004实例</p>
</li>
</ul>
<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20221005174406023.png" srcset="/img/loading.gif" lazyload alt="image-20221005174406023"></p>
<p>修改复制后的配置文件端口，再启动7004文件中的redis服务</p>
<p>后面指定已经存在的集群节点</p>
<figure><div class="code-wrapper"><pre class="line-numbers language-ini" data-language="ini"><code class="language-ini">redis-cli --cluster add-node 192.168.26.133:7004 192.168.26.133:7001<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></div></figure>

<img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20221005175240778.png" srcset="/img/loading.gif" lazyload alt="image-20221005175240778" style="zoom:80%;" />

<p>查看集群状态</p>
<figure><div class="code-wrapper"><pre class="line-numbers language-none"><code class="language-none">redis-cli -p 7001 cluster nodes<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></div></figure>

<p>但是新创建的节点没有查询</p>
<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20221005175538567.png" srcset="/img/loading.gif" lazyload alt="image-20221005175538567"></p>
<p>向新的节点分配插槽</p>
<p>根据命名查看帮助文档</p>
<figure><div class="code-wrapper"><pre class="line-numbers language-none"><code class="language-none">redis-cli --cluster help <span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></div></figure>

<img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20221005180316290.png" srcset="/img/loading.gif" lazyload alt="image-20221005180316290" style="zoom:80%;" />

<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20221005180520807.png" srcset="/img/loading.gif" lazyload alt="image-20221005180520807"></p>
<p>删除节点</p>
<p>首先将节点的插槽转移</p>
<p>删除节点</p>
<figure><div class="code-wrapper"><pre class="line-numbers language-ini" data-language="ini"><code class="language-ini">redis-cli --cluster del-node ip:端口 分支id<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></div></figure>



<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20221005191422166.png" srcset="/img/loading.gif" lazyload alt="image-20221005191422166"></p>
<p>删除成功</p>
<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20221005191607190.png" srcset="/img/loading.gif" lazyload alt="image-20221005191607190"></p>
<h3 id="18-5-4故障转移"><a href="#18-5-4故障转移" class="headerlink" title="18.5.4故障转移"></a>18.5.4故障转移</h3><p>采用watch的方式监控分片集群</p>
<figure><div class="code-wrapper"><pre class="line-numbers language-ini" data-language="ini"><code class="language-ini">watch redis-cli -p 7001 cluster nodes<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></div></figure>

<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20221005191934645.png" srcset="/img/loading.gif" lazyload alt="image-20221005191934645"></p>
<p>测试将7002宕机</p>
<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20221005192748404.png" srcset="/img/loading.gif" lazyload alt="image-20221005192748404"></p>
<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20221005192722231.png" srcset="/img/loading.gif" lazyload alt="image-20221005192722231"></p>
<p>重启7002的redis服务</p>
<figure><div class="code-wrapper"><pre class="line-numbers language-ini" data-language="ini"><code class="language-ini">edis-server 7002/redis.conf<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></div></figure>

<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20221005192943279.png" srcset="/img/loading.gif" lazyload alt="image-20221005192943279"></p>
<h3 id="18-5-5数据迁移"><a href="#18-5-5数据迁移" class="headerlink" title="18.5.5数据迁移"></a>18.5.5数据迁移</h3><p><code>利用cluster failover命令可以手动让集群中的某个master宕机，切换到执行cluster failover命令的这个slave节点，实现无感知的数据迁移</code>。其流程如下：</p>
<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20221005193222962.png" srcset="/img/loading.gif" lazyload alt="image-20221005193222962"></p>
<p>测试：将刚刚成为slave节点的7002变为master</p>
<ol>
<li><p>利用redis-cli连接7002这个节点</p>
</li>
<li><p>执行cluster failover命令</p>
</li>
</ol>
<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20221005193724101.png" srcset="/img/loading.gif" lazyload alt="image-20221005193724101"></p>
<p>查看集群状态信息</p>
<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20221005193820185.png" srcset="/img/loading.gif" lazyload alt="image-20221005193820185"></p>
<h3 id="18-5-6RedisTemplate连接分片集群"><a href="#18-5-6RedisTemplate连接分片集群" class="headerlink" title="18.5.6RedisTemplate连接分片集群"></a>18.5.6RedisTemplate连接分片集群</h3><p><font color='red'><strong>首先关闭虚拟机防火墙，并重启redis和sentinel</strong></font></p>
<p>RedisTemplate底层同样基于lettuce实现了分片集群的支持，而使用的步骤与哨兵模式基本一致：</p>
<ol>
<li><p>引入redis的starter依赖</p>
</li>
<li><p>配置分片集群地址</p>
</li>
<li><p>配置读写分离</p>
</li>
</ol>
<p>与哨兵模式相比，其中只有分片集群的配置方式略有差异，如下：</p>
<figure><div class="code-wrapper"><pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">redis</span><span class="token punctuation">:</span>
    <span class="token key atrule">cluster</span><span class="token punctuation">:</span>
      <span class="token key atrule">nodes</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> 192.168.26.133<span class="token punctuation">:</span><span class="token number">7001</span>
        <span class="token punctuation">-</span> 192.168.26.133<span class="token punctuation">:</span><span class="token number">7002</span>
        <span class="token punctuation">-</span> 192.168.26.133<span class="token punctuation">:</span><span class="token number">7003</span>
        <span class="token punctuation">-</span> 192.168.26.133<span class="token punctuation">:</span><span class="token number">8001</span>
        <span class="token punctuation">-</span> 192.168.26.133<span class="token punctuation">:</span><span class="token number">8002</span>
        <span class="token punctuation">-</span> 192.168.26.133<span class="token punctuation">:</span><span class="token number">8003</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure>

<p>测试接口：</p>
<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20221005195853676.png" srcset="/img/loading.gif" lazyload alt="image-20221005195853676"></p>
<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20221005202002079.png" srcset="/img/loading.gif" lazyload alt="image-20221005202002079"></p>
<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20221005201104601.png" srcset="/img/loading.gif" lazyload alt="image-20221005201104601"></p>
<p>查看控制台，读操作操作7002的从节点8003 	</p>
<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20221005201710230.png" srcset="/img/loading.gif" lazyload alt="image-20221005201710230"></p>
<p>写操作操作7002主节点</p>
<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20221005202016737.png" srcset="/img/loading.gif" lazyload alt="image-20221005202016737"></p>
<h1 id="1-多级缓存"><a href="#1-多级缓存" class="headerlink" title="1.多级缓存"></a>1.多级缓存</h1><p>传统的缓存策略一般是请求到达Tomcat后，先查询Redis，如果未命中则查询数据库，存在下面的问题：</p>
<ul>
<li><p>请求要经过Tomcat处理，<code>Tomcat的性能成为整个系统的瓶颈</code></p>
</li>
<li><p><code>Redis缓存失效时，会对数据库产生冲击</code></p>
<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20221005202859818.png" srcset="/img/loading.gif" lazyload alt="image-20221005202859818"></p>
</li>
</ul>
<p>多级缓存就是充分利用请求处理的每个环节，分别添加缓存，减轻Tomcat压力，提升服务性能：</p>
<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20221005203432613.png" srcset="/img/loading.gif" lazyload alt="image-20221005203432613"></p>
<p>浏览器访问静态资源时，优先读取浏览器本地缓存</p>
<ul>
<li><p>访问非静态资源（ajax查询数据）时，访问服务端</p>
</li>
<li><p>请求到达Nginx后，优先读取Nginx本地缓存 </p>
</li>
<li><p>如果Nginx本地缓存未命中，则去直接查询Redis（不经过Tomcat）</p>
</li>
<li><p>如果Redis查询未命中，则查询Tomcat </p>
</li>
<li><p>请求进入Tomcat后，优先查询JVM进程缓存</p>
</li>
<li><p>如果JVM进程缓存未命中，则查询数据库</p>
</li>
</ul>
<p>在多级缓存架构中，Nginx内部需要编写&#x3D;&#x3D;本地缓存查询、Redis查询、Tomcat查询的业务逻辑&#x3D;&#x3D;，因此这样的nginx服务不再是一个反向代理服务器，而是一个编写业务的Web服务器了。</p>
<p>因此这样的业务Nginx服务也需要搭建集群来提高并发，再有专门的nginx服务来做反向代理，如图：</p>
<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20221005204819105.png" srcset="/img/loading.gif" lazyload alt="image-20221005204819105"></p>
<p>可见，多级缓存的关键有两个：</p>
<ul>
<li><code>一个是在nginx中编写业务，实现nginx本地缓存、Redis、Tomcat的查询</code></li>
<li><code>另一个就是在Tomcat中实现JVM进程缓存</code></li>
</ul>

                
              </div>
            
            <hr/>
            <div>
              <div class="post-metas my-3">
  
    <div class="post-meta mr-3 d-flex align-items-center">
      <i class="iconfont icon-category"></i>
      

<span class="category-chains">
  
  
    
      <span class="category-chain">
        
  <a href="/categories/Redis/" class="category-chain-item">Redis</a>
  
  

      </span>
    
  
</span>

    </div>
  
  
    <div class="post-meta">
      <i class="iconfont icon-tags"></i>
      
        <a href="/tags/NoSQL/">#NoSQL</a>
      
        <a href="/tags/Redis/">#Redis</a>
      
        <a href="/tags/%E7%BC%93%E5%AD%98/">#缓存</a>
      
    </div>
  
</div>


              
  

  <div class="license-box my-3">
    <div class="license-title">
      <div>Redis</div>
      <div>http://example.com/2022/10/13/Redis/</div>
    </div>
    <div class="license-meta">
      
        <div class="license-meta-item">
          <div>作者</div>
          <div>Xu huaiang</div>
        </div>
      
      
        <div class="license-meta-item license-meta-date">
          <div>发布于</div>
          <div>2022年10月13日</div>
        </div>
      
      
      
        <div class="license-meta-item">
          <div>许可协议</div>
          <div>
            
              
              
                <a target="_blank" href="https://creativecommons.org/licenses/by/4.0/">
                  <span class="hint--top hint--rounded" aria-label="BY - 署名">
                    <i class="iconfont icon-by"></i>
                  </span>
                </a>
              
            
          </div>
        </div>
      
    </div>
    <div class="license-icon iconfont"></div>
  </div>



              
                <div class="post-prevnext my-3">
                  <article class="post-prev col-6">
                    
                    
                      <a href="/2022/10/22/Rabbitmq/" title="RabbitMQ">
                        <i class="iconfont icon-arrowleft"></i>
                        <span class="hidden-mobile">RabbitMQ</span>
                        <span class="visible-mobile">上一篇</span>
                      </a>
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/2022/09/10/Git/" title="Git">
                        <span class="hidden-mobile">Git</span>
                        <span class="visible-mobile">下一篇</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
          </article>
        </div>
      </div>
    </div>

    <div class="side-col d-none d-lg-block col-lg-2">
      
  <aside class="sidebar" style="margin-left: -1rem">
    <div id="toc">
  <p class="toc-header">
    <i class="iconfont icon-list"></i>
    <span>目录</span>
  </p>
  <div class="toc-body" id="toc-body"></div>
</div>



  </aside>


    </div>
  </div>
</div>





  



  



  



  



  







    

    
      <a id="scroll-top-button" aria-label="TOP" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">搜索</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v" for="local-search-input">关键词</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>

    

    
  </main>

  <footer>
    <div class="footer-inner">
  
    <div class="footer-content">
       <svg t="1686619990842" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="2219" width="10" height="10"><path d="M512 16C238.066 16 16 238.066 16 512s222.066 496 496 496 496-222.066 496-496S785.934 16 512 16z m0 896c-221.064 0-400-178.902-400-400 0-221.062 178.902-400 400-400 221.064 0 400 178.902 400 400 0 221.064-178.902 400-400 400z m214.702-202.128c-19.228 19.424-91.06 82.792-208.13 82.792-164.86 0-280.968-122.85-280.968-283.134 0-158.304 120.55-278.802 279.524-278.802 111.062 0 177.476 53.24 195.186 69.558a23.93 23.93 0 0 1 3.872 30.644l-36.31 56.226c-7.682 11.9-23.932 14.564-34.998 5.842-17.19-13.552-63.628-45.076-123.416-45.076-96.606 0-155.832 70.66-155.832 160.164 0 83.178 53.776 167.384 156.554 167.384 65.314 0 113.686-38.078 131.452-54.45 10.54-9.714 27.192-8.078 35.64 3.476l39.73 54.34a23.894 23.894 0 0 1-2.304 31.036z" fill="" p-id="2220"></path></svg> <span>2023 - 2023</span> <i class="iconfont icon-love"></i> <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>Fluid</span></a> 
    </div>
  
  
    <div class="statistics">
  
  

  
    
      <span id="leancloud-site-pv-container" style="display: none">
        总访问量 
        <span id="leancloud-site-pv"></span>
         次
      </span>
    
    
      <span id="leancloud-site-uv-container" style="display: none">
        总访客数 
        <span id="leancloud-site-uv"></span>
         人
      </span>
    
    

  
</div>

  
  
  
</div>

  </footer>

  <!-- Scripts -->
  
  <script  src="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":100})
    NProgress.start()
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://lib.baomitu.com/jquery/3.6.0/jquery.min.js" ></script>
<script  src="https://lib.baomitu.com/twitter-bootstrap/4.6.1/js/bootstrap.min.js" ></script>
<script  src="/js/events.js" ></script>
<script  src="/js/plugins.js" ></script>


  <script  src="https://lib.baomitu.com/typed.js/2.0.12/typed.min.js" ></script>
  <script>
    (function (window, document) {
      var typing = Fluid.plugins.typing;
      var subtitle = document.getElementById('subtitle');
      if (!subtitle || !typing) {
        return;
      }
      var text = subtitle.getAttribute('data-typed-text');
      
        typing(text);
      
    })(window, document);
  </script>




  
    <script  src="/js/img-lazyload.js" ></script>
  




  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/tocbot/4.18.2/tocbot.min.js', function() {
    var toc = jQuery('#toc');
    if (toc.length === 0 || !window.tocbot) { return; }
    var boardCtn = jQuery('#board-ctn');
    var boardTop = boardCtn.offset().top;

    window.tocbot.init(Object.assign({
      tocSelector     : '#toc-body',
      contentSelector : '.markdown-body',
      linkClass       : 'tocbot-link',
      activeLinkClass : 'tocbot-active-link',
      listClass       : 'tocbot-list',
      isCollapsedClass: 'tocbot-is-collapsed',
      collapsibleClass: 'tocbot-is-collapsible',
      scrollSmooth    : true,
      includeTitleTags: true,
      headingsOffset  : -boardTop,
    }, CONFIG.toc));
    if (toc.find('.toc-list-item').length > 0) {
      toc.css('visibility', 'visible');
    }

    Fluid.events.registerRefreshCallback(function() {
      if ('tocbot' in window) {
        tocbot.refresh();
        var toc = jQuery('#toc');
        if (toc.length === 0 || !tocbot) {
          return;
        }
        if (toc.find('.toc-list-item').length > 0) {
          toc.css('visibility', 'visible');
        }
      }
    });
  });
</script>


  <script  src="https://lib.baomitu.com/prism/1.29.0/plugins/line-numbers/prism-line-numbers.min.js" ></script>

  <script src=https://lib.baomitu.com/clipboard.js/2.0.11/clipboard.min.js></script>

  <script>Fluid.plugins.codeWidget();</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/anchor-js/4.3.1/anchor.min.js', function() {
    window.anchors.options = {
      placement: CONFIG.anchorjs.placement,
      visible  : CONFIG.anchorjs.visible
    };
    if (CONFIG.anchorjs.icon) {
      window.anchors.options.icon = CONFIG.anchorjs.icon;
    }
    var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
    var res = [];
    for (var item of el) {
      res.push('.markdown-body > ' + item.trim());
    }
    if (CONFIG.anchorjs.placement === 'left') {
      window.anchors.options.class = 'anchorjs-link-left';
    }
    window.anchors.add(res.join(', '));

    Fluid.events.registerRefreshCallback(function() {
      if ('anchors' in window) {
        anchors.removeAll();
        var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
        var res = [];
        for (var item of el) {
          res.push('.markdown-body > ' + item.trim());
        }
        if (CONFIG.anchorjs.placement === 'left') {
          anchors.options.class = 'anchorjs-link-left';
        }
        anchors.add(res.join(', '));
      }
    });
  });
</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.js', function() {
    Fluid.plugins.fancyBox();
  });
</script>


  <script>Fluid.plugins.imageCaption();</script>

  <script defer src="/js/leancloud.js" ></script>

  <script  src="/js/local-search.js" ></script>





<!-- 主题的启动项，将它保持在最底部 -->
<!-- the boot of the theme, keep it at the bottom -->
<script  src="/js/boot.js" ></script>


  

  <noscript>
    <div class="noscript-warning">博客在允许 JavaScript 运行的环境下浏览效果更佳</div>
  </noscript>
</body>
</html>
