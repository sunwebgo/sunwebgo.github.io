

<!DOCTYPE html>
<html lang="zh-CN" data-default-color-scheme=light>



<head>
  <meta charset="UTF-8">
  <link rel="apple-touch-icon" sizes="76x76" href="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/hexo/favicon.png">
  <link rel="icon" href="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/hexo/favicon.png">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="author" content="Xu huaiang">
  <meta name="keywords" content="">
  
    <meta name="description" content="7.1. 栈、堆、方法区的交互关系 对于以下图片   将对象的类型加载到方法区 如果当前对象是存在于一个方法当中，则person变量存储在虚拟机栈当中 创建的对象存储在堆内存当中    堆、栈和方法区之间的交互关系如下：  对于Java虚拟机栈中的局部变量表中的对象引用指向堆空间当中的对象实例，其中堆空间中的对象实例 当中存在到对象类型数据的指针，其指向了方法区当中对应的对象类型。   7.2方">
<meta property="og:type" content="article">
<meta property="og:title" content="第07章_方法区">
<meta property="og:url" content="https://xhablog.online/2022/05/15/JVM-%E7%AC%AC07%E7%AB%A0_%E6%96%B9%E6%B3%95%E5%8C%BA/index.html">
<meta property="og:site_name" content="xhang′s blog">
<meta property="og:description" content="7.1. 栈、堆、方法区的交互关系 对于以下图片   将对象的类型加载到方法区 如果当前对象是存在于一个方法当中，则person变量存储在虚拟机栈当中 创建的对象存储在堆内存当中    堆、栈和方法区之间的交互关系如下：  对于Java虚拟机栈中的局部变量表中的对象引用指向堆空间当中的对象实例，其中堆空间中的对象实例 当中存在到对象类型数据的指针，其指向了方法区当中对应的对象类型。   7.2方">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/hexo/U6LRTMY%28VCAU0%281%60%29BK7LV1.png">
<meta property="article:published_time" content="2022-05-15T12:42:00.000Z">
<meta property="article:modified_time" content="2023-08-19T06:24:48.044Z">
<meta property="article:author" content="Xu huaiang">
<meta property="article:tag" content="Java">
<meta property="article:tag" content="JVM">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image" content="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/hexo/U6LRTMY%28VCAU0%281%60%29BK7LV1.png">
  
  
  
  <title>第07章_方法区 - xhang′s blog</title>

  <link  rel="stylesheet" href="https://lib.baomitu.com/twitter-bootstrap/4.6.1/css/bootstrap.min.css" />



  <link  rel="stylesheet" href="https://lib.baomitu.com/github-markdown-css/4.0.0/github-markdown.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/hint.css/2.7.0/hint.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/prism/1.29.0/plugins/line-numbers/prism-line-numbers.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.css" />



<!-- 主题依赖的图标库，不要自行修改 -->
<!-- Do not modify the link that theme dependent icons -->

<link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_hj8rtnfg7um.css">



<link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_lbnruvf0jn.css">


<link  rel="stylesheet" href="/css/main.css" />


  <link id="highlight-css" rel="stylesheet" href="/css/highlight.css" />
  
    <link id="highlight-css-dark" rel="stylesheet" href="/css/highlight-dark.css" />
  



  
<link rel="stylesheet" href="/css/macpanel.css">
<link rel="stylesheet" href="/css/iconfont.css">
<link rel="stylesheet" href="/css/indeximg-hover.css">



  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    Fluid.ctx = Object.assign({}, Fluid.ctx)
    var CONFIG = {"hostname":"xhablog.online","root":"/","version":"1.9.4","typing":{"enable":true,"typeSpeed":70,"cursorChar":"_","loop":false,"scope":[]},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"left","visible":"hover","icon":""},"progressbar":{"enable":true,"height_px":3,"color":"#29d","options":{"showSpinner":false,"trickleSpeed":100}},"code_language":{"enable":true,"default":"TEXT"},"copy_btn":true,"image_caption":{"enable":true},"image_zoom":{"enable":true,"img_url_replace":["",""]},"toc":{"enable":true,"placement":"right","headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":0},"lazyload":{"enable":true,"loading_img":"/img/loading.gif","onlypost":false,"offset_factor":2},"web_analytics":{"enable":true,"follow_dnt":true,"baidu":null,"google":null,"gtag":null,"tencent":{"sid":null,"cid":null},"woyaola":null,"cnzz":null,"leancloud":{"app_id":"giycfQfOF4KRyAqEJy6tocBG-gzGzoHsz","app_key":"eFPJSGrHpiDV2uq6UTxse15b","server_url":"https://giycfqfo.lc-cn-n1-shared.com","path":"window.location.pathname","ignore_local":false}},"search_path":"/local-search.xml"};

    if (CONFIG.web_analytics.follow_dnt) {
      var dntVal = navigator.doNotTrack || window.doNotTrack || navigator.msDoNotTrack;
      Fluid.ctx.dnt = dntVal && (dntVal.startsWith('1') || dntVal.startsWith('yes') || dntVal.startsWith('on'));
    }
  </script>
  <script  src="/js/utils.js" ></script>
  <script  src="/js/color-schema.js" ></script>
  

  

  

  

  

  

  

  
    
  



  
<meta name="generator" content="Hexo 6.3.0"></head>


<body>
  

  <header>
    

<div class="header-inner" style="height: 70vh;">
  <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand" href="/">
      <strong>xhang′s blog</strong>
    </a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/">
                <i class="iconfont icon-zhuye"></i>
                <span>首页</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/">
                <i class="iconfont icon-guidang1"></i>
                <span>归档</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/categories/">
                <i class="iconfont icon-fenlei"></i>
                <span>分类</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/tags/">
                <i class="iconfont icon-biaoqian"></i>
                <span>标签</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/messageboard/">
                <i class="iconfont icon-liuyanban-05"></i>
                <span>留言板</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/links/">
                <i class="iconfont icon-youqinglianjie"></i>
                <span>友链</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/">
                <i class="iconfont icon-guanyuwomen"></i>
                <span>关于</span>
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search">
              <i class="iconfont icon-search"></i>
            </a>
          </li>
          
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" target="_self" href="javascript:;" aria-label="Color Toggle">
              <i class="iconfont icon-dark" id="color-toggle-icon"></i>
            </a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

  

<div id="banner" class="banner" parallax=true
     style="background: url('https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/hexo/index.png') no-repeat center center; background-size: cover;">
  <div class="full-bg-img">
    <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
      <div class="banner-text text-center fade-in-up">
        <div class="h2">
          
            <span id="subtitle" data-typed-text="第07章_方法区"></span>
          
        </div>

        
          
  <div class="mt-3">
    
      <span class="post-meta mr-2">
        <i class="iconfont icon-author" aria-hidden="true"></i>
        Xu huaiang
      </span>
    
    
      <span class="post-meta">
        <i class="iconfont icon-date-fill" aria-hidden="true"></i>
        <time datetime="2022-05-15 20:42" pubdate>
          2022年5月15日 晚上
        </time>
      </span>
    
  </div>

  <div class="mt-1">
    
      <span class="post-meta mr-2">
        <i class="iconfont icon-chart"></i>
        
          9.5k 字
        
      </span>
    

    
      <span class="post-meta mr-2">
        <i class="iconfont icon-clock-fill"></i>
        
        
        
          80 分钟
        
      </span>
    

    
    
      
        <span id="leancloud-page-views-container" class="post-meta" style="display: none">
          <i class="iconfont icon-eye" aria-hidden="true"></i>
          <span id="leancloud-page-views"></span> 次
        </span>
        
      
    
  </div>


        
      </div>

      
    </div>
  </div>
</div>

</div>

  </header>

  <main>
    
      

<div class="container-fluid nopadding-x">
  <div class="row nomargin-x">
    <div class="side-col d-none d-lg-block col-lg-2">
      

    </div>

    <div class="col-lg-8 nopadding-x-md">
      <div class="container nopadding-x-md" id="board-ctn">
        <div id="board">
          <article class="post-content mx-auto">
            <!-- SEO header -->
            <h1 style="display: none">第07章_方法区</h1>
            
            
              <div class="markdown-body">
                
                <p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20230603204318272.png" srcset="/img/loading.gif" lazyload alt="image-20230603204318272"></p>
<h2 id="7-1-栈、堆、方法区的交互关系"><a href="#7-1-栈、堆、方法区的交互关系" class="headerlink" title="7.1. 栈、堆、方法区的交互关系"></a>7.1. 栈、堆、方法区的交互关系</h2><p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20230603204724409.png" srcset="/img/loading.gif" lazyload></p>
<p>对于以下图片</p>
<blockquote>
<ul>
<li>将对象的类型加载到方法区</li>
<li>如果当前对象是存在于一个方法当中，则person变量存储在虚拟机栈当中</li>
<li>创建的对象存储在堆内存当中</li>
</ul>
</blockquote>
<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20230604114310318.png" srcset="/img/loading.gif" lazyload alt="image-20230604114310318"></p>
<p>堆、栈和方法区之间的交互关系如下：</p>
<blockquote>
<p>对于Java虚拟机栈中的局部变量表中的对象引用指向堆空间当中的对象实例，其中堆空间中的对象实例 当中存在<code>到对象类型数据的指针</code>，其指向了方法区当中对应的对象类型。</p>
</blockquote>
<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20230603210226813.png" srcset="/img/loading.gif" lazyload></p>
<h2 id="7-2方法区概述"><a href="#7-2方法区概述" class="headerlink" title="7.2方法区概述"></a>7.2方法区概述</h2><h3 id="7-2-1-方法区概述"><a href="#7-2-1-方法区概述" class="headerlink" title="7.2.1.方法区概述"></a>7.2.1.方法区概述</h3><p>方法区是Java虚拟机（JVM）中的一个重要内存区域，用于存储已被虚拟机加载的<code>类型信息</code>、<code>运行时常量池</code>、<code>静态变量</code>、<code>即时编译器编译后的代码缓存</code>等。它是<font color='scarlet'>所有线程共享的内存区域</font>，与堆、栈不同。方法区在JVM启动时被创建，它存在于物理内存中，并且具有固定大小。</p>
<h3 id="7-2-2-HotSpot中方法区的演进"><a href="#7-2-2-HotSpot中方法区的演进" class="headerlink" title="7.2.2. HotSpot中方法区的演进"></a>7.2.2. HotSpot中方法区的演进</h3><p>在jdk7及以前，习惯上把方法区，称为永久代。jdk8开始，<font color='red'>使用元空间取代了永久代。</font></p>
<p>本质上，<font color='scarlet'>方法区和永久代并不等价</font>。仅是对hotspot而言的。《Java虚拟机规范》对如何实现方法区，不做统一要求。例如：BEA JRockit &#x2F; IBM J9 中不存在永久代的概念。</p>
<p>现在来看，当年使用永久代，不是好的idea。导致Java程序更容易OOM（超过<code>-XX:MaxPermsize</code>上限）</p>
<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20230603224736788.png" srcset="/img/loading.gif" lazyload></p>
<p>而到了JDK8，终于完全废弃了永久代的概念，改用与JRockit、J9一样在本地内存中实现的元空间（Metaspace）来代替</p>
<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20230603224817854.png" srcset="/img/loading.gif" lazyload alt="image-20230603224817854"></p>
<p><font color='scarlet'>元空间的本质和永久代类似，都是对JVM规范中方法区的实现。不过元空间与永久代最大的区别在于：&#x3D;&#x3D;元空间不在虚拟机设置的内存中，而是使用本地内存。&#x3D;&#x3D;</font></p>
<p>永久代、元空间二者并不只是名字变了，内部结构也调整了</p>
<p>根据《Java虚拟规范》的规定，如果方法区无法满足新的内存分配需求时，将抛出OOM异常</p>
<h3 id="7-2-3-方法区和元空间or永久代之间的关系"><a href="#7-2-3-方法区和元空间or永久代之间的关系" class="headerlink" title="7.2.3.方法区和元空间or永久代之间的关系"></a>7.2.3.方法区和元空间or永久代之间的关系</h3><p>方法区和永久代以及元空间的关系很像 Java 中接口和类的关系，类实现了接口，这里的类就可以看作是永久代和元空间，接口可以看作是方法区，也就是说<font color='scarlet'>永久代以及元空间是 HotSpot 虚拟机对虚拟机规范中方法区的两种实现方式。</font></p>
<p>并且，永久代是 JDK 1.8 之前的方法区实现，JDK 1.8 及以后方法区的实现便成为元空间。</p>
<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20230604112050519.png" srcset="/img/loading.gif" lazyload alt="image-20230604112050519"></p>
<h2 id="7-3-设置方法区大小与OOM"><a href="#7-3-设置方法区大小与OOM" class="headerlink" title="7.3. 设置方法区大小与OOM"></a>7.3. 设置方法区大小与OOM</h2><h3 id="7-3-1-设置方法区内存的大小"><a href="#7-3-1-设置方法区内存的大小" class="headerlink" title="7.3.1. 设置方法区内存的大小"></a>7.3.1. 设置方法区内存的大小</h3><p>方法区的大小不必是固定的，JVM可以根据应用的需要动态调整。</p>
<p><strong>JDK7及以前</strong></p>
<ul>
<li><p>通过<code>-XX:Permsize</code>来设置永久代初始分配空间。默认值是20.75M</p>
</li>
<li><p>通过<code>-XX:MaxPermsize</code>来设定永久代最大可分配空间。32位机器默认是64M，64位机器模式是82M</p>
</li>
<li><p>当JVM加载的类信息容量超过了这个值，会报异常<code>OutOfMemoryError:PermGen space</code>。</p>
</li>
</ul>
<p><strong>JDK8及以后</strong></p>
<ul>
<li><p>元数据区大小可以使用参数 <code>-XX:MetaspaceSize</code> 和 <code>-XX:MaxMetaspaceSize</code>指定</p>
</li>
<li><p>默认值依赖于平台。windows下，<code>-XX:MetaspaceSize=21M -XX:MaxMetaspaceSize=-1//即没有限制</code>。</p>
</li>
<li><p>与永久代不同，如果不指定大小，默认情况下，虚拟机会耗尽所有的可用系统内存。如果元数据区发生溢出，虚拟机一样会抛出异常<code>OutOfMemoryError:Metaspace</code></p>
</li>
<li><p><code>-XX:MetaspaceSize</code>：设置初始的元空间大小。对于一个64位的服务器端JVM来说，其默认的<code>-XX:MetaspaceSize</code>值为21MB。这就是初始的高水位线，一旦触及这个水位线，Full GC将会被触发并卸载没用的类（即这些类对应的类加载器不再存活），然后这个高水位线将会重置。新的高水位线的值取决于GC后释放了多少元空间。如果释放的空间不足，那么在不超过<code>MaxMetaspaceSize</code>时，适当提高该值。如果释放空间过多，则适当降低该值。</p>
</li>
<li><p>如果初始化的高水位线设置过低，上述高水位线调整情况会发生很多次。通过垃圾回收器的日志可以观察到Full GC多次调用。为了避免频繁地GC，建议将<code>-XX:MetaspaceSize</code>设置为一个相对较高的值。</p>
</li>
</ul>
<h3 id="7-3-2方法区OOM演示"><a href="#7-3-2方法区OOM演示" class="headerlink" title="7.3.2方法区OOM演示"></a>7.3.2方法区OOM演示</h3><p>使用以下代码创建10000个类，<font color='scarlet'>并不设置元空间大小，其使用的是本地内存</font>，查看是否会出现<code>OutOfMemoryError:Metaspace</code>。</p>
<figure><div class="code-wrapper"><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">import</span> <span class="token import"><span class="token namespace">jdk<span class="token punctuation">.</span>internal<span class="token punctuation">.</span>org<span class="token punctuation">.</span>objectweb<span class="token punctuation">.</span>asm<span class="token punctuation">.</span></span><span class="token class-name">ClassWriter</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">jdk<span class="token punctuation">.</span>internal<span class="token punctuation">.</span>org<span class="token punctuation">.</span>objectweb<span class="token punctuation">.</span>asm<span class="token punctuation">.</span></span><span class="token class-name">Opcodes</span></span><span class="token punctuation">;</span>

<span class="token comment">/**
 * jdk8中：
 * -XX:MetaspaceSize=10m-XX:MaxMetaspaceSize=10m
 * jdk6中：
 * -XX:PermSize=10m-XX:MaxPermSize=10m
 */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MetaSpaceTest</span> <span class="token keyword">extends</span> <span class="token class-name">ClassLoader</span><span class="token punctuation">&#123;</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
        <span class="token keyword">int</span> j <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span><span class="token punctuation">&#123;</span>
            <span class="token class-name">MetaSpaceTest</span> test <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MetaSpaceTest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>i<span class="token operator">&lt;</span><span class="token number">10000</span><span class="token punctuation">;</span>i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
                <span class="token comment">//创建Classwriter对象，用于生成类的二进制字节码</span>
                <span class="token class-name">ClassWriter</span> classWriter <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ClassWriter</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">//指明版本号，public，类名，包名，父类，接口</span>
                classWriter<span class="token punctuation">.</span><span class="token function">visit</span><span class="token punctuation">(</span><span class="token class-name">Opcodes</span><span class="token punctuation">.</span><span class="token constant">V1_6</span><span class="token punctuation">,</span> <span class="token class-name">Opcodes</span><span class="token punctuation">.</span><span class="token constant">ACC_PUBLIC</span><span class="token punctuation">,</span> <span class="token string">"Class"</span> <span class="token operator">+</span> i<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token string">"java/lang/Object"</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">//返回byte[]</span>
                <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> code <span class="token operator">=</span> classWriter<span class="token punctuation">.</span><span class="token function">toByteArray</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">//类的加载</span>
                test<span class="token punctuation">.</span><span class="token function">defineClass</span><span class="token punctuation">(</span><span class="token string">"Class"</span> <span class="token operator">+</span> i<span class="token punctuation">,</span> code<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> code<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//CLass对象</span>
                j<span class="token operator">++</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span> <span class="token keyword">finally</span><span class="token punctuation">&#123;</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>j<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure>

<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20230603230757761.png" srcset="/img/loading.gif" lazyload alt="image-20230603230757761"></p>
<p>使用以下参数对<code>元空间</code>内存大小进行限制：</p>
<figure><div class="code-wrapper"><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token operator">-</span><span class="token constant">XX</span><span class="token operator">:</span><span class="token class-name">MetaspaceSize</span><span class="token operator">=</span><span class="token number">10</span>m <span class="token operator">-</span><span class="token constant">XX</span><span class="token operator">:</span><span class="token class-name">MaxMetaspaceSize</span><span class="token operator">=</span><span class="token number">10</span>m<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></div></figure>

<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20230603231011755.png" srcset="/img/loading.gif" lazyload alt="image-20230603231011755"></p>
<p>出现<code>OutOfMemoryError:Metaspace</code></p>
<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20230603231115601.png" srcset="/img/loading.gif" lazyload alt="image-20230603231115601"></p>
<h3 id="7-3-3-如何解决这些OOM"><a href="#7-3-3-如何解决这些OOM" class="headerlink" title="7.3.3. 如何解决这些OOM"></a>7.3.3. 如何解决这些OOM</h3><blockquote>
<ol>
<li><p>要解决OOM异常或heap space的异常，一般的手段是首先通过内存映像分析工具（如Eclipse Memory Analyzer）对dump出来的堆转储快照进行分析，重点是确认内存中的对象是否是必要的，也就是要先分清楚到底是出现了内存泄漏（Memory Leak）还是内存溢出（Memory Overflow）</p>
</li>
<li><p>如果是内存泄漏，可进一步通过工具查看泄漏对象到GC Roots的引用链。于是就能找到泄漏对象是通过怎样的路径与GCRoots相关联并导致垃圾收集器无法自动回收它们的。掌握了泄漏对象的类型信息，以及GCRoots引用链的信息，就可以比较准确地定位出泄漏代码的位置。</p>
</li>
<li><p>如果不存在内存泄漏，换句话说就是内存中的对象确实都还必须存活着，那就应当检查虚拟机的堆参数（<code>-Xmx</code>与<code>-Xms</code>），与机器物理内存对比看是否还可以调大，从代码上检查是否存在某些对象生命周期过长、持有状态时间过长的情况，尝试减少程序运行期的内存消耗。</p>
</li>
</ol>
</blockquote>
<h2 id="7-4方法区的内部结构"><a href="#7-4方法区的内部结构" class="headerlink" title="7.4方法区的内部结构"></a>7.4方法区的内部结构</h2><p>对于下图的执行信息如下：</p>
<blockquote>
<ul>
<li><p>java源代码通过编译后得到字节码文件，由类加载子系统中的类加载器将字节码转换为二进制字节流，并放入运行时数据区。</p>
</li>
<li><p>类信息放入到方法区当中。</p>
</li>
<li><p>堆内存当中存储对象实例。</p>
</li>
<li><p>虚拟机栈当中存储方法调用过程当中的临时数据和调用者的地址信息。</p>
</li>
<li><p>程序计数器记录指令地址，并由执行引擎读取指令地址，执行相应的操作指令。</p>
</li>
</ul>
</blockquote>
<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20230603232428082.png" srcset="/img/loading.gif" lazyload alt="image-20230603232428082"></p>
<h3 id="7-4-1方法区（Method-Area）存储什么？"><a href="#7-4-1方法区（Method-Area）存储什么？" class="headerlink" title="7.4.1方法区（Method Area）存储什么？"></a>7.4.1方法区（Method Area）存储什么？</h3><p>它用于存储已被虚拟机加载的<code>类型信息</code>、<code>运行时常量池</code>、<code>静态变量</code>、<code>即时编译器编译后的代码缓存</code>等。</p>
<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20230603233937392.png" srcset="/img/loading.gif" lazyload alt="image-20230603233937392"></p>
<h3 id="7-4-2-方法区的内部结构"><a href="#7-4-2-方法区的内部结构" class="headerlink" title="7.4.2. 方法区的内部结构"></a>7.4.2. 方法区的内部结构</h3><h4 id="7-4-2-1类型信息"><a href="#7-4-2-1类型信息" class="headerlink" title="7.4.2.1类型信息"></a>7.4.2.1类型信息</h4><p>对每个加载的类型（类class、接口interface、枚举enum、注解annotation），JVM必须在方法区中存储以下类型信息：</p>
<blockquote>
<ol>
<li><p>这个类型的完整有效名称（全名&#x3D;包名.类名）</p>
</li>
<li><p>这个类型直接父类的完整有效名（对于interface或是java.lang.object，都没有父类）</p>
</li>
<li><p>这个类型的修饰符（public，abstract，final的某个子集）</p>
</li>
<li><p>这个类型直接接口的一个有序列表</p>
</li>
</ol>
</blockquote>
<h4 id="7-4-2-2域（Field）信息"><a href="#7-4-2-2域（Field）信息" class="headerlink" title="7.4.2.2域（Field）信息"></a>7.4.2.2域（Field）信息</h4><p>域（Field）也就是属性。</p>
<p>JVM必须在方法区中保存类型的所有域的相关信息以及域的声明顺序。</p>
<p>域的相关信息包括：域名称、域类型、域修饰符（public，private，protected，static，final，volatile，transient的某个子集）</p>
<h4 id="7-4-2-3方法（Method）信息"><a href="#7-4-2-3方法（Method）信息" class="headerlink" title="7.4.2.3方法（Method）信息"></a>7.4.2.3方法（Method）信息</h4><p>JVM必须保存所有方法的以下信息，同域信息一样包括声明顺序：</p>
<blockquote>
<ol>
<li>方法名称</li>
<li>方法的返回类型（或void）</li>
<li>方法参数的数量和类型（按顺序）</li>
<li>方法的修饰符（public，private，protected，static，final，synchronized，native，abstract的一个子集）</li>
<li>方法的字节码（bytecodes）、操作数栈、局部变量表及大小（abstract和native方法除外）</li>
<li>异常表（abstract和native方法除外）<ul>
<li>每个异常处理的开始位置、结束位置、代码处理在程序计数器中的偏移地址、被捕获的异常类的常量池索引</li>
</ul>
</li>
</ol>
</blockquote>
<h4 id="7-4-2-4non-final的类变量"><a href="#7-4-2-4non-final的类变量" class="headerlink" title="7.4.2.4non-final的类变量"></a>7.4.2.4non-final的类变量</h4><ul>
<li><p>静态变量（类变量）和类关联在一起，随着类的加载而加载，他们成为类数据在逻辑上的一部分</p>
</li>
<li><p><font color='scarlet'>类变量被类的所有实例共享，即使没有类实例时，你也可以访问它</font></p>
</li>
</ul>
<figure><div class="code-wrapper"><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MethodAreaTest</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">Order</span> order <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Order</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        order<span class="token punctuation">.</span><span class="token function">hello</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>order<span class="token punctuation">.</span>count<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>
<span class="token keyword">class</span> <span class="token class-name">Order</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">int</span> count <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">hello</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"hello!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure>

<h4 id="7-4-2-5补充说明：全局常量（static-final）"><a href="#7-4-2-5补充说明：全局常量（static-final）" class="headerlink" title="7.4.2.5补充说明：全局常量（static final）"></a>7.4.2.5补充说明：全局常量（static final）</h4><p>被声明为final的类变量的处理方法则不同，每个全局常量在编译的时候就会被分配了。</p>
<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20230604090049088.png" srcset="/img/loading.gif" lazyload alt="image-20230604090049088"></p>
<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20230604090105844.png" srcset="/img/loading.gif" lazyload alt="image-20230604090105844"></p>
<h4 id="7-4-2-6案例演示"><a href="#7-4-2-6案例演示" class="headerlink" title="7.4.2.6案例演示"></a>7.4.2.6案例演示</h4><p>对以下代码进行反编译，查看详细信息。</p>
<figure><div class="code-wrapper"><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span><span class="token class-name">Serializable</span></span><span class="token punctuation">;</span>

<span class="token comment">/**
 * 方法内部结构测试
 *
 * @author Xu huaiang
 * @date 2023/06/03
 */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MethodInnerStructTest</span> <span class="token keyword">extends</span> <span class="token class-name">Object</span> <span class="token keyword">implements</span> <span class="token class-name">Comparable</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">></span></span><span class="token punctuation">,</span> <span class="token class-name">Serializable</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">public</span> <span class="token keyword">int</span> num <span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">String</span> str <span class="token operator">=</span> <span class="token string">"测试方法内部结构"</span><span class="token punctuation">;</span>

    <span class="token comment">// 方法</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">test1</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">int</span> count <span class="token operator">=</span> <span class="token number">20</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"count = "</span> <span class="token operator">+</span> count<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token comment">// 方法</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">test2</span><span class="token punctuation">(</span><span class="token keyword">int</span> cal<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">int</span> result <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">int</span> value <span class="token operator">=</span> <span class="token number">30</span><span class="token punctuation">;</span>
            result <span class="token operator">=</span> value <span class="token operator">/</span> cal<span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token keyword">return</span> result<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">compareTo</span><span class="token punctuation">(</span><span class="token class-name">String</span> o<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure>

<figure><div class="code-wrapper"><pre class="line-numbers language-java" data-language="java"><code class="language-java">javap <span class="token operator">-</span>v <span class="token operator">-</span>p <span class="token class-name">MethodInnerStructTest</span><span class="token punctuation">.</span><span class="token keyword">class</span> <span class="token operator">></span> <span class="token class-name">MethodInnerStructTest</span><span class="token punctuation">.</span>txt<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></div></figure>

<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20230604000013854.png" srcset="/img/loading.gif" lazyload alt="image-20230604000013854"></p>
<p>查看字节码文件内容：</p>
<p>类型信息：</p>
<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20230604083355078.png" srcset="/img/loading.gif" lazyload alt="image-20230604083355078"></p>
<p>域信息：</p>
<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20230604083510427.png" srcset="/img/loading.gif" lazyload></p>
<p>方法信息：</p>
<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20230604083723393.png" srcset="/img/loading.gif" lazyload></p>
<h3 id="7-4-3-Class文件常量池、运行时常量池、字符串常量池"><a href="#7-4-3-Class文件常量池、运行时常量池、字符串常量池" class="headerlink" title="7.4.3. Class文件常量池、运行时常量池、字符串常量池"></a>7.4.3. Class文件常量池、运行时常量池、字符串常量池</h3><h4 id="7-4-3-1Class文件常量池和运行时常量池的关系"><a href="#7-4-3-1Class文件常量池和运行时常量池的关系" class="headerlink" title="7.4.3.1Class文件常量池和运行时常量池的关系"></a>7.4.3.1Class文件常量池和运行时常量池的关系</h4><p><font color='read'>Class文件常量池是指编译生成的字节码文件结构中的一个常量池，用于存放编译期间生成的字面量和符号引用。而在类加载时（<code>链接阶段的解析步骤</code>），会将Class文件常量池当中的字面量和符号引用以及将符号引用转换为对应后的直接引用，存储在运行时常量池当中。</font></p>
<blockquote>
<ul>
<li>字节码文件，内部包含了常量池</li>
<li>方法区，内部包含了运行时常量池</li>
</ul>
</blockquote>
<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20230604090918352.png" srcset="/img/loading.gif" lazyload alt="image-20230604083355078"></p>
<h4 id="7-4-3-2Class文件常量池"><a href="#7-4-3-2Class文件常量池" class="headerlink" title="7.4.3.2Class文件常量池"></a>7.4.3.2Class文件常量池</h4><p><font color='read'>Class 文件常量池是 Java 类文件结构中的一部分，用于存放编译器生成的各种字面量和符号引用。它不是 JVM 结构的一部分，而是字节码文件中的内容。</font></p>
<p>一个有效的字节码文件中除了包含类的版本信息、字段、方法以及接口等描述符信息外，还包含一项信息就是常量池表（Constant Pool Table），<font color='scarlet'>包括各种字面量和对类型、域和方法的<code>符号引用</code></font>。</p>
<p><font color='scarlet'>常量池、可以看做是一张表，虚拟机指令根据这张常量表找到要执行的类名、方法名、参数类型、字面量等类型。即根据符号引用找到直接引用。</font></p>
<p><strong>常量池中有什么?</strong></p>
<p>常量池内存储的数据类型包括<code>字面量和符号引用</code>：</p>
<blockquote>
<ul>
<li><code>CONSTANT_Utf8_info</code>：表示字符串类型的常量。</li>
<li><code>CONSTANT_Integer_info</code>：表示整型字面量。</li>
<li><code>CONSTANT_Float_info</code>：表示浮点型字面量。</li>
<li><code>CONSTANT_Long_info</code>：表示长整型字面量。</li>
<li><code>CONSTANT_Double_info</code>：表示双精度浮点型字面量。</li>
<li><code>CONSTANT_Class_info</code>：表示类或接口的符号引用。</li>
<li><code>CONSTANT_String_info</code>：表示字符串类型字面量的引用。</li>
<li><code>CONSTANT_Fieldref_info</code>：表示字段的符号引用。</li>
<li><code>CONSTANT_Methodref_info</code>：表示类中方法的符号引用。</li>
<li><code>CONSTANT_InterfaceMethodref_info</code>：表示接口中方法的符号引用。</li>
<li><code>CONSTANT_NameAndType_info</code>：表示字段或方法的部分符号引用。</li>
</ul>
</blockquote>
<ol>
<li>根据符号引用指向类引用，创建一个<code>StringBuilder</code>类</li>
</ol>
<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20230604094651212.png" srcset="/img/loading.gif" lazyload alt="image-20230604083355078"></p>
<ol start="2">
<li>符号引用指向字符串值，指向字符串常量</li>
</ol>
<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20230604094958453.png" srcset="/img/loading.gif" lazyload alt="image-20230604083355078"></p>
<h4 id="7-4-3-3运行时常量池"><a href="#7-4-3-3运行时常量池" class="headerlink" title="7.4.3.3运行时常量池"></a>7.4.3.3运行时常量池</h4><p>运行时常量池是方法区的一部分。<font color='read'>而在类加载时（<code>链接阶段的解析步骤</code>），会将Class文件常量池当中的字面量和符号引用以及将符号引用转换为对应后的直接引用，存储在运行时常量池当中。</font></p>
<p>运行时常量池相对于<code>Class</code>文件常量池的另一个重要特征是具备<font color='scarlet'><strong>动态性</strong></font>，运行期间也可以将新的常量池放入运行时常量池中。它的字面量是可以动态添加的（<code>String</code>类的<code>intern()</code>方法），符号引用可以被解析为直接引用。</p>
<blockquote>
<ul>
<li><font color='scarlet'><strong>动态链接</strong></font>是在程序运行期间完成的，将符号引用替换成直接引用。在类加载阶段，虚拟机会将Class文件中的符号引用保存到运行时常量池中，并将其中一些符号引用转换为直接引用。<font color='red'>但是，并不是所有的符号引用都会在类加载阶段被转换为直接引用。有些符号引用需要在每次运行期间才能转化为直接引用，这种转换就叫做动态链接。</font></li>
</ul>
</blockquote>
<h4 id="7-4-3-4字符串常量池"><a href="#7-4-3-4字符串常量池" class="headerlink" title="7.4.3.4字符串常量池"></a>7.4.3.4字符串常量池</h4><p><font color='read'>字符串常量池在JDK1.7的时候从方法区当中的运行时常量池中分离出来并放到堆当中。</font>在JDK1.8的时候使用元空间替换掉了永久代，字符串常量池依旧存在于堆当中。</p>
<p>字符串常量池是用于存储字符串常量。它的目的是为了避免字符串的重复创建。<font color='read'>当我们在程序中创建一个字符串常量时，JVM会首先检查字符串常量池中是否已经存在该字符串。如果存在，JVM会直接返回该字符串的引用；如果不存在，JVM会在字符串常量池中创建一个新的字符串，并返回其引用。</font></p>
<p>下面是一些关于字符串常量池的例子：</p>
<figure><div class="code-wrapper"><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token class-name">String</span> s1 <span class="token operator">=</span> <span class="token string">"hello"</span><span class="token punctuation">;</span>
<span class="token class-name">String</span> s2 <span class="token operator">=</span> <span class="token string">"hello"</span><span class="token punctuation">;</span>
<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>s1 <span class="token operator">==</span> s2<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 输出true</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre></div></figure>

<p>上面的代码中，我们创建了两个字符串常量<code>&quot;hello&quot;</code>。由于它们具有相同的值，所以JVM只会在字符串常量池中创建一个<code>&quot;hello&quot;</code>字符串，并返回其引用。因此，<code>s1</code>和<code>s2</code>指向的是同一个字符串对象，所以它们相等。</p>
<figure><div class="code-wrapper"><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token class-name">String</span> s1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">(</span><span class="token string">"hello"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">String</span> s2 <span class="token operator">=</span> <span class="token string">"hello"</span><span class="token punctuation">;</span>
<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>s1 <span class="token operator">==</span> s2<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 输出false</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre></div></figure>

<p>使用<code>new String(&quot;hello&quot;)</code>创建字符串对象时，JVM会在堆内存中创建一个新的字符串对象，并将其引用赋值给<code>s1</code>。同时，JVM也会检查字符串常量池中是否已经存在<code>&quot;hello&quot;</code>这个字符串。如果不存在，JVM会在字符串常量池中创建一个新的<code>&quot;hello&quot;</code>字符串。因此，总共创建了两个对象。</p>
<h3 id="7-4-4方法区案例演示"><a href="#7-4-4方法区案例演示" class="headerlink" title="7.4.4方法区案例演示"></a>7.4.4方法区案例演示</h3><figure><div class="code-wrapper"><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MethodAreaDemo</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span> args<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">int</span> x <span class="token operator">=</span> <span class="token number">500</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> y <span class="token operator">=</span> <span class="token number">100</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> a <span class="token operator">=</span> x <span class="token operator">/</span> y<span class="token punctuation">;</span>
        <span class="token keyword">int</span> b <span class="token operator">=</span> <span class="token number">50</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>a<span class="token operator">+</span>b<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure>

<p>对于以上代码，由于没有New对象，所以没有涉及到堆空间。存在方法区和虚拟机栈。</p>
<p>下面演示方法区和虚拟机栈之间的操作：</p>
<ol>
<li><p>流程如下：</p>
<blockquote>
<p>执行引擎根据程序计数器当中的指令地址进行指令操作，操作数栈当中用于存储变量在计算过程中的中间结果，伴随着入栈和出栈操作 。局部变量表中存储方法的形参和方法的局部变量。</p>
</blockquote>
</li>
</ol>
<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20230604102656403.png" srcset="/img/loading.gif" lazyload alt="image-20230604102656403"></p>
<ol start="2">
<li></li>
</ol>
<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20230604102713450.png" srcset="/img/loading.gif" lazyload alt="image-20230604102713450"></p>
<ol start="3">
<li></li>
</ol>
<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20230604102726233.png" srcset="/img/loading.gif" lazyload alt="image-20230604102726233"></p>
<ol start="4">
<li></li>
</ol>
<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20230604102747978.png" srcset="/img/loading.gif" lazyload alt="image-20230604102747978"></p>
<ol start="5">
<li></li>
</ol>
<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20230604102805082.png" srcset="/img/loading.gif" lazyload alt="image-20230604102805082"></p>
<ol start="6">
<li></li>
</ol>
<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20230604102816176.png" srcset="/img/loading.gif" lazyload alt="image-20230604102816176"></p>
<ol start="7">
<li></li>
</ol>
<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20230604102827955.png" srcset="/img/loading.gif" lazyload alt="image-20230604102827955"></p>
<ol start="8">
<li></li>
</ol>
<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20230604102843075.png" srcset="/img/loading.gif" lazyload alt="image-20230604102843075"></p>
<ol start="9">
<li></li>
</ol>
<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20230604102856196.png" srcset="/img/loading.gif" lazyload alt="image-20230604102856196"></p>
<ol start="10">
<li></li>
</ol>
<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20230604102906882.png" srcset="/img/loading.gif" lazyload alt="image-20230604102906882"></p>
<ol start="11">
<li></li>
</ol>
<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20230604102917516.png" srcset="/img/loading.gif" lazyload alt="image-20230604102917516"></p>
<ol start="12">
<li></li>
</ol>
<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20230604102928487.png" srcset="/img/loading.gif" lazyload alt="image-20230604102928487"></p>
<ol start="13">
<li></li>
</ol>
<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20230604102938252.png" srcset="/img/loading.gif" lazyload alt="image-20230604102938252"></p>
<ol start="14">
<li></li>
</ol>
<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20230604102948756.png" srcset="/img/loading.gif" lazyload alt="image-20230604102948756"></p>
<ol start="15">
<li></li>
</ol>
<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20230604102959810.png" srcset="/img/loading.gif" lazyload alt="image-20230604102959810"></p>
<ol start="16">
<li></li>
</ol>
<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20230604103010664.png" srcset="/img/loading.gif" lazyload alt="image-20230604103010664"></p>
<h2 id="7-5-方法区的演进细节"><a href="#7-5-方法区的演进细节" class="headerlink" title="7.5. 方法区的演进细节"></a>7.5. 方法区的演进细节</h2><ol>
<li><p>首先明确：只有Hotspot才有永久代。BEA JRockit、IBMJ9等来说，是不存在永久代的概念的。原则上如何实现方法区属于虚拟机实现细节，不受《Java虚拟机规范》管束，并不要求统一</p>
</li>
<li><p>Hotspot中方法区的变化：</p>
</li>
</ol>
<table>
<thead>
<tr>
<th>版本</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>JDK1.6及之前</td>
<td>有永久代（permanet），静态变量存储在永久代上</td>
</tr>
<tr>
<td>JDK1.7</td>
<td>有永久代，但已经逐步 “去永久代”，字符串常量池，静态变量移除，保存在堆中</td>
</tr>
<tr>
<td>JDK1.8</td>
<td>无<code>永久代</code>，取而代之的是<code>元空间</code>。<font color='red'>类型信息，字段，方法，常量保存在本地内存的元空间（方法区），但字符串常量池、静态变量仍然在堆中。</font></td>
</tr>
</tbody></table>
<ol>
<li>所以说JDK1.6及之前<code>字符串常量池</code>是在<code>方法区</code>当中的的<code>运行时常量池</code>当中，而<code>静态变量</code>就是存储在方法区当中</li>
</ol>
<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20230604124541613.png" srcset="/img/loading.gif" lazyload></p>
<ol start="2">
<li>​	JDK1.7的时候分别将<code>字符串常量池</code>和<code>静态变量</code>从<code>方法区常量池</code>和<code>方法区</code>中移到<code>堆空间</code>中。</li>
</ol>
<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20230604124559313.png" srcset="/img/loading.gif" lazyload></p>
<ol start="3">
<li>JDK1.8及之后使用元空间代替了永久代，并使用本地内存。字符串常量池和静态变量依旧存在于堆空间中。</li>
</ol>
<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20230604124643175.png" srcset="/img/loading.gif" lazyload></p>
<h2 id="7-6为什么要使用元空间替换永久代"><a href="#7-6为什么要使用元空间替换永久代" class="headerlink" title="7.6为什么要使用元空间替换永久代"></a>7.6为什么要使用元空间替换永久代</h2><p><font color='scarlet'>当使用永久代实现方法区时，永久代的最大容量受制于 PermSize 和 MaxPermSize 参数设置的大小，而这两个参数的大小又很难确定，因为在程序运行时需要加载多少类是很难估算的，如果这两个参数设置的过小就会频繁的触发 FullGC 和导致 <a target="_blank" rel="noopener" href="https://so.csdn.net/so/search?q=OOM&spm=1001.2101.3001.7020">OOM</a>（Out of Memory，内存溢出）。</font></p>
<p>但是，当使用元空间替代了永久代之后，出现 OOM 的几率就被大大降低了，因为元空间使用的是本地内存，从而大大降低了 OOM 的问题。</p>
<h2 id="7-7为什么要将字符串常量池调整到堆"><a href="#7-7为什么要将字符串常量池调整到堆" class="headerlink" title="7.7为什么要将字符串常量池调整到堆"></a>7.7为什么要将字符串常量池调整到堆</h2><p><font color='scarlet'>因为永久代（方法区实现）的 GC 回收效率太低，只有在整堆收集 (Full GC)的时候才会被执行 GC。Java 程序在运行过程中通常会有大量的被创建的字符串等待回收，最终可能会导致永久代空间不足。</font></p>
<p>&#x3D;&#x3D;将字符串常量池放到堆中，能够更高效及时地回收内存。&#x3D;&#x3D;</p>
<h2 id="7-8方法区的垃圾回收行为"><a href="#7-8方法区的垃圾回收行为" class="headerlink" title="7.8方法区的垃圾回收行为"></a>7.8方法区的垃圾回收行为</h2><p>有些人认为方法区（如Hotspot虚拟机中的元空间或者永久代）是没有垃圾收集行为的，其实不然。《Java虚拟机规范》对方法区的约束是非常宽松的，提到过可以不要求虚拟机在方法区中实现垃圾收集。事实上也确实有未实现或未能完整实现方法区类型卸载的收集器存在（如JDK11时期的zGC收集器就不支持类卸载）。</p>
<p><font color='scarlet'>一般来说这个区域的回收效果比较难令人满意，尤其是类型的卸载，条件相当苛刻。但是这部分区域的回收有时又确实是必要的。</font>以前sun公司的Bug列表中，曾出现过的若干个严重的Bug就是由于低版本的HotSpot虚拟机对此区域未完全回收而导致内存泄漏。</p>
<p>方法区的垃圾收集主要回收两部分内容：&#x3D;&#x3D;常量池中废弃的常量和不再使用的类型。&#x3D;&#x3D;</p>
<p>先来说说方法区内常量池之中主要存放的两大类常量：字面量和符号引用。字面量比较接近Java语言层次的常量概念，如文本字符串、被声明为final的常量值等。而符号引用则属于编译原理方面的概念，包括下面三类常量：</p>
<blockquote>
<ul>
<li><p>类和接口的全限定名</p>
</li>
<li><p>字段的名称和描述符</p>
</li>
<li><p>方法的名称和描述符</p>
</li>
</ul>
</blockquote>
<p><font color='scarlet'>HotSpot虚拟机对常量池的回收策略是很明确的，只要常量池中的常量没有被任何地方引用，就可以被回收。</font></p>
<p>回收废弃常量与回收Java堆中的对象非常类似。</p>
<p><font color='red'>判定一个常量是否“废弃”还是相对简单，而要判定一个类型是否属于“不再被使用的类”的条件就比较苛刻了。需要同时满足下面三个条件：</font></p>
<ul>
<li><p>该类所有的实例都已经被回收，也就是Java堆中不存在该类及其任何派生子类的实例。</p>
</li>
<li><p>加载该类的类加载器已经被回收，这个条件除非是经过精心设计的可替换类加载器的场景，如OSGi、JSP的重加载等，否则通常是很难达成的。</p>
</li>
<li><p>该类对应的java.lang.Class对象没有在任何地方被引用，无法在任何地方通过反射访问该类的方法。</p>
</li>
</ul>
<p>Java虚拟机被允许对满足上述三个条件的无用类进行回收，这里说的仅仅是“被允许”，而并不是和对象一样，没有引用了就必然会回收。关于是否要对类型进行回收，HotSpot虚拟机提供了<code>-Xnoclassgc</code>参数进行控制，还可以使用<code>-verbose:class</code> 以及 <code>-XX:+TraceClassLoading</code>、<code>-XX:+TraceClassUnLoading</code>查看类加载和卸载信息</p>
<p>在大量使用反射、动态代理、CGLib等字节码框架，动态生成JSP以及OSGi这类频繁自定义类加载器的场景中，通常都需要Java虚拟机具备类型卸载的能力，以保证不会对方法区造成过大的内存压力。</p>
<h2 id="7-9方法区总结"><a href="#7-9方法区总结" class="headerlink" title="7.9方法区总结"></a>7.9方法区总结</h2><p><font color='scarlet'>动态链接指向了方法区运行时常量池当中的方法引用。</font></p>
<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20230604125826161.png" srcset="/img/loading.gif" lazyload alt="image-20230604125826161"></p>
<h2 id="7-10方法区面试题"><a href="#7-10方法区面试题" class="headerlink" title="7.10方法区面试题"></a>7.10方法区面试题</h2><ul>
<li><p>百度：</p>
<ul>
<li>说一下JVM内存模型吧，有哪些区？分别干什么的？</li>
</ul>
</li>
<li><p>蚂蚁金服：</p>
<ul>
<li>Java8的内存分代改进 JVM内存分哪几个区，每个区的作用是什么？</li>
<li>一面：JVM内存分布&#x2F;内存结构？栈和堆的区别？堆的结构？为什么两个survivor区？</li>
<li>二面：Eden和survior的比例分配</li>
</ul>
</li>
<li><p>小米：</p>
<ul>
<li>jvm内存分区，为什么要有新生代和老年代</li>
</ul>
</li>
<li><p>字节跳动：</p>
<ul>
<li>二面：Java的内存分区</li>
<li>二面：讲讲jvm运行时数据库区 什么时候对象会进入老年代？</li>
</ul>
</li>
<li><p>京东：</p>
<ul>
<li>JVM的内存结构，Eden和Survivor比例。</li>
<li>JVM内存为什么要分成新生代，老年代，持久代。</li>
<li>新生代中为什么要分为Eden和survivor。</li>
</ul>
</li>
<li><p>天猫：</p>
<ul>
<li>一面：Jvm内存模型以及分区，需要详细到每个区放什么。</li>
<li>一面：JVM的内存模型，Java8做了什么改</li>
</ul>
</li>
<li><p>拼多多：</p>
<ul>
<li>JVM内存分哪几个区，每个区的作用是什么？</li>
</ul>
</li>
<li><p>美团：</p>
<ul>
<li>java内存分配 jvm的永久代中会发生垃圾回收吗？</li>
<li>一面：jvm内存分区，为什么要有新生代和老年代？</li>
</ul>
</li>
</ul>

                
              </div>
            
            <hr/>
            <div>
              <div class="post-metas my-3">
  
    <div class="post-meta mr-3 d-flex align-items-center">
      <i class="iconfont icon-category"></i>
      

<span class="category-chains">
  
  
    
      <span class="category-chain">
        
  <a href="/categories/JVM/" class="category-chain-item">JVM</a>
  
  

      </span>
    
  
</span>

    </div>
  
  
    <div class="post-meta">
      <i class="iconfont icon-tags"></i>
      
        <a href="/tags/Java/">#Java</a>
      
        <a href="/tags/JVM/">#JVM</a>
      
    </div>
  
</div>


              
  

  <div class="license-box my-3">
    <div class="license-title">
      <div>第07章_方法区</div>
      <div>https://xhablog.online/2022/05/15/JVM-第07章_方法区/</div>
    </div>
    <div class="license-meta">
      
        <div class="license-meta-item">
          <div>作者</div>
          <div>Xu huaiang</div>
        </div>
      
      
        <div class="license-meta-item license-meta-date">
          <div>发布于</div>
          <div>2022年5月15日</div>
        </div>
      
      
      
        <div class="license-meta-item">
          <div>许可协议</div>
          <div>
            
              
              
                <a target="_blank" href="https://creativecommons.org/licenses/by/4.0/">
                  <span class="hint--top hint--rounded" aria-label="BY - 署名">
                    <i class="iconfont icon-by"></i>
                  </span>
                </a>
              
            
          </div>
        </div>
      
    </div>
    <div class="license-icon iconfont"></div>
  </div>



              
                <div class="post-prevnext my-3">
                  <article class="post-prev col-6">
                    
                    
                      <a href="/2022/05/16/JVM-%E7%AC%AC08%E7%AB%A0_%E5%AF%B9%E8%B1%A1%E5%AE%9E%E4%BE%8B%E5%8C%96%E5%92%8C%E7%9B%B4%E6%8E%A5%E5%86%85%E5%AD%98/" title="第08章_对象实例化和直接内存">
                        <i class="iconfont icon-arrowleft"></i>
                        <span class="hidden-mobile">第08章_对象实例化和直接内存</span>
                        <span class="visible-mobile">上一篇</span>
                      </a>
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/2022/05/14/JVM-%E7%AC%AC06%E7%AB%A0_%E5%A0%86/" title="第06章_堆">
                        <span class="hidden-mobile">第06章_堆</span>
                        <span class="visible-mobile">下一篇</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
  
  
    <article id="comments" lazyload>
      
  <div id="gitalk-container"></div>
  <script type="text/javascript">
    Fluid.utils.loadComments('#gitalk-container', function() {
      Fluid.utils.createCssLink('/css/gitalk.css')
      Fluid.utils.createScript('https://lib.baomitu.com/gitalk/1.8.0/gitalk.min.js', function() {
        var options = Object.assign(
          {"clientID":"65685887a536577e68ad","clientSecret":"da9f0f4e5301326ac35bb6141f0234e2a7561f4c","repo":"sunwebgo.github.io","owner":"sunwebgo","admin":["sunwebgo"],"language":"zh-CN","labels":["Gitalk"],"perPage":10,"pagerDirection":"last","distractionFreeMode":false,"createIssueManually":true,"proxy":"https://cors-anywhere.azm.workers.dev/https://github.com/login/oauth/access_token"},
          {
            id: 'ff69d6ad46af53bf8bb4c61b1eed0532'
          }
        )
        var gitalk = new Gitalk(options);
        gitalk.render('gitalk-container');
      });
    });
  </script>
  <noscript>Please enable JavaScript to view the comments</noscript>


    </article>
  


          </article>
        </div>
      </div>
    </div>

    <div class="side-col d-none d-lg-block col-lg-2">
      
  <aside class="sidebar" style="margin-left: -1rem">
    <div id="toc">
  <p class="toc-header">
    <i class="iconfont icon-list"></i>
    <span>目录</span>
  </p>
  <div class="toc-body" id="toc-body"></div>
</div>



  </aside>


    </div>
  </div>
</div>





  



  



  



  



  







    

    
      <a id="scroll-top-button" aria-label="TOP" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">搜索</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v" for="local-search-input">关键词</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>

    

    
  </main>

  <footer>
    <div class="footer-inner">
  
    <div class="footer-content">
       <span><svg t="1686650467734" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="4406" width="13" height="13"><path d="M926.991 337.678c-22.571-53.364-54.877-101.283-96.021-142.426-41.143-41.143-89.062-73.449-142.426-96.02-55.266-23.375-113.953-35.228-174.434-35.228-60.48 0-119.168 11.852-174.433 35.228-53.364 22.571-101.283 54.877-142.426 96.02s-73.449 89.062-96.02 142.426c-23.375 55.265-35.228 113.953-35.228 174.433 0 60.48 11.852 119.168 35.228 174.434 22.571 53.364 54.877 101.283 96.02 142.426 41.143 41.144 89.062 73.449 142.426 96.021 55.265 23.375 113.953 35.228 174.433 35.228 60.48 0 119.168-11.853 174.434-35.228 53.364-22.571 101.283-54.877 142.426-96.021 41.144-41.143 73.449-89.062 96.021-142.426 23.375-55.266 35.228-113.953 35.228-174.434 0-60.48-11.853-119.168-35.228-174.433z m-412.88 558.541c-211.797 0-384.107-172.31-384.107-384.107 0-211.797 172.31-384.107 384.107-384.107 211.798 0 384.107 172.31 384.107 384.107 0.001 211.797-172.309 384.107-384.107 384.107z" p-id="4407"></path><path d="M514.111 290.829c51.918 0 102.431 18.428 142.233 51.889 13.528 11.375 33.715 9.626 45.086-3.902 11.373-13.527 9.626-33.713-3.902-45.086-51.316-43.142-116.456-66.901-183.417-66.901-76.201 0-147.842 29.675-201.725 83.557-53.883 53.883-83.558 125.523-83.558 201.725s29.675 147.843 83.558 201.726 125.523 83.558 201.725 83.558c66.961 0 132.1-23.76 183.417-66.901 13.528-11.372 15.275-31.559 3.902-45.086s-31.559-15.275-45.086-3.902c-39.803 33.462-90.315 51.89-142.233 51.89-122.015 0-221.282-99.268-221.282-221.283 0-122.017 99.267-221.284 221.282-221.284z" p-id="4408"></path></svg>2021 - 2023</span> <span>本站由</span> <a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a> <span>&</span> <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>Fluid</span></a> <span>强力驱动</span> 
      <!--《添加网站运行时间 -->
<br/>

    <span id="timeDate">载入天数...</span><span id="times">载入时分秒...</span>
    <script>
      var now = new Date();

      function createtime() {
        //此处修改你的建站时间或者网站上线时间
        var grt = new Date('06/09/2023 8:00:00');
        now.setTime(now.getTime() + 250);
        days = (now - grt) / 1000 / 60 / 60 / 24;

        dnum = Math.floor(days);
        hours = (now - grt) / 1000 / 60 / 60 - (24 * dnum);
        hnum = Math.floor(hours);
        if (String(hnum).length == 1) {
          hnum = "0" + hnum;
        }
        minutes = (now - grt) / 1000 / 60 - (24 * 60 * dnum) - (60 * hnum);
        mnum = Math.floor(minutes);
        if (String(mnum).length == 1) {
          mnum = "0" + mnum;
        }
        seconds = (now - grt) / 1000 - (24 * 60 * 60 * dnum) - (60 * 60 * hnum) - (60 * mnum);
        snum = Math.round(seconds);
        if (String(snum).length == 1) {
          snum = "0" + snum;
        }
        document.getElementById("timeDate").innerHTML = " 本站已破天荒的安全运行 " + dnum + " 天 ";
        document.getElementById("times").innerHTML = hnum + " 小时 " + mnum + " 分 " + snum + " 秒";
      }
      setInterval("createtime()", 250);
    </script>

<!-- 添加网站运行时间》-->
<br/>
<span style="font-weight: initial">文章总字数2612k</span>

    </div>
  
  
    <div class="statistics">
  
  

  
    
      <span id="leancloud-site-pv-container" style="display: none">
        总访问量 
        <span id="leancloud-site-pv"></span>
         次
      </span>
    
    
      <span id="leancloud-site-uv-container" style="display: none">
        总访客数 
        <span id="leancloud-site-uv"></span>
         人
      </span>
    
    

  
</div>

  
  
  
</div>

  </footer>

  <!-- Scripts -->
  
  <script  src="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":100})
    NProgress.start()
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://lib.baomitu.com/jquery/3.6.0/jquery.min.js" ></script>
<script  src="https://lib.baomitu.com/twitter-bootstrap/4.6.1/js/bootstrap.min.js" ></script>
<script  src="/js/events.js" ></script>
<script  src="/js/plugins.js" ></script>


  <script  src="https://lib.baomitu.com/typed.js/2.0.12/typed.min.js" ></script>
  <script>
    (function (window, document) {
      var typing = Fluid.plugins.typing;
      var subtitle = document.getElementById('subtitle');
      if (!subtitle || !typing) {
        return;
      }
      var text = subtitle.getAttribute('data-typed-text');
      
        typing(text);
      
    })(window, document);
  </script>




  
    <script  src="/js/img-lazyload.js" ></script>
  




  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/tocbot/4.18.2/tocbot.min.js', function() {
    var toc = jQuery('#toc');
    if (toc.length === 0 || !window.tocbot) { return; }
    var boardCtn = jQuery('#board-ctn');
    var boardTop = boardCtn.offset().top;

    window.tocbot.init(Object.assign({
      tocSelector     : '#toc-body',
      contentSelector : '.markdown-body',
      linkClass       : 'tocbot-link',
      activeLinkClass : 'tocbot-active-link',
      listClass       : 'tocbot-list',
      isCollapsedClass: 'tocbot-is-collapsed',
      collapsibleClass: 'tocbot-is-collapsible',
      scrollSmooth    : true,
      includeTitleTags: true,
      headingsOffset  : -boardTop,
    }, CONFIG.toc));
    if (toc.find('.toc-list-item').length > 0) {
      toc.css('visibility', 'visible');
    }

    Fluid.events.registerRefreshCallback(function() {
      if ('tocbot' in window) {
        tocbot.refresh();
        var toc = jQuery('#toc');
        if (toc.length === 0 || !tocbot) {
          return;
        }
        if (toc.find('.toc-list-item').length > 0) {
          toc.css('visibility', 'visible');
        }
      }
    });
  });
</script>


  <script  src="https://lib.baomitu.com/prism/1.29.0/plugins/line-numbers/prism-line-numbers.min.js" ></script>

  <script src=https://lib.baomitu.com/clipboard.js/2.0.11/clipboard.min.js></script>

  <script>Fluid.plugins.codeWidget();</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/anchor-js/4.3.1/anchor.min.js', function() {
    window.anchors.options = {
      placement: CONFIG.anchorjs.placement,
      visible  : CONFIG.anchorjs.visible
    };
    if (CONFIG.anchorjs.icon) {
      window.anchors.options.icon = CONFIG.anchorjs.icon;
    }
    var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
    var res = [];
    for (var item of el) {
      res.push('.markdown-body > ' + item.trim());
    }
    if (CONFIG.anchorjs.placement === 'left') {
      window.anchors.options.class = 'anchorjs-link-left';
    }
    window.anchors.add(res.join(', '));

    Fluid.events.registerRefreshCallback(function() {
      if ('anchors' in window) {
        anchors.removeAll();
        var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
        var res = [];
        for (var item of el) {
          res.push('.markdown-body > ' + item.trim());
        }
        if (CONFIG.anchorjs.placement === 'left') {
          anchors.options.class = 'anchorjs-link-left';
        }
        anchors.add(res.join(', '));
      }
    });
  });
</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.js', function() {
    Fluid.plugins.fancyBox();
  });
</script>


  <script>Fluid.plugins.imageCaption();</script>

  <script defer src="/js/leancloud.js" ></script>

  <script  src="/js/local-search.js" ></script>





<!-- 主题的启动项，将它保持在最底部 -->
<!-- the boot of the theme, keep it at the bottom -->
<script  src="/js/boot.js" ></script>


  

  <noscript>
    <div class="noscript-warning">博客在允许 JavaScript 运行的环境下浏览效果更佳</div>
  </noscript>
</body>
</html>
