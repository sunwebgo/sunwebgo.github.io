

<!DOCTYPE html>
<html lang="zh-CN" data-default-color-scheme=light>



<head>
  <meta charset="UTF-8">
  <link rel="apple-touch-icon" sizes="76x76" href="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/hexo/favicon.png">
  <link rel="icon" href="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/hexo/favicon.png">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="author" content="Xu huaiang">
  <meta name="keywords" content="">
  
    <meta name="description" content="1. 最佳左前缀法则在MySQL建立联合索引时会遵守最佳左前缀原则，即最左优先，在检索数据时从联合索引的最左边开始匹配。  MySQL 中的索引最左匹配原则是指，在使用复合索引进行查询时，如果查询条件中包含多个列，那么只有从复合索引的最左边开始的几个列被用到，才能够利用到这个索引。具体来说，MySQL 查询优化器会根据查询条件的匹配度，选择适当的索引来执行查询操作。 例如，假设我们有一个表 use">
<meta property="og:type" content="article">
<meta property="og:title" content="第10章_索引的优化与查询优化">
<meta property="og:url" content="https://xhablog.online/2021/04/23/MySQL%E9%AB%98%E7%BA%A7-%E7%AC%AC10%E7%AB%A0_%E7%B4%A2%E5%BC%95%E7%9A%84%E4%BC%98%E5%8C%96%E4%B8%8E%E6%9F%A5%E8%AF%A2%E4%BC%98%E5%8C%96/index.html">
<meta property="og:site_name" content="xhang′s blog">
<meta property="og:description" content="1. 最佳左前缀法则在MySQL建立联合索引时会遵守最佳左前缀原则，即最左优先，在检索数据时从联合索引的最左边开始匹配。  MySQL 中的索引最左匹配原则是指，在使用复合索引进行查询时，如果查询条件中包含多个列，那么只有从复合索引的最左边开始的几个列被用到，才能够利用到这个索引。具体来说，MySQL 查询优化器会根据查询条件的匹配度，选择适当的索引来执行查询操作。 例如，假设我们有一个表 use">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/hexo/image-20230412151501213.png">
<meta property="article:published_time" content="2021-04-23T08:00:00.000Z">
<meta property="article:modified_time" content="2023-08-15T18:16:40.477Z">
<meta property="article:author" content="Xu huaiang">
<meta property="article:tag" content="MySQL">
<meta property="article:tag" content="数据库">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image" content="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/hexo/image-20230412151501213.png">
  
  
  
  <title>第10章_索引的优化与查询优化 - xhang′s blog</title>

  <link  rel="stylesheet" href="https://lib.baomitu.com/twitter-bootstrap/4.6.1/css/bootstrap.min.css" />



  <link  rel="stylesheet" href="https://lib.baomitu.com/github-markdown-css/4.0.0/github-markdown.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/hint.css/2.7.0/hint.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/prism/1.29.0/plugins/line-numbers/prism-line-numbers.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.css" />



<!-- 主题依赖的图标库，不要自行修改 -->
<!-- Do not modify the link that theme dependent icons -->

<link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_hj8rtnfg7um.css">



<link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_lbnruvf0jn.css">


<link  rel="stylesheet" href="/css/main.css" />


  <link id="highlight-css" rel="stylesheet" href="/css/highlight.css" />
  
    <link id="highlight-css-dark" rel="stylesheet" href="/css/highlight-dark.css" />
  



  
<link rel="stylesheet" href="/css/macpanel.css">
<link rel="stylesheet" href="/css/iconfont.css">
<link rel="stylesheet" href="/css/indeximg-hover.css">



  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    Fluid.ctx = Object.assign({}, Fluid.ctx)
    var CONFIG = {"hostname":"xhablog.online","root":"/","version":"1.9.4","typing":{"enable":true,"typeSpeed":70,"cursorChar":"_","loop":false,"scope":[]},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"left","visible":"hover","icon":""},"progressbar":{"enable":true,"height_px":3,"color":"#29d","options":{"showSpinner":false,"trickleSpeed":100}},"code_language":{"enable":true,"default":"TEXT"},"copy_btn":true,"image_caption":{"enable":true},"image_zoom":{"enable":true,"img_url_replace":["",""]},"toc":{"enable":true,"placement":"right","headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":0},"lazyload":{"enable":true,"loading_img":"/img/loading.gif","onlypost":false,"offset_factor":2},"web_analytics":{"enable":true,"follow_dnt":true,"baidu":null,"google":null,"gtag":null,"tencent":{"sid":null,"cid":null},"woyaola":null,"cnzz":null,"leancloud":{"app_id":"giycfQfOF4KRyAqEJy6tocBG-gzGzoHsz","app_key":"eFPJSGrHpiDV2uq6UTxse15b","server_url":"https://giycfqfo.lc-cn-n1-shared.com","path":"window.location.pathname","ignore_local":false}},"search_path":"/local-search.xml"};

    if (CONFIG.web_analytics.follow_dnt) {
      var dntVal = navigator.doNotTrack || window.doNotTrack || navigator.msDoNotTrack;
      Fluid.ctx.dnt = dntVal && (dntVal.startsWith('1') || dntVal.startsWith('yes') || dntVal.startsWith('on'));
    }
  </script>
  <script  src="/js/utils.js" ></script>
  <script  src="/js/color-schema.js" ></script>
  

  

  

  

  

  

  

  
    
  



  
<meta name="generator" content="Hexo 6.3.0"></head>


<body>
  

  <header>
    

<div class="header-inner" style="height: 70vh;">
  <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand" href="/">
      <strong>xhang′s blog</strong>
    </a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/">
                <i class="iconfont icon-zhuye"></i>
                <span>首页</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/">
                <i class="iconfont icon-guidang1"></i>
                <span>归档</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/categories/">
                <i class="iconfont icon-fenlei"></i>
                <span>分类</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/tags/">
                <i class="iconfont icon-biaoqian"></i>
                <span>标签</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/messageboard/">
                <i class="iconfont icon-liuyanban-05"></i>
                <span>留言板</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/links/">
                <i class="iconfont icon-youqinglianjie"></i>
                <span>友链</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/">
                <i class="iconfont icon-guanyuwomen"></i>
                <span>关于</span>
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search">
              <i class="iconfont icon-search"></i>
            </a>
          </li>
          
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" target="_self" href="javascript:;" aria-label="Color Toggle">
              <i class="iconfont icon-dark" id="color-toggle-icon"></i>
            </a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

  

<div id="banner" class="banner" parallax=true
     style="background: url('https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/hexo/index.png') no-repeat center center; background-size: cover;">
  <div class="full-bg-img">
    <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
      <div class="banner-text text-center fade-in-up">
        <div class="h2">
          
            <span id="subtitle" data-typed-text="第10章_索引的优化与查询优化"></span>
          
        </div>

        
          
  <div class="mt-3">
    
      <span class="post-meta mr-2">
        <i class="iconfont icon-author" aria-hidden="true"></i>
        Xu huaiang
      </span>
    
    
      <span class="post-meta">
        <i class="iconfont icon-date-fill" aria-hidden="true"></i>
        <time datetime="2021-04-23 16:00" pubdate>
          2021年4月23日 下午
        </time>
      </span>
    
  </div>

  <div class="mt-1">
    
      <span class="post-meta mr-2">
        <i class="iconfont icon-chart"></i>
        
          25k 字
        
      </span>
    

    
      <span class="post-meta mr-2">
        <i class="iconfont icon-clock-fill"></i>
        
        
        
          206 分钟
        
      </span>
    

    
    
      
        <span id="leancloud-page-views-container" class="post-meta" style="display: none">
          <i class="iconfont icon-eye" aria-hidden="true"></i>
          <span id="leancloud-page-views"></span> 次
        </span>
        
      
    
  </div>


        
      </div>

      
    </div>
  </div>
</div>

</div>

  </header>

  <main>
    
      

<div class="container-fluid nopadding-x">
  <div class="row nomargin-x">
    <div class="side-col d-none d-lg-block col-lg-2">
      

    </div>

    <div class="col-lg-8 nopadding-x-md">
      <div class="container nopadding-x-md" id="board-ctn">
        <div id="board">
          <article class="post-content mx-auto">
            <!-- SEO header -->
            <h1 style="display: none">第10章_索引的优化与查询优化</h1>
            
            
              <div class="markdown-body">
                
                <h2 id="1-最佳左前缀法则"><a href="#1-最佳左前缀法则" class="headerlink" title="1. 最佳左前缀法则"></a>1. 最佳左前缀法则</h2><p><strong><font color='scarlet'>在MySQL建立联合索引时会遵守最佳左前缀原则，即最左优先，在检索数据时从联合索引的最左边开始匹配。</font></strong></p>
<blockquote>
<p>MySQL 中的索引最左匹配原则是指，在使用复合索引进行查询时，如果查询条件中包含多个列，那么只有从复合索引的最左边开始的几个列被用到，才能够利用到这个索引。具体来说，MySQL 查询优化器会根据查询条件的匹配度，选择适当的索引来执行查询操作。</p>
<p>例如，假设我们有一个表 <code>user</code>，该表包含三个列：<code>id</code>、<code>name</code> 和 <code>age</code>。现在我们创建了一个复合索引，包含两个列：<code>(name, age)</code>。那么，如果我们执行如下查询语句：</p>
<figure><div class="code-wrapper"><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> <span class="token keyword">user</span> <span class="token keyword">WHERE</span> name <span class="token operator">=</span> <span class="token string">'John'</span> <span class="token operator">AND</span> age <span class="token operator">=</span> <span class="token number">25</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></div></figure>

<p>由于查询语句中涉及的列和复合索引的前两个列一致，因此 MySQL 查询优化器可以利用这个复合索引，快速定位匹配的数据行，而不需要全表扫描。然而，如果我们将查询条件中的列顺序调换一下，变成：</p>
<figure><div class="code-wrapper"><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> <span class="token keyword">user</span> <span class="token keyword">WHERE</span> age <span class="token operator">=</span> <span class="token number">25</span> <span class="token operator">AND</span> name <span class="token operator">=</span> <span class="token string">'John'</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></div></figure>

<p>虽然查询条件仍然相同，但由于 <code>age</code> 不是复合索引的左侧列，因此 MySQL 查询优化器无法利用这个索引，而是需要进行全表扫描来查找匹配的数据行，效率自然大大降低。</p>
<p>因此，在设计和使用索引时，需要尽量遵循最左匹配原则，将最常用、最具区分度的列放在复合索引的左侧，以提高索引的利用率和查询性能。同时，也需要注意查询条件的顺序和列的数据类型等因素对索引的影响，以优化查询语句的性能。</p>
</blockquote>
<p>删除前两个索引，测试联合索引</p>
<figure><div class="code-wrapper"><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">alter</span> <span class="token keyword">table</span> student <span class="token keyword">drop</span> <span class="token keyword">index</span> idx_age<span class="token punctuation">;</span>
<span class="token keyword">alter</span> <span class="token keyword">table</span> student <span class="token keyword">drop</span> <span class="token keyword">index</span> idx_age_classId<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre></div></figure>

<p>举例1：</p>
<blockquote>
<p>最左前缀匹配原则只满足age，所以只是用了部分索引</p>
<figure><div class="code-wrapper"><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">EXPLAIN</span> <span class="token keyword">SELECT</span> SQL_NO_CACHE <span class="token operator">*</span> <span class="token keyword">FROM</span> student <span class="token keyword">WHERE</span> student<span class="token punctuation">.</span>age<span class="token operator">=</span><span class="token number">30</span> <span class="token operator">AND</span> student<span class="token punctuation">.</span>name <span class="token operator">=</span> <span class="token string">'abcd'</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></div></figure>

<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20230513112554231.png" srcset="/img/loading.gif" lazyload alt="image-20230513112554231"></p>
</blockquote>
<p>举例2：</p>
<blockquote>
<p>最左匹配原则失效，MySQL查询优化器不使用索引。</p>
<figure><div class="code-wrapper"><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">EXPLAIN</span> <span class="token keyword">SELECT</span> SQL_NO_CACHE <span class="token operator">*</span> <span class="token keyword">FROM</span> student <span class="token keyword">WHERE</span> student<span class="token punctuation">.</span>classId<span class="token operator">=</span><span class="token number">1</span> <span class="token operator">AND</span> student<span class="token punctuation">.</span>name <span class="token operator">=</span> <span class="token string">'abcd'</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></div></figure>

<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20230513113152109.png" srcset="/img/loading.gif" lazyload alt="image-20230513113152109"></p>
</blockquote>
<p>​	举例3：</p>
<blockquote>
<p>全匹配</p>
<figure><div class="code-wrapper"><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">EXPLAIN</span> <span class="token keyword">SELECT</span> SQL_NO_CACHE <span class="token operator">*</span> <span class="token keyword">FROM</span> student <span class="token keyword">WHERE</span> student<span class="token punctuation">.</span>age<span class="token operator">=</span><span class="token number">30</span> <span class="token operator">AND</span> student<span class="token punctuation">.</span>classId<span class="token operator">=</span><span class="token number">4</span> <span class="token operator">AND</span> student<span class="token punctuation">.</span>name <span class="token operator">=</span> <span class="token string">'abcd'</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></div></figure>

<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20230513115203068.png" srcset="/img/loading.gif" lazyload alt="image-20230513115203068"></p>
</blockquote>
<p>举例4：</p>
<blockquote>
<p>以下sql，索引<code>idx_age_classid_name</code>还能否正常使用？</p>
<figure><div class="code-wrapper"><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">EXPLAIN</span> <span class="token keyword">SELECT</span> SQL_NO_CACHE <span class="token operator">*</span> <span class="token keyword">FROM</span> student <span class="token keyword">WHERE</span> student<span class="token punctuation">.</span>classId<span class="token operator">=</span><span class="token number">4</span> <span class="token operator">AND</span> student<span class="token punctuation">.</span>name <span class="token operator">=</span> <span class="token string">'abcd'</span> <span class="token operator">AND</span> student<span class="token punctuation">.</span>age<span class="token operator">=</span><span class="token number">30</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></div></figure>

<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20230419204031587.png" srcset="/img/loading.gif" lazyload alt="image-20230419204031587"></p>
<p>上述原因如下：</p>
<p><font color='cornflowerblue'><strong>在使用复合索引时，MySQL 通常只能从索引的最左侧列开始匹配查询条件，即要求满足最左前缀匹配原则。但是如果查询条件中涉及到复合索引中所有的列，MySQL 可以直接利用索引进行查询，而无需满足最左前缀匹配原则。</strong></font></p>
<p><strong><font color='orange'>MySQL 查询优化器可以根据查询条件中涉及到的列和索引的定义，自动决定使用哪个索引来执行查询，并且&#x3D;&#x3D;可以对查询条件的顺序进行重新排序，以最大程度地利用索引进行查询。&#x3D;&#x3D;这个过程称为查询优化。</font></strong></p>
</blockquote>
<p>结论：MySQL可以为多个字段创建索引，一个索引可以包含16个字段。对于多列索引，**<font color='scarlet'>过滤条件要使用索引必须按照索引建立时的顺序，依次满足，一旦跳过某个字段，索引后面的字段都无法被使用。如果查询条件中没有用这些字段中第一个字段时，多列（或联合）索引不会被使用</font>。如果查询条件涉及到复合索引的所有列，但是顺序不同，为了更大程度的使用索引，MySQL查询优化器会对查询字段顺寻重新排序。**</p>
<blockquote>
<p>拓展：Alibaba《Java开发手册》</p>
<p>索引文件具有 B-Tree 的最左前缀匹配特性，如果左边的值未确定，那么无法使用此索引。</p>
</blockquote>
<h2 id="2-索引失效场景和原因"><a href="#2-索引失效场景和原因" class="headerlink" title="2. 索引失效场景和原因"></a>2. 索引失效场景和原因</h2><p>记忆口诀：模型数OR运最快</p>
<blockquote>
<ol>
<li><strong>模糊查询</strong> <code>LIKE</code> 以 <code>%</code> 开头。<strong>因为值无法确定。</strong></li>
<li><strong>数据类型错误</strong>：如果查询条件中的数据类型与索引列的数据类型不匹配，则索引可能会失效。这是因为MySQL的索引是基于字段的类型来创建的，如果查询条件中的数据类型与索引列的数据类型不匹配，那么MySQL就无法使用索引来优化查询。</li>
<li><strong>对索引字段使用内部函数</strong>：如果在查询条件中对索引字段使用了内部函数（例如 <code>LENGTH(name)</code>），则索引可能会失效。这是因为内部函数会改变数据的值，使得MySQL无法使用索引来优化查询。</li>
<li><strong>OR 前后存在非索引的列</strong>：比如如果在OR前的条件列进行了索引，而在OR后的条件列没有进行索引，那么索引会失效。因为 MySQL 无法确定哪个条件会被满足，所以只能进行全表扫描。</li>
<li><strong>索引列进行运算</strong>：如果在查询条件中对索引列进行了四则运算，则索引可能会失效。这是因为四则运算会改变数据的值，使得MySQL无法使用索引来优化查询。</li>
<li><strong>复合索引不按最左匹配原则查找</strong>：如果在复合索引中，查询条件不满足最左原则，则索引可能会失效。这是因为MySQL在使用复合索引时，必须按照最左原则进行查找，否则无法使用索引来优化查询。</li>
<li><strong>全表查找预计比索引更快</strong>：在某些情况下，MySQL可能会判断全表查找比使用索引更快。这通常发生在表中数据量较小或者查询条件过于复杂时。在这种情况下，MySQL会选择全表查找而不是使用索引来优化查询。</li>
</ol>
</blockquote>
<p><strong>练习：</strong>有以下索引：**index(a,b,c)**，判断下列场景索引的使用情况。</p>
<table>
<thead>
<tr>
<th>Where语句</th>
<th>索引是否被使用</th>
</tr>
</thead>
<tbody><tr>
<td><code>where a = 3</code></td>
<td>能够使用索引，使用a</td>
</tr>
<tr>
<td><code>where a = 3 and b = 5</code></td>
<td>能够使用索引，使用a、b</td>
</tr>
<tr>
<td><code>where a = 3 and b = 5 and c = 4</code></td>
<td>能够使用索引，使用a、b、c</td>
</tr>
<tr>
<td><code>where b = 3 或者 where b = 3 and c = 4 或者 where c = 4</code></td>
<td>根据最左前缀匹配原则，不能使用索引</td>
</tr>
<tr>
<td><code>where a =3 and c = 5</code></td>
<td>能够使用索引，使用a</td>
</tr>
<tr>
<td><code>where a = 3 and b &gt; 4 and c =5</code></td>
<td>能够使用索引，使用a、b，c不能使用，因为范围右侧索引失效</td>
</tr>
<tr>
<td><code>where a  is null and b is not null</code></td>
<td>能够使用索引，使用a</td>
</tr>
<tr>
<td><code>where a  &lt;&gt; 3</code></td>
<td>不能够使用索引</td>
</tr>
<tr>
<td><code>where a = 3 and b like &#39;kk%&#39; and c = 4</code></td>
<td>能够使用索引，使用a、b、c</td>
</tr>
<tr>
<td><code>where a = 3 and b like &#39;%kk&#39; and c = 4</code></td>
<td>能够使用索引，使用a</td>
</tr>
<tr>
<td><code>where a = 3 and b like &#39;%kk%&#39; and c = 4</code></td>
<td>能够使用索引，使用a</td>
</tr>
<tr>
<td><code>where a = 3 and b like &#39;k%kk%&#39; and c = 4</code></td>
<td>能够使用索引，使用a、b、c</td>
</tr>
</tbody></table>
<p><strong>一般性建议</strong></p>
<blockquote>
<ul>
<li>对于单列索引，尽量选择针对当前query过滤性更好的索引</li>
<li>在选择组合索引的时候，当前query中过滤性最好的字段在索引字段顺序中，位置越靠前越好。</li>
<li>在选择组合索引的时候，尽量选择能够当前query中where子句中更多的索引。</li>
<li>在选择组合索引的时候，如果某个字段可能出现范围查询时，尽量把这个字段放在索引次序的最后面。</li>
</ul>
</blockquote>
<p><strong>总之，书写SQL语句时，尽量避免造成索引失效的情况</strong></p>
<h2 id="3-关联查询优化"><a href="#3-关联查询优化" class="headerlink" title="3. 关联查询优化"></a>3. 关联查询优化</h2><h3 id="3-1-数据准备"><a href="#3-1-数据准备" class="headerlink" title="3.1 数据准备"></a>3.1 数据准备</h3><figure><div class="code-wrapper"><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token comment"># 分类</span>
<span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token keyword">IF</span> <span class="token operator">NOT</span> <span class="token keyword">EXISTS</span> <span class="token identifier"><span class="token punctuation">`</span>type<span class="token punctuation">`</span></span> <span class="token punctuation">(</span>
<span class="token identifier"><span class="token punctuation">`</span>id<span class="token punctuation">`</span></span> <span class="token keyword">INT</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span> <span class="token keyword">UNSIGNED</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">AUTO_INCREMENT</span><span class="token punctuation">,</span>
<span class="token identifier"><span class="token punctuation">`</span>card<span class="token punctuation">`</span></span> <span class="token keyword">INT</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span> <span class="token keyword">UNSIGNED</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
<span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token punctuation">(</span><span class="token identifier"><span class="token punctuation">`</span>id<span class="token punctuation">`</span></span><span class="token punctuation">)</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">#图书</span>
<span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token keyword">IF</span> <span class="token operator">NOT</span> <span class="token keyword">EXISTS</span> <span class="token identifier"><span class="token punctuation">`</span>book<span class="token punctuation">`</span></span> <span class="token punctuation">(</span>
<span class="token identifier"><span class="token punctuation">`</span>bookid<span class="token punctuation">`</span></span> <span class="token keyword">INT</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span> <span class="token keyword">UNSIGNED</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">AUTO_INCREMENT</span><span class="token punctuation">,</span>
<span class="token identifier"><span class="token punctuation">`</span>card<span class="token punctuation">`</span></span> <span class="token keyword">INT</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span> <span class="token keyword">UNSIGNED</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
<span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token punctuation">(</span><span class="token identifier"><span class="token punctuation">`</span>bookid<span class="token punctuation">`</span></span><span class="token punctuation">)</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">#向分类表中添加20条记录</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> <span class="token identifier"><span class="token punctuation">`</span>type<span class="token punctuation">`</span></span><span class="token punctuation">(</span>card<span class="token punctuation">)</span> <span class="token keyword">VALUES</span><span class="token punctuation">(</span>FLOOR<span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">+</span> <span class="token punctuation">(</span>RAND<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> <span class="token identifier"><span class="token punctuation">`</span>type<span class="token punctuation">`</span></span><span class="token punctuation">(</span>card<span class="token punctuation">)</span> <span class="token keyword">VALUES</span><span class="token punctuation">(</span>FLOOR<span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">+</span> <span class="token punctuation">(</span>RAND<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> <span class="token identifier"><span class="token punctuation">`</span>type<span class="token punctuation">`</span></span><span class="token punctuation">(</span>card<span class="token punctuation">)</span> <span class="token keyword">VALUES</span><span class="token punctuation">(</span>FLOOR<span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">+</span> <span class="token punctuation">(</span>RAND<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> <span class="token identifier"><span class="token punctuation">`</span>type<span class="token punctuation">`</span></span><span class="token punctuation">(</span>card<span class="token punctuation">)</span> <span class="token keyword">VALUES</span><span class="token punctuation">(</span>FLOOR<span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">+</span> <span class="token punctuation">(</span>RAND<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> <span class="token identifier"><span class="token punctuation">`</span>type<span class="token punctuation">`</span></span><span class="token punctuation">(</span>card<span class="token punctuation">)</span> <span class="token keyword">VALUES</span><span class="token punctuation">(</span>FLOOR<span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">+</span> <span class="token punctuation">(</span>RAND<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> <span class="token identifier"><span class="token punctuation">`</span>type<span class="token punctuation">`</span></span><span class="token punctuation">(</span>card<span class="token punctuation">)</span> <span class="token keyword">VALUES</span><span class="token punctuation">(</span>FLOOR<span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">+</span> <span class="token punctuation">(</span>RAND<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> <span class="token identifier"><span class="token punctuation">`</span>type<span class="token punctuation">`</span></span><span class="token punctuation">(</span>card<span class="token punctuation">)</span> <span class="token keyword">VALUES</span><span class="token punctuation">(</span>FLOOR<span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">+</span> <span class="token punctuation">(</span>RAND<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> <span class="token identifier"><span class="token punctuation">`</span>type<span class="token punctuation">`</span></span><span class="token punctuation">(</span>card<span class="token punctuation">)</span> <span class="token keyword">VALUES</span><span class="token punctuation">(</span>FLOOR<span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">+</span> <span class="token punctuation">(</span>RAND<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> <span class="token identifier"><span class="token punctuation">`</span>type<span class="token punctuation">`</span></span><span class="token punctuation">(</span>card<span class="token punctuation">)</span> <span class="token keyword">VALUES</span><span class="token punctuation">(</span>FLOOR<span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">+</span> <span class="token punctuation">(</span>RAND<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> <span class="token identifier"><span class="token punctuation">`</span>type<span class="token punctuation">`</span></span><span class="token punctuation">(</span>card<span class="token punctuation">)</span> <span class="token keyword">VALUES</span><span class="token punctuation">(</span>FLOOR<span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">+</span> <span class="token punctuation">(</span>RAND<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> <span class="token identifier"><span class="token punctuation">`</span>type<span class="token punctuation">`</span></span><span class="token punctuation">(</span>card<span class="token punctuation">)</span> <span class="token keyword">VALUES</span><span class="token punctuation">(</span>FLOOR<span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">+</span> <span class="token punctuation">(</span>RAND<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> <span class="token identifier"><span class="token punctuation">`</span>type<span class="token punctuation">`</span></span><span class="token punctuation">(</span>card<span class="token punctuation">)</span> <span class="token keyword">VALUES</span><span class="token punctuation">(</span>FLOOR<span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">+</span> <span class="token punctuation">(</span>RAND<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> <span class="token identifier"><span class="token punctuation">`</span>type<span class="token punctuation">`</span></span><span class="token punctuation">(</span>card<span class="token punctuation">)</span> <span class="token keyword">VALUES</span><span class="token punctuation">(</span>FLOOR<span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">+</span> <span class="token punctuation">(</span>RAND<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> <span class="token identifier"><span class="token punctuation">`</span>type<span class="token punctuation">`</span></span><span class="token punctuation">(</span>card<span class="token punctuation">)</span> <span class="token keyword">VALUES</span><span class="token punctuation">(</span>FLOOR<span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">+</span> <span class="token punctuation">(</span>RAND<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> <span class="token identifier"><span class="token punctuation">`</span>type<span class="token punctuation">`</span></span><span class="token punctuation">(</span>card<span class="token punctuation">)</span> <span class="token keyword">VALUES</span><span class="token punctuation">(</span>FLOOR<span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">+</span> <span class="token punctuation">(</span>RAND<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> <span class="token identifier"><span class="token punctuation">`</span>type<span class="token punctuation">`</span></span><span class="token punctuation">(</span>card<span class="token punctuation">)</span> <span class="token keyword">VALUES</span><span class="token punctuation">(</span>FLOOR<span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">+</span> <span class="token punctuation">(</span>RAND<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> <span class="token identifier"><span class="token punctuation">`</span>type<span class="token punctuation">`</span></span><span class="token punctuation">(</span>card<span class="token punctuation">)</span> <span class="token keyword">VALUES</span><span class="token punctuation">(</span>FLOOR<span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">+</span> <span class="token punctuation">(</span>RAND<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> <span class="token identifier"><span class="token punctuation">`</span>type<span class="token punctuation">`</span></span><span class="token punctuation">(</span>card<span class="token punctuation">)</span> <span class="token keyword">VALUES</span><span class="token punctuation">(</span>FLOOR<span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">+</span> <span class="token punctuation">(</span>RAND<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> <span class="token identifier"><span class="token punctuation">`</span>type<span class="token punctuation">`</span></span><span class="token punctuation">(</span>card<span class="token punctuation">)</span> <span class="token keyword">VALUES</span><span class="token punctuation">(</span>FLOOR<span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">+</span> <span class="token punctuation">(</span>RAND<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> <span class="token identifier"><span class="token punctuation">`</span>type<span class="token punctuation">`</span></span><span class="token punctuation">(</span>card<span class="token punctuation">)</span> <span class="token keyword">VALUES</span><span class="token punctuation">(</span>FLOOR<span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">+</span> <span class="token punctuation">(</span>RAND<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">#向图书表中添加20条记录</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> book<span class="token punctuation">(</span>card<span class="token punctuation">)</span> <span class="token keyword">VALUES</span><span class="token punctuation">(</span>FLOOR<span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">+</span> <span class="token punctuation">(</span>RAND<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> book<span class="token punctuation">(</span>card<span class="token punctuation">)</span> <span class="token keyword">VALUES</span><span class="token punctuation">(</span>FLOOR<span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">+</span> <span class="token punctuation">(</span>RAND<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> book<span class="token punctuation">(</span>card<span class="token punctuation">)</span> <span class="token keyword">VALUES</span><span class="token punctuation">(</span>FLOOR<span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">+</span> <span class="token punctuation">(</span>RAND<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> book<span class="token punctuation">(</span>card<span class="token punctuation">)</span> <span class="token keyword">VALUES</span><span class="token punctuation">(</span>FLOOR<span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">+</span> <span class="token punctuation">(</span>RAND<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> book<span class="token punctuation">(</span>card<span class="token punctuation">)</span> <span class="token keyword">VALUES</span><span class="token punctuation">(</span>FLOOR<span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">+</span> <span class="token punctuation">(</span>RAND<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> book<span class="token punctuation">(</span>card<span class="token punctuation">)</span> <span class="token keyword">VALUES</span><span class="token punctuation">(</span>FLOOR<span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">+</span> <span class="token punctuation">(</span>RAND<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> book<span class="token punctuation">(</span>card<span class="token punctuation">)</span> <span class="token keyword">VALUES</span><span class="token punctuation">(</span>FLOOR<span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">+</span> <span class="token punctuation">(</span>RAND<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> book<span class="token punctuation">(</span>card<span class="token punctuation">)</span> <span class="token keyword">VALUES</span><span class="token punctuation">(</span>FLOOR<span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">+</span> <span class="token punctuation">(</span>RAND<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> book<span class="token punctuation">(</span>card<span class="token punctuation">)</span> <span class="token keyword">VALUES</span><span class="token punctuation">(</span>FLOOR<span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">+</span> <span class="token punctuation">(</span>RAND<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> book<span class="token punctuation">(</span>card<span class="token punctuation">)</span> <span class="token keyword">VALUES</span><span class="token punctuation">(</span>FLOOR<span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">+</span> <span class="token punctuation">(</span>RAND<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> book<span class="token punctuation">(</span>card<span class="token punctuation">)</span> <span class="token keyword">VALUES</span><span class="token punctuation">(</span>FLOOR<span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">+</span> <span class="token punctuation">(</span>RAND<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> book<span class="token punctuation">(</span>card<span class="token punctuation">)</span> <span class="token keyword">VALUES</span><span class="token punctuation">(</span>FLOOR<span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">+</span> <span class="token punctuation">(</span>RAND<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> book<span class="token punctuation">(</span>card<span class="token punctuation">)</span> <span class="token keyword">VALUES</span><span class="token punctuation">(</span>FLOOR<span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">+</span> <span class="token punctuation">(</span>RAND<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> book<span class="token punctuation">(</span>card<span class="token punctuation">)</span> <span class="token keyword">VALUES</span><span class="token punctuation">(</span>FLOOR<span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">+</span> <span class="token punctuation">(</span>RAND<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> book<span class="token punctuation">(</span>card<span class="token punctuation">)</span> <span class="token keyword">VALUES</span><span class="token punctuation">(</span>FLOOR<span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">+</span> <span class="token punctuation">(</span>RAND<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> book<span class="token punctuation">(</span>card<span class="token punctuation">)</span> <span class="token keyword">VALUES</span><span class="token punctuation">(</span>FLOOR<span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">+</span> <span class="token punctuation">(</span>RAND<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> book<span class="token punctuation">(</span>card<span class="token punctuation">)</span> <span class="token keyword">VALUES</span><span class="token punctuation">(</span>FLOOR<span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">+</span> <span class="token punctuation">(</span>RAND<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> book<span class="token punctuation">(</span>card<span class="token punctuation">)</span> <span class="token keyword">VALUES</span><span class="token punctuation">(</span>FLOOR<span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">+</span> <span class="token punctuation">(</span>RAND<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> book<span class="token punctuation">(</span>card<span class="token punctuation">)</span> <span class="token keyword">VALUES</span><span class="token punctuation">(</span>FLOOR<span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">+</span> <span class="token punctuation">(</span>RAND<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> book<span class="token punctuation">(</span>card<span class="token punctuation">)</span> <span class="token keyword">VALUES</span><span class="token punctuation">(</span>FLOOR<span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">+</span> <span class="token punctuation">(</span>RAND<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure>

<h3 id="3-2-左外连接索引优化"><a href="#3-2-左外连接索引优化" class="headerlink" title="3.2 左外连接索引优化"></a>3.2 左外连接索引优化</h3><p>下面开始 EXPLAIN 分析</p>
<figure><div class="code-wrapper"><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">EXPLAIN</span> <span class="token keyword">SELECT</span> SQL_NO_CACHE <span class="token operator">*</span> <span class="token keyword">FROM</span> <span class="token identifier"><span class="token punctuation">`</span>type<span class="token punctuation">`</span></span> <span class="token keyword">LEFT</span> <span class="token keyword">JOIN</span> book <span class="token keyword">ON</span> <span class="token keyword">type</span><span class="token punctuation">.</span>card <span class="token operator">=</span> book<span class="token punctuation">.</span>card<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></div></figure>

<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20230514094648908.png" srcset="/img/loading.gif" lazyload alt="image-20230514094648908"></p>
<p>结论：**<font color='red'>type 为All，使用全表扫描。</font>**</p>
<p>添加索引优化</p>
<figure><div class="code-wrapper"><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">ALTER</span> <span class="token keyword">TABLE</span> book <span class="token keyword">ADD</span> <span class="token keyword">INDEX</span> Y <span class="token punctuation">(</span> card<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">#【被驱动表】，可以避免全表扫描</span>
<span class="token keyword">EXPLAIN</span> <span class="token keyword">SELECT</span> SQL_NO_CACHE <span class="token operator">*</span> <span class="token keyword">FROM</span> <span class="token identifier"><span class="token punctuation">`</span>type<span class="token punctuation">`</span></span> <span class="token keyword">LEFT</span> <span class="token keyword">JOIN</span> book <span class="token keyword">ON</span> <span class="token keyword">type</span><span class="token punctuation">.</span>card <span class="token operator">=</span> book<span class="token punctuation">.</span>card<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre></div></figure>

<p>可以看到第二行的 type 变为了 ref，rows 也变成了优化比较明显。这是由左连接特性决定的。LEFT JOIN 条件用于确定如何从右表搜索行，左边一定都有，所以 <code>右边是我们的关键点,一定需要建立索引</code> 。</p>
<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20230514094832230.png" srcset="/img/loading.gif" lazyload alt="image-20230514094832230"></p>
<p>为驱动表添加索引：</p>
<figure><div class="code-wrapper"><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">ALTER</span> <span class="token keyword">TABLE</span> <span class="token identifier"><span class="token punctuation">`</span>type<span class="token punctuation">`</span></span> <span class="token keyword">ADD</span> <span class="token keyword">INDEX</span> X <span class="token punctuation">(</span>card<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">#【驱动表】，无法避免全表扫描</span>
<span class="token keyword">EXPLAIN</span> <span class="token keyword">SELECT</span> SQL_NO_CACHE <span class="token operator">*</span> <span class="token keyword">FROM</span> <span class="token identifier"><span class="token punctuation">`</span>type<span class="token punctuation">`</span></span> <span class="token keyword">LEFT</span> <span class="token keyword">JOIN</span> book <span class="token keyword">ON</span> <span class="token keyword">type</span><span class="token punctuation">.</span>card <span class="token operator">=</span> book<span class="token punctuation">.</span>card<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre></div></figure>

<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20230514095117260.png" srcset="/img/loading.gif" lazyload alt="image-20230514095117260"></p>
<p>接着删除被驱动表的索引：</p>
<figure><div class="code-wrapper"><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">DROP</span> <span class="token keyword">INDEX</span> Y <span class="token keyword">ON</span> book<span class="token punctuation">;</span>
<span class="token keyword">EXPLAIN</span> <span class="token keyword">SELECT</span> SQL_NO_CACHE <span class="token operator">*</span> <span class="token keyword">FROM</span> <span class="token identifier"><span class="token punctuation">`</span>type<span class="token punctuation">`</span></span> <span class="token keyword">LEFT</span> <span class="token keyword">JOIN</span> book <span class="token keyword">ON</span> <span class="token keyword">type</span><span class="token punctuation">.</span>card <span class="token operator">=</span> book<span class="token punctuation">.</span>card<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre></div></figure>

<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20230514095247148.png" srcset="/img/loading.gif" lazyload alt="image-20230514095247148"></p>
<h3 id="3-3-内连接索引优化"><a href="#3-3-内连接索引优化" class="headerlink" title="3.3 内连接索引优化"></a>3.3 内连接索引优化</h3><p><font color='cornflowerblue'>如果两张表进行内连接，并且只有其中一张表的连接字段上存在索引，那么该表通常会被作为被驱动表。</font></p>
<p><font color='red'>被驱动表是指在执行查询时，MySQL 选择使用它上面的索引来定位和过滤数据行，而不是通过全表扫描来查找数据。由于索引可以极大地提高数据访问速度，因此将被驱动表设置为具有索引的表，可以提高查询性能。</font></p>
<figure><div class="code-wrapper"><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">drop</span> <span class="token keyword">index</span> X <span class="token keyword">on</span> <span class="token keyword">type</span><span class="token punctuation">;</span>
<span class="token keyword">drop</span> <span class="token keyword">index</span> Y <span class="token keyword">on</span> book<span class="token punctuation">;</span>（如果已经删除了可以不用再执行该操作）<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre></div></figure>

<p>换成 inner join（MySQL自动选择驱动表）</p>
<figure><div class="code-wrapper"><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">EXPLAIN</span> <span class="token keyword">SELECT</span> SQL_NO_CACHE <span class="token operator">*</span> <span class="token keyword">FROM</span> <span class="token keyword">type</span> <span class="token keyword">INNER</span> <span class="token keyword">JOIN</span> book <span class="token keyword">ON</span> <span class="token keyword">type</span><span class="token punctuation">.</span>card<span class="token operator">=</span>book<span class="token punctuation">.</span>card<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></div></figure>

<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20230420091132282.png" srcset="/img/loading.gif" lazyload alt="image-20230420091132282"></p>
<p>为被驱动表添加索引优化</p>
<figure><div class="code-wrapper"><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">ALTER</span> <span class="token keyword">TABLE</span> book <span class="token keyword">ADD</span> <span class="token keyword">INDEX</span> Y <span class="token punctuation">(</span>card<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">EXPLAIN</span> <span class="token keyword">SELECT</span> SQL_NO_CACHE <span class="token operator">*</span> <span class="token keyword">FROM</span> <span class="token keyword">type</span> <span class="token keyword">INNER</span> <span class="token keyword">JOIN</span> book <span class="token keyword">ON</span> <span class="token keyword">type</span><span class="token punctuation">.</span>card<span class="token operator">=</span>book<span class="token punctuation">.</span>card<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre></div></figure>

<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20230420091210297.png" srcset="/img/loading.gif" lazyload alt="image-20230420091210297"></p>
<p>为驱动表添加索引</p>
<figure><div class="code-wrapper"><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">ALTER</span> <span class="token keyword">TABLE</span> <span class="token keyword">type</span> <span class="token keyword">ADD</span> <span class="token keyword">INDEX</span> X <span class="token punctuation">(</span>card<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">EXPLAIN</span> <span class="token keyword">SELECT</span> SQL_NO_CACHE <span class="token operator">*</span> <span class="token keyword">FROM</span> <span class="token keyword">type</span> <span class="token keyword">INNER</span> <span class="token keyword">JOIN</span> book <span class="token keyword">ON</span> <span class="token keyword">type</span><span class="token punctuation">.</span>card<span class="token operator">=</span>book<span class="token punctuation">.</span>card<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre></div></figure>

<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20230420091233246.png" srcset="/img/loading.gif" lazyload alt="image-20230420091233246"></p>
<p><strong><font color='red'>对于内连接来说，如果两张表的字段都存在索引的情况下，查询优化器可以决定谁作为驱动表，谁作为被驱动表。</font></strong></p>
<p>删除被驱动表索引</p>
<figure><div class="code-wrapper"><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">DROP</span> <span class="token keyword">INDEX</span> X <span class="token keyword">ON</span> <span class="token identifier"><span class="token punctuation">`</span>type<span class="token punctuation">`</span></span><span class="token punctuation">;</span>
<span class="token keyword">EXPLAIN</span> <span class="token keyword">SELECT</span> SQL_NO_CACHE <span class="token operator">*</span> <span class="token keyword">FROM</span> <span class="token keyword">TYPE</span> <span class="token keyword">INNER</span> <span class="token keyword">JOIN</span> book <span class="token keyword">ON</span> <span class="token keyword">type</span><span class="token punctuation">.</span>card<span class="token operator">=</span>book<span class="token punctuation">.</span>card<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre></div></figure>

<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20230420091259097.png" srcset="/img/loading.gif" lazyload alt="image-20230420091259097"></p>
<p>接着：</p>
<figure><div class="code-wrapper"><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">ALTER</span> <span class="token keyword">TABLE</span> <span class="token identifier"><span class="token punctuation">`</span>type<span class="token punctuation">`</span></span> <span class="token keyword">ADD</span> <span class="token keyword">INDEX</span> X <span class="token punctuation">(</span>card<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">EXPLAIN</span> <span class="token keyword">SELECT</span> SQL_NO_CACHE <span class="token operator">*</span> <span class="token keyword">FROM</span> <span class="token identifier"><span class="token punctuation">`</span>type<span class="token punctuation">`</span></span> <span class="token keyword">INNER</span> <span class="token keyword">JOIN</span> book <span class="token keyword">ON</span> <span class="token keyword">type</span><span class="token punctuation">.</span>card<span class="token operator">=</span>book<span class="token punctuation">.</span>card<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre></div></figure>

<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20230420091322921.png" srcset="/img/loading.gif" lazyload alt="image-20230420091322921"></p>
<p>接着：</p>
<figure><div class="code-wrapper"><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token comment">#向图书表中添加20条记录</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> book<span class="token punctuation">(</span>card<span class="token punctuation">)</span> <span class="token keyword">VALUES</span><span class="token punctuation">(</span>FLOOR<span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">+</span> <span class="token punctuation">(</span>RAND<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> book<span class="token punctuation">(</span>card<span class="token punctuation">)</span> <span class="token keyword">VALUES</span><span class="token punctuation">(</span>FLOOR<span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">+</span> <span class="token punctuation">(</span>RAND<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> book<span class="token punctuation">(</span>card<span class="token punctuation">)</span> <span class="token keyword">VALUES</span><span class="token punctuation">(</span>FLOOR<span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">+</span> <span class="token punctuation">(</span>RAND<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> book<span class="token punctuation">(</span>card<span class="token punctuation">)</span> <span class="token keyword">VALUES</span><span class="token punctuation">(</span>FLOOR<span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">+</span> <span class="token punctuation">(</span>RAND<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> book<span class="token punctuation">(</span>card<span class="token punctuation">)</span> <span class="token keyword">VALUES</span><span class="token punctuation">(</span>FLOOR<span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">+</span> <span class="token punctuation">(</span>RAND<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> book<span class="token punctuation">(</span>card<span class="token punctuation">)</span> <span class="token keyword">VALUES</span><span class="token punctuation">(</span>FLOOR<span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">+</span> <span class="token punctuation">(</span>RAND<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> book<span class="token punctuation">(</span>card<span class="token punctuation">)</span> <span class="token keyword">VALUES</span><span class="token punctuation">(</span>FLOOR<span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">+</span> <span class="token punctuation">(</span>RAND<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> book<span class="token punctuation">(</span>card<span class="token punctuation">)</span> <span class="token keyword">VALUES</span><span class="token punctuation">(</span>FLOOR<span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">+</span> <span class="token punctuation">(</span>RAND<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> book<span class="token punctuation">(</span>card<span class="token punctuation">)</span> <span class="token keyword">VALUES</span><span class="token punctuation">(</span>FLOOR<span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">+</span> <span class="token punctuation">(</span>RAND<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> book<span class="token punctuation">(</span>card<span class="token punctuation">)</span> <span class="token keyword">VALUES</span><span class="token punctuation">(</span>FLOOR<span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">+</span> <span class="token punctuation">(</span>RAND<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> book<span class="token punctuation">(</span>card<span class="token punctuation">)</span> <span class="token keyword">VALUES</span><span class="token punctuation">(</span>FLOOR<span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">+</span> <span class="token punctuation">(</span>RAND<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> book<span class="token punctuation">(</span>card<span class="token punctuation">)</span> <span class="token keyword">VALUES</span><span class="token punctuation">(</span>FLOOR<span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">+</span> <span class="token punctuation">(</span>RAND<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> book<span class="token punctuation">(</span>card<span class="token punctuation">)</span> <span class="token keyword">VALUES</span><span class="token punctuation">(</span>FLOOR<span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">+</span> <span class="token punctuation">(</span>RAND<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> book<span class="token punctuation">(</span>card<span class="token punctuation">)</span> <span class="token keyword">VALUES</span><span class="token punctuation">(</span>FLOOR<span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">+</span> <span class="token punctuation">(</span>RAND<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> book<span class="token punctuation">(</span>card<span class="token punctuation">)</span> <span class="token keyword">VALUES</span><span class="token punctuation">(</span>FLOOR<span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">+</span> <span class="token punctuation">(</span>RAND<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> book<span class="token punctuation">(</span>card<span class="token punctuation">)</span> <span class="token keyword">VALUES</span><span class="token punctuation">(</span>FLOOR<span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">+</span> <span class="token punctuation">(</span>RAND<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> book<span class="token punctuation">(</span>card<span class="token punctuation">)</span> <span class="token keyword">VALUES</span><span class="token punctuation">(</span>FLOOR<span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">+</span> <span class="token punctuation">(</span>RAND<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> book<span class="token punctuation">(</span>card<span class="token punctuation">)</span> <span class="token keyword">VALUES</span><span class="token punctuation">(</span>FLOOR<span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">+</span> <span class="token punctuation">(</span>RAND<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> book<span class="token punctuation">(</span>card<span class="token punctuation">)</span> <span class="token keyword">VALUES</span><span class="token punctuation">(</span>FLOOR<span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">+</span> <span class="token punctuation">(</span>RAND<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> book<span class="token punctuation">(</span>card<span class="token punctuation">)</span> <span class="token keyword">VALUES</span><span class="token punctuation">(</span>FLOOR<span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">+</span> <span class="token punctuation">(</span>RAND<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">ALTER</span> <span class="token keyword">TABLE</span> book <span class="token keyword">ADD</span> <span class="token keyword">INDEX</span> Y <span class="token punctuation">(</span>card<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">EXPLAIN</span> <span class="token keyword">SELECT</span> SQL_NO_CACHE <span class="token operator">*</span> <span class="token keyword">FROM</span> <span class="token identifier"><span class="token punctuation">`</span>type<span class="token punctuation">`</span></span> <span class="token keyword">INNER</span> <span class="token keyword">JOIN</span> book <span class="token keyword">ON</span> <span class="token identifier"><span class="token punctuation">`</span>type<span class="token punctuation">`</span></span><span class="token punctuation">.</span>card <span class="token operator">=</span> book<span class="token punctuation">.</span>card<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure>

<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20230420091359379.png" srcset="/img/loading.gif" lazyload alt="image-20230420091359379"></p>
<blockquote>
<p>结论：<font color='orange'>对于内连接来说，如果只有一张表存在索引，那么存在索引的表会作为被驱动表。在两个表的索引都存在的情况下，会选择小表（结果集小）作为驱动表。小表驱动大表</font></p>
</blockquote>
<h3 id="3-4-JOIN语句原理"><a href="#3-4-JOIN语句原理" class="headerlink" title="3.4 JOIN语句原理"></a>3.4 JOIN语句原理</h3><p>join方式连接多个表，本质就是各个表之间数据的循环匹配。MySQL5.5版本之前，MySQL只支持一种表间关联方式，就是嵌套循环(Nested Loop Join)。如果关联表的数据量很大，则join关联的执行时间会很长。在MySQL5.5以后的版本中，MySQL通过引入BNLJ算法来优化嵌套执行。</p>
<h4 id="1-驱动表和被驱动表"><a href="#1-驱动表和被驱动表" class="headerlink" title="1. 驱动表和被驱动表"></a>1. 驱动表和被驱动表</h4><p><strong><font color='scarlet'>驱动表就是主表，被驱动表就是从表、非驱动表。</font></strong></p>
<ul>
<li>对于内连接来说：</li>
</ul>
<figure><div class="code-wrapper"><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> A <span class="token keyword">JOIN</span> B <span class="token keyword">ON</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></div></figure>

<p>&#x3D;&#x3D;A一定是驱动表吗？不一定，优化器会根据你查询语句做优化，决定先查哪张表。先查询的那张表就是驱动表，反之就是被驱动表。&#x3D;&#x3D;通过explain关键字可以查看。</p>
<ul>
<li>对于外连接来说：</li>
</ul>
<figure><div class="code-wrapper"><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> A <span class="token keyword">LEFT</span> <span class="token keyword">JOIN</span> B <span class="token keyword">ON</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token comment"># 或</span>
<span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> B <span class="token keyword">RIGHT</span> <span class="token keyword">JOIN</span> A <span class="token keyword">ON</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre></div></figure>

<p>通常，大家会认为A就是驱动表，B就是被驱动表。但也未必。测试如下：</p>
<figure><div class="code-wrapper"><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> a<span class="token punctuation">(</span>f1 <span class="token keyword">INT</span><span class="token punctuation">,</span> f2 <span class="token keyword">INT</span><span class="token punctuation">,</span> <span class="token keyword">INDEX</span><span class="token punctuation">(</span>f1<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">ENGINE</span><span class="token operator">=</span><span class="token keyword">INNODB</span><span class="token punctuation">;</span>
<span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> b<span class="token punctuation">(</span>f1 <span class="token keyword">INT</span><span class="token punctuation">,</span> f2 <span class="token keyword">INT</span><span class="token punctuation">)</span> <span class="token keyword">ENGINE</span><span class="token operator">=</span><span class="token keyword">INNODB</span><span class="token punctuation">;</span>

<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> a <span class="token keyword">VALUES</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">,</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> b <span class="token keyword">VALUES</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">,</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">7</span><span class="token punctuation">,</span><span class="token number">7</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">,</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> b<span class="token punctuation">;</span>

<span class="token comment"># 测试1</span>
<span class="token keyword">EXPLAIN</span> <span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> a <span class="token keyword">LEFT</span> <span class="token keyword">JOIN</span> b <span class="token keyword">ON</span><span class="token punctuation">(</span>a<span class="token punctuation">.</span>f1<span class="token operator">=</span>b<span class="token punctuation">.</span>f1<span class="token punctuation">)</span> <span class="token keyword">WHERE</span> <span class="token punctuation">(</span>a<span class="token punctuation">.</span>f2<span class="token operator">=</span>b<span class="token punctuation">.</span>f2<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment"># 测试2</span>
<span class="token keyword">EXPLAIN</span> <span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> a <span class="token keyword">LEFT</span> <span class="token keyword">JOIN</span> b <span class="token keyword">ON</span><span class="token punctuation">(</span>a<span class="token punctuation">.</span>f1<span class="token operator">=</span>b<span class="token punctuation">.</span>f1<span class="token punctuation">)</span> <span class="token operator">AND</span> <span class="token punctuation">(</span>a<span class="token punctuation">.</span>f2<span class="token operator">=</span>b<span class="token punctuation">.</span>f2<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure>

<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20230514102317314.png" srcset="/img/loading.gif" lazyload alt="image-20230514102317314"></p>
<h4 id="2-Simple-Nested-Loop-Join-简单嵌套循环连接"><a href="#2-Simple-Nested-Loop-Join-简单嵌套循环连接" class="headerlink" title="2. Simple Nested-Loop Join (简单嵌套循环连接)"></a>2. Simple Nested-Loop Join (简单嵌套循环连接)</h4><p>算法相当简单，从表A中取出一条数据1，遍历表B，将匹配到的数据放到result.. 以此类推，驱动表A中的每一条记录与被驱动表B的记录进行判断：</p>
<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20230420092238421.png" srcset="/img/loading.gif" lazyload alt="image-20230420092238421"></p>
<p>可以看到这种方式效率是非常低的，以上述表A数据100条，表B数据1000条计算，则A*B&#x3D;10万次。开销统计如下:</p>
<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20230420092248617.png" srcset="/img/loading.gif" lazyload alt="image-20230420092248617"></p>
<p>当然mysql肯定不会这么粗暴的去进行表的连接，所以就出现了后面的两种对Nested-Loop Join优化算法。</p>
<h4 id="3-Index-Nested-Loop-Join-（索引嵌套循环连接）"><a href="#3-Index-Nested-Loop-Join-（索引嵌套循环连接）" class="headerlink" title="3. Index Nested-Loop Join （索引嵌套循环连接）"></a>3. Index Nested-Loop Join （索引嵌套循环连接）</h4><p>Index Nested-Loop Join其优化的思路主要是为了<code>减少内存表数据的匹配次数</code>，所以要求被驱动表上必须<code>有索引</code>才行。通过外层表匹配条件直接与内层表索引进行匹配，避免和内存表的每条记录去进行比较，这样极大的减少了对内存表的匹配次数。</p>
<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20230420092259947.png" srcset="/img/loading.gif" lazyload alt="image-20230420092259947"></p>
<p>**<font color='red'>驱动表中的每条记录通过被驱动表的索引进行访问，因为索引查询的成本是比较固定的，故mysql优化器都倾向于使用记录数少的表作为驱动表（外表）</font>**。</p>
<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20230420092307685.png" srcset="/img/loading.gif" lazyload alt="image-20230420092307685"></p>
<p>如果被驱动表加索引，效率是非常高的，但如果索引不是主键索引，所以还得进行一次回表查询。相比，被驱动表的索引是主键索引，效率会更高。</p>
<h4 id="4-Block-Nested-Loop-Join（块嵌套循环连接）"><a href="#4-Block-Nested-Loop-Join（块嵌套循环连接）" class="headerlink" title="4. Block Nested-Loop Join（块嵌套循环连接）"></a>4. Block Nested-Loop Join（块嵌套循环连接）</h4><p><font color='red'>如果存在索引，那么会使用index的方式进行join,如果join的列没有索引，被驱动表要扫描的次数太多了。每次访问被驱动表,其表中的记录都会被加载到内存中，然后再从驱动表中取一条与其匹配，匹配结束后清除内存，然后再从驱动表中加载一条记录， 然后把被驱动表的记录在加载到内存匹配，这样周而复始,大大增加了10的次数。为了减少被驱动表的I0次数,就出现了Block Nested-oop Join的方式。</font></p>
<p><font color='cornflowerblue'>不再是逐条获取驱动表的数据，而是一块一块的获取，引入了<code>join buffer缓冲区</code> ，将驱动表join相关的部分数据列(大小受join buffer的限制)缓存到join buffer中,然后全表扫描被驱动表,被驱动表的每一条记录一次性和join<br>buffer中的所有驱动表记录进行匹配(内存中操作) , 将简单嵌套循环中的多次比较合并成一次，降低了被驱动表的访问频率。</font></p>
<blockquote>
<p>注意：</p>
<p>这里缓存的不只是关联表的列，select后面的列也会缓存起来。</p>
<p>在一个有N个join关联的sql中会分配N-1个join buffer。所以查询的时候尽量减少不必要的字段，可以让join buffer中可以存放更多的列。</p>
</blockquote>
<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20230420092930799.png" srcset="/img/loading.gif" lazyload alt="image-20230420092930799"></p>
<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20230420092921377.png" srcset="/img/loading.gif" lazyload alt="image-20230420092921377"></p>
<p>参数设置：</p>
<ul>
<li>block_nested_loop</li>
</ul>
<p>通过<code>show variables like &#39;%optimizer_switch%</code> 查看 <code>block_nested_loop</code>状态。默认是开启的。</p>
<ul>
<li>join_buffer_size</li>
</ul>
<p>驱动表能不能一次加载完，要看join buffer能不能存储所有的数据，默认情况下<code>join_buffer_size=256k</code>。</p>
<figure><div class="code-wrapper"><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql">mysql<span class="token operator">></span> <span class="token keyword">show</span> variables <span class="token operator">like</span> <span class="token string">'%join_buffer%'</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></div></figure>

<p>join_buffer_size的最大值在32位操作系统可以申请4G，而在64位操作系统下可以申请大于4G的Join Buffer空间（64位Windows除外，其大值会被截断为4GB并发出警告）。</p>
<h4 id="5-JOIN小结"><a href="#5-JOIN小结" class="headerlink" title="5. JOIN小结"></a>5. JOIN小结</h4><p>1、**<font color='scarlet'>整体效率比较：INLJ（索引嵌套循环连接） &gt; BNLJ（块嵌套循环连接） &gt; SNLJ（简单嵌套循环连接）</font>**</p>
<p>2、**<font color='scarlet'>永远用小结果集驱动大结果集（其本质就是减少外层循环的数据数量）（小的度量单位指的是表行数 * 每行大小）</font>**</p>
<figure><div class="code-wrapper"><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">select</span> t1<span class="token punctuation">.</span>b<span class="token punctuation">,</span>t2<span class="token punctuation">.</span><span class="token operator">*</span> <span class="token keyword">from</span> t1 straight_join t2 <span class="token keyword">on</span> <span class="token punctuation">(</span>t1<span class="token punctuation">.</span>b<span class="token operator">=</span>t2<span class="token punctuation">.</span>b<span class="token punctuation">)</span> <span class="token keyword">where</span> t2<span class="token punctuation">.</span>id<span class="token operator">&lt;=</span><span class="token number">100</span><span class="token punctuation">;</span> <span class="token comment"># 推荐</span>
<span class="token keyword">select</span> t1<span class="token punctuation">.</span>b<span class="token punctuation">,</span>t2<span class="token punctuation">.</span><span class="token operator">*</span> <span class="token keyword">from</span> t2 straight_join t1 <span class="token keyword">on</span> <span class="token punctuation">(</span>t1<span class="token punctuation">.</span>b<span class="token operator">=</span>t2<span class="token punctuation">.</span>b<span class="token punctuation">)</span> <span class="token keyword">where</span> t2<span class="token punctuation">.</span>id<span class="token operator">&lt;=</span><span class="token number">100</span><span class="token punctuation">;</span> <span class="token comment"># 不推荐</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre></div></figure>

<p>3、为被驱动表匹配的条件增加索引(减少内存表的循环匹配次数)</p>
<p>4、增大join buffer size的大小（一次索引的数据越多，那么内层包的扫描次数就越少）</p>
<p>5、减少驱动表不必要的字段查询（字段越少，join buffer所缓存的数据就越多）</p>
<h4 id="6-Hash-Join"><a href="#6-Hash-Join" class="headerlink" title="6. Hash Join"></a>6. Hash Join</h4><p><font color='scarlet'><strong>从MySQL的8.0.20版本开始将废弃BNLJ，因为从MySQL8.0.18版本开始就加入了hash join默认都会使用hash join</strong></font></p>
<ul>
<li><p>Nested Loop:</p>
<p>对于被连接的数据子集较小的情况，Nested Loop是个较好的选择。</p>
</li>
<li><p>Hash Join是做<code>大数据集连接</code>时的常用方式，优化器使用两个表中较小（相对较小）的表利用Join Key在内存中建立<code>散列表</code>，然后扫描较大的表并探测散列表，找出与Hash表匹配的行。</p>
<ul>
<li>这种方式适合于较小的表完全可以放于内存中的情况，这样总成本就是访问两个表的成本之和。</li>
<li>在表很大的情况下并不能完全放入内存，这时优化器会将它分割成<code>若干不同的分区</code>，不能放入内存的部分就把该分区写入磁盘的临时段，此时要求有较大的临时段从而尽量提高I&#x2F;O的性能。</li>
<li>它能够很好的工作于没有索引的大表和并行查询的环境中，并提供最好的性能。大多数人都说它是Join的重型升降机。Hash Join只能应用于等值连接（如WHERE A.COL1 &#x3D; B.COL2），这是由Hash的特点决定的。</li>
</ul>
</li>
</ul>
<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20230420093458782.png" srcset="/img/loading.gif" lazyload alt="image-20230420093458782"></p>
<h3 id="3-5-小结"><a href="#3-5-小结" class="headerlink" title="3.5 小结"></a>3.5 小结</h3><ul>
<li>保证被驱动表的JOIN字段已经创建了索引</li>
<li>需要JOIN 的字段，数据类型保持绝对一致。</li>
<li>LEFT JOIN 时，选择小表作为驱动表， 大表作为被驱动表 。减少外层循环的次数。</li>
<li>INNER JOIN 时，MySQL会自动将 小结果集的表选为驱动表 。选择相信MySQL优化策略。</li>
<li>能够直接多表关联的尽量直接关联，不用子查询。(减少查询的趟数)</li>
<li>不建议使用子查询，建议将子查询SQL拆开结合程序多次查询，或使用 JOIN 来代替子查询。</li>
<li>衍生表建不了索引</li>
</ul>
<h2 id="4-子查询优化"><a href="#4-子查询优化" class="headerlink" title="4. 子查询优化"></a>4. 子查询优化</h2><p>MySQL从4.1版本开始支持子查询，使用子查询可以进行SELECT语句的嵌套查询，即一个SELECT查询的结 果作为另一个SELECT语句的条件。 <code>子查询可以一次性完成很多逻辑上需要多个步骤才能完成的SQL操作</code> 。</p>
<p>**<font color='scarlet'>子查询是 MySQL 的一项重要的功能，可以帮助我们通过一个 SQL 语句实现比较复杂的查询。但是，子 查询的执行效率不高。</font>**原因：</p>
<p>① 执行子查询时，MySQL需要为内层查询语句的查询结果 建立一个<code>临时表</code> ，然后外层查询语句从临时表 中查询记录。查询完毕后，再撤销这些临时表 。这样会消耗过多的CPU和IO资源，产生大量的慢查询。</p>
<p>② 子查询的结果集存储的临时表，不论是内存临时表还是磁盘临时表都 不会存在索引 ，所以查询性能会 受到一定的影响。</p>
<p>③ 对于返回结果集比较大的子查询，其对查询性能的影响也就越大。</p>
<p><strong>在MySQL中，可以使用连接（JOIN）查询来替代子查询。</strong>连接查询 <code>不需要建立临时表</code> ，其 <code>速度比子查询</code> 要快 ，如果查询中使用索引的话，性能就会更好。</p>
<p>举例1：查询学生表中是班长的学生信息</p>
<ul>
<li>使用子查询</li>
</ul>
<figure><div class="code-wrapper"><pre class="line-numbers language-sqlite" data-language="sqlite"><code class="language-sqlite"># 创建班级表中班长的索引
CREATE INDEX idx_monitor ON class(monitor);

EXPLAIN SELECT * FROM student stu1
WHERE stu1.&#96;stuno&#96; IN (
SELECT monitor
FROM class c
WHERE monitor IS NOT NULL
)<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure>

<ul>
<li>推荐使用多表查询</li>
</ul>
<figure><div class="code-wrapper"><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">EXPLAIN</span> <span class="token keyword">SELECT</span> stu1<span class="token punctuation">.</span><span class="token operator">*</span> <span class="token keyword">FROM</span> student stu1 <span class="token keyword">JOIN</span> class c
<span class="token keyword">ON</span> stu1<span class="token punctuation">.</span><span class="token identifier"><span class="token punctuation">`</span>stuno<span class="token punctuation">`</span></span> <span class="token operator">=</span> c<span class="token punctuation">.</span><span class="token identifier"><span class="token punctuation">`</span>monitor<span class="token punctuation">`</span></span>
<span class="token keyword">WHERE</span> c<span class="token punctuation">.</span><span class="token identifier"><span class="token punctuation">`</span>monitor<span class="token punctuation">`</span></span> <span class="token operator">is</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre></div></figure>

<p>举例2：取所有不为班长的同学</p>
<ul>
<li>不推荐</li>
</ul>
<figure><div class="code-wrapper"><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">EXPLAIN</span> <span class="token keyword">SELECT</span> SQL_NO_CACHE a<span class="token punctuation">.</span><span class="token operator">*</span>
<span class="token keyword">FROM</span> student a
<span class="token keyword">WHERE</span> a<span class="token punctuation">.</span>stuno <span class="token operator">NOT</span> <span class="token operator">IN</span> <span class="token punctuation">(</span>
	<span class="token keyword">SELECT</span> monitor <span class="token keyword">FROM</span> class b
    <span class="token keyword">WHERE</span> monitor <span class="token operator">IS</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure>

<p>执行结果如下：</p>
<ul>
<li>推荐：</li>
</ul>
<figure><div class="code-wrapper"><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">EXPLAIN</span> <span class="token keyword">SELECT</span> SQL_NO_CACHE a<span class="token punctuation">.</span><span class="token operator">*</span>
<span class="token keyword">FROM</span> student a <span class="token keyword">LEFT</span> <span class="token keyword">OUTER</span> <span class="token keyword">JOIN</span> class b
<span class="token keyword">ON</span> a<span class="token punctuation">.</span>stuno <span class="token operator">=</span> b<span class="token punctuation">.</span>monitor
<span class="token keyword">WHERE</span> b<span class="token punctuation">.</span>monitor <span class="token operator">IS</span> <span class="token boolean">NULL</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre></div></figure>


<blockquote>
<p>结论：尽量不要使用NOT IN或者NOT EXISTS，用LEFT JOIN xxx ON xx WHERE xx IS NULL替代</p>
</blockquote>
<h2 id="5-排序优化"><a href="#5-排序优化" class="headerlink" title="5. 排序优化"></a>5. 排序优化</h2><h3 id="5-1-排序优化"><a href="#5-1-排序优化" class="headerlink" title="5.1 排序优化"></a>5.1 排序优化</h3><p><strong>问题</strong>：在 WHERE 条件字段上加索引，但是为什么在 ORDER BY 字段上还要加索引呢？</p>
<p><strong>回答：</strong></p>
<p>在MySQL中，支持两种排序方式，分别是 <code>FileSort</code> 和 <code>Index</code> 排序。</p>
<ul>
<li>Index 排序中，索引可以保证数据的有序性，不需要再进行排序，<code>效率更高</code>。</li>
<li>FileSort 排序则一般在 <code>内存中</code> 进行排序，占用<code>CPU较多</code>。如果待排结果较大，会产生临时文件 I&#x2F;O 到磁盘进行排序的情况，效率较低。</li>
</ul>
<p><strong>优化建议：</strong></p>
<ol>
<li>SQL 中，可以在 WHERE 子句和 ORDER BY 子句中使用索引，目的是在 WHERE 子句中 <code>避免全表扫描</code> ，在 ORDER BY 子句 <code>避免使用 FileSort 排序</code> 。当然，某些情况下全表扫描，或者 FileSort 排序不一定比索引慢。但总的来说，我们还是要避免，以提高查询效率。</li>
<li>尽量使用 Index 完成 ORDER BY 排序。如果 WHERE 和 ORDER BY 后面是相同的列就使用单索引列； 如果不同就使用联合索引。</li>
<li>无法使用 Index 时，需要对 FileSort 方式进行调优。</li>
</ol>
<h3 id="5-2-排序优化案例"><a href="#5-2-排序优化案例" class="headerlink" title="5.2 排序优化案例"></a>5.2 排序优化案例</h3><p>删除student表和class表中已创建的索引。</p>
<figure><div class="code-wrapper"><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token comment"># 方式1</span>
<span class="token keyword">DROP</span> <span class="token keyword">INDEX</span> idx_monitor <span class="token keyword">ON</span> class<span class="token punctuation">;</span>
<span class="token keyword">DROP</span> <span class="token keyword">INDEX</span> idx_cid <span class="token keyword">ON</span> student<span class="token punctuation">;</span>
<span class="token keyword">DROP</span> <span class="token keyword">INDEX</span> idx_age <span class="token keyword">ON</span> student<span class="token punctuation">;</span>
<span class="token keyword">DROP</span> <span class="token keyword">INDEX</span> idx_name <span class="token keyword">ON</span> student<span class="token punctuation">;</span>
<span class="token keyword">DROP</span> <span class="token keyword">INDEX</span> idx_age_name_classId <span class="token keyword">ON</span> student<span class="token punctuation">;</span>
<span class="token keyword">DROP</span> <span class="token keyword">INDEX</span> idx_age_classId_name <span class="token keyword">ON</span> student<span class="token punctuation">;</span>

<span class="token comment"># 方式2</span>
<span class="token keyword">call</span> proc_drop_index<span class="token punctuation">(</span><span class="token string">'atguigudb2'</span><span class="token punctuation">,</span><span class="token string">'student'</span><span class="token punctuation">;</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure>

<p>以下是否能使用到索引，<code>能否去掉using filesort</code></p>
<p><strong>一： 在order by 语句中不使用limit，索引失效</strong></p>
<p>创建索引：</p>
<figure><div class="code-wrapper"><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">alter</span> <span class="token keyword">table</span> student <span class="token keyword">add</span> <span class="token keyword">index</span> idx_age_classId_name<span class="token punctuation">(</span>age<span class="token punctuation">,</span>classId<span class="token punctuation">,</span><span class="token identifier"><span class="token punctuation">`</span>name<span class="token punctuation">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></div></figure>

<p>不使用limit时，索引失效，因为如果使用<code>idx_age_classId_name</code>索引的话，就会造成回表操作，为了提高查询效率，查询优化器就不会使用该索引。</p>
<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20230514131250905.png" srcset="/img/loading.gif" lazyload alt="image-20230514131250905"></p>
<p><strong>二： 在order by 语句中使用limit，索引生效</strong></p>
<p>当使用limit时，MySQL 可以更容易地确定需要返回的有序数据行范围，进而利用索引完成有序访问。相反，如果没有加入 <code>LIMIT</code> 子句，则 MySQL 需要全部扫描产生的结果集，再次排序，这就使得索引不能被完全有效利用。</p>
<figure><div class="code-wrapper"><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">EXPLAIN</span> <span class="token keyword">SELECT</span> SQL_NO_CACHE <span class="token operator">*</span> <span class="token keyword">FROM</span> student <span class="token keyword">ORDER</span> <span class="token keyword">BY</span> age<span class="token punctuation">,</span>classid <span class="token keyword">limit</span> <span class="token number">10</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></div></figure>

<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20230514132204368.png" srcset="/img/loading.gif" lazyload alt="image-20230514132204368"></p>
<p><strong>三：order by 时顺序错误，索引失效</strong></p>
<figure><div class="code-wrapper"><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token comment">#创建索引age, classid, stuno</span>
<span class="token keyword">CREATE</span> <span class="token keyword">INDEX</span> idx_age_classid_stuno <span class="token keyword">ON</span> student <span class="token punctuation">(</span> age<span class="token punctuation">,</span> classid<span class="token punctuation">,</span> stuno<span class="token punctuation">)</span> <span class="token punctuation">;</span>
<span class="token comment">#以下哪些索引失效?</span>
<span class="token keyword">EXPLAIN</span> <span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> student <span class="token keyword">ORDER</span> <span class="token keyword">BY</span> classid <span class="token keyword">LIMIT</span> <span class="token number">10</span><span class="token punctuation">;</span> <span class="token keyword">No</span>
<span class="token keyword">EXPLAIN</span> <span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> student <span class="token keyword">ORDER</span> <span class="token keyword">BY</span> classid<span class="token punctuation">,</span> NAME <span class="token keyword">LIMIT</span> <span class="token number">10</span><span class="token punctuation">;</span> <span class="token keyword">No</span>
<span class="token keyword">EXPLAIN</span>
<span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> student <span class="token keyword">ORDER</span> <span class="token keyword">BY</span> age<span class="token punctuation">,</span> classid<span class="token punctuation">,</span> stuno <span class="token keyword">LIMIT</span> <span class="token number">10</span><span class="token punctuation">;</span> Yes
<span class="token keyword">EXPLAIN</span> <span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> student <span class="token keyword">ORDER</span> <span class="token keyword">BY</span> age<span class="token punctuation">,</span> classid <span class="token keyword">LIMIT</span> <span class="token number">10</span><span class="token punctuation">;</span> Yes
<span class="token keyword">EXPLAIN</span> <span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> student <span class="token keyword">ORDER</span> <span class="token keyword">BY</span> age <span class="token keyword">LIMIT</span> <span class="token number">10</span><span class="token punctuation">;</span> Yes<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure>



<p><strong>四：order by 时规则不一致，索引失效（顺序错，不索引；方向反，不索引）</strong></p>
<figure><div class="code-wrapper"><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">EXPLAIN</span>
<span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> student <span class="token keyword">ORDER</span> <span class="token keyword">BY</span> age <span class="token keyword">DESC</span><span class="token punctuation">,</span>classid <span class="token keyword">ASC</span> <span class="token keyword">LIMIT</span> <span class="token number">10</span><span class="token punctuation">;</span> <span class="token keyword">No</span>
<span class="token keyword">EXPLAIN</span> <span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> student <span class="token keyword">ORDER</span> <span class="token keyword">BY</span> classid <span class="token keyword">DESC</span>，NAME <span class="token keyword">DESC</span> <span class="token keyword">LIMIT</span> <span class="token number">10</span><span class="token punctuation">;</span> <span class="token keyword">No</span>
<span class="token keyword">EXPLAIN</span> <span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> student <span class="token keyword">ORDER</span> <span class="token keyword">BY</span> age <span class="token keyword">ASC</span><span class="token punctuation">,</span> classid <span class="token keyword">DESC</span> <span class="token keyword">LIMIT</span> <span class="token number">10</span><span class="token punctuation">;</span> <span class="token keyword">No</span>
<span class="token keyword">EXPLAIN</span> <span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> student <span class="token keyword">ORDER</span> <span class="token keyword">BY</span> age <span class="token keyword">DESC</span>， classid <span class="token keyword">DESC</span> <span class="token keyword">LIMIT</span> <span class="token number">10</span><span class="token punctuation">;</span> Yes<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure>

<blockquote>
<p>结论：ORDER BY 子句，尽量使用 Index 方式排序，避免使用 FileSort 方式排序</p>
</blockquote>
<p><strong>五：小结</strong></p>
<figure><div class="code-wrapper"><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">INDEX</span> a_b_c<span class="token punctuation">(</span>a<span class="token punctuation">,</span>b<span class="token punctuation">,</span>c<span class="token punctuation">)</span>
<span class="token keyword">order</span> <span class="token keyword">by</span> 能使用索引最左前缀
<span class="token operator">-</span> <span class="token keyword">ORDER</span> <span class="token keyword">BY</span> a
<span class="token operator">-</span> <span class="token keyword">ORDER</span> <span class="token keyword">BY</span> a<span class="token punctuation">,</span>b
<span class="token operator">-</span> <span class="token keyword">ORDER</span> <span class="token keyword">BY</span> a<span class="token punctuation">,</span>b<span class="token punctuation">,</span>c
<span class="token operator">-</span> <span class="token keyword">ORDER</span> <span class="token keyword">BY</span> a <span class="token keyword">DESC</span><span class="token punctuation">,</span>b <span class="token keyword">DESC</span><span class="token punctuation">,</span>c <span class="token keyword">DESC</span>
如果<span class="token keyword">WHERE</span>使用索引的最左前缀定义为常量，则<span class="token keyword">order</span> <span class="token keyword">by</span> 能使用索引
<span class="token operator">-</span> <span class="token keyword">WHERE</span> a <span class="token operator">=</span> const <span class="token keyword">ORDER</span> <span class="token keyword">BY</span> b<span class="token punctuation">,</span>c
<span class="token operator">-</span> <span class="token keyword">WHERE</span> a <span class="token operator">=</span> const <span class="token operator">AND</span> b <span class="token operator">=</span> const <span class="token keyword">ORDER</span> <span class="token keyword">BY</span> c
<span class="token operator">-</span> <span class="token keyword">WHERE</span> a <span class="token operator">=</span> const <span class="token keyword">ORDER</span> <span class="token keyword">BY</span> b<span class="token punctuation">,</span>c
<span class="token operator">-</span> <span class="token keyword">WHERE</span> a <span class="token operator">=</span> const <span class="token operator">AND</span> b <span class="token operator">></span> const <span class="token keyword">ORDER</span> <span class="token keyword">BY</span> b<span class="token punctuation">,</span>c
不能使用索引进行排序
<span class="token operator">-</span> <span class="token keyword">ORDER</span> <span class="token keyword">BY</span> a <span class="token keyword">ASC</span><span class="token punctuation">,</span>b <span class="token keyword">DESC</span><span class="token punctuation">,</span>c <span class="token keyword">DESC</span> <span class="token comment">/* 排序不一致 */</span>
<span class="token operator">-</span> <span class="token keyword">WHERE</span> g <span class="token operator">=</span> const <span class="token keyword">ORDER</span> <span class="token keyword">BY</span> b<span class="token punctuation">,</span>c <span class="token comment">/*丢失a索引*/</span>
<span class="token operator">-</span> <span class="token keyword">WHERE</span> a <span class="token operator">=</span> const <span class="token keyword">ORDER</span> <span class="token keyword">BY</span> c <span class="token comment">/*丢失b索引*/</span>
<span class="token operator">-</span> <span class="token keyword">WHERE</span> a <span class="token operator">=</span> const <span class="token keyword">ORDER</span> <span class="token keyword">BY</span> a<span class="token punctuation">,</span>d <span class="token comment">/*d不是索引的一部分*/</span>
<span class="token operator">-</span> <span class="token keyword">WHERE</span> a <span class="token operator">in</span> <span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span> <span class="token keyword">ORDER</span> <span class="token keyword">BY</span> b<span class="token punctuation">,</span>c <span class="token comment">/*对于排序来说，多个相等条件也是范围查询*/</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure>

<h3 id="5-3-案例实战"><a href="#5-3-案例实战" class="headerlink" title="5.3 案例实战"></a>5.3 案例实战</h3><p>ORDER BY子句，尽量使用Index方式排序，避免使用FileSort方式排序。</p>
<p>执行案例前先清除student上的索引，只留主键：</p>
<figure><div class="code-wrapper"><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">DROP</span> <span class="token keyword">INDEX</span> idx_age <span class="token keyword">ON</span> student<span class="token punctuation">;</span>
<span class="token keyword">DROP</span> <span class="token keyword">INDEX</span> idx_age_classid_stuno <span class="token keyword">ON</span> student<span class="token punctuation">;</span>
<span class="token keyword">DROP</span> <span class="token keyword">INDEX</span> idx_age_classid_name <span class="token keyword">ON</span> student<span class="token punctuation">;</span>

<span class="token comment">#或者</span>
<span class="token keyword">call</span> proc_drop_index<span class="token punctuation">(</span><span class="token string">'atguigudb2'</span><span class="token punctuation">,</span><span class="token string">'student'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure>

<p><strong>场景:查询年龄为30岁的，且学生编号小于101000的学生，按用户名称排序</strong></p>
<figure><div class="code-wrapper"><pre class="line-numbers language-none"><code class="language-none">EXPLAIN SELECT SQL_NO_CACHE * FROM student WHERE age &#x3D; 30 AND stuno &lt;101000 ORDER BY NAME ;<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></div></figure>


<p>查询结果如下：</p>
<figure><div class="code-wrapper"><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql">mysql<span class="token operator">></span> <span class="token keyword">SELECT</span> SQL_NO_CACHE <span class="token operator">*</span> <span class="token keyword">FROM</span> student <span class="token keyword">WHERE</span> age <span class="token operator">=</span> <span class="token number">30</span> <span class="token operator">AND</span> stuno <span class="token operator">&lt;</span><span class="token number">101000</span> <span class="token keyword">ORDER</span> <span class="token keyword">BY</span> NAME<span class="token punctuation">;</span>
<span class="token operator">+</span><span class="token comment">---------+--------+--------+------+---------+</span>
<span class="token operator">|</span> id      <span class="token operator">|</span> stuno  <span class="token operator">|</span>  name  <span class="token operator">|</span> age  <span class="token operator">|</span> classId <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">---------+--------+--------+------+---------+</span>
<span class="token operator">|</span> <span class="token number">922</span>     <span class="token operator">|</span> <span class="token number">100923</span> <span class="token operator">|</span> elTLXD <span class="token operator">|</span> <span class="token number">30</span>   <span class="token operator">|</span> <span class="token number">249</span>     <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">3723263</span> <span class="token operator">|</span> <span class="token number">100412</span> <span class="token operator">|</span> hKcjLb <span class="token operator">|</span> <span class="token number">30</span>   <span class="token operator">|</span> <span class="token number">59</span>      <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">3724152</span> <span class="token operator">|</span> <span class="token number">100827</span> <span class="token operator">|</span> iHLJmh <span class="token operator">|</span> <span class="token number">30</span>   <span class="token operator">|</span> <span class="token number">387</span>     <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">3724030</span> <span class="token operator">|</span> <span class="token number">100776</span> <span class="token operator">|</span> LgxWoD <span class="token operator">|</span> <span class="token number">30</span>   <span class="token operator">|</span> <span class="token number">253</span>     <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">30</span>      <span class="token operator">|</span> <span class="token number">100031</span> <span class="token operator">|</span> LZMOIa <span class="token operator">|</span> <span class="token number">30</span>   <span class="token operator">|</span> <span class="token number">97</span>      <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">3722887</span> <span class="token operator">|</span> <span class="token number">100237</span> <span class="token operator">|</span> QzbJdx <span class="token operator">|</span> <span class="token number">30</span>   <span class="token operator">|</span> <span class="token number">440</span>     <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">609</span>     <span class="token operator">|</span> <span class="token number">100610</span> <span class="token operator">|</span> vbRimN <span class="token operator">|</span> <span class="token number">30</span>   <span class="token operator">|</span> <span class="token number">481</span>     <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">139</span>     <span class="token operator">|</span> <span class="token number">100140</span> <span class="token operator">|</span> ZqFbuR <span class="token operator">|</span> <span class="token number">30</span>   <span class="token operator">|</span> <span class="token number">351</span>     <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">---------+--------+--------+------+---------+</span>
<span class="token number">8</span> <span class="token keyword">rows</span> <span class="token operator">in</span> <span class="token keyword">set</span><span class="token punctuation">,</span> <span class="token number">1</span> warning <span class="token punctuation">(</span><span class="token number">3.16</span> sec<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure>

<blockquote>
<p>结论：type 是 ALL，即最坏的情况。Extra 里还出现了 Using filesort,也是最坏的情况。优化是必须的。</p>
</blockquote>
<p><strong>方案一: 为了去掉filesort我们可以把索引建成</strong></p>
<figure><div class="code-wrapper"><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token comment">#创建新索引</span>
<span class="token keyword">CREATE</span> <span class="token keyword">INDEX</span> idx_age_name <span class="token keyword">ON</span> student<span class="token punctuation">(</span>age<span class="token punctuation">,</span>NAME<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">EXPLAIN</span> <span class="token keyword">SELECT</span> SQL_NO_CACHE <span class="token operator">*</span> <span class="token keyword">FROM</span> student <span class="token keyword">WHERE</span> age <span class="token operator">=</span> <span class="token number">30</span> <span class="token operator">AND</span> stuno <span class="token operator">&lt;</span><span class="token number">101000</span> <span class="token keyword">ORDER</span> <span class="token keyword">BY</span> NAME<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre></div></figure>

<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20230514140427607.png" srcset="/img/loading.gif" lazyload alt="image-20230514140427607"></p>
<p>这样我们优化掉了 using filesort</p>
<p><strong>方案二：尽量让where的过滤条件和排序使用上索引</strong></p>
<p>建一个三个字段的组合索引：</p>
<figure><div class="code-wrapper"><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">DROP</span> <span class="token keyword">INDEX</span> idx_age_name <span class="token keyword">ON</span> student<span class="token punctuation">;</span>
<span class="token keyword">CREATE</span> <span class="token keyword">INDEX</span> idx_age_stuno_name <span class="token keyword">ON</span> student <span class="token punctuation">(</span>age<span class="token punctuation">,</span>stuno<span class="token punctuation">,</span>NAME<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">EXPLAIN</span> <span class="token keyword">SELECT</span> SQL_NO_CACHE <span class="token operator">*</span> <span class="token keyword">FROM</span> student <span class="token keyword">WHERE</span> age <span class="token operator">=</span> <span class="token number">30</span> <span class="token operator">AND</span> stuno <span class="token operator">&lt;</span><span class="token number">101000</span> <span class="token keyword">ORDER</span> <span class="token keyword">BY</span> NAME<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre></div></figure>

<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20230514140640079.png" srcset="/img/loading.gif" lazyload alt="image-20230514140640079"></p>
<p>我们发现using filesort依然存在，所以name并没有用到索引，而且type还是range光看名字其实并不美好。原因是，因为<code>stuno是一个范围过滤</code>，所以索引后面的字段不会在使用索引了 。</p>
<p>结果如下：</p>
<figure><div class="code-wrapper"><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql">mysql<span class="token operator">></span> <span class="token keyword">SELECT</span> SQL_NO_CACHE <span class="token operator">*</span> <span class="token keyword">FROM</span> student
<span class="token operator">-</span><span class="token operator">></span> <span class="token keyword">WHERE</span> age <span class="token operator">=</span> <span class="token number">30</span> <span class="token operator">AND</span> stuno <span class="token operator">&lt;</span><span class="token number">101000</span> <span class="token keyword">ORDER</span> <span class="token keyword">BY</span> NAME <span class="token punctuation">;</span>
<span class="token operator">+</span><span class="token comment">-----+--------+--------+------+---------+</span>
<span class="token operator">|</span> id <span class="token operator">|</span> stuno <span class="token operator">|</span> name <span class="token operator">|</span> age <span class="token operator">|</span> classId <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">-----+--------+--------+------+---------+</span>
<span class="token operator">|</span> <span class="token number">167</span> <span class="token operator">|</span> <span class="token number">100168</span> <span class="token operator">|</span> AClxEF <span class="token operator">|</span> <span class="token number">30</span> <span class="token operator">|</span> <span class="token number">319</span> <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">323</span> <span class="token operator">|</span> <span class="token number">100324</span> <span class="token operator">|</span> bwbTpQ <span class="token operator">|</span> <span class="token number">30</span> <span class="token operator">|</span> <span class="token number">654</span> <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">651</span> <span class="token operator">|</span> <span class="token number">100652</span> <span class="token operator">|</span> DRwIac <span class="token operator">|</span> <span class="token number">30</span> <span class="token operator">|</span> <span class="token number">997</span> <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">517</span> <span class="token operator">|</span> <span class="token number">100518</span> <span class="token operator">|</span> HNSYqJ <span class="token operator">|</span> <span class="token number">30</span> <span class="token operator">|</span> <span class="token number">256</span> <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">344</span> <span class="token operator">|</span> <span class="token number">100345</span> <span class="token operator">|</span> JuepiX <span class="token operator">|</span> <span class="token number">30</span> <span class="token operator">|</span> <span class="token number">329</span> <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">905</span> <span class="token operator">|</span> <span class="token number">100906</span> <span class="token operator">|</span> JuWALd <span class="token operator">|</span> <span class="token number">30</span> <span class="token operator">|</span> <span class="token number">892</span> <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">574</span> <span class="token operator">|</span> <span class="token number">100575</span> <span class="token operator">|</span> kbyqjX <span class="token operator">|</span> <span class="token number">30</span> <span class="token operator">|</span> <span class="token number">260</span> <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">703</span> <span class="token operator">|</span> <span class="token number">100704</span> <span class="token operator">|</span> KJbprS <span class="token operator">|</span> <span class="token number">30</span> <span class="token operator">|</span> <span class="token number">594</span> <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">723</span> <span class="token operator">|</span> <span class="token number">100724</span> <span class="token operator">|</span> OTdJkY <span class="token operator">|</span> <span class="token number">30</span> <span class="token operator">|</span> <span class="token number">236</span> <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">656</span> <span class="token operator">|</span> <span class="token number">100657</span> <span class="token operator">|</span> Pfgqmj <span class="token operator">|</span> <span class="token number">30</span> <span class="token operator">|</span> <span class="token number">600</span> <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">982</span> <span class="token operator">|</span> <span class="token number">100983</span> <span class="token operator">|</span> qywLqw <span class="token operator">|</span> <span class="token number">30</span> <span class="token operator">|</span> <span class="token number">837</span> <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">468</span> <span class="token operator">|</span> <span class="token number">100469</span> <span class="token operator">|</span> sLEKQW <span class="token operator">|</span> <span class="token number">30</span> <span class="token operator">|</span> <span class="token number">346</span> <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">988</span> <span class="token operator">|</span> <span class="token number">100989</span> <span class="token operator">|</span> UBYqJl <span class="token operator">|</span> <span class="token number">30</span> <span class="token operator">|</span> <span class="token number">457</span> <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">173</span> <span class="token operator">|</span> <span class="token number">100174</span> <span class="token operator">|</span> UltkTN <span class="token operator">|</span> <span class="token number">30</span> <span class="token operator">|</span> <span class="token number">830</span> <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">332</span> <span class="token operator">|</span> <span class="token number">100333</span> <span class="token operator">|</span> YjWiZw <span class="token operator">|</span> <span class="token number">30</span> <span class="token operator">|</span> <span class="token number">824</span> <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">-----+--------+--------+------+---------+</span>
<span class="token number">15</span> <span class="token keyword">rows</span> <span class="token operator">in</span> <span class="token keyword">set</span><span class="token punctuation">,</span> <span class="token number">1</span> warning <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure>

<p>结果竟然有 filesort的 sql 运行速度， 超过了已经优化掉 filesort的 sql ，而且快了很多，几乎一瞬间就出现了结果。</p>
<p>原因：</p>
<p>所有的排序都是在条件过滤之后才执行的。所以,如果条件过滤掉大部分数据的话,剩下几百几千条数据进行排<br>序其实并不是很消耗性能，即使索引优化了排序,但实际提升性能很有限。相对的stuno&lt;101000这个条件,如<br>果没有用到索引的话，要对几万条的数据进行扫描，这是非常消耗性能的，所以索引放在这个字段上性价比最<br>高是最优选择。</p>
<blockquote>
<p>结论：</p>
<ol>
<li>两个索引同时存在，mysql自动选择最优的方案。（对于这个例子，mysql选择 idx_age_stuno_name）。但是， <code>随着数据量的变化，选择的索引也会随之变化的 </code>。</li>
<li><strong>当【范围条件】和【group by 或者 order by】的字段出现二选一时，优先观察条件字段的过 滤数量，如果过滤的数据足够多，而需要排序的数据并不多时，优先把索引放在范围字段上。反之，亦然。</strong></li>
</ol>
</blockquote>
<p>思考：这里我们使用如下索引，是否可行？</p>
<figure><div class="code-wrapper"><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">DROP</span> <span class="token keyword">INDEX</span> idx_age_stuno_name <span class="token keyword">ON</span> student<span class="token punctuation">;</span>

<span class="token keyword">CREATE</span> <span class="token keyword">INDEX</span> idx_age_stuno <span class="token keyword">ON</span> student<span class="token punctuation">(</span>age<span class="token punctuation">,</span>stuno<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre></div></figure>

<p>当然可以。</p>
<h3 id="5-4-filesort算法：双路排序和单路排序"><a href="#5-4-filesort算法：双路排序和单路排序" class="headerlink" title="5.4 filesort算法：双路排序和单路排序"></a>5.4 filesort算法：双路排序和单路排序</h3><p>排序的字段若不在索引列上，则filesort会有两种算法：双路排序和单路排序</p>
<p><strong>双路排序 （慢）</strong></p>
<ul>
<li>MySQL 4.1之前是使用双路排序 ，字面意思就是两次扫描磁盘，最终得到数据， 读取行指针和 order by列 ，对他们进行排序，然后扫描已经排序好的列表，按照列表中的值重新从列表中读取对应的数据输出</li>
<li>从磁盘取排序字段，在buffer进行排序，再从磁盘取其他字段 。</li>
</ul>
<p>取一批数据，要对磁盘进行两次扫描，众所周知，IO是很耗时的，所以在mysql4.1之后，出现了第二种 改进的算法，就是单路排序。</p>
<p><strong>单路排序 （快）</strong></p>
<p>从磁盘读取查询需要的 所有列 ，按照order by列在buffer对它们进行排序，然后扫描排序后的列表进行输出， 它的效率更快一些，避免了第二次读取数据。并且把随机IO变成了顺序IO，但是它会使用更多的空间， 因为它把每一行都保存在内存中了。</p>
<p><strong>结论及引申出的问题</strong></p>
<ul>
<li>由于单路是后出的，总体而言好过双路</li>
<li>但是用单路有问题<ul>
<li>在sort_buffer中，单路要比多路多占用很多空间，因为单路是把所有字段都取出，所以有可能取出的数据的总大小超出了<code>sort_buffer</code>的容量，导致每次只能取<code>sort_buffer</code>容量大小的数据，进行排序（创建tmp文件，多路合并），排完再取sort_buffer容量大小，再排…从而多次I&#x2F;O。</li>
<li>单路本来想省一次I&#x2F;O操作，反而导致了大量的I&#x2F;O操作，反而得不偿失。</li>
</ul>
</li>
</ul>
<p><strong>优化策略</strong></p>
<p><strong>1. 尝试提高 sort_buffer_size</strong></p>
<p>不管用哪种算法,提高这个参数都会提高效率,要根据系统的能力去提高，因为这个参数是针对每个进程<br>(connection)的1M-8M之间调整。MySQL5.7, InnoDB存储引擎默认值是1048576字节，1MB。</p>
<p><strong>2. 尝试提高 max_length_for_sort_data</strong></p>
<p><strong>3. Order by 时select * 是一个大忌。最好只Query需要的字段。</strong></p>
<ul>
<li>当Query的字段大小总和小于max_ length_ for. sort_ data ，而且排序字段不是TEXT|BLOB类型时，会用改<br>进后的算法- – 单路排序，否则用老算法– 多路排序。</li>
<li>两种算法的数据都有可能超出sort_ buffer_ size的容量，超出之后，会创建tmp文件进行合并排序，导致多次I&#x2F;O,但是用单路排序算法的风险会更大-些，所以要提高sort_ .buffer_ size 。</li>
</ul>
<h2 id="6-GROUP-BY优化"><a href="#6-GROUP-BY优化" class="headerlink" title="6. GROUP BY优化"></a>6. GROUP BY优化</h2><ul>
<li>group by 使用索引的原则几乎跟order by一致 ，group by 即使没有过滤条件用到索引，也可以直接使用索引。</li>
<li>group by 先排序再分组，遵照索引建的最佳左前缀法则</li>
<li>当无法使用索引列，增大 max_length_for_sort_data 和 sort_buffer_size 参数的设置</li>
<li>where效率高于having，能写在where限定的条件就不要写在having中了</li>
<li>减少使用order by，和业务沟通能不排序就不排序，或将排序放到程序端去做。Order by、group by、distinct这些语句较为耗费CPU，数据库的CPU资源是极其宝贵的。</li>
<li>包含了order by、group by、distinct这些查询的语句，where条件过滤出来的结果集请保持在1000行 以内，否则SQL会很慢。</li>
</ul>
<h2 id="7-优化分页查询"><a href="#7-优化分页查询" class="headerlink" title="7. 优化分页查询"></a>7. 优化分页查询</h2><p>一般分页查询时， 通过创建覆盖索引能够比较好地提高性能。常见又非常头疼的问题就是limit 200000,10<br>，此时需要MySQL排序前2000010记录，仅仅返回0000000 - 2000010的记录，其他记录丢弃，查询排序的代价非<br>常大。</p>
<p><font color='scarlet'><strong>优化思路一</strong></font></p>
<p>在索引上完成排序分页操作，最后根据主键关联回原表查询所需要的其他列内容。</p>
<figure><div class="code-wrapper"><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">EXPLAIN</span> <span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> student t<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token keyword">SELECT</span> id <span class="token keyword">FROM</span> student <span class="token keyword">ORDER</span> <span class="token keyword">BY</span> id <span class="token keyword">LIMIT</span> <span class="token number">2000000</span><span class="token punctuation">,</span><span class="token number">10</span><span class="token punctuation">)</span> a <span class="token keyword">WHERE</span> t<span class="token punctuation">.</span>id <span class="token operator">=</span> a<span class="token punctuation">.</span>id<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></div></figure>


<p><font color='scarlet'><strong>优化思路二</strong></font></p>
<p>该方案适用于主键自增的表，可以把Limit 查询转换成某个位置的查询 。</p>
<figure><div class="code-wrapper"><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">EXPLAIN</span> <span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> student <span class="token keyword">WHERE</span> id <span class="token operator">></span> <span class="token number">2000000</span> <span class="token keyword">LIMIT</span> <span class="token number">10</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></div></figure>


<h2 id="8-优先考虑覆盖索引"><a href="#8-优先考虑覆盖索引" class="headerlink" title="8. 优先考虑覆盖索引"></a>8. 优先考虑覆盖索引</h2><h3 id="8-1-什么是覆盖索引？"><a href="#8-1-什么是覆盖索引？" class="headerlink" title="8.1 什么是覆盖索引？"></a>8.1 什么是覆盖索引？</h3><p><code>覆盖查询</code>（Covering Index Query）是一种查询优化技术，它可以利用索引的特性直接返回所需的数据，而无需进行额外的访问操作。具体而言，如果查询语句中涉及到的所有字段都已经包含在某个索引中，并且该索引是覆盖索引（Covering Index），那么 MySQL 可以直接使用该索引来返回查询结果，而不必再到数据表中去查找数据，从而提高查询效率。。**<font color='scarlet'>一个索引包含了满足查询结果的数据就叫做覆盖索引</font>	**。</p>
<p>简单说就是， <code>索引列+主键</code> 包含 <code>SELECT 到 FROM之间查询的列</code> 。</p>
<p><strong>举例一：</strong></p>
<figure><div class="code-wrapper"><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token comment"># 删除之前的索引</span>
<span class="token keyword">DROP</span> <span class="token keyword">INDEX</span> idx_age_stuno <span class="token keyword">ON</span> student<span class="token punctuation">;</span>
<span class="token keyword">CREATE</span> <span class="token keyword">INDEX</span> idx_age_name <span class="token keyword">ON</span> student<span class="token punctuation">(</span>age<span class="token punctuation">,</span> NAME<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">EXPLAIN</span> <span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> student <span class="token keyword">WHERE</span> age <span class="token operator">&lt;></span> <span class="token number">20</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre></div></figure>

<p><strong>举例二：</strong></p>
<figure><div class="code-wrapper"><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">EXPLAIN</span> <span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> student <span class="token keyword">WHERE</span> NAME <span class="token operator">LIKE</span> <span class="token string">'%abc'</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></div></figure>

<figure><div class="code-wrapper"><pre class="line-numbers language-none"><code class="language-none">CREATE INDEX idx_age_name ON student(age, NAME);
EXPLAIN SELECT id,age,NAME FROM student WHERE NAME LIKE &#39;%abc&#39;;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre></div></figure>

<p>上述都使用到了声明的索引，下面的情况则不然，查询列依然多了classId,结果是未使用到索引：</p>
<figure><div class="code-wrapper"><pre class="line-numbers language-none"><code class="language-none">EXPLAIN SELECT id,age,NAME,classId FROM student WHERE NAME LIKE &#39;%abc&#39;;<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></div></figure>

<h3 id="8-2-覆盖索引的利弊"><a href="#8-2-覆盖索引的利弊" class="headerlink" title="8.2 覆盖索引的利弊"></a>8.2 覆盖索引的利弊</h3><p><strong><font color='cornflowerblue'>好处:</font></strong></p>
<ul>
<li><p><strong><font color='scarlet'>避免Innodb表进行索引的二次查询(回表)</font></strong><br>Innodb是以聚集索引的顺序来存储的，对于Innodb来说，二级索引在叶子节点中所保存的是行的主键信息，如果是用二级索引查询数据，在查找到相应的键值后,还需通过主键进行二次查询才能获取我们真实所需要的数据。<br>在覆盖索引中，二级索弓|的键值中可以获取所要的数据，避免了 对主键的二次查询，减少了I0操作，提升了查询效率。</p>
</li>
<li><p><strong><font color='scarlet'>可以把随机I0变成顺序I0加快查询效率</font></strong><br>由于覆盖索引|是按键值的顺序存储的，对于I0密集型的范围查找来说,对比随机从磁盘读取每- -行的数据10要少的多，因此利用覆盖索引在访问时也可以把磁盘的随机读取的I0转变成索弓|查找的顺序I0。</p>
<p>由于覆盖索引可以减少树的搜索次数，显著提升查询性能，所以使用覆盖索引是-一个常用的性能优化手段。</p>
</li>
</ul>
<p><strong><font color='cornflowerblue'>弊端</font></strong></p>
<p>索引字段的维护总是有代价的。因此，在建立冗余索引来支持覆盖索引时就需要权衡考虑了。这是业务DBA,或。者称为业务数据架构师的工作。</p>
<h2 id="9-如何给字符串添加索引"><a href="#9-如何给字符串添加索引" class="headerlink" title="9. 如何给字符串添加索引"></a>9. 如何给字符串添加索引</h2><p>有一张教师表，表定义如下：</p>
<figure><div class="code-wrapper"><pre class="line-numbers language-none"><code class="language-none">create table teacher(
ID bigint unsigned primary key,
email varchar(64),
...
)engine&#x3D;innodb;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure>

<p>讲师要使用邮箱登录，所以业务代码中一定会出现类似于这样的语句：</p>
<figure><div class="code-wrapper"><pre class="line-numbers language-none"><code class="language-none">mysql&gt; select col1, col2 from teacher where email&#x3D;&#39;xxx&#39;;<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></div></figure>

<p>如果email这个字段上没有索引，那么这个语句就只能做 <code>全表扫描</code> 。</p>
<h3 id="9-1-前缀索引"><a href="#9-1-前缀索引" class="headerlink" title="9.1 前缀索引"></a>9.1 前缀索引</h3><p>MySQL是支持前缀索引的。默认地，如果你创建索引的语句不指定前缀长度，那么索引就会包含整个字 符串。</p>
<figure><div class="code-wrapper"><pre class="line-numbers language-none"><code class="language-none">mysql&gt; alter table teacher add index index1(email);
#或
mysql&gt; alter table teacher add index index2(email(6));<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre></div></figure>

<p>这两种不同的定义在数据结构和存储上有什么区别呢？下图就是这两个索引的示意图。</p>
<p>以及</p>
<p><strong>如果使用的是index1</strong>（即email整个字符串的索引结构），执行顺序是这样的：</p>
<ol>
<li>从index1索引树找到满足索引值是’ <a href="mailto:zhangssxyz@xxx.com">zhangssxyz@xxx.com</a>’的这条记录，取得ID2的值；</li>
<li>到主键上查到主键值是ID2的行，判断email的值是正确的，将这行记录加入结果集；</li>
<li>取index1索引树上刚刚查到的位置的下一条记录，发现已经不满足email&#x3D;’ <a href="mailto:zhangssxyz@xxx.com">zhangssxyz@xxx.com</a> ’的 条件了，循环结束。</li>
</ol>
<p>这个过程中，只需要回主键索引取一次数据，所以系统认为只扫描了一行。</p>
<p><strong>如果使用的是index2</strong>（即email(6)索引结构），执行顺序是这样的：</p>
<ol>
<li>从index2索引树找到满足索引值是’zhangs’的记录，找到的第一个是ID1；</li>
<li>到主键上查到主键值是ID1的行，判断出email的值不是’ <a href="mailto:zhangssxyz@xxx.com">zhangssxyz@xxx.com</a> ’，这行记录丢弃；</li>
<li>取index2上刚刚查到的位置的下一条记录，发现仍然是’zhangs’，取出ID2，再到ID索引上取整行然 后判断，这次值对了，将这行记录加入结果集；</li>
<li>重复上一步，直到在idxe2上取到的值不是’zhangs’时，循环结束。</li>
</ol>
<p>也就是说<strong>使用前缀索引，定义好长度，就可以做到既节省空间，又不用额外增加太多的查询成本。</strong>前面 已经讲过区分度，区分度越高越好。因为区分度越高，意味着重复的键值越少。</p>
<h3 id="9-2-前缀索引对覆盖索引的影响"><a href="#9-2-前缀索引对覆盖索引的影响" class="headerlink" title="9.2 前缀索引对覆盖索引的影响"></a>9.2 前缀索引对覆盖索引的影响</h3><blockquote>
<p>结论： 使用前缀索引就用不上覆盖索引对查询性能的优化了，这也是你在选择是否使用前缀索引时需要考虑的一个因素。</p>
</blockquote>
<h2 id="10-索引下推"><a href="#10-索引下推" class="headerlink" title="10. 索引下推"></a>10. 索引下推</h2><p>索引条件下推，也叫索引下推，英文全称<code>Index Condition Pushdown</code>，简称ICP。</p>
<p>索引下推是<strong>MySQL5.6</strong>新添加的特性，用于优化数据的查询。</p>
<p>在MySQL5.6之前，通过使用非主键索引进行查询的时候，存储引擎通过索引查询数据，然后将结果返回给MySQL server层，<strong>在server层判断是否符合条件</strong>。</p>
<p>在MySQL5.6及以上版本，可以使用索引下推的特性。<font color='read'>当存在索引的列做为判断条件时，MySQL server将这一部分判断条件传递给存储引擎，然后存储引擎会筛选出<strong>符合MySQL server传递条件的索引项</strong>，即在存储引擎层根据索引条件<strong>过滤</strong>掉不符合条件的索引项，然后回表查询得到结果，将结果返回给MySQL server。</font></p>
<p><strong>有了索引下推的优化，在满足一定的条件下，存储引擎层会在回表查询之前对数据进行过滤，可以减少存储引擎回表查询的次数</strong>。</p>
<p><strong>举个例子</strong></p>
<p>假设有一张用户信息表user_info，有三个字段<code>name, level, weapon（装备）</code>，建立联合索引<code>(name, level)</code>，user_info表初始数据如下：</p>
<table>
<thead>
<tr>
<th>id</th>
<th>name</th>
<th>level</th>
<th>weapon</th>
</tr>
</thead>
<tbody><tr>
<td>1</td>
<td>大彬</td>
<td>1</td>
<td>键盘</td>
</tr>
<tr>
<td>2</td>
<td>盖聂</td>
<td>2</td>
<td>渊虹</td>
</tr>
<tr>
<td>3</td>
<td>卫庄</td>
<td>3</td>
<td>鲨齿</td>
</tr>
<tr>
<td>4</td>
<td>大铁锤</td>
<td>4</td>
<td>铁锤</td>
</tr>
</tbody></table>
<p>假如需要匹配姓名第一个字为”大”，并且level为1的用户，SQL语句如下：</p>
<figure><div class="code-wrapper"><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">sql</span>
复制代码<span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> user_info <span class="token keyword">WHERE</span> name <span class="token operator">LIKE</span> <span class="token string">"大%"</span> <span class="token operator">AND</span> <span class="token keyword">level</span> <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre></div></figure>

<p>那么这条SQL具体会怎么执行呢？</p>
<p>下面分情况进行分析。</p>
<p><strong>先来看看MySQL5.6以前的版本</strong>。</p>
<p>前面提到MySQL5.6以前的版本没有索引下推，其执行过程如下：</p>
<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20230814122619011.png" srcset="/img/loading.gif" lazyload alt="image-20230814122619011"></p>
<p>查询条件<code>name LIKE </code>不是等值匹配，根据<strong>最左匹配原则</strong>，在<code>(name, level)</code>索引树上只用到<code>name</code>去匹配，查找到两条记录（id为1和4），拿到这两条记录的id分别回表查询，然后将结果返回给MySQL server，在MySQL server层进行<code>level</code>字段的判断。<strong>整个过程需要回表2次</strong>。</p>
<p><strong>然后看看MySQL5.6及以上版本的执行过程</strong>，如下图。</p>
<p><img src="https://imagebed-xuhuaiang.oss-cn-shanghai.aliyuncs.com/typora/image-20230814122631846.png" srcset="/img/loading.gif" lazyload alt="image-20230814122631846"></p>
<p>相比5.6以前的版本，多了索引下推的优化，在索引遍历过程中，对<strong>索引中的字段</strong>先做判断，过滤掉不符合条件的索引项，<strong>也就是判断level是否等于1</strong>，level不为1则直接跳过。因此在<code>(name, level)</code>索引树只匹配一个记录，之后拿着此记录对应的id（id&#x3D;1）回表查询全部数据，<strong>整个过程回表1次</strong>。</p>
<p>可以使用explain查看是否使用索引下推，当<code>Extra</code>列的值为<code>Using index condition</code>，则表示使用了索引下推。</p>
<p><strong>总结</strong></p>
<p>从上面的例子可以看出，使用索引下推在某些场景下可以有效<strong>减少回表次数</strong>，从而提高查询效率。</p>
<h2 id="11-普通索引-vs-唯一索引"><a href="#11-普通索引-vs-唯一索引" class="headerlink" title="11. 普通索引 vs 唯一索引"></a>11. 普通索引 vs 唯一索引</h2><p>从性能的角度考虑，你选择唯一索引还是普通索引呢？选择的依据是什么呢？</p>
<p>假设，我们有一个主键列为ID的表，表中有字段k，并且在k上有索引，假设字段 k 上的值都不重复。</p>
<p>这个表的建表语句是：</p>
<figure><div class="code-wrapper"><pre class="line-numbers language-none"><code class="language-none">mysql&gt; create table test(
id int primary key,
k int not null,
name varchar(16),
index (k)
)engine&#x3D;InnoDB;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure>

<p>表中R1~R5的(ID,k)值分别为(100,1)、(200,2)、(300,3)、(500,5)和(600,6)。</p>
<h3 id="11-1-查询过程"><a href="#11-1-查询过程" class="headerlink" title="11.1 查询过程"></a>11.1 查询过程</h3><p>假设，执行查询的语句是 select id from test where k&#x3D;5。</p>
<ul>
<li>对于普通索引来说，查找到满足条件的第一个记录(5,500)后，需要查找下一个记录，直到碰到第一 个不满足k&#x3D;5条件的记录。</li>
<li>对于唯一索引来说，由于索引定义了唯一性，查找到第一个满足条件的记录后，就会停止继续检 索。</li>
</ul>
<p>那么，这个不同带来的性能差距会有多少呢？答案是， 微乎其微 。</p>
<h3 id="11-2-更新过程"><a href="#11-2-更新过程" class="headerlink" title="11.2 更新过程"></a>11.2 更新过程</h3><p>为了说明普通索引和唯一索引对更新语句性能的影响这个问题，介绍一下change buffer。</p>
<p>当需要更新一个数据页时，如果数据页在内存中就直接更新，而如果这个数据页还没有在内存中的话， 在不影响数据一致性的前提下， <code>InooDB会将这些更新操作缓存在change buffer中</code> ，这样就不需要从磁盘中读入这个数据页了。在下次查询需要访问这个数据页的时候，将数据页读入内存，然后执行change buffer中与这个页有关的操作。通过这种方式就能保证这个数据逻辑的正确性。</p>
<p>将change buffer中的操作应用到原数据页，得到最新结果的过程称为 merge 。除了 <code>访问这个数据页</code> 会触 发merge外，系统有 <code>后台线程会定期</code> merge。在 <code>数据库正常关闭（shutdown）</code> 的过程中，也会执行merge 操作。</p>
<p>如果能够将更新操作先记录在change buffer， <code>减少读磁盘</code> ，语句的执行速度会得到明显的提升。而且， 数据读入内存是需要占用 buffer pool 的，所以这种方式还能够 <code>避免占用内存 </code>，提高内存利用率。</p>
<p><code>唯一索引的更新就不能使用change buffer</code> ，实际上也只有普通索引可以使用。</p>
<p>如果要在这张表中插入一个新记录(4,400)的话，InnoDB的处理流程是怎样的？</p>
<h3 id="11-3-change-buffer的使用场景"><a href="#11-3-change-buffer的使用场景" class="headerlink" title="11.3 change buffer的使用场景"></a>11.3 change buffer的使用场景</h3><ol>
<li>普通索引和唯一索引应该怎么选择？其实，这两类索引在查询能力上是没差别的，主要考虑的是 对 更新性能 的影响。所以，建议你 尽量选择普通索引 。</li>
<li>在实际使用中会发现， 普通索引 和 change buffer 的配合使用，对于 数据量大 的表的更新优化 还是很明显的。</li>
<li>如果所有的更新后面，都马上 伴随着对这个记录的查询 ，那么你应该 关闭change buffer 。而在 其他情况下，change buffer都能提升更新性能。</li>
<li>由于唯一索引用不上change buffer的优化机制，因此如果 业务可以接受 ，从性能角度出发建议优 先考虑非唯一索引。但是如果”业务可能无法确保”的情况下，怎么处理呢？<ul>
<li>首先， 业务正确性优先 。我们的前提是“业务代码已经保证不会写入重复数据”的情况下，讨论性能 问题。如果业务不能保证，或者业务就是要求数据库来做约束，那么没得选，必须创建唯一索引。 这种情况下，本节的意义在于，如果碰上了大量插入数据慢、内存命中率低的时候，给你多提供一 个排查思路。</li>
<li>然后，在一些“ 归档库 ”的场景，你是可以考虑使用唯一索引的。比如，线上数据只需要保留半年， 然后历史数据保存在归档库。这时候，归档数据已经是确保没有唯一键冲突了。要提高归档效率， 可以考虑把表里面的唯一索引改成普通索引。</li>
</ul>
</li>
</ol>
<h2 id="12-其它查询优化策略"><a href="#12-其它查询优化策略" class="headerlink" title="12. 其它查询优化策略"></a>12. 其它查询优化策略</h2><h3 id="12-1-EXISTS-和-IN-的区分"><a href="#12-1-EXISTS-和-IN-的区分" class="headerlink" title="12.1 EXISTS 和 IN 的区分"></a>12.1 EXISTS 和 IN 的区分</h3><p><strong><font color='scarlet'>问题：</font></strong></p>
<p>不太理解哪种情况下应该使用 EXISTS，哪种情况应该用 IN。选择的标准是看能否使用表的索引吗？</p>
<p><strong><font color='scarlet'>回答：</font></strong></p>
<p>索引是个前提，其实选择与否还是要看表的大小。你可以将选择的标准理解为<code>小表驱动大表</code>。在这种方式下效率是最高的。<br>比如下面这样:</p>
<figure><div class="code-wrapper"><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> A <span class="token keyword">WHERE</span> cC <span class="token operator">IN</span> <span class="token punctuation">(</span><span class="token keyword">SELECT</span> cc <span class="token keyword">FROM</span> B<span class="token punctuation">)</span>
<span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> A <span class="token keyword">WHERE</span> <span class="token keyword">EXISTS</span> <span class="token punctuation">(</span><span class="token keyword">SELECT</span> CC <span class="token keyword">FROM</span> B <span class="token keyword">WHERE</span> B<span class="token punctuation">.</span>CC<span class="token operator">=</span>A<span class="token punctuation">.</span> cc<span class="token punctuation">)</span>
当A小于B时，用<span class="token keyword">EXISTS</span>。因为<span class="token keyword">EXISTS</span>的实现，相当于外表循环<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre></div></figure>

<p><strong><font color='scarlet'>即当我们需要判断某个值是否存在于子查询中，且子查询中数据量比较大时，通常使用 EXISTS 子查询，因为它可以在找到第一条符合条件的记录时就立即退出查询，从而提高效率；而当我们需要获取所有符合条件的数据行时，可以使用 IN 子查询。</font></strong></p>
<h3 id="12-2-不同COUNT的效率"><a href="#12-2-不同COUNT的效率" class="headerlink" title="12.2 不同COUNT的效率"></a>12.2 不同COUNT的效率</h3><p>问：在 MySQL 中统计数据表的行数，可以使用三种方式：<code> SELECT COUNT(*)</code> 、 <code>SELECT COUNT(1) </code>和 <code>SELECT COUNT(具体字段) </code>，使用这三者之间的查询效率是怎样的？</p>
<blockquote>
<p>在 MySQL 中，<code>SELECT COUNT(*)</code>、<code>SELECT COUNT(1)</code> 和 <code>SELECT COUNT(具体字段)</code> 都可以用来查询数据表中所有行的数量。它们的效果是相同的，都会返回所有行的数量。但是，在内部实现细节上存在一些差异。</p>
<ol>
<li><code>SELECT COUNT(*)</code>：该语句会对每一行进行计数，包括 NULL 值，因此得到的行数可能会比使用其他列的方式多。它会遍历整张表进行计数，也就是说它会对表中的所有行进行扫描。如果表比较小，那么使用 <code>COUNT(*)</code> 可能不会对性能产生太大影响；但如果表比较大，那么可能会在计算时耗费大量的时间和系统资源。</li>
<li><code>SELECT COUNT(1)</code>：该语句会将每个值都视为 1 进行计数，并且不会计算 NULL 值。它与 <code>COUNT(*)</code> 的区别在于，在使用 <code>COUNT(1)</code> 时不需要取出任何具体的表字段数据，因此可以减少开销。实际上，MySQL 会把 <code>COUNT(1)</code> 转化成 <code>COUNT(*)</code> 进行处理，从而得到的效果是相同的。</li>
<li><code>SELECT COUNT(具体字段)</code>：该语句会计算指定字段的非 NULL 值的数量。由于只涉及指定的字段，因此可以缩小查询范围，提高效率。但如果表中的指定字段包含 NULL 值，则结果可能会比使用 <code>COUNT(*)</code> 或 <code>COUNT(1)</code> 得到的行数少。</li>
</ol>
<p>综上所述，虽然 <code>SELECT COUNT(*)</code>、<code>SELECT COUNT(1)</code> 和 <code>SELECT COUNT(具体字段)</code> 都可以用来查询数据表中所有行的数量，但在实践中，我们通常建议使用 <code>SELECT COUNT(1)</code>，因为它的内部实现方式更简单、效率更高，同时可以减少系统资源的占用。当然，在某些情况下，也可以选择使用 <code>SELECT COUNT(具体字段)</code> 来缩小查询范围并提高效率。</p>
</blockquote>
<h3 id="12-3-关于SELECT"><a href="#12-3-关于SELECT" class="headerlink" title="12.3 关于SELECT(*)"></a>12.3 关于SELECT(*)</h3><blockquote>
<p>在表查询中，建议明确字段，不要使用 * 作为查询的字段列表，推荐使用SELECT &lt;字段列表&gt; 查询。原因：</p>
<p>① MySQL 在解析的过程中，会通过<code>查询数据字典 </code>将<code>*</code>按序转换成所有列名，这会大大的耗费时间和系统资源。</p>
<p>② 无法使用<code>覆盖索引</code></p>
</blockquote>
<h3 id="12-4-LIMIT-1-对优化的影响"><a href="#12-4-LIMIT-1-对优化的影响" class="headerlink" title="12.4 LIMIT 1 对优化的影响"></a>12.4 LIMIT 1 对优化的影响</h3><blockquote>
<p>针对的是会扫描全表的 SQL 语句，如果你可以确定结果集只有一条，那么加上 LIMIT 1 的时候，当找到一条结果的时候就不会继续扫描了，这样会加快查询速度。</p>
<p>如果数据表已经对字段建立了唯一索引，那么可以通过索引进行查询，不会全表扫描的话，就不需要加上 LIMIT 1 了。</p>
</blockquote>
<h3 id="12-5-多使用COMMIT"><a href="#12-5-多使用COMMIT" class="headerlink" title="12.5 多使用COMMIT"></a>12.5 多使用COMMIT</h3><p>只要有可能，在程序中尽量多使用 COMMIT，这样程序的性能得到提高，需求也会因为 COMMIT 所释放 的资源而减少。</p>
<p>COMMIT 所释放的资源：</p>
<ul>
<li>回滚段上用于恢复数据的信息</li>
<li>被程序语句获得的锁</li>
<li>redo &#x2F; undo log buffer 中的空间</li>
<li>管理上述 3 种资源中的</li>
</ul>

                
              </div>
            
            <hr/>
            <div>
              <div class="post-metas my-3">
  
    <div class="post-meta mr-3 d-flex align-items-center">
      <i class="iconfont icon-category"></i>
      

<span class="category-chains">
  
  
    
      <span class="category-chain">
        
  <a href="/categories/MySQL/" class="category-chain-item">MySQL</a>
  
  

      </span>
    
  
</span>

    </div>
  
  
    <div class="post-meta">
      <i class="iconfont icon-tags"></i>
      
        <a href="/tags/MySQL/">#MySQL</a>
      
        <a href="/tags/%E6%95%B0%E6%8D%AE%E5%BA%93/">#数据库</a>
      
    </div>
  
</div>


              
  

  <div class="license-box my-3">
    <div class="license-title">
      <div>第10章_索引的优化与查询优化</div>
      <div>https://xhablog.online/2021/04/23/MySQL高级-第10章_索引的优化与查询优化/</div>
    </div>
    <div class="license-meta">
      
        <div class="license-meta-item">
          <div>作者</div>
          <div>Xu huaiang</div>
        </div>
      
      
        <div class="license-meta-item license-meta-date">
          <div>发布于</div>
          <div>2021年4月23日</div>
        </div>
      
      
      
        <div class="license-meta-item">
          <div>许可协议</div>
          <div>
            
              
              
                <a target="_blank" href="https://creativecommons.org/licenses/by/4.0/">
                  <span class="hint--top hint--rounded" aria-label="BY - 署名">
                    <i class="iconfont icon-by"></i>
                  </span>
                </a>
              
            
          </div>
        </div>
      
    </div>
    <div class="license-icon iconfont"></div>
  </div>



              
                <div class="post-prevnext my-3">
                  <article class="post-prev col-6">
                    
                    
                      <a href="/2021/04/23/MySQL%E9%AB%98%E7%BA%A7-SQL%E4%BC%98%E5%8C%96/" title="MySQL高级-SQL优化">
                        <i class="iconfont icon-arrowleft"></i>
                        <span class="hidden-mobile">MySQL高级-SQL优化</span>
                        <span class="visible-mobile">上一篇</span>
                      </a>
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/2021/04/22/MySQL%E9%AB%98%E7%BA%A7-%E7%AC%AC09%E7%AB%A0_%E6%80%A7%E8%83%BD%E5%88%86%E6%9E%90%E5%B7%A5%E5%85%B7%E7%9A%84%E4%BD%BF%E7%94%A8/" title="第09章_性能分析工具的使用">
                        <span class="hidden-mobile">第09章_性能分析工具的使用</span>
                        <span class="visible-mobile">下一篇</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
  
  
    <article id="comments" lazyload>
      
  <div id="gitalk-container"></div>
  <script type="text/javascript">
    Fluid.utils.loadComments('#gitalk-container', function() {
      Fluid.utils.createCssLink('/css/gitalk.css')
      Fluid.utils.createScript('https://lib.baomitu.com/gitalk/1.8.0/gitalk.min.js', function() {
        var options = Object.assign(
          {"clientID":"65685887a536577e68ad","clientSecret":"da9f0f4e5301326ac35bb6141f0234e2a7561f4c","repo":"sunwebgo.github.io","owner":"sunwebgo","admin":["sunwebgo"],"language":"zh-CN","labels":["Gitalk"],"perPage":10,"pagerDirection":"last","distractionFreeMode":false,"createIssueManually":true,"proxy":"https://cors-anywhere.azm.workers.dev/https://github.com/login/oauth/access_token"},
          {
            id: 'b8b5fe831752875b825df231e5f8090e'
          }
        )
        var gitalk = new Gitalk(options);
        gitalk.render('gitalk-container');
      });
    });
  </script>
  <noscript>Please enable JavaScript to view the comments</noscript>


    </article>
  


          </article>
        </div>
      </div>
    </div>

    <div class="side-col d-none d-lg-block col-lg-2">
      
  <aside class="sidebar" style="margin-left: -1rem">
    <div id="toc">
  <p class="toc-header">
    <i class="iconfont icon-list"></i>
    <span>目录</span>
  </p>
  <div class="toc-body" id="toc-body"></div>
</div>



  </aside>


    </div>
  </div>
</div>





  



  



  



  



  







    

    
      <a id="scroll-top-button" aria-label="TOP" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">搜索</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v" for="local-search-input">关键词</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>

    

    
  </main>

  <footer>
    <div class="footer-inner">
  
    <div class="footer-content">
       <span><svg t="1686650467734" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="4406" width="13" height="13"><path d="M926.991 337.678c-22.571-53.364-54.877-101.283-96.021-142.426-41.143-41.143-89.062-73.449-142.426-96.02-55.266-23.375-113.953-35.228-174.434-35.228-60.48 0-119.168 11.852-174.433 35.228-53.364 22.571-101.283 54.877-142.426 96.02s-73.449 89.062-96.02 142.426c-23.375 55.265-35.228 113.953-35.228 174.433 0 60.48 11.852 119.168 35.228 174.434 22.571 53.364 54.877 101.283 96.02 142.426 41.143 41.144 89.062 73.449 142.426 96.021 55.265 23.375 113.953 35.228 174.433 35.228 60.48 0 119.168-11.853 174.434-35.228 53.364-22.571 101.283-54.877 142.426-96.021 41.144-41.143 73.449-89.062 96.021-142.426 23.375-55.266 35.228-113.953 35.228-174.434 0-60.48-11.853-119.168-35.228-174.433z m-412.88 558.541c-211.797 0-384.107-172.31-384.107-384.107 0-211.797 172.31-384.107 384.107-384.107 211.798 0 384.107 172.31 384.107 384.107 0.001 211.797-172.309 384.107-384.107 384.107z" p-id="4407"></path><path d="M514.111 290.829c51.918 0 102.431 18.428 142.233 51.889 13.528 11.375 33.715 9.626 45.086-3.902 11.373-13.527 9.626-33.713-3.902-45.086-51.316-43.142-116.456-66.901-183.417-66.901-76.201 0-147.842 29.675-201.725 83.557-53.883 53.883-83.558 125.523-83.558 201.725s29.675 147.843 83.558 201.726 125.523 83.558 201.725 83.558c66.961 0 132.1-23.76 183.417-66.901 13.528-11.372 15.275-31.559 3.902-45.086s-31.559-15.275-45.086-3.902c-39.803 33.462-90.315 51.89-142.233 51.89-122.015 0-221.282-99.268-221.282-221.283 0-122.017 99.267-221.284 221.282-221.284z" p-id="4408"></path></svg>2021 - 2023</span> <span>本站由</span> <a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a> <span>&</span> <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>Fluid</span></a> <span>强力驱动</span> 
      <!--《添加网站运行时间 -->
<br/>

    <span id="timeDate">载入天数...</span><span id="times">载入时分秒...</span>
    <script>
      var now = new Date();

      function createtime() {
        //此处修改你的建站时间或者网站上线时间
        var grt = new Date('06/09/2023 8:00:00');
        now.setTime(now.getTime() + 250);
        days = (now - grt) / 1000 / 60 / 60 / 24;

        dnum = Math.floor(days);
        hours = (now - grt) / 1000 / 60 / 60 - (24 * dnum);
        hnum = Math.floor(hours);
        if (String(hnum).length == 1) {
          hnum = "0" + hnum;
        }
        minutes = (now - grt) / 1000 / 60 - (24 * 60 * dnum) - (60 * hnum);
        mnum = Math.floor(minutes);
        if (String(mnum).length == 1) {
          mnum = "0" + mnum;
        }
        seconds = (now - grt) / 1000 - (24 * 60 * 60 * dnum) - (60 * 60 * hnum) - (60 * mnum);
        snum = Math.round(seconds);
        if (String(snum).length == 1) {
          snum = "0" + snum;
        }
        document.getElementById("timeDate").innerHTML = " 本站已破天荒的安全运行 " + dnum + " 天 ";
        document.getElementById("times").innerHTML = hnum + " 小时 " + mnum + " 分 " + snum + " 秒";
      }
      setInterval("createtime()", 250);
    </script>

<!-- 添加网站运行时间》-->
<br/>
<span style="font-weight: initial">文章总字数2608k</span>

    </div>
  
  
    <div class="statistics">
  
  

  
    
      <span id="leancloud-site-pv-container" style="display: none">
        总访问量 
        <span id="leancloud-site-pv"></span>
         次
      </span>
    
    
      <span id="leancloud-site-uv-container" style="display: none">
        总访客数 
        <span id="leancloud-site-uv"></span>
         人
      </span>
    
    

  
</div>

  
  
  
</div>

  </footer>

  <!-- Scripts -->
  
  <script  src="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":100})
    NProgress.start()
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://lib.baomitu.com/jquery/3.6.0/jquery.min.js" ></script>
<script  src="https://lib.baomitu.com/twitter-bootstrap/4.6.1/js/bootstrap.min.js" ></script>
<script  src="/js/events.js" ></script>
<script  src="/js/plugins.js" ></script>


  <script  src="https://lib.baomitu.com/typed.js/2.0.12/typed.min.js" ></script>
  <script>
    (function (window, document) {
      var typing = Fluid.plugins.typing;
      var subtitle = document.getElementById('subtitle');
      if (!subtitle || !typing) {
        return;
      }
      var text = subtitle.getAttribute('data-typed-text');
      
        typing(text);
      
    })(window, document);
  </script>




  
    <script  src="/js/img-lazyload.js" ></script>
  




  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/tocbot/4.18.2/tocbot.min.js', function() {
    var toc = jQuery('#toc');
    if (toc.length === 0 || !window.tocbot) { return; }
    var boardCtn = jQuery('#board-ctn');
    var boardTop = boardCtn.offset().top;

    window.tocbot.init(Object.assign({
      tocSelector     : '#toc-body',
      contentSelector : '.markdown-body',
      linkClass       : 'tocbot-link',
      activeLinkClass : 'tocbot-active-link',
      listClass       : 'tocbot-list',
      isCollapsedClass: 'tocbot-is-collapsed',
      collapsibleClass: 'tocbot-is-collapsible',
      scrollSmooth    : true,
      includeTitleTags: true,
      headingsOffset  : -boardTop,
    }, CONFIG.toc));
    if (toc.find('.toc-list-item').length > 0) {
      toc.css('visibility', 'visible');
    }

    Fluid.events.registerRefreshCallback(function() {
      if ('tocbot' in window) {
        tocbot.refresh();
        var toc = jQuery('#toc');
        if (toc.length === 0 || !tocbot) {
          return;
        }
        if (toc.find('.toc-list-item').length > 0) {
          toc.css('visibility', 'visible');
        }
      }
    });
  });
</script>


  <script  src="https://lib.baomitu.com/prism/1.29.0/plugins/line-numbers/prism-line-numbers.min.js" ></script>

  <script src=https://lib.baomitu.com/clipboard.js/2.0.11/clipboard.min.js></script>

  <script>Fluid.plugins.codeWidget();</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/anchor-js/4.3.1/anchor.min.js', function() {
    window.anchors.options = {
      placement: CONFIG.anchorjs.placement,
      visible  : CONFIG.anchorjs.visible
    };
    if (CONFIG.anchorjs.icon) {
      window.anchors.options.icon = CONFIG.anchorjs.icon;
    }
    var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
    var res = [];
    for (var item of el) {
      res.push('.markdown-body > ' + item.trim());
    }
    if (CONFIG.anchorjs.placement === 'left') {
      window.anchors.options.class = 'anchorjs-link-left';
    }
    window.anchors.add(res.join(', '));

    Fluid.events.registerRefreshCallback(function() {
      if ('anchors' in window) {
        anchors.removeAll();
        var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
        var res = [];
        for (var item of el) {
          res.push('.markdown-body > ' + item.trim());
        }
        if (CONFIG.anchorjs.placement === 'left') {
          anchors.options.class = 'anchorjs-link-left';
        }
        anchors.add(res.join(', '));
      }
    });
  });
</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.js', function() {
    Fluid.plugins.fancyBox();
  });
</script>


  <script>Fluid.plugins.imageCaption();</script>

  <script defer src="/js/leancloud.js" ></script>

  <script  src="/js/local-search.js" ></script>





<!-- 主题的启动项，将它保持在最底部 -->
<!-- the boot of the theme, keep it at the bottom -->
<script  src="/js/boot.js" ></script>


  

  <noscript>
    <div class="noscript-warning">博客在允许 JavaScript 运行的环境下浏览效果更佳</div>
  </noscript>
</body>
</html>
